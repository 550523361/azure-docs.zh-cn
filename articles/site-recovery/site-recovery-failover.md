---
title: "Site Recovery 中的故障转移 | Microsoft Docs"
description: "Azure Site Recovery 可以协调虚拟机和物理服务器的复制、故障转移与恢复。 了解有关故障转移到 Azure 或辅助数据中心的信息。"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 1/04/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: b70d2d709d0940964c4220b798207adaf3551d36
ms.openlocfilehash: d31e987e636b178b5aa05722ff08707a6e53c3cf


---
# <a name="failover-in-site-recovery"></a>Site Recovery 中的故障转移
Azure Site Recovery 服务有助于业务连续性和灾难恢复 (BCDR) 策略，因为它可以协调虚拟机和物理服务器的复制、故障转移和恢复。 虚拟机可复制到 Azure 中，也可复制到本地数据中心中。 如需快速概览，请阅读[什么是 Azure Site Recovery？](site-recovery-overview.md)

## <a name="overview"></a>概述
本文提供有关恢复（故障转移和故障回复）使用 Site Recovery 保护的虚拟机和物理服务器的信息与说明。

请将任何评论或问题发布到本文底部，或者发布到 [Azure 恢复服务论坛](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)。

## <a name="types-of-failover"></a>故障转移类型
为虚拟机和物理服务器启用保护并且在它们进行复制后，可以根据需要运行故障转移。 Site Recovery 支持多种类型的故障转移。

| **故障转移** | **运行时机** | **详细信息** | **过程** |
| --- | --- | --- | --- |
| **测试故障转移** |运行以验证复制策略，或执行灾难恢复演练 |无数据丢失或停机时间。<br/><br/>不会影响复制<br/><br/>不会影响生产环境 |启动故障转移<br/><br/>指定测试计算机在故障转移后如何连接到网络<br/><br/>在“**作业**”选项卡上跟踪进度。 在辅助位置创建和启动测试计算机<br/><br/>Azure - 连接到 Azure 门户中的计算机<br/><br/>辅助站点 - 访问位于相同的主机和云中的计算机<br/><br/>完成测试并自动清除测试故障转移设置。 |
| **计划内故障转移** |运行以满足合规性要求<br/><br/>运行以进行计划内维护<br/><br/>根据故障转移数据运行，确保工作负荷在已知的服务中断时仍能正常运行 - 例如预期的断电或严重的天气报告<br/><br/>从主位置故障转移到辅助位置后运行故障回复 |无数据丢失<br/><br/>在主位置上关闭虚拟计算机，并在辅助位置上将其打开时，即产生停机时间。<br/><br/>当目标计算机在故障转移后变为源计算机后，虚拟机会受影响。 |启动故障转移<br/><br/>在“**作业**”选项卡上跟踪进度。 源计算机已关机<br/><br/>副本计算机在辅助位置启动<br/><br/>Azure - 连接到 Azure 门户中的副本计算机<br/><br/>辅助站点 - 访问位于相同的主机和相同的云中的计算机<br/><br/>提交故障转移 |
| **计划外故障转移** |由于意外事件（如断电或病毒攻击）而导致主站点不可访问时，应以反映方式运行此类故障转移 <br/><br/> 即使主站点不可用，你也可以运行可完成的计划外故障转移。 |数据丢失取决于复制频率设置<br/><br/>数据将根据上次同步的时间保持最新 |启动故障转移<br/><br/>在“**作业**”选项卡上跟踪进度。 尝试关闭虚拟机并同步最新数据（可选）<br/><br/>副本计算机在辅助位置启动<br/><br/>Azure - 连接到 Azure 门户中的副本计算机<br/><br/>辅助站点访问位于相同的主机和相同的云中的计算机<br/><br/>提交故障转移 |

支持的故障转移类型取决于你的部署方案。

| **故障转移方向** | **测试故障转移** | **计划内故障转移** | **计划外故障转移** |
| --- | --- | --- | --- |
| 主 VMM 站点到辅助 VMM 站点 |支持 |支持 |支持 |
| 辅助 VMM 站点到主 VMM 站点 |支持 |支持 |支持 |
| 云到云（单个 VMM 服务器） |支持 |支持 |支持 |
| VMM 站点到 Azure |支持 |支持 |支持 |
| Azure 到 VMM 站点 |不支持 |支持 |不支持 |
| Hyper-V 站点到 Azure |支持 |支持 |支持 |
| Azure 到 Hyper-V 站点 |不支持 |支持 |不支持 |
| VMware 站点到 Azure |支持（增强方案）<br/><br/> 不支持（旧版方案） |不支持 |支持 |
| 物理服务器到 Azure |支持（增强方案）<br/><br/> 不支持（旧版方案） |不支持 |支持 |

## <a name="failover-and-failback"></a>故障转移和故障回复
根据你的部署，将虚拟机故障转移到本地辅助站点或 Azure。 故障转移到 Azure 的计算机将作为 Azure 虚拟机创建。 可以故障转移单个虚拟机、物理服务器或恢复计划。 恢复计划由一个或多个包含受保护虚拟机或物理服务器的有序组构成。 它们用于根据多个虚拟机所在的组协调这些虚拟机的故障转移。 [详细了解](site-recovery-create-recovery-plans.md)恢复计划。

完成故障转移并且计算机在辅助位置正常运行后，请注意：

* 如果故障转移到了 Azure，在故障转移后，计算机将不受保护，也不会在主要位置或辅助位置中复制。 在 Azure 中，虚拟机存储在提供复原能力但不提供复制的地域复制存储空间中。
* 如果你执行了到辅助站点的非计划故障转移，在故障转移后，辅助位置中的计算机将不受保护或进行复制。
* 如果你执行了到辅助站点的计划故障转移，在故障转移后，辅助位置中的计算机将受保护。

### <a name="failback-from-secondary-site"></a>从辅助站点故障回复
从辅助站点到主站点的故障回复所用的过程，与从主站点到辅助站点的故障转移相同。 提交并完成从主数据中心到辅助数据中心的故障转移后，你可以在主站点可用后启动反向复制。 反向复制会通过同步增量数据，在辅助站点与主站点之间启动复制。 反向复制会使虚拟机进入受保护状态，但辅助数据中心仍是活动位置。 为了使主站点成为活动位置，可以启动从辅助站点到主站点的计划故障转移，然后再次启动反向复制。

### <a name="failback-from-azure"></a>从 Azure 故障回复
如果已故障转移到 Azure，针对虚拟机的 Azure 复原功能将保护你的虚拟机。 若要使原始主站点成为活动位置，可以运行计划的故障转移。 如果原始站点不可用，可以故障回复到原始位置或备用位置。 若要在故障回复到主位置后再次启动复制，你可以启动反向复制。

### <a name="failover-considerations"></a>故障转移注意事项
* **故障转移后的 IP 地址** — 默认情况下，故障转移后计算机的 IP 地址将与源计算机不同。 如果想要保留相同的 IP 地址，请参阅：
  * **辅助站点** — 如果要故障转移到辅助站点，并且想要保留 IP 地址，请[阅读](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx)此文章。 请注意，只有你的 ISP 支持保留公共 IP 地址，你才可以保留这种 IP 地址。
  * **Azure** — 如果要故障转移到 Azure，你可以在虚拟机属性的“**配置**”选项卡上指定想要分配的 IP 地址。 故障转移到 Azure 后无法保留公共 IP 地址。 可以保留用作内部地址的非 RFC 1918 地址空间。
* **部分故障转移** — 如果你想要故障转移站点的一部分而不是整个站点，请注意：

  * **辅助站点** — 如果你要将主站点的一部分故障转移到辅助站点并想要连接回到主站点，你可以使用站点到站点 VPN 连接，将辅助站点上已故障转移的应用程序连接到主站点上运行的基础结构组件。 如果故障转移了整个子网，则你可以保留虚拟机 IP 地址。 如果故障转移了部分子网，则你无法保留虚拟机 IP 地址，因为无法在站点之间拆分子网。
  * **Azure** — 如果你要将站点的一部分故障转移到 Azure 并想要连接回到主站点，你可以使用站点到站点 VPN 将 Azure 中已故障转移的应用程序连接到主站点上运行的基础结构组件。 请注意，如果故障转移了整个子网，则你可以保留虚拟机 IP 地址。 如果故障转移了部分子网，则你无法保留虚拟机 IP 地址，因为无法在站点之间拆分子网。
* **驱动器号** — 如果你要在故障转移后保留虚拟机上的驱动器号，可将虚拟机的 SAN 策略设置为“**打开**”。 虚拟机磁盘将自动联机。 [了解详细信息](https://technet.microsoft.com/library/gg252636.aspx)。
* **路由客户端请求** — Site Recovery 可与 Azure 流量管理器配合工作，以便在故障转移后将客户端请求路由到你的应用程序。

## <a name="run-a-test-failover"></a>运行测试故障转移
如果要进行测试故障转移到 Azure，请参阅[测试故障转移到 Azure](site-recovery-test-failover-to-azure.md) 文档。 如果要进行测试故障转移到 VMM 服务器管理的其他本地站点，请参阅[测试故障转移到 VMM](site-recovery-test-failover-vmm-to-vmm.md) 文档。  

## <a name="run-a-planned-failover-primary-to-secondary"></a>运行计划的故障转移（主站点到辅助站点）
 本过程描述如何对恢复计划运行计划的故障转移。 或者，也可以在“**虚拟机**”选项卡上对单个虚拟机运行故障转移。

1. 在开始之前，请确保要故障转移的所有虚拟机已完成初始复制。
2. 选择“**恢复计划**” > “*recoveryplan_name*”。 单击“**故障转移**” > “**计划的故障转移**”。
3. 在“确认计划的故障转移”页上，选择源和目标位置。 请注意故障转移方向。

   * 如果先前的故障转移符合预期要求，并且所有虚拟机服务器要么位于源位置，要么位于目标位置，则故障转移方向详细信息仅供参考。
   * 如果虚拟机在源位置和目标位置上均处于活动状态，则将显示“**更改方向**”按钮。 使用此按钮可以更改和指定故障转移应发生的方向。
4. 如果你要故障转移到 Azure 并且为云启用了数据加密，请在“**加密密钥**”中，选择你在 VMM 服务器上安装提供者期间启用数据加密时颁发的证书。
5. 当计划的故障转移开始时，第一步是关闭虚拟机以确保不会丢失数据。 你可以在“**作业**”选项卡上跟踪故障转移进度。 如果在故障转移中发生了错误（在虚拟机上或在恢复计划所包含的脚本中），则恢复计划的计划故障转移将停止。 你可以再次启动故障转移。
6. 副本虚拟机在创建后处于待提交状态。 单击“**提交**”以提交故障转移。
7. 复制完成后，虚拟机将在辅助位置启动。

## <a name="run-an-unplanned-failover"></a>运行非计划的故障转移
本过程描述如何对恢复计划运行非计划的故障转移。 或者，你也可以在“**虚拟机**”选项卡上对单个虚拟机或物理服务器运行故障转移。

1. 选择“**恢复计划**” > “*recoveryplan_name*”。 单击“**故障转移**” > “**非计划的故障转移**”。
2. 在“确认非计划的故障转移”页上，选择源和目标位置。 请注意故障转移方向。

   * 如果先前的故障转移符合预期要求，并且所有虚拟机服务器要么位于源位置，要么位于目标位置，则故障转移方向详细信息仅供参考。
   * 如果虚拟机在源位置和目标位置上均处于活动状态，则将显示“**更改方向**”按钮。 使用此按钮可以更改和指定故障转移应发生的方向。
3. 如果你要故障转移到 Azure 并且为云启用了数据加密，请在“**加密密钥**”中，选择你在 VMM 服务器上安装提供者期间启用数据加密时颁发的证书。
4. 选择“**关闭虚拟机并同步最新数据**”，指定 Azure Site Recovery 应尝试关闭受保护的虚拟机并同步数据，以便对最新版的数据进行故障转移。 如果你不选择此选项或尝试不成功，则系统将从虚拟机的最近恢复点开始故障转移。
5. 你可以在“**作业**”选项卡上跟踪故障转移进度。 请注意，即使在未计划的故障转移期间发生错误，恢复计划也会运行直至完成。
6. 故障转移后，虚拟机处于**待提交**状态。 单击“**提交**”以提交故障转移。
7. 如果将复制设置为使用多个恢复点，则在“更改恢复点”中，你可以选择使用不是最新的恢复点（默认情况下使用最新的恢复点）。 提交后，将删除其他恢复点。
8. 复制完成后，虚拟机将在辅助位置启动并运行。 但是，它们不受保护或进行复制。 当主站点再次可用并采用相同的底层基础结构时，请单击“**反向复制**”开始反向复制。 这确保所有数据都复制回主站点，并且虚拟机准备好再次进行故障转移。 未计划的故障转移之后的反向复制会导致数据传输开销。 传输将使用为云的初始复制设置配置的相同方法。

## <a name="failback-from-secondary-to-primary"></a>辅助位置故障回复到主要位置
 从主要位置故障转移到辅助位置后，复制的虚拟机不受 Site Recovery 的保护，辅助位置现在充当主要位置。 请遵循以下过程故障回复到原始主站点。 本过程描述如何对恢复计划运行计划的故障转移。 或者，也可以在“**虚拟机**”选项卡上对单个虚拟机运行故障转移。

1. 选择“**恢复计划**” > “*recoveryplan_name*”。 单击“**故障转移**” > “**计划的故障转移**”。
2. 在“确认计划的故障转移”页上，选择源和目标位置。 请注意故障转移方向。 如果从主要位置故障转移已按预期完成，并且所有虚拟机都位于辅助位置，则本部分仅供参考。
3. 如果你要从 Azure 故障回复，请在“**数据同步**”中选择设置：

   * **在故障转移之前同步数据（仅同步增量更改）** - 此选项可最大程度地减少虚拟机的停机时间，因为它可在不关闭虚拟机的情况下执行同步。 此选项将执行以下操作：
     * 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。
     * 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的更改集将传输到本地服务器，本地虚拟机将会启动。

    - **仅在故障转移期间同步数据（完整下载）** - 如果已在 Azure 上长时间运行，则使用此选项。 此选项速度更快，因为我们预计磁盘的大部分已经更改，而且不想花时间进行校验和计算。 此选项会执行磁盘的下载。 如果已删除本地虚拟机，此选项也很有帮助。

    > [!NOTE] 
    > 如果已在 Azure 上运行了一段时间（一个月或以上）或已删除本地 VM，我们建议你使用此选项。此选项不会执行任何校验和计算。
    >
    >


1. 如果你要故障转移到 Azure 并且为云启用了数据加密，请在“**加密密钥**”中，选择你在 VMM 服务器上安装提供者期间启用数据加密时颁发的证书。
2. 默认情况下，将使用最后一个恢复点，但你可以在“**更改恢复点**”中指定不同的恢复点。
3. 单击复选标记开始故障回复。  你可以在“**作业**”选项卡上跟踪故障转移进度。
4. 如果你选择了在故障转移之前同步数据的选项，请在完成初始数据同步并且你已准备好在 Azure 中关闭虚拟机后，单击“**作业**” > <planned failover job name>“**完成故障转移**”。 这将关闭 Azure 计算机，将最新更改传输到本地虚拟机，然后启动虚拟机。
5. 现在，你可以登录到虚拟机，以验证是否可以按预期使用它。
6. 虚拟机处于待提交状态。 单击“**提交**”以提交故障转移。
7. 现在，为了完成故障回复，请单击“**反向复制**”以开始保护主站点中的虚拟机。

## <a name="failback-to-an-alternate-location"></a>故障回复到备用位置
如果你在 [Hyper-V 站点与 Azure](site-recovery-hyper-v-site-to-azure.md) 之间部署了保护，则可以从 Azure 故障回复到备用本地位置。 如果你需要设置新的本地硬件，此功能将十分有用。 下面介绍了操作方法。

1. 如果你需要设置新的硬件，请在服务器上安装 Windows Server 2012 R2 和 Hyper-V 角色。
2. 创建与原始服务器上的名称相同的虚拟网络交换机。
3. 选择“**受保护的项**” -> 要故障回复的“**保护组**” -> <ProtectionGroupName> -> <VirtualMachineName>，然后选择“**计划的故障转移**”。
4. 在“**确认计划的故障转移**”中，选择“**如果本地虚拟机不存在，则创建它**”。
5. 在“**主机名**”中，选择你要在其上放置虚拟机的新 Hyper-V 主机服务器。
6. 在“数据同步”中，我们建议选择选项“**在故障转移之前同步数据**”。 此选项可以最大程度地减少虚拟机的停机时间，因为它可以在不关闭虚拟机的情况下执行同步。 此选项将执行以下操作：

   * 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。
   * 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的更改集将传输到本地服务器，本地虚拟机将会启动。
7. 单击复选标记开始故障转移（故障回复）。
8. 在完成初始数据同步并且你已准备好在 Azure 中关闭虚拟机后，单击“**作业**” > <planned failover job> > “**完成故障转移**”。 这将关闭 Azure 计算机，将最新更改传输到本地虚拟机，然后启动虚拟机。
9. 你可以登录到本地虚拟机，以验证一切是否如你所愿。 然后单击“**提交**”完成故障转移。
10. 单击“**反向复制**”开始保护本地虚拟机。

    > [!NOTE]
    > 如果在“数据同步”步骤中取消故障回复作业，则本地 VM 将处于损坏状态。 这是因为数据同步将 Azure VM 磁盘中的最新数据复制到本地数据磁盘上，在同步完成之前，磁盘数据并不处于一致状态。 如果在取消数据同步后启动本地 VM，则可能无法启动。 重新触发故障转移以完成数据同步。
    >
    >



<!--HONumber=Jan17_HO2-->


