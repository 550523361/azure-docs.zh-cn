---
title: Azure 上的微服务简介
description: 概述为何使用微服务方法构建云应用程序对于开发现代应用程序非常重要，以及 Azure Service Fabric 如何提供一个平台用于实现此目的。
ms.topic: conceptual
ms.date: 06/18/2019
ms.openlocfilehash: e23c571d2000b5565da018d6ddf70a6388cb9226
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/25/2019
ms.locfileid: "75466321"
---
# <a name="why-use-a-microservices-approach-to-building-applications"></a>为什么使用微服务方法构建应用程序？

对于软件开发人员而言，将应用程序分解为组件部分并不新鲜。 通常使用分层方法，其中包含后端存储、中间层业务逻辑和前端用户界面（UI）。 过去几*年发生了哪些变化*，开发人员正在为云构建分布式应用程序。

下面是一些不断变化的业务需求：

* 大规模构建和运营的一项服务，可在新的地理区域中访问客户。
* 更快地交付特性和功能，以灵活的方式响应客户需求。
* 提高资源利用率以降低成本。

这些业务要求影响我们*如何*构建应用程序。

有关微服务 Azure 方法的详细信息，请参阅[微服务：由云支持的应用程序革命](https://azure.microsoft.com/blog/microservices-an-application-revolution-powered-by-the-cloud/)。

## <a name="monolithic-vs-microservices-design-approach"></a>单片设计方法与微服务设计方法

应用程序会随着时间而发展。 成功的应用程序因为有实用性而发展。 不成功的应用程序不会演化，最终不推荐使用。 这是个问题：今天你对你的需求有多少了解，今后它们将是什么？ 例如，假设要为公司中的部门构建报表应用程序。 你确定应用程序仅适用于你的公司范围内，并且报表不会保留很长时间。 你的方法与构建将视频内容传递给成千上万的客户的服务不同。

有时，将门作为概念证明，就是驱动因素。 你知道以后可以重新设计应用程序。 几乎不会使用任何地方的过度工程处理。 另一方面，当公司为云构建时，预期会增长并使用。 增长和规模不可预测。 我们想要快速构建原型，同时还要知道我们所处的路径可以应对未来的成功。 这是简练的启动方法：构建、测量、学习和迭代。

在客户端/服务器时代，我们倾向将重点放在每个层中使用特定技术来构建分层应用程序上。 术语 "*单一*应用程序" 已发生，用于说明这些方法。 接口通常存在于各层之间，而在一层内的各组件之间采用更紧密耦合的设计。 开发人员设计并分解了编译到库中并链接到几个可执行文件和 Dll 的类。

整体设计方法有一些优点。 单一应用程序的设计速度通常更简单，并且组件间的调用速度更快，因为这些调用通常在进程间通信（IPC）上。 此外，每个人都可以测试单个产品，这往往是更有效地使用人力资源。 缺点是分层层之间存在紧密耦合，无法缩放各个组件。 如果需要执行修复或升级，则必须等待其他人完成其测试。 很难成为 agile。

微服务解决了这些缺点，并更密切地满足了前面的业务要求。 但它们也具有优点和责任。 微服务的优点是通常各自封装较为简单的业务功能，可独立缩放、测试、部署和管理。 微服务方法的一个重要优点是：团队在业务方案方面比技术更多。 小型团队基于客户方案开发微服务，并使用他们想要使用的任何技术。

换句话说，组织不需要为了维护微服务应用程序而将技术标准化。 拥有服务的单个团队可以根据团队的专业知识，或什么最适合解决问题，各自发挥所长。 在实践中，最好使用一组建议的技术，例如特定的 NoSQL 存储或 web 应用程序框架。

微服务的缺点是您必须管理更多不同的实体，并处理更复杂的部署和版本控制。 微服务之间的网络流量会随着相应网络延迟的增加而增加。 很多有问题且粒度较高的服务可能会导致性能不足。 如果没有工具来帮助您查看这些依赖关系，则很难看到整个系统。

标准通过指定如何从服务（而不是严格协定）进行通信和容忍，实现微服务方法的工作方式。 在设计中预先定义这些协定是非常重要的，因为服务会彼此独立地进行更新。 在设计微服务方法时出现的另一个描述是“面向服务的精细体系结构 (SOA)”。

***最简单的做法是，微服务设计方法是与服务的分离联合，并对每个和议定的通信标准进行独立更改。***

随着越来越多的云应用程序的生成，人们发现这将整个应用程序分解为独立的、以方案为中心的服务，是一种更好的长期方法。

## <a name="comparison-between-application-development-approaches"></a>应用程序开发方法的比较

![Service Fabric 平台应用程序开发][Image1]

1) 单一应用程序包含特定于域的功能，通常划分为功能层，如 web、业务和数据。

2) 可以通过将应用克隆到多个服务器/虚拟机/容器来缩放单一应用程序。

3) 微服务应用程序将单个功能分隔成单个较小的服务。

4) 微服务方法可通过独立部署每个服务而扩展，跨服务器/虚拟机/容器创建这些服务的实例。

使用微服务方法进行设计并非适用于所有项目，但它确实更符合前面所述的业务目标。 如果你知道你将有机会在微服务设计中重新创建代码，从整体方法开始可能会有意义。 更常见的是，从单一式应用程序入手，分阶段慢慢分解它（从需要提高可缩放性或敏捷性的功能区域开始）。

使用微服务方法时，会为应用程序编写许多小型服务。 这些服务在部署在计算机群集中的容器中运行。 小型团队开发一项服务，该服务侧重于方案，并对每个服务进行单独测试、版本、部署和缩放，因此整个应用程序可以发展。

## <a name="what-is-a-microservice"></a>什么是微服务？

微服务存在多种定义。 但微服务的大多数特征都被广泛接受：

* 封装客户方案或业务方案。 您正在解决什么问题？
* 由小型工程团队开发。
* 使用任何框架以任何编程语言编写的。
* 包含代码和可选状态，两者都是独立的版本控制、部署和缩放。
* 通过定义完善的接口和协议来与其他微服务交互。
* 具有用于解析其位置的唯一名称（Url）。
* 在出现故障时可保持一致且可用。

若要求和：

***微服务应用程序由独立控制版本和可缩放的、以客户为中心的服务组成，这些服务通过标准协议和定义完善的接口彼此通信。***

### <a name="written-in-any-programming-language-using-any-framework"></a>使用任何框架以任何编程语言编写

作为开发人员，我们希望根据我们的技能和我们正在创建的服务的需要，随意选择语言或框架。 对于某些服务，可能会将上述任何其他方面C++的性能优势作为价值。 对于其他人来说，从C#或 Java 获取的易管理开发可能更重要。 在某些情况下，可能需要使用特定合作伙伴库、数据存储技术，或向客户端公开服务的方法。

选择某项技术后，需要考虑服务的操作或生命周期管理和缩放。

### <a name="allows-code-and-state-to-be-independently-versioned-deployed-and-scaled"></a>允许独立控制版本、部署及缩放的代码和状态

无论你如何编写微服务，代码和（可选）状态都应该独立部署、升级和缩放。 这种问题很难解决，因为它是您所选的技术。 对于缩放，了解如何对代码和状态进行分区（或分片）都很有挑战性。 当代码和状态使用不同的技术时，通常情况下，微服务的部署脚本需要能够对其进行缩放。 这种分离方式还涉及灵活性和灵活性，因此你可以升级某些微服务，而无需同时升级所有这些操作。

接下来，我们来比较一下整体和微服务方法。 此图显示了存储状态的方法之间的差异：

#### <a name="state-storage-for-the-two-approaches"></a>这两种方法的状态存储

![Service Fabric 平台状态存储][Image2]

***左侧的单一方法具有单一数据库和特定技术层。***

***右侧的微服务方法具有互连的微服务图，其中状态通常作用于微服务并使用各种技术。***

在单一式方法中，应用程序通常使用单一数据库。 使用一个数据库的优点是它位于单个位置，这使其易于部署。 每个组件可以通过单个表来存储其状态。 困难之处在于团队必须严格区分状态。 有些人可能会想要将某列添加到现有 customer 表、在表之间进行联接，以及在存储层创建依赖关系。 发生这种情况后，无法缩放各个组件。

在微服务方法中，每个服务都管理并存储自己的状态。 每个服务将负责同时缩放代码和状态，以满足服务的需求。 缺点是，需要创建应用程序数据的视图或查询时，需要跨多个状态存储进行查询。 此问题通常由单独的微服务在微服务集合中生成视图来解决。 如果需要对数据运行多个即席查询，应考虑将每个微服务的数据写入数据仓库服务以供脱机分析。

微服务是版本控制的。 微服务的不同版本可能会并行运行。 在升级过程中，较新版本的微服务可能会失败，需要回滚到早期版本。 版本控制还有助于进行 A/B 测试，其中不同的用户体验到不同版本的服务。 例如，在更广泛推出新功能之前，为一组特定的客户升级微服务以测试新功能。

### <a name="interacts-with-other-microservices-over-well-defined-interfaces-and-protocols"></a>通过定义完善的接口和协议来与其他微服务交互

过去10年来，已经发布了大量信息，说明了面向服务的体系结构中的通信模式。 一般而言，服务通信使用 REST 方法，并配合 HTTP 与 TCP 协议及 XML 或 JSON 作为序列化格式。 从接口角度来看，这就是采用 web 设计方法。 但不应阻止你使用二进制协议或你自己的数据格式。 请注意，如果这些协议和格式没有公开提供，用户将会有更难使用微服务的时间。

### <a name="has-a-unique-name-url-used-to-resolve-its-location"></a>具有用来解析位置的唯一名称 (URL)

无论微服务在哪里运行，都需是可寻址的。 如果你正在考虑计算机，以及哪台计算机正在运行特定的微服务，事情会迅速出现错误。

就像 DNS 解析特定计算机的特定 URL 一样，微服务需要有唯一的名称来发现它目前所在的位置。 微服务需要独立于它们运行所在的基础结构的可寻址名称。 这意味着服务的部署和发现方式之间存在交互，因为需要有服务注册表。 当一台计算机出现故障时，注册表服务需要告诉您服务的移动位置。

### <a name="remains-consistent-and-available-in-the-presence-of-failures"></a>在出现故障时可保持一致且可用

处理意外的故障是最难解决的问题之一，特别是在分布式系统中。 作为开发人员编写的大部分代码都用于处理异常。 在测试过程中，我们还需要花费最多的时间来处理异常。 此过程比编写代码来处理故障更复杂。 如果运行微服务的计算机发生故障，会发生什么情况？ 你需要检测故障，这本身就是一个难题。 但你还需要重新启动微服务。

为实现可用性，微服务需要能够应对故障，并能够在另一台计算机上重新启动。 除了这些复原要求之外，数据不应丢失，并且数据需要保持一致。

如果在应用程序升级期间发生故障，则很难实现复原。 在配合部署系统一起运行时，微服务不仅需要恢复。 它需要确定是可以继续前进到较新的版本，还是回滚到以前的版本以保持一致的状态。 你需要考虑几个问题，例如是否有足够的计算机可供继续，以及如何恢复以前版本的微服务。 若要做出这些决定，需要微服务发出运行状况信息。

### <a name="reports-health-and-diagnostics"></a>报告运行状况和诊断

这似乎很明显，它经常被忽略，但微服务需要报告其运行状况和诊断。 否则，从操作的角度来看，您几乎不了解其运行状况。 面临的难题是关联一组独立服务的诊断事件并修正计算机时钟偏差以识别事件顺序。 同样地，通过议定的协议和数据格式来与微服务交互时，需要将运行状况和诊断事件的记录方式标准化，这些事件最终将写入可供查询和查看的事件存储。 使用微服务方法，不同的团队需要同意单一日志记录格式。 需要有一致的方法来查看整个应用程序中的诊断事件。

运行状况与诊断不同。 运行状况是指微服务报告其当前状态，以便采取适当的措施。 一个很好的例子便是使用升级和部署机制来保持可用性。 尽管服务可能由于进程崩溃或计算机重新启动而无法正常运行，但服务可能仍可正常运行。 最后一件事是通过开始升级，使问题更糟。 最佳方法是先调查，或留出时间让微服务恢复。 微服务中的运行状况事件可以帮助我们制定明智的决策，并且实际上也有助于创建自愈服务。

## <a name="guidance-for-designing-microservices-on-azure"></a>在 Azure 上设计微服务的指南 
请访问 Azure 体系结构中心，获取有关在[Azure 上设计和构建微服务](https://docs.microsoft.com/azure/architecture/microservices/)的指导。

## <a name="service-fabric-as-a-microservices-platform"></a>Service Fabric 作为微服务平台

当 Microsoft 从交付盒装产品（通常是单一的产品）转换到交付服务时，会出现 Azure Service Fabric。 构建和操作大型服务的体验（如 Azure SQL 数据库和 Azure Cosmos DB）形状 Service Fabric。 随着越来越多的服务采用该平台，该平台不断演变。 Service Fabric 不仅要在 Azure 中运行，还要在独立的 Windows Server 部署中运行。

***Service Fabric 旨在解决构建和运行服务的困难问题，并有效地使用基础结构资源，使团队可以使用微服务方法解决业务问题。***

Service Fabric 可帮助你构建使用微服务方法的应用程序，它提供：

* 提供系统服务的平台，用于部署、升级、检测和重启失败的服务、发现服务、路由消息、管理状态和监视运行状况。
* 能够部署在容器中运行或作为进程运行的应用程序。 Service Fabric 是容器和进程 Orchestrator。
* 高效编程 Api，可帮助你以微服务的形式生成应用程序： [ASP.NET Core、Reliable Actors 和 Reliable Services](service-fabric-choose-framework.md)。 例如，可以获取运行状况和诊断信息，或利用内置的高可用性。

***Service Fabric 不知道如何生成服务，可以使用任何技术。但它确实提供内置编程 Api，使生成微服务变得更加容易。***

### <a name="migrating-existing-applications-to-service-fabric"></a>将现有应用程序迁移到 Service Fabric

Service Fabric 允许你重复使用现有代码，并使用新的微服务实现现代化。 应用程序的现代化分为五个阶段，你可以在任何阶段启动和停止。 阶段为：

1) 从传统单一式应用程序入手。  
2) 移. 使用容器或来宾可执行文件在 Service Fabric 中托管现有代码。  
3) 之. 添加新的微服务与现有容器化代码。  
4) 创新。 根据需要将单一应用程序分解成微服务。  
5) 将应用程序转换为微服务。 转换现有的单一应用程序或生成新的领域应用程序。

![迁移到微服务][Image3]

请记住，可以*在任何这些阶段启动和停止*。 无需进行下一阶段。 

我们来看看每个阶段的示例。

**迁移**  
由于两个原因，许多公司正在将现有的单一应用程序迁移到容器中：

* 降低成本，因为现有硬件的合并和删除，或由于运行的应用程序的密度较高而导致的。
* 开发和操作之间一致的部署协定。

成本降低非常简单。 在 Microsoft，许多现有应用程序正在进行容器化，因此节省了数百万美元的资金。 一致性部署更难评估，但同样重要。 这意味着开发人员可以选择适合自己的技术，但操作只接受用于部署和管理应用程序的单个方法。 它使操作无需处理支持不同技术的复杂性，也不会强制开发人员仅选择特定技术。 实质上，每个应用程序都容器化到自包含的部署映像中。

许多组织止步于这一阶段。 它们已经具有容器的优点，并且 Service Fabric 提供完整的管理体验，包括部署、升级、版本控制、回滚和运行状况监视。

**现代化**  
现代化是将新服务与现有容器化代码一起添加。 如果要编写新代码，最好在微服务路径下少执行一些步骤。 这可能意味着添加新的 REST API 终结点或新的业务逻辑。 这样，便可以开始生成新的微服务，并进行开发和部署。

**创新**  
微服务方法可适应不断变化的业务需求。 在此阶段，你需要决定是要开始将单一应用程序拆分为服务还是进行了创新。 典型的示例是，作为工作流队列使用的数据库将成为处理瓶颈。 随着工作流请求数量不断增加，需要分布工作，以实现缩放。 使应用程序的特定部分不会缩放，或者需要更频繁地进行更新，并将其拆分为微服务和创新。

**将应用程序转换为微服务**  
在此阶段，应用程序完全由（或拆分为）微服务组成。 到现在为止，您已经完成了微服务旅程。 你可以从这里开始，但没有微服务的平台可帮助你需要大量投资。

### <a name="are-microservices-right-for-my-application"></a>微服务适合我的应用程序吗？

也许。 在 Microsoft，随着更多团队开始出于商业原因为云而构建，其中许多团队都认识到了采用类似微服务的方法所带来的好处。 例如，必应使用的是微服务。 微服务方法对于其他团队而言相当新颖。 团队发现需要解决一些疑难问题，但这并非他们的强项。 这就是 Service Fabric 获得用于构建服务的技术的原因。

Service Fabric 的目标是降低构建微服务应用程序的复杂性，使您不必经历太多代价高昂的重新设计工作。 从小规模开始，按需缩放，淘汰旧服务，添加新服务，并随着客户用量的增加而改进。 我们也知道，为了让微服务更易于为大部分开发人员所接受，还有许多其他尚待解决的问题。 容器和执行组件编程模型是该方向上小步骤的示例。 我们肯定会出现更多的革新，使微服务方法更容易。


## <a name="next-steps"></a>后续步骤

* [微服务：由云支持的应用程序变革](https://azure.microsoft.com/blog/microservices-an-application-revolution-powered-by-the-cloud/)
* [Azure 体系结构中心：在 Azure 上构建微服务](https://docs.microsoft.com/azure/architecture/microservices/)
* [Azure Service Fabric 应用程序和群集最佳实践](service-fabric-best-practices-overview.md)
* [Service Fabric 术语概述](service-fabric-technical-overview.md)

[Image1]: media/service-fabric-overview-microservices/monolithic-vs-micro.png
[Image2]: media/service-fabric-overview-microservices/statemonolithic-vs-micro.png
[Image3]: media/service-fabric-overview-microservices/microservices-migration.png
