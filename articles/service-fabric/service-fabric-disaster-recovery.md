---
title: Azure Service Fabric 灾难恢复
description: Azure 服务结构提供了处理灾难的功能。 本文介绍可能发生的灾难类型，以及如何应对这些灾难。
author: masnider
ms.topic: conceptual
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: b29985d40ae3a1bf582099e998e000fed83460f6
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2020
ms.locfileid: "79371641"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a>Azure Service Fabric 中的灾难恢复
提供高可用性的一个关键部分是确保服务能够经受住所有不同类型的故障。 对于计划外且无法控制的故障，这一点尤其重要。 

本文介绍了一些常见的故障模式，如果建模和管理不当，这些模式可能是灾难。 它还讨论了在发生灾难时要采取的缓解措施和操作。 目标是在发生故障（计划还是其他原因）时限制或消除停机或数据丢失的风险。

## <a name="avoiding-disaster"></a>避免灾难
Azure Service Fabric 的主要目标是帮助您对环境和服务建模，使常见故障类型不是灾难。 

通常，有两种类型的灾难/失败方案：
- 硬件和软件故障
- 操作故障

### <a name="hardware-and-software-faults"></a>硬件和软件故障
硬件和软件故障是不可预知的。 生存故障的最简单方法是跨硬件或软件故障边界运行更多的服务副本。 

例如，如果服务仅在一台计算机上运行，则该计算机的故障是该服务的灾难。 避免此灾难的简单方法是确保服务在多台计算机上运行。 测试对于确保一台计算机的故障不会中断正在运行的服务也是必需的。 容量规划可确保可以在其他位置创建替换实例，并且容量减少不会使剩余服务过载。 

无论尝试避免哪种故障，都可以使用这一相同模式。 例如，如果您担心 SAN 的失败，则跨多个 SAN 运行。 如果担心服务器机架丢失，则可跨多个机架运行。 如果您担心数据中心丢失，则服务应跨多个 Azure 区域、多个 Azure 可用性区域或跨您自己的数据中心运行。 

当服务跨越多个物理实例（计算机、机架、数据中心、区域）时，您仍会同时发生故障。 但是，特定类型的单次甚至多次故障（例如，单个虚拟机或网络链路失败）将自动处理，因此不再是"灾难"。 

Service Fabric 提供了扩展群集的机制，并处理将失败的节点和服务带回来。 Service Fabric 还允许运行服务的许多实例，以防止计划外故障变成实际灾难。

运行足够大以跨越故障的部署可能有些原因不可行。 例如，相对于失败的机会，它可能需要的硬件资源可能比您愿意为之付出的要多。 处理分布式应用程序时，跨地理距离的其他通信跃点或状态复制成本可能会导致不可接受的延迟。 具体界限因不同的应用程序而异。 

对于软件故障，故障可能位于您尝试扩展的服务中。 在这种情况下，更多的副本无法预防灾难，因为故障条件在所有实例中都相关。

### <a name="operational-faults"></a>操作故障
即使服务遍布全球且存在许多冗余，仍然可能遇到灾难性事件。 例如，有人可能会意外重新配置服务的 DNS 名称，或将其彻底删除。 

举例来说，假设你有一个有状态 Service Fabric 服务，有人意外删除了该服务。 除非有其他缓解措施，否则该服务及其已有的所有状态现在都消失了。 这些类型的操作灾难（“事故”）需要采取不同于常规计划外故障的缓解措施和步骤才能恢复。 

避免这些类型的操作故障的最佳方法是：
- 限制对环境的操作访问。
- 严格审核危险操作。
- 实施自动化，防止手动或带外更改，并在实施之前针对环境验证特定更改。
- 确保破坏性操作是"软的"。 软操作不会立即生效，或者可以在时间范围内撤消。

Service Fabric 提供了防止操作故障的机制，例如为群集操作提供[基于角色的](service-fabric-cluster-security-roles.md)访问控制。 但是，大多数操作故障都需要组织和其他系统来配合解决。 Service Fabric 确实为幸存的操作故障提供了机制，其中最引人注目的是[状态服务的备份和恢复](service-fabric-backuprestoreservice-quickstart-azurecluster.md)。

## <a name="managing-failures"></a>管理故障
服务结构的目标是自动管理故障。 但是，要处理某些类型的故障，服务必须具有其他代码。 出于安全和业务连续性原因，_不应_自动解决其他类型的故障。 

### <a name="handling-single-failures"></a>处理单个故障
单台计算机可能由于各种原因发生故障。 有时是硬件原因，如电源和网络硬件故障。 其他故障与软件有关。 这些包括操作系统和服务本身的失败。 Service Fabric 可自动检测这些类型的故障，包括计算机由于网络问题而与其他计算机隔离的情况。

无论服务是什么类型，如果代码的单个副本由于任何原因而发生故障，则运行单个实例会导致该服务停机。 

要处理任何单个故障，最简单的方法是确保服务默认在多个节点上运行。 对于无状态服务，请确保`InstanceCount`大于 1。 对于有状态服务，最低建议是 和`TargetReplicaSetSize``MinReplicaSetSize`都设置为 3。 运行服务代码的更多副本可确保服务能够自动处理任何单一故障。 

### <a name="handling-coordinated-failures"></a>处理协调性故障
群集中的协调故障可能是由于计划内或计划外基础结构故障和更改，或计划的软件更改造成的。 Service Fabric 将遇到协调故障的基础结构区域建模为*容错域*。 将经历协调软件更改的区域建模为*升级域*。 有关容错域、升级域和群集拓扑的详细信息，请参阅[使用群集资源管理器描述服务结构群集](service-fabric-cluster-resource-manager-cluster-description.md)。

默认情况下，在规划服务应运行的位置时，Service Fabric 会考虑故障和升级域。 默认情况下，Service Fabric 会尝试确保您的服务跨多个故障运行并升级域，以便在发生计划内或计划外更改时，服务保持可用状态。 

例如，假设电源故障会导致机架上的所有计算机同时发生故障。 在运行多个服务副本时，故障域故障中许多计算机的丢失将变成服务单次故障的另一个示例。 这就是为什么管理故障和升级域对于确保服务的高可用性至关重要。 

在 Azure 中运行服务结构时，将自动管理容错域和升级域。 在其他环境中，它们可能不是。 如果要在本地构建自己的群集，请确保正确映射和规划容错域布局。

升级域可用于同时升级软件的建模区域。 因此，升级域还经常定义在计划升级期间删除软件的边界。 Service Fabric 和服务的升级均遵循相同的模型。 有关滚动升级、升级域和服务交换矩阵运行状况模型的详细信息，这些模型有助于防止意外更改影响群集和服务，请参阅：

 - [应用程序升级](service-fabric-application-upgrade.md)
 - [应用程序升级教程](service-fabric-application-upgrade-tutorial.md)
 - [服务结构运行状况模型](service-fabric-health-introduction.md)

您可以使用[服务结构资源管理器](service-fabric-visualizing-your-cluster.md)中提供的群集映射来可视化群集的布局：

<center>

![Service Fabric Explorer 中分散在容错域之间的节点][sfx-cluster-map]
</center>

> [!NOTE]
> 建模故障区域、滚动升级、运行服务代码和状态的许多实例、确保服务跨故障和升级域运行的放置规则以及内置运行状况监视只是 Service Fabric 为防止正常操作问题和故障演变为灾难而提供的*一些*功能。 
>

### <a name="handling-simultaneous-hardware-or-software-failures"></a>处理同步硬件或软件故障
我们一直在谈论单次失败。 正如您所看到的，只需使更多的代码（和状态）副本跨容和升级域运行，就可以轻松处理无状态和有状态服务。 

也可能发生多个同时随机故障。 这些更有可能导致停机或实际灾难。


#### <a name="stateless-services"></a>无状态服务
无状态服务的实例计数指示需要运行的所需实例数。 当任何（或全部）实例失败时，Service Fabric 会通过在其他节点上自动创建替换实例来响应。 Service Fabric 继续创建替换，直到服务恢复其所需的实例计数。

例如，假设无状态服务的值`InstanceCount`为 -1。 此值表示一个实例应在群集中的每个节点上运行。 如果其中一些实例失败，Service Fabric 将检测到服务未处于所需状态，并将尝试在缺少服务的节点上创建实例。

#### <a name="stateful-services"></a>有状态的服务
有两种类型的有状态服务：
- 状态与持久状态。
- 状态与非持久状态。 （状态存储在内存中。

状态服务故障的恢复取决于有状态服务的类型、服务有多少副本以及有多少副本失败。

在有状态服务中，传入数据在副本（主副本和任何活动辅助副本）之间复制。 如果大多数副本接收数据，则数据将被视为提交*仲裁*。 （对于五个副本，三个副本将是仲裁。这意味着在任何时候，至少有包含最新数据的复制副本的仲裁。 如果副本失败（例如五分之二），我们可以使用仲裁值来计算是否可以恢复。 （由于五个副本中其余三个副本仍然已打开，因此保证至少有一个副本具有完整的数据。

当副本的仲裁失败时，分区将声明为*仲裁丢失*状态。 假设分区有五个副本，这意味着至少有三个副本保证具有完整的数据。 如果副本的仲裁（五分之三）失败，Service Fabric 无法确定剩余的副本（二分之五）是否有足够的数据来还原分区。 在 Service Fabric 检测到仲裁丢失的情况下，其默认行为是防止对分区进行其他写入，声明仲裁丢失，并等待还原副本的仲裁。

确定状态服务是否发生灾难，然后管理它遵循三个阶段：

1. 确定是否存在仲裁损失。
   
   当状态服务的大多数副本同时关闭时，将声明仲裁丢失。
2. 确定仲裁损失是否永久。
   
   大多数情况下，故障是暂时性的。 进程重新启动，节点重新启动，虚拟机重新启动，网络分区修复。 然而，有时失败是永久性的。 故障是否永久取决于状态服务是否保持其状态，或者它是否仅保留在内存中： 
   
   - 对于没有永久性状态的服务，仲裁或多个副本故障会立即导致永久性仲裁丢失__。 Service Fabric 在有状态、非永久性服务中检测到仲裁丢失时，会立即通过声明（潜在的）数据丢失转到步骤 3。 继续数据丢失是有道理的，因为 Service Fabric 知道等待副本回来没有意义。 即使它们恢复，数据也会由于服务的非持久性而丢失。
   - 对于有状态的持久服务，仲裁或更多副本的失败会导致 Service Fabric 等待副本回来并还原仲裁。 这会对服务的受影响分区（或“副本集”）的任何写入造成服务中断__。 但是，在降低一致性保证下，读取可能仍是可能的。 Service Fabric 等待恢复仲裁的默认时间是*无限的*，因为继续是（潜在）数据丢失事件，并会带来其他风险。 这意味着，除非管理员采取措施声明数据丢失，否则 Service Fabric 将不会继续执行下一步。
3. 确定是否丢失数据，并从备份中还原。

   如果法定人数丢失已声明（自动或通过管理操作），则 Service Fabric 和服务将继续确定数据是否实际丢失。 此时，Service Fabric 也知道其他副本不会返回。 这是当我们停止等待仲裁丢失自行解决时所做的决策。 服务采取的最佳做法通常是冻结并等待特定的管理员介入。
   
   当 Service Fabric`OnDataLossAsync`调用 该方法时，总是因为_怀疑_数据丢失。 Service Fabric 可确保将此调用传送到最合适的剩余副本__。 也就是进度最大的副本。 
   
   我们总是说_可疑的_数据丢失的原因是，剩余的副本可能具有与丢失仲裁时的主副本相同的状态。 但是，如果没有该状态作为对比，Service Fabric 或操作者就没有很好的方法来明确这一点。     
   
   那么 `OnDataLossAsync` 方法所执行的典型实现是什么？
   1. 已触发的`OnDataLossAsync`实现日志，并触发任何必要的管理警报。
   1. 通常，实现会暂停并等待进一步决策和手动操作。 这是因为即使备份可用，它们也可能需要准备。 
   
      例如，如果两个不同的服务协调信息，则可能需要修改这些备份，以确保还原发生后，这两个服务所关心的信息是一致的。 
   1. 通常有一些其他遥测或耗尽的服务。 此元数据可能包含在其他服务或日志中。 此信息可以根据需要用于确定在主数据库接收和处理的任何呼叫是否存在备份中或复制到此特定副本。 在还原可行之前，可能需要重播这些调用或添加到备份中。  
   1. 实现将剩余副本的状态与任何可用备份中包含的状态进行比较。 如果您使用的是 Service Fabric 可靠的集合，则有可用于执行此操作[的工具和流程](service-fabric-reliable-services-backup-restore.md)。 目标是查看副本中的状态是否足够，并查看备份可能缺少的内容。
   1. 比较完成后，在还原完成后（如有必要），如果进行了任何状态更改，服务代码应返回**true。** 如果副本确定它是状态的最佳可用副本，并且不进行任何更改，则代码将返回**false**。 
   
      **值为 true**表示_任何其他_剩余的副本现在可能与此副本不一致。 应删除这些副本并根据此副本重新生成。 **false**值表示未进行任何状态更改，因此其他副本可以保留其拥有的内容。 

在将服务部署到生产中之前，服务作者必须练习潜在的数据丢失和失败方案，这一点至关重要。 为了防止数据丢失的可能性，定期将任何有状态服务[的状态备份](service-fabric-reliable-services-backup-restore.md)到异地冗余存储非常重要。 

您还必须确保能够还原状态。 由于许多不同的服务的备份是在不同时间进行的，因此您需要确保在还原后，服务具有彼此一致的视图。 

例如，考虑一个服务生成数字并存储它的情况，然后将其发送到另一个也存储它的服务。 还原后，您可能会发现第二个服务具有编号，但第一个服务没有，因为它的备份不包括该操作。

如果发现剩余的副本不足以在数据丢失方案中继续，并且无法从遥测或排气中重建服务状态，则备份频率决定了最佳恢复点目标 （RPO）。 Service Fabric 提供了许多用于测试各种故障方案的工具，包括需要从备份进行还原的永久仲裁和数据丢失。 这些方案包含在由故障分析服务管理的 Service Fabric 中可测试性工具的一部分。 有关这些工具和模式的详细信息，请参阅[故障分析服务简介](service-fabric-testability-overview.md)。 

> [!NOTE]
> 系统服务也可能遭受仲裁损失。 影响特定于相关服务。 例如，命名服务中的仲裁丢失会影响名称解析，而故障转移管理器 服务中的仲裁丢失会阻止新的服务创建和故障转移。 
> 
> Service Fabric 系统服务遵循与状态管理服务相同的模式，但我们不建议您尝试将它们从仲裁丢失中移出，并进入潜在的数据丢失。 相反，我们建议您[寻求支持](service-fabric-support.md)，以找到针对您情况的解决方案。 通常最好等到向下的副本返回。
>

#### <a name="troubleshooting-quorum-loss"></a>故障排除仲裁损失

副本可能会由于暂时性故障而间歇性地关闭。 等待一段时间，因为服务结构试图提出他们。 如果副本已关闭超过预期持续时间，请按照以下故障排除操作操作操作：
- 副本可能正在崩溃。 检查副本级运行状况报告和应用程序日志。 收集崩溃转储并采取必要的措施进行恢复。
- 副本进程可能已无响应。 检查应用程序日志以验证此。 收集进程转储，然后停止无响应的进程。 Service Fabric 将创建一个替换过程，并尝试将副本带回来。
- 承载副本的节点可能已关闭。 重新启动基础虚拟机以启动节点。

有时，可能无法恢复副本。 例如，驱动器出现故障或计算机实际未响应。 在这些情况下，需要告诉 Service Fabric 不要等待副本恢复。

如果潜在的数据丢失是不可接受的，*请勿*使用这些方法使服务联机。 在这种情况下，应全力回收物理机器。

以下操作可能会导致数据丢失。 在跟随它们之前，请检查它们。
   
> [!NOTE]
> 使用这些方法_从来都不是_安全的，除了针对特定分区的定向方式。 
>

- 使用`Repair-ServiceFabricPartition -PartitionId`或`System.Fabric.FabricClient.ClusterManagementClient.RecoverPartitionAsync(Guid partitionId)`API。 此 API 允许指定分区的 ID 以摆脱仲裁损失并进入潜在的数据丢失。
- 如果您的群集经常遇到导致服务进入仲裁丢失状态的故障，并且可能_丢失数据是可以接受的_，则指定适当的[仲裁LossWaitDuration值](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps)可以帮助您的服务自动恢复。 服务结构将等待提供`QuorumLossWaitDuration`的值（默认为无限），然后再执行恢复。 *我们不*推荐此方法，因为它可能会导致意外的数据丢失。

## <a name="availability-of-the-service-fabric-cluster"></a>Service Fabric 群集的可用性
通常，Service Fabric 群集是一个高度分布式的环境，没有单点故障。 任何一个节点的故障不会导致群集的可用性或可靠性问题，这主要是因为 Service Fabric 系统服务遵循了前面提供的相同准则。 也就是说，默认情况下，它们始终使用三个或更多副本运行，并且系统服务在所有节点上运行无状态。 

基础 Service Fabric 网络和故障检测层是完全分布式层。 大多数系统服务可以根据群集中的元数据重新生成，或者知道如何从其他位置重新同步其状态。 如果系统服务进入仲裁丢失情况，如前面所述的情况，群集的可用性可能会受到影响。 在这些情况下，可能无法对群集执行某些操作（如启动升级或部署新服务），但群集本身仍处于打开。 

正在运行的群集上的服务将在这些条件下继续运行，除非它们需要写入系统服务才能继续运行。 例如，如果故障转移管理器处于仲裁丢失状态，则所有服务将继续运行。 但是，任何失败的服务都无法自动重新启动，因为这需要故障转移管理器的参与。 

### <a name="failures-of-a-datacenter-or-an-azure-region"></a>数据中心或 Azure 区域的失败
在极少数情况下，物理数据中心可能会因断电或网络连接中断而暂时不可用。 在这些情况下，Service Fabric 群集和该数据中心或 Azure 区域中的服务不可用。 但会保留你的数据__。 

对于在 Azure 中运行的群集，可以在 [Azure 状态页][azure-status-dashboard]上查看有关中断的最新信息。 如果物理数据中心被部分或完全销毁，则托管在那里的任何 Service Fabric 群集或其中的服务可能会丢失。 此丢失包括未在该数据中心或区域外部备份的任何状态。

在单个数据中心或区域的永久或持续故障中生存有两种不同的策略： 

- 在多个这样的区域中运行单独的 Service Fabric 群集，并使用某些机制在这些环境之间进行故障转移和故障转移。 这种多群集主动/主动或主动/被动模型需要额外的管理和操作代码。 此模型还需要协调来自一个数据中心或区域中的服务的备份，以便在发生故障时在其他数据中心或区域中提供备份。 
- 运行跨多个数据中心或区域的单个 Service Fabric 群集。 此策略受支持的最小配置是三个数据中心或区域。 建议的区域或数据中心数量为 5。 
  
  此模型需要更复杂的群集拓扑。 但是，好处是一个数据中心或区域的故障从灾难转换为正常故障。 可通过适用于单个区域内群集的机制来处理这些故障。 故障域、升级域和服务交换矩阵放置规则可确保分发工作负载，以便它们能够容忍正常故障。 
  
  有关可帮助在此类群集中操作服务的策略的详细信息，请参阅[服务交换矩阵服务的放置策略](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md)。

### <a name="random-failures-that-lead-to-cluster-failures"></a>导致群集故障的随机故障
服务结构具有*种子节点*的概念。 种子节点可以维护基础群集的可用性。 

种子节点通过与其他节点建立租约并在某些类型的故障期间充当绑定中断器，有助于确保群集保持保持状态。 如果随机故障删除了群集中的大部分种子节点，并且它们未快速恢复，则群集将自动关闭。 群集然后失败。 

在 Azure 中，服务结构资源提供程序管理服务结构群集配置。 默认情况下，资源提供程序在*主节点类型的*故障和升级域之间分发种子节点。 如果主节点类型标记为 Silver 或 Gold 持久性，则当您删除种子节点（通过在主节点类型中缩放或手动删除它），群集将尝试从主节点类型的可用容量升级另一个非种子节点。 如果可用容量低于主节点类型所需的群集可靠性级别，则此尝试将失败。

在独立的 Service Fabric 群集和 Azure 中，主节点类型是运行种子的节点类型。 定义主节点类型时，Service Fabric 将自动利用每个系统服务的最多 9 个种子节点和 7 个副本提供的节点数。 如果一组随机故障同时获取了这些副本中的大多数，则系统服务将进入仲裁丢失。 如果大部分种子节点丢失，群集将在不久之后关闭。

## <a name="next-steps"></a>后续步骤
- 了解如何使用[可测试性框架](service-fabric-testability-overview.md)模拟各种故障。
- 阅读有关灾难恢复和高可用性的其他资源。 Microsoft 已发布大量有关这些主题的指导。 尽管其中一些资源是指用于其他产品的特定技术，但它们包含许多可在 Service Fabric 上下文中应用的一般最佳实践：
  - [可用性检查表](/azure/architecture/checklist/resiliency-per-service)
  - [执行灾难恢复演练](../sql-database/sql-database-disaster-recovery-drills.md)
  - [Azure 应用程序的灾难恢复和高可用性][dr-ha-guide]
- 了解 [Service Fabric 支持选项](service-fabric-support.md)。


<!-- External links -->

[repair-partition-ps]: https://msdn.microsoft.com/library/mt163522.aspx
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: https://msdn.microsoft.com/library/azure/dn251004.aspx


<!-- Images -->

[sfx-cluster-map]: ./media/service-fabric-disaster-recovery/sfx-clustermap.png
