---
title: Azure Service Fabric 灾难恢复
description: Azure Service Fabric 提供处理灾难的功能。 本文介绍可能发生的灾难类型，以及如何应对这些灾难。
author: masnider
ms.topic: conceptual
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: b29985d40ae3a1bf582099e998e000fed83460f6
ms.sourcegitcommit: 512d4d56660f37d5d4c896b2e9666ddcdbaf0c35
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/14/2020
ms.locfileid: "79371641"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a>Azure Service Fabric 中的灾难恢复
提供高可用性的关键部分是确保服务能够经受各种不同类型的故障。 这对于非计划外和不受控制的故障尤其重要。 

本文介绍了一些常见的故障模式，如果未正确建模和管理，则可能会出现灾难。 还介绍了在发生灾难时应采取的缓解措施和操作。 目标是在发生故障时，限制或消除停机或数据丢失的风险。

## <a name="avoiding-disaster"></a>避免灾难
Azure Service Fabric 的主要目标是帮助你以常见故障类型不是灾难的方式为你的环境和服务建模。 

通常，有两种类型的灾难/故障方案：
- 硬件和软件故障
- 操作故障

### <a name="hardware-and-software-faults"></a>硬件和软件故障
硬件和软件故障是不可预知的。 出现故障的最简单方法是跨硬件或软件故障边界运行服务的更多副本。 

例如，如果服务仅在一台计算机上运行，则该计算机的故障是该服务的灾难。 避免此灾难的简单方法是确保服务在多台计算机上运行。 还需要进行测试，以确保一台计算机的故障不会中断正在运行的服务。 容量规划确保可以在其他位置创建替换实例，并且容量减少不会重载剩余的服务。 

无论尝试避免哪种故障，都可以使用这一相同模式。 例如，如果您担心 SAN 发生故障，则可以跨多个 San 运行。 如果担心服务器机架丢失，则可跨多个机架运行。 如果担心数据中心丢失，服务应跨多个 Azure 区域、跨多个 Azure 可用性区域或跨你自己的数据中心运行。 

当服务跨多个物理实例（计算机、机架、数据中心和区域）时，仍然需要执行某些类型的并发故障。 但会自动处理特定类型的单个甚至多个故障（例如单个虚拟机或网络链接故障），因而不再是 "灾难"。 

Service Fabric 提供了用于扩展群集的机制，并处理故障节点和服务的恢复。 Service Fabric 还允许运行多个服务实例，以防止计划外故障变成真实灾难。

可能存在这样的情况，即运行部署大到足以跨越故障的原因是不切实际的。 例如，它可能需要更多的硬件资源，而不愿意支付相关的故障。 在处理分布式应用程序时，跨地理距离的其他通信跃点或状态复制成本可能导致不可接受的延迟。 具体界限因不同的应用程序而异。 

具体而言，对于软件故障，故障可能发生在尝试缩放的服务中。 在这种情况下，多个副本不能防止灾难发生，因为故障条件与所有实例相关。

### <a name="operational-faults"></a>操作故障
即使服务遍布全球且存在许多冗余，仍然可能遇到灾难性事件。 例如，某人可能会意外地重新配置服务的 DNS 名称，或将其完全删除。 

举例来说，假设你有一个有状态 Service Fabric 服务，有人意外删除了该服务。 除非有其他的缓解措施，否则该服务及其所有状态现在均已消失。 这些类型的操作灾难（“事故”）需要采取不同于常规计划外故障的缓解措施和步骤才能恢复。 

避免这些类型的操作故障的最佳方法是：
- 限制对环境的操作访问。
- 严格审核危险操作。
- 实施自动化、防止手动或带外更改，并在制定之前验证针对环境的特定更改。
- 确保破坏性操作为 "软"。 软操作不会立即生效，也不能在某个时间范围内撤消。

Service Fabric 提供阻止操作故障的机制，如为群集操作提供[基于角色的](service-fabric-cluster-security-roles.md)访问控制。 但是，大多数操作故障都需要组织和其他系统来配合解决。 Service Fabric 提供了一些机制来解决操作故障，最值得注意[的是有状态服务的备份和还原](service-fabric-backuprestoreservice-quickstart-azurecluster.md)。

## <a name="managing-failures"></a>管理故障
Service Fabric 的目标是自动管理故障。 但是，若要处理某些类型的故障，服务必须具有其他代码。 出于安全性和业务连续性方面的考虑，_不_应自动处理其他类型的故障。 

### <a name="handling-single-failures"></a>处理单个故障
单台计算机可能由于各种原因发生故障。 有时会出现硬件问题，例如电源和网络硬件故障。 其他故障与软件有关。 这包括操作系统和服务本身的故障。 Service Fabric 会自动检测这些类型的故障，包括由于网络问题而导致计算机与其他计算机相隔离的情况。

无论服务是什么类型，如果代码的单个副本由于任何原因而发生故障，则运行单个实例会导致该服务停机。 

若要处理任何单一故障，可执行的最简单操作是确保服务默认在多个节点上运行。 对于无状态服务，请确保 `InstanceCount` 大于1。 对于有状态服务，最低建议是将 `TargetReplicaSetSize` 和 `MinReplicaSetSize` 均设置为3。 运行服务代码的更多副本可确保服务能够自动处理任何单一故障。 

### <a name="handling-coordinated-failures"></a>处理协调性故障
群集中的协调故障可能是由于计划内或计划外基础结构故障和更改或计划的软件更改引起的。 Service Fabric 将遇到协调故障的基础结构区域建模为*容错域*。 将遇到协调软件更改的区域将建模为*升级域*。 有关容错域、升级域和群集拓扑的详细信息，请参阅[使用群集资源管理器描述 Service Fabric 群集](service-fabric-cluster-resource-manager-cluster-description.md)。

默认情况下，在规划服务应该运行的位置时，Service Fabric 会考虑容错域和升级域。 默认情况下，Service Fabric 会尝试确保服务跨多个容错域和升级域运行，以便在发生计划内或计划外更改时，服务仍然可用。 

例如，假设电源故障导致机架上的所有计算机同时发生故障。 使用服务的多个副本运行时，容错域故障中的多台计算机的损失就变成了一个服务出现单一故障的另一个示例。 这就是管理容错域和升级域的原因，这是确保服务高可用性的关键所在。 

在 Azure 中运行 Service Fabric 时，会自动管理容错域和升级域。 在其他环境中，它们可能不是。 如果要在本地生成自己的群集，请务必正确映射和规划容错域布局。

升级域可用于对软件同时升级的区域进行建模。 因此，升级域还经常定义在计划的升级过程中软件被关闭的边界。 Service Fabric 和服务的升级均遵循相同的模型。 若要深入了解滚动升级、升级域以及可帮助防止意外更改影响群集和服务的 Service Fabric 运行状况模型，请参阅：

 - [应用程序升级](service-fabric-application-upgrade.md)
 - [应用程序升级教程](service-fabric-application-upgrade-tutorial.md)
 - [Service Fabric 运行状况模型](service-fabric-health-introduction.md)

可以使用[Service Fabric Explorer](service-fabric-visualizing-your-cluster.md)中提供的群集映射来可视化群集布局：

<center>

![在 Service Fabric Explorer][sfx-cluster-map]
中跨容错域分布的节点 </center>

> [!NOTE]
> 建模故障区域、滚动升级、运行服务代码和状态的多个实例、放置规则以确保服务跨容错域和升级域运行，以及内置运行状况监视只是 Service Fabric 提供的*一些*功能，使正常操作问题和故障变成灾难。 
>

### <a name="handling-simultaneous-hardware-or-software-failures"></a>处理同步硬件或软件故障
我们已经谈论了单一故障。 如您所见，只需保留跨容错域和升级域运行的代码（和状态）的副本，即可轻松处理无状态服务和有状态服务。 

也可能发生多个同时随机故障。 这更有可能导致停机或发生实际的灾难。


#### <a name="stateless-services"></a>无状态服务
无状态服务的实例计数指示需要运行的所需实例数。 当任何（或全部）实例失败时，Service Fabric 会通过在其他节点上自动创建替换实例来做出响应。 Service Fabric 继续创建替换项，直至服务恢复到所需的实例计数。

例如，假设无状态服务的 `InstanceCount` 值为-1。 此值表示一个实例应该在群集中的每个节点上运行。 如果其中一些实例发生故障，Service Fabric 将检测该服务是否未处于所需状态，并且将尝试在缺少的节点上创建实例。

#### <a name="stateful-services"></a>有状态服务
有两种类型的有状态服务：
- 具有持久状态的状态。
- 具有非持久化状态的有状态。 （状态存储在内存中。）

从有状态服务的故障中恢复取决于有状态服务的类型、服务拥有的副本数以及多少副本失败。

在有状态服务中，将在副本（主副本和任何活动辅助数据库）之间复制传入数据。 如果大多数副本接收数据，则会将数据视为已提交*仲裁*。 （对于5个副本，三个都是仲裁。）这意味着，在任何时候，都将至少有包含最新数据的副本的仲裁。 如果副本失败（例如，其中的两个），我们可以使用仲裁值计算是否可以恢复。 （由于5个副本中的其余三个副本仍在运行，因此保证至少一个副本具有完整的数据。）

当副本的仲裁失败时，该分区将声明为处于*仲裁丢失*状态。 假设一个分区有5个副本，这意味着至少有三个副本具有完整的数据。 如果某个仲裁（三个输出五个）的副本出现故障，Service Fabric 无法确定剩余副本（两个输出数据）是否有足够的数据来还原分区。 在 Service Fabric 检测到仲裁丢失的情况下，其默认行为是阻止额外写入分区、声明仲裁丢失并等待恢复副本的仲裁。

确定有状态服务是否发生灾难，然后管理它的步骤分为三个阶段：

1. 确定是否存在仲裁丢失。
   
   当有状态服务的大多数副本同时关闭时，会声明仲裁丢失。
2. 确定仲裁丢失是否是永久性的。
   
   大多数情况下，故障是暂时性的。 重新启动了进程，重新启动了节点，虚拟机变，并修复了网络分区。 但有时，故障是永久性的。 故障是否是永久性的取决于有状态服务是否保持其状态，或者是否将其仅保存在内存中： 
   
   - 对于没有永久性状态的服务，仲裁或多个副本故障会立即导致永久性仲裁丢失。 Service Fabric 在有状态、非永久性服务中检测到仲裁丢失时，会立即通过声明（潜在的）数据丢失转到步骤 3。 继续数据丢失很有意义，因为 Service Fabric 知道在等待副本恢复没有任何意义。 即使恢复，数据也将丢失，因为服务的非持久化性质。
   - 对于有状态持久性服务，仲裁或更多副本的故障会导致 Service Fabric 等待副本恢复并还原仲裁。 这会对服务的受影响分区（或“副本集”）的任何写入造成服务中断。 但是，仍然可以通过降低一致性保证来进行读取。 Service Fabric 等待仲裁恢复的默认时间量是*无限*的，因为继续操作是（潜在的）数据丢失事件，并承担其他风险。 这意味着，除非管理员采取操作来声明数据丢失，否则 Service Fabric 不会继续执行下一步。
3. 确定数据是否丢失，以及是否从备份还原。

   如果已声明仲裁丢失（自动或通过管理操作），Service Fabric 和服务将继续确定数据是否确实丢失。 此时，Service Fabric 还知道其他副本不会返回。 这是当我们停止等待仲裁丢失自行解决时所做的决策。 服务采取的最佳做法通常是冻结并等待特定的管理员介入。
   
   当 Service Fabric 调用 `OnDataLossAsync` 方法时，这始终是因为_可疑_的数据丢失。 Service Fabric 可确保将此调用传送到最合适的剩余副本。 也就是进度最大的副本。 
   
   我们始终认为_可疑_数据丢失的原因是，在仲裁丢失时，剩余副本的状态可能与主副本的状态完全相同。 但是，如果没有该状态作为对比，Service Fabric 或操作者就没有很好的方法来明确这一点。     
   
   那么 `OnDataLossAsync` 方法所执行的典型实现是什么？
   1. 已触发 `OnDataLossAsync` 的实现日志，并触发任何必要的管理警报。
   1. 通常，实现会暂停，并等待进一步的决策和手动操作。 这是因为即使备份可用，也可能需要做好准备。 
   
      例如，如果两个不同的服务协调信息，则可能需要修改这些备份，以确保在执行还原操作之后，这两个服务所关注的信息一致。 
   1. 通常还有一些其他遥测或服务排出。 此元数据可能包含在其他服务或日志中。 此信息可根据需要使用，以确定主副本上是否接收并处理了任何调用，或未将其复制到此特定副本。 在还原可行之前，这些调用可能需要重播或添加到备份中。  
   1. 实现将剩余副本的状态与包含在任何可用备份中的状态进行比较。 如果使用的是 Service Fabric 可靠的集合，则可以使用[工具和过程](service-fabric-reliable-services-backup-restore.md)来执行此操作。 目标是查看副本中的状态是否足够，并查看备份可能丢失的内容。
   1. 完成比较后以及还原完成后（如有必要），如果进行了任何状态更改，则服务代码应返回**true** 。 如果副本确定它是该状态的最佳可用副本，并且未进行任何更改，则代码将返回**false**。 
   
      值为**true**表示任何_其他_剩余副本现在可能与此副本不一致。 应删除这些副本并根据此副本重新生成。 如果值为**false** ，则表示未进行任何状态更改，因此其他副本可以保留其内容。 

在生产环境中部署服务之前，服务创作者对潜在的数据丢失和故障方案进行实践至关重要。 若要防止数据丢失的可能性，请务必定期将任何有状态服务的[状态备份](service-fabric-reliable-services-backup-restore.md)到异地冗余存储中。 

还必须确保能够还原状态。 由于许多不同服务的备份是在不同时间进行的，因此，您需要确保在还原后，您的服务具有一致的视图。 

例如，假设有一个服务生成一个数字并存储它，然后将其发送到另一个也存储它的服务。 还原后，你可能会发现第二个服务的数量为，但第一个服务没有，因为其备份未包含该操作。

如果发现剩余副本不足以在丢失数据的情况下继续工作，并且无法从遥测或排出重新构建服务状态，则备份频率决定了可能的最佳恢复点目标（RPO）。 Service Fabric 提供了许多工具用于测试各种故障方案，包括需要从备份还原的永久性仲裁和数据丢失。 这些方案包含为 Service Fabric 中的可测试性工具的一部分，由故障分析服务管理。 有关这些工具和模式的详细信息，请参阅[故障分析服务简介](service-fabric-testability-overview.md)。 

> [!NOTE]
> 系统服务也会受到仲裁丢失的影响。 此影响特定于所涉及的服务。 例如，命名服务的仲裁丢失会影响名称解析，而故障转移管理器服务中的仲裁丢失会阻止新的服务创建和故障转移。 
> 
> Service Fabric 系统服务遵循的模式与状态管理服务的模式相同，但我们不建议您尝试将它们移出仲裁丢失和可能的数据丢失。 相反，我们建议你查找[支持](service-fabric-support.md)以查找针对你的情况的解决方案。 通常，只需等到关闭副本返回即可。
>

#### <a name="troubleshooting-quorum-loss"></a>仲裁丢失疑难解答

由于暂时性故障，副本可能会间歇停机。 等待一段时间，Service Fabric 尝试使其启动。 如果副本的运行时间超过预期持续时间，请遵循以下故障排除操作：
- 副本可能会崩溃。 检查副本级别运行状况报告和应用程序日志。 收集故障转储并采取必要的措施进行恢复。
- 副本进程可能已停止响应。 检查应用程序日志以验证这一点。 收集进程转储，然后停止无响应的进程。 Service Fabric 将创建一个替换进程，并将尝试恢复副本。
- 承载副本的节点可能已关闭。 重新启动基础虚拟机以使节点启动。

有时，可能无法恢复副本。 例如，驱动器出现故障或计算机物理上没有响应。 在这些情况下，需要告知 Service Fabric 不等待副本恢复。

如果使服务处于联机状态，则*不能*使用这些方法。 在这种情况下，应尽力恢复物理计算机。

以下操作可能导致数据丢失。 在追随它们之前进行检查。
   
> [!NOTE]
> 对于特定的分区，使用这些方法的方法_不_是有针对性的方法。 
>

- 使用 `Repair-ServiceFabricPartition -PartitionId` 或 `System.Fabric.FabricClient.ClusterManagementClient.RecoverPartitionAsync(Guid partitionId)` API。 此 API 允许指定要移出仲裁丢失和可能丢失数据的分区的 ID。
- 如果你的群集遇到导致服务进入仲裁丢失状态的频繁故障，而且可能会_丢失数据，则_指定适当的[QuorumLossWaitDuration](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps)值可帮助你的服务自动恢复。 在执行恢复之前，Service Fabric 将等待提供的 `QuorumLossWaitDuration` 值（默认为无限）。 *不*建议采用此方法，因为这可能会导致意外的数据丢失。

## <a name="availability-of-the-service-fabric-cluster"></a>Service Fabric 群集的可用性
一般情况下，Service Fabric 群集是高度分布式环境，没有单点故障。 任何一个节点发生故障不会导致群集的可用性或可靠性问题，主要是因为 Service Fabric 系统服务遵循前面提供的相同准则。 也就是说，默认情况下，它们始终使用三个或更多个副本运行，并且在所有节点上运行无状态的系统服务。 

基础 Service Fabric 网络和故障检测层是完全分布式层。 大多数系统服务可以根据群集中的元数据重新生成，或者知道如何从其他位置重新同步其状态。 如果系统服务遇到仲裁丢失情况（如前面所述），则群集的可用性可能会受到威胁。 在这些情况下，你可能无法在群集上执行某些操作（例如启动升级或部署新服务），但群集本身仍处于启动状态。 

正在运行的群集上的服务将继续运行，除非它们要求写入系统服务才能继续运行。 例如，如果故障转移管理器处于仲裁丢失中，则所有服务将继续运行。 但失败的任何服务无法自动重启，因为这需要故障转移管理器的参与。 

### <a name="failures-of-a-datacenter-or-an-azure-region"></a>数据中心或 Azure 区域的故障
在极少数情况下，物理数据中心可能会由于电源或网络连接中断而暂时不可用。 在这些情况下，Service Fabric 群集和该数据中心或 Azure 区域中的服务不可用。 但会保留你的数据。 

对于在 Azure 中运行的群集，可以在[azure 状态页][azure-status-dashboard]上查看有关中断的更新。 在极少数情况下，物理数据中心部分或全部被销毁，主机上托管的任何 Service Fabric 群集或其中的服务可能会丢失。 此损失包括未在该数据中心或区域外部备份的任何状态。

存在两种不同的策略，可使单个数据中心或区域出现永久性故障或持续故障： 

- 在多个此类区域中运行单独的 Service Fabric 群集，并使用某种机制在这些环境之间进行故障转移和故障回复。 这种多群集主动/主动或主动/被动模型需要额外的管理和操作代码。 此模型还需要协调来自一个数据中心或区域中服务的备份，以便在其他数据中心或区域发生故障时可以使用它们。 
- 运行跨多个数据中心或区域的单个 Service Fabric 群集。 此策略支持的最低配置为三个数据中心或区域。 建议的区域或数据中心数量为 5。 
  
  此模型需要更复杂的群集拓扑。 但优点在于，一个数据中心或区域的故障将从灾难转换为正常故障。 可通过适用于单个区域内群集的机制来处理这些故障。 容错域、升级域和 Service Fabric 放置规则可确保分配工作负荷，使其能够承受正常故障。 
  
  有关有助于在此类群集中运行服务的策略的详细信息，请参阅[Service Fabric 服务的放置策略](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md)。

### <a name="random-failures-that-lead-to-cluster-failures"></a>导致群集故障的随机故障
Service Fabric 具有*种子节点*的概念。 种子节点可以维护基础群集的可用性。 

种子节点通过与其他节点建立租约并在某些类型的故障期间提供决胜属性来帮助确保群集正常运行。 如果随机故障删除了群集中的大部分种子节点，并且它们没有快速恢复，则群集会自动关闭。 群集随后会失败。 

在 Azure 中，Service Fabric 资源提供程序管理 Service Fabric 群集配置。 默认情况下，资源提供程序在*主节点类型*的容错域和升级域之间分配种子节点。 如果主节点类型被标记为 "白银" 或 "黄金" 持续性，则在删除种子节点（通过在主节点类型中缩放或手动删除该节点）时，群集将尝试从主节点类型的可用容量升级另一个非种子节点。 如果你的可用容量低于你的主节点类型所需的群集可靠性级别，此尝试将失败。

在独立 Service Fabric 群集和 Azure 中，主节点类型是运行种子的节点类型。 定义主节点类型时，Service Fabric 会自动利用提供的节点数，最多可创建9个种子节点和每个系统服务的7个副本。 如果一组随机故障同时使用这些副本中的大部分，则系统服务将进入仲裁丢失。 如果大部分种子节点丢失，群集将在不久之后关闭。

## <a name="next-steps"></a>后续步骤
- 了解如何使用可[测试性框架](service-fabric-testability-overview.md)模拟各种故障。
- 阅读有关灾难恢复和高可用性的其他资源。 Microsoft 已发布大量有关这些主题的指导。 尽管其中一些资源是指在其他产品中使用的特定技术，但它们包含了可在 Service Fabric 上下文中应用的许多一般最佳实践：
  - [可用性清单](/azure/architecture/checklist/resiliency-per-service)
  - [执行灾难恢复演练](../sql-database/sql-database-disaster-recovery-drills.md)
  - [Azure 应用程序的灾难恢复和高可用性][dr-ha-guide]
- 了解 [Service Fabric 支持选项](service-fabric-support.md)。


<!-- External links -->

[repair-partition-ps]: https://msdn.microsoft.com/library/mt163522.aspx
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: https://msdn.microsoft.com/library/azure/dn251004.aspx


<!-- Images -->

[sfx-cluster-map]: ./media/service-fabric-disaster-recovery/sfx-clustermap.png
