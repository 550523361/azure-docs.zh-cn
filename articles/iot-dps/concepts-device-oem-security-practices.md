---
title: 制造商的安全实践-Azure IoT 设备预配服务
description: 概述准备设备注册到 Azure IoT 设备预配服务（DPS）的 Oem 和设备制造商的常见安全做法。
author: timlt
ms.author: timlt
ms.date: 3/02/2020
ms.topic: conceptual
ms.service: iot-dps
ms.custom: iot-p0-scenario, iot-devices-deviceOEM
ms.reviewer: nberdy
ms.openlocfilehash: 3854f353e4ea0b78c0162681e0b89d37419105d8
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2020
ms.locfileid: "80529526"
---
# <a name="security-practices-for-azure-iot-device-manufacturers"></a>Azure IoT 设备制造商的安全实践
随着更多的制造商发布 IoT 设备，识别有关常见做法的指导会很有帮助。 本文总结了使用 Azure IoT 设备预配服务（DPS）制造设备时要考虑的建议安全做法。  

> [!div class="checklist"]
> * 选择设备身份验证选项
> * 在 IoT 设备上安装证书
> * 将受信任的平台模块（TPM）集成到制造过程中

## <a name="selecting-device-authentication-options"></a>选择设备身份验证选项
任何 IoT 设备安全措施的终极目标是创建安全的 IoT 解决方案。 但问题（如硬件限制、成本和安全专业水平）会影响选择的选项。 此外，安全的安全方法会影响 IoT 设备连接到云的方式。 尽管需要考虑[IoT 安全的几个元素](https://www.microsoft.com/research/publication/seven-properties-highly-secure-devices/)，但每个客户遇到的一个关键元素是使用哪种身份验证类型。 

三种广泛使用的身份验证类型为 x.509 证书、受信任的平台模块（TPM）和对称密钥。 虽然存在其他身份验证类型，但在 Azure IoT 上构建解决方案的大多数客户都使用这三种类型中的一种。 本文的其余部分将介绍使用每种身份验证类型的优点和缺点。

### <a name="x509-certificate"></a>X.509 证书
X.509 证书是一种可用于身份验证的数字标识。 X.509 证书标准在[IETF RFC 5280](https://tools.ietf.org/html/rfc5280)中进行了介绍。 在 Azure IoT 中，可以通过两种方式对证书进行身份验证：
- 指纹. 指纹算法在证书上运行以生成十六进制字符串。 生成的字符串是证书的唯一标识符。 
- 基于完整链的 CA 身份验证。 证书链是对最终实体（EE）证书进行身份验证所需的所有证书的层次结构列表。 若要对 EE 证书进行身份验证，需要对证书链中的每个证书进行身份验证，包括受信任的根 CA。 

X.509 的专业人员：
- X.509 是 Azure IoT 中支持的最安全的身份验证类型。
- X.509 允许使用高级控制来实现证书管理。
- 许多供应商提供了基于 x.509 的身份验证解决方案。

X.509 的缺点：
- 许多客户可能需要依赖于其证书的外部供应商。
- 证书管理的成本可能很高，并且会增加解决方案的总体成本。
- 如果物流没有太好的考虑，证书生命周期管理可能会很困难。 

### <a name="trusted-platform-module-tpm"></a>受信任的平台模块 (TPM)
TPM 也称为[ISO/IEC 11889](https://www.iso.org/standard/66510.html)，是一种安全地生成和存储加密密钥的标准。 TPM 还引用了与实现标准的模块交互的虚拟或物理 i/o 设备。 TPM 设备可以作为离散硬件、集成硬件、基于固件的模块或基于软件的模块存在。 

Tpm 和对称密钥之间有两个重要区别： 
- TPM 芯片还可以存储 x.509 证书。
- DPS 中的 TPM 证明使用 TPM 认可密钥（EK），这种形式的非对称身份验证。 如果使用非对称身份验证，则使用公钥进行加密，并使用单独的私钥进行解密。 相反，对称密钥使用对称身份验证，其中私钥用于加密和解密。 

适用于 TPM 的专业：
- Tpm 作为标准硬件包含在许多 Windows 设备上，内置了对操作系统的支持。 
- TPM 证明比基于共享访问签名（SAS）令牌的对称密钥证明更易于保护。
- 你可以轻松地过期并续订或回滚设备凭据。 每当 TPM 设备重新设置时，DPS 会自动滚动 IoT 中心凭据。

TPM 的缺点： 
- Tpm 是很复杂的，可能很难使用。 
- 使用 Tpm 的应用程序开发非常困难，除非你具有物理 TPM 或质量模拟器。
- 你可能需要重新设计设备的板以在硬件中包含 TPM。 
- 如果在 TPM 上滚动 EK，则会销毁 TPM 的标识并创建一个新的。 尽管物理芯片保持不变，但它在 IoT 解决方案中具有新的标识。

### <a name="symmetric-key"></a>对称密钥
使用对称密钥时，将使用相同的密钥来加密和解密消息。 因此，对设备和对其进行身份验证的服务都知道相同的密钥。 Azure IoT 支持基于 SAS 令牌的对称密钥连接。 对称密钥身份验证要求有重要的所有者责任来保护密钥，并使用 x.509 authentication 实现同等的安全级别。 如果使用对称密钥，建议的做法是使用硬件安全模块（HSM）来保护密钥。

对称密钥的优点：
- 使用对称密钥是开始身份验证的最简单、最低的成本方式。
- 使用对称密钥可简化进程，因为无需生成任何内容。 

对称密钥的缺点： 
- 对称密钥需要大量精力来保护密钥。 同一密钥在设备和云之间共享，这意味着必须在两个位置保护密钥。 与此相反，TPM 和 x.509 证书的挑战是证明公钥的所有权，而不会泄露私钥。
- 利用对称密钥，可以轻松地遵循不良的安全做法。 对称密钥的常见趋势是在设备上对未加密的密钥进行硬编码。 虽然这种做法很方便，但它会使密钥容易受到攻击。 可以通过安全地将对称密钥存储在设备上来缓解某些风险。 但是，如果你的优先级最终是安全性而不是便利，请使用 x.509 证书或 TPM 进行身份验证。 

### <a name="shared-symmetric-key"></a>共享对称密钥
存在一种称为共享对称密钥的对称密钥身份验证的变化形式。 此方法涉及到在所有设备中使用相同的对称密钥。 建议避免在设备上使用共享对称密钥。 

共享对称密钥的 Pro：
- 规模简单，实现规模的成本更低。 

共享对称密钥的缺点： 
- 很容易受到攻击。 轻松实现的好处是有点的风险。 
- 如果设备获取共享密钥，则任何人都可以模拟设备。
- 如果依赖于受攻击的共享对称密钥，可能会失去设备控制。 

### <a name="making-the-right-choice-for-your-devices"></a>为设备做出正确的选择
若要选择一种身份验证方法，请务必考虑每种方法在独特制造过程中的好处和成本。  对于设备身份验证，在给定方法的安全程度和使用方式之间，通常有一种逆的关系。  

## <a name="installing-certificates-on-iot-devices"></a>在 IoT 设备上安装证书
如果使用 x.509 证书对 IoT 设备进行身份验证，本部分将提供有关如何将证书集成到制造过程的指导。 需要做出几项决策。  其中包括有关常见证书变量、何时生成证书以及何时安装的决策。 

如果你使用的是密码，则可能会询问你为何无法在所有设备中使用相同的证书，其方式与你在所有设备中使用相同的密码相同。 首先，在任何地方使用同一密码都是危险的。 该练习已向公司公开了重大 DDoS 攻击，其中包括几年前在美国东部海岸发生 DNS 的情况。 请勿在任何位置使用相同的密码，即使使用个人帐户也是如此。 其次，证书不是密码，而是唯一标识。 密码类似于机密代码，任何人都可以使用它来打开安全大楼的门。  这是你知道的东西，你可以为任何人指定密码以获得进入权限。  证书类似于驾照，附带你的照片和其他详细信息，你可以将其显示给一种保护，使其进入受保护的大楼。 它与你的身份关联。  如果该防护能准确地将用户与驱动程序的许可证匹配，则只能使用您的许可证（标识）来获取进入。 

### <a name="variables-involved-in-certificate-decisions"></a>证书决策中涉及的变量
请考虑以下变量，以及每个变量如何影响总体制造流程。 

#### <a name="where-the-certificate-root-of-trust-comes-from"></a>信任的证书根来自何处
管理公钥基础结构（PKI）可能成本高昂且复杂。  尤其是当你的公司没有任何管理 PKI 的经验时。 选项包括：
- 使用第三方 PKI。 你可以从第三方证书供应商处购买中间签名证书。 或者，你可以使用专用证书颁发机构（CA）。 
- 使用自我管理的 PKI。 您可以维护自己的 PKI 系统并生成您自己的证书。
- 使用[Azure Sphere](https://azure.microsoft.com/services/azure-sphere/)安全服务。 此选项仅适用于 Azure Sphere 设备。 

#### <a name="where-certificates-are-stored"></a>存储证书的位置
有几个因素会影响存储证书的决定。 这些因素包括设备类型、预期利润利润（是否可以承受安全存储）、设备功能以及可使用的设备上现有的安全技术。 请考虑以下选项：
- 在硬件安全模块（HSM）中。 强烈建议使用 HSM。 检查设备的控制板是否已安装 HSM。 如果你知道没有 HSM，请与硬件制造商合作来识别满足你的需求的 HSM。
- 在磁盘上的安全位置（如受信任的执行环境（t））。
- 位于本地文件系统或证书存储区中。 例如，Windows 证书存储区。 

#### <a name="connectivity-at-the-factory"></a>出厂时的连接
工厂的连接决定了在设备上安装证书的方式和时间。 连接选项如下所示：
- 连接。 建立连接是最佳的，它简化了本地生成证书的过程。 
- 无连接。 在这种情况下，可以使用 CA 中的签名证书来本地和脱机生成设备证书。 
- 无连接。 在这种情况下，你可以获取提前生成的证书。 或者，可以使用脱机 PKI 在本地生成证书。

#### <a name="audit-requirement"></a>审核要求
根据所生成设备的类型，你可能需要在设备上创建有关如何安装设备标识的审核记录的法规要求。 审核增加了大量的生产成本。 在大多数情况下，仅在必要时才执行此操作。 如果不确定是否需要审核，请咨询公司的法律部门。 审核选项包括： 
- 不是敏感行业。 无需审核。
- 相关行业。 应根据符合性认证要求，将证书安装在安全房间中。 如果需要安全的空间来安装证书，则可能已了解如何在设备中安装证书。 您可能已准备好审核系统。 

#### <a name="length-of-certificate-validity"></a>证书有效期
与驾照一样，证书的到期日期是在创建时设置的。 以下是证书有效期的选项：
- 不需要续订。  此方法使用较长的续订期，因此在设备的生存期内，你永远不需要续订证书。 虽然这种方法很方便，但它也是危险的。  可以通过在设备上使用 HSM 等安全存储来降低风险。 但是，建议的做法是避免使用长期证书。
- 需要续订。  需要在设备的生存期内续订证书。 证书有效期的长度取决于上下文，并且你需要续订策略。  策略应包括你在何处获取证书，以及设备在续订过程中必须使用哪种类型的无线功能。 

### <a name="when-to-generate-certificates"></a>何时生成证书
工厂中的 internet 连接功能将影响生成证书的过程。 你可以使用几个选项来生成证书： 

- 预加载的证书。  某些 HSM 供应商提供了一项高级服务，其中 HSM 供应商为客户安装证书。 首先，客户为 HSM 供应商提供签名证书的访问权限。 然后，HSM 供应商在客户购买的每个 HSM 上安装签名证书签名的证书。 所有客户都必须在设备上安装 HSM。 尽管此服务增加了成本，但它有助于简化制造过程。  并解决了何时安装证书的问题。
- 设备生成的证书。  如果你的设备在内部生成证书，则必须从设备中提取公共 x.509 证书，以便在 DPS 中注册它。 
- 连接的工厂。  如果你的工厂有连接，则可以在需要时生成设备证书。
- 具有自己的 PKI 的脱机工厂。 如果你的工厂没有连接，并且你使用的是你自己的具有脱机支持的 PKI，则可以在需要时生成证书。
- 具有第三方 PKI 的脱机工厂。 如果工厂没有连接，并且使用的是第三方 PKI，则必须提前生成证书。 并且需要从具有连接的位置生成证书。 

### <a name="when-to-install-certificates"></a>何时安装证书
为 IoT 设备生成证书后，可将其安装到设备中。 

如果你将预加载的证书与 HSM 结合使用，则简化了该过程。 在设备中安装 HSM 后，设备代码可以访问它。 然后，将调用 HSM Api 来访问存储在 HSM 中的证书。 此方法最适合您的生产过程。 

如果不使用预先加载的证书，则必须在生产过程中安装该证书。 最简单的方法是将证书安装到 HSM 中，同时刷新初始固件映像。 你的过程必须在每个设备上添加一个步骤来安装映像。 完成此步骤后，你可以在打包和发运设备之前运行最终质量检查和任何其他步骤。 

有一些软件工具可让你在单个步骤中运行安装过程和最终质量检查。 您可以修改这些工具以生成证书，或从预先生成的证书存储中拉取证书。 然后，软件可以安装需要安装证书的证书。 此类型的软件工具使你可以大规模运行生产质量生产。 

在设备上安装证书后，下一步是了解如何使用[DPS](about-iot-dps.md)注册设备。 

## <a name="integrating-a-tpm-into-the-manufacturing-process"></a>将 TPM 集成到制造过程
如果使用 TPM 对 IoT 设备进行身份验证，本部分会提供相关指导。 本指南涵盖了使用基于哈希的消息身份验证代码（HMAC）密钥支持的广泛使用的 TPM 2.0 设备。 Tpm 芯片的 TPM 规范是由受信任的计算组维护的 ISO 标准。 有关 TPM 的详细信息，请参阅[tpm 2.0](https://trustedcomputinggroup.org/tpm-library-specification/)和[ISO/IEC 11889](https://www.iso.org/standard/66510.html)的规格。 

### <a name="taking-ownership-of-the-tpm"></a>取得 TPM 的所有权
使用 TPM 芯片制造设备的一个关键步骤是获得 TPM 的所有权。 此步骤是必需的，以便你可以为设备所有者提供密钥。 第一步是从设备中提取认可密钥（EK）。 下一步是实际声明所有权。 如何实现这一点取决于所使用的 TPM 和操作系统。 如果需要，请联系 TPM 制造商或设备操作系统的开发人员来确定如何声明所有权。 

在生产过程中，你可以在不同时间提取 EK 和声明所有权，这会增加灵活性。 许多制造商通过添加硬件安全模块（HSM）来增强其设备的安全性，充分利用这种灵活性。 本部分提供有关何时提取 EK、何时声明 TPM 所有权的指导，以及将这些步骤集成到生产时间线的注意事项。 

> [!IMPORTANT]
> 以下指南假设你使用独立的、固件或集成的 TPM。 在适用的位置，本指南添加了有关使用非离散或软件 TPM 的说明。 如果使用的是软件 TPM，则本指南可能不包括其他步骤。 软件 Tpm 有多种不同的实施方式，超出了本文的讨论范围。  通常，可以将软件 TPM 集成到以下常规制造时间线中。 但是，虽然软件仿真的 TPM 适用于原型制作和测试，但它不能提供与离散、固件或集成 TPM 相同的安全性级别。 一般做法是避免在生产环境中使用软件 TPM。

### <a name="general-manufacturing-timeline"></a>一般生产时间线
以下时间线显示了 TPM 如何经历生产过程，并在设备中结束。 每个制造流程都是唯一的，此时间线显示最常见的模式。 时间线提供有关何时使用密钥执行特定操作的指导。 

#### <a name="step-1-tpm-is-manufactured"></a>步骤1： TPM 已制造
- 如果你购买了制造商提供的 Tpm 供设备使用，请查看他们是否会提取公共认可密钥（EK_pubs）。 如果制造商为随附设备提供 EK_pubs 列表，则此方法非常有用。 
    > [!NOTE]
    > 可以通过在预配服务中使用共享访问策略，为 TPM 制造商提供对注册列表的写入访问权限。  此方法可让他们将 Tpm 添加到你的注册列表。  但这早于制造过程，并且需要 TPM 制造商提供信任。 这样做的风险由您自己承担。 

- 如果你制造 Tpm 将销售给设备制造商，请考虑为你的客户提供 EK_pubs 及其物理 Tpm 的列表。  向客户提供 EK_pubs 会在其过程中保存步骤。 
- 如果你制造 Tpm 将其与你自己的设备一起使用，请确定你的进程中哪个点最便于提取 EK_pub。 您可以在时间线中的任何其他点提取 EK_pub。 

#### <a name="step-2-tpm-is-installed-into-a-device"></a>步骤2：将 TPM 安装到设备
此时，在生产过程中，您应该知道设备将与哪个 DPS 实例一起使用。 因此，你可以将设备添加到自动预配的注册列表。 有关自动设备预配的详细信息，请参阅[DPS 文档](about-iot-dps.md)。
- 如果尚未提取 EK_pub，现在就可以了。 
- 根据 TPM 的安装过程，此步骤也是取得 TPM 所有权的好时机。 

#### <a name="step-3-device-has-firmware-and-software-installed"></a>步骤3：设备已安装固件和软件
此时，在该过程中，安装 DPS 客户端以及用于预配的 ID 范围和全局 URL。
- 现在，最后机会提取 EK_pub。 如果第三方将软件安装在你的设备上，则最好先提取 EK_pub。
- 制造过程中的这一点非常适合获得 TPM 的所有权。  
    > [!NOTE]
    > 如果你使用的是软件 TPM，你现在可以安装它。  同时提取 EK_pub。

#### <a name="step-4-device-is-packaged-and-sent-to-the-warehouse"></a>步骤4：将设备打包并发送到仓库
在部署之前，设备可以在仓库中的6-12 个月内进行部署。 

#### <a name="step-5-device-is-installed-into-the-location"></a>步骤5：将设备安装到位置
设备到达其最终位置之后，会通过使用 DPS 进行自动预配。

有关详细信息，请参阅[自动预配概念](concepts-auto-provisioning.md)和[TPM 证明](concepts-tpm-attestation.md)。 

## <a name="resources"></a>资源

除了本文中建议的安全做法，Azure IoT 还提供了一些资源，可帮助选择安全硬件和创建安全的 IoT 部署： 
- Azure IoT[安全建议](../iot-fundamentals/security-recommendations.md)，指导部署过程。 
- [Azure 安全中心](https://azure.microsoft.com/services/security-center/)提供了一种服务，可帮助创建安全的 IoT 部署。 
- 有关评估硬件环境的帮助，请参阅白皮书[评估 IoT 安全性](https://download.microsoft.com/download/D/3/9/D3948E3C-D5DC-474E-B22F-81BA8ED7A446/Evaluating_Your_IOT_Security_whitepaper_EN_US.pdf)。 
- 若要获取有关选择安全硬件的帮助，请参阅[IoT 部署的正确安全硬件](https://download.microsoft.com/download/C/0/5/C05276D6-E602-4BB1-98A4-C29C88E57566/The_right_secure_hardware_for_your_IoT_deployment_EN_US.pdf)。 