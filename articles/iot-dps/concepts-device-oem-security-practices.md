---
title: 制造商的安全实践 - Azure IoT 设备配置服务
description: 概述 OEM 和设备制造商的常见安全做法，这些制造商准备设备注册 Azure IoT 设备配置服务 （DPS）。
author: timlt
ms.author: timlt
ms.date: 3/02/2020
ms.topic: conceptual
ms.service: iot-dps
ms.custom: iot-p0-scenario, iot-devices-deviceOEM
ms.reviewer: nberdy
ms.openlocfilehash: 3854f353e4ea0b78c0162681e0b89d37419105d8
ms.sourcegitcommit: c5661c5cab5f6f13b19ce5203ac2159883b30c0e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/01/2020
ms.locfileid: "80529526"
---
# <a name="security-practices-for-azure-iot-device-manufacturers"></a>Azure IoT 设备制造商的安全实践
随着更多制造商发布 IoT 设备，确定有关常见做法的指导会很有帮助。 本文总结了在制造用于 Azure IoT 设备配置服务 （DPS） 的设备时要考虑的建议安全实践。  

> [!div class="checklist"]
> * 选择设备身份验证选项
> * 在 IoT 设备上安装证书
> * 将受信任的平台模块 （TPM） 集成到制造流程中

## <a name="selecting-device-authentication-options"></a>选择设备身份验证选项
任何 IoT 设备安全措施的最终目的是创建安全的 IoT 解决方案。 但是，硬件限制、成本和安全专业知识级别等问题都会影响您选择的选项。 此外，您的安全方法会影响 IoT 设备连接到云的方式。 虽然要考虑[IoT 安全性的几个元素](https://www.microsoft.com/research/publication/seven-properties-highly-secure-devices/)，但每个客户遇到的一个关键元素是要使用的身份验证类型。 

三种广泛使用的身份验证类型是 X.509 证书、可信平台模块 （TPM） 和对称密钥。 尽管存在其他身份验证类型，但大多数在 Azure IoT 上构建解决方案的客户使用这三种类型之一。 本文的其余部分将调查使用每种身份验证类型的优缺点。

### <a name="x509-certificate"></a>X.509 证书
X.509 证书是可用于身份验证的数字标识类型。 X.509 证书标准记录在[IETF RFC 5280](https://tools.ietf.org/html/rfc5280)中。 在 Azure IoT 中，有两种方法可以对证书进行身份验证：
- 指纹。 指纹算法在证书上运行以生成十六进制字符串。 生成的字符串是证书的唯一标识器。 
- 基于完整链的 CA 身份验证。 证书链是验证最终实体 （EE） 证书所需的所有证书的分层列表。 要对 EE 证书进行身份验证，必须对链中每个证书（包括受信任的根 CA）进行身份验证。 

X.509 的优点：
- X.509 是 Azure IoT 中支持的最安全身份验证类型。
- X.509 允许为证书管理目的进行高级别控制。
- 许多供应商都提供基于 X.509 的身份验证解决方案。

X.509 的辅音：
- 许多客户可能需要依赖外部供应商获得证书。
- 证书管理可能成本高昂，并会增加总解决方案成本。
- 如果物流没有经过深思熟虑，证书生命周期管理可能很困难。 

### <a name="trusted-platform-module-tpm"></a>受信任的平台模块 (TPM)
TPM 也称为[ISO/IEC 11889，](https://www.iso.org/standard/66510.html)是安全生成和存储加密密钥的标准。 TPM 还指与实现标准的模块交互的虚拟或物理 I/O 设备。 TPM 设备可以作为离散硬件、集成硬件、基于固件的模块或基于软件的模块存在。 

TM 和对称键之间有两个关键区别： 
- TPM 芯片还可以存储 X.509 证书。
- DPS 中的 TPM 认证使用 TPM 背书密钥 （EK），这是一种非对称身份验证形式。 使用非对称身份验证时，公钥用于加密，并且单独的私钥用于解密。 相反，对称密钥使用对称身份验证，其中私钥用于加密和解密。 

TPM 的优点：
- TM 作为标准硬件包含在许多 Windows 设备上，并且对操作系统具有内置支持。 
- TPM 认证比基于令牌的共享访问签名 （SAS） 更容易安全。
- 您可以轻松地过期和续订或滚动设备凭据。 每当 TPM 设备需要重新预配时，DPS 都会自动滚动 IoT 中心凭据。

TPM 的辅因： 
- TM 很复杂，可能难以使用。 
- 除非您有物理 TPM 或高质量的仿真器，否则使用 TM 的应用程序开发将非常困难。
- 您可能需要重新设计设备的主板，才能在硬件中包括 TPM。 
- 如果在 TPM 上滚动 EK，它将破坏 TPM 的标识并创建新的。 尽管物理芯片保持不变，但它在 IoT 解决方案中具有新的标识。

### <a name="symmetric-key"></a>对称密钥
使用对称密钥时，相同的密钥用于加密和解密消息。 因此，设备和对其进行身份验证的服务都知道同一密钥。 Azure IoT 支持基于 SAS 的对称密钥连接。 对称密钥身份验证需要大量所有者责任来保护密钥，并借助 X.509 身份验证实现同等级别的安全性。 如果使用对称键，建议的做法是使用硬件安全模块 （HSM） 保护密钥。

对称键的优点：
- 使用对称键是开始使用身份验证的最简单、成本最低的方法。
- 使用对称键可以简化过程，因为没有什么额外的要生成。 

对称键的缺点： 
- 对称键需要大量努力来保护密钥。 同一密钥在设备和云之间共享，这意味着密钥必须在两个位置受到保护。 相比之下，TPM 和 X.509 证书的挑战是在不泄露私钥的情况下证明公钥的拥有。
- 对称密钥便于遵循较差的安全实践。 对称密钥的一个常见趋势是在设备上硬编码未加密的密钥。 虽然这种做法很方便，但它使密钥容易受到攻击。 通过将对称密钥安全地存储在设备上，可以减轻某些风险。 但是，如果您的优先级最终是安全性而不是便利性，请使用 X.509 证书或 TPM 进行身份验证。 

### <a name="shared-symmetric-key"></a>共享对称键
对称密钥身份验证称为共享对称密钥有一种变体。 此方法涉及在所有设备中使用同一对称密钥。 建议是避免在设备上使用共享对称键。 

用于共享对称键：
- 易于实施，生产成本低。 

共享对称键的缺点： 
- 极易受到攻击。 轻松实施的好处远远大于风险。 
- 任何人都可以模拟您的设备，如果他们获得共享密钥。
- 如果您依赖于被泄露的共享对称密钥，则可能会失去对设备的控制。 

### <a name="making-the-right-choice-for-your-devices"></a>为您的设备做出正确的选择
要选择身份验证方法，请确保考虑每种方法对独特制造流程的好处和成本。  对于设备身份验证，给定方法的安全性与其方便程度之间通常存在相反的关系。  

## <a name="installing-certificates-on-iot-devices"></a>在 IoT 设备上安装证书
如果使用 X.509 证书对 IoT 设备进行身份验证，本节提供有关如何将证书集成到制造流程中的指南。 您需要做出几个决定。  其中包括有关常见证书变量、何时生成证书以及何时安装它们的决定。 

如果您习惯于使用密码，您可能会问为什么不能在所有设备中使用同一证书，就像所有设备都使用相同的密码一样。 首先，在任何地方使用相同的密码是危险的。 这种做法使公司面临重大 DDoS 攻击，包括几年前在美国东海岸关闭 DNS 的攻击。 切勿在任何地方使用相同的密码，即使是个人帐户也是如此。 其次，证书不是密码，它是一个唯一的身份。 密码就像一个秘密代码，任何人都可以用它来在安全的建筑物打开门。  这是你知道的，你可以给任何人密码，以获得入口。  证书就像带有照片和其他详细信息的驾照，您可以向警卫出示这些许可证以进入安全的建筑物。 这与你是谁有关。  如果防护装置与驾照精确匹配人员，则只有您可以使用您的驾照（身份）获得入口。 

### <a name="variables-involved-in-certificate-decisions"></a>证书决策中涉及的变量
请考虑以下变量，以及每个变量如何影响整个制造流程。 

#### <a name="where-the-certificate-root-of-trust-comes-from"></a>信任的证书根来自
管理公钥基础结构 （PKI） 可能成本高昂且复杂。  特别是如果您的公司没有任何管理 PKI 的经验。 选项包括：
- 使用第三方 PKI。 您可以从第三方证书供应商处购买中间签名证书。 或者，您可以使用专用证书颁发机构 （CA）。 
- 使用自管理的 PKI。 您可以维护自己的 PKI 系统并生成自己的证书。
- 使用[Azure 球体](https://azure.microsoft.com/services/azure-sphere/)安全服务。 此选项仅适用于 Azure 球体设备。 

#### <a name="where-certificates-are-stored"></a>证书的存储位置
有几个因素会影响证书存储位置的决策。 这些因素包括设备类型、预期利润率（是否负担得起安全存储）、设备功能以及设备上可能可以使用的现有安全技术。 请考虑以下选项：
- 在硬件安全模块 （HSM） 中。 强烈建议使用 HSM。 检查设备的控制板是否已安装 HSM。 如果您知道没有 HSM，请与您的硬件制造商合作，确定满足您需求的 HSM。
- 在磁盘上的安全位置，如受信任的执行环境 （TEE）。
- 在本地文件系统或证书存储中。 例如，Windows 证书存储。 

#### <a name="connectivity-at-the-factory"></a>工厂的连接
工厂的连接决定了如何以及何时获得要在设备上安装的证书。 连接选项如下：
- 连接。 具有连接性是最佳的，它简化了在本地生成证书的过程。 
- 无连接。 在这种情况下，您可以使用来自 CA 的已签名证书在本地和脱机生成设备证书。 
- 无连接。 在这种情况下，您可以获取提前生成的证书。 或者，您可以使用脱机 PKI 在本地生成证书。

#### <a name="audit-requirement"></a>审计要求
根据所生产的设备类型，您可能有法规要求来创建设备上设备标识的审计跟踪。 审核会增加大量生产成本。 因此，在大多数情况下，只有在必要时才这样做。 如果您不确定是否需要审核，请咨询公司的法律部门。 审核选项包括： 
- 不是一个敏感的行业。 无需审核。
- 敏感行业。 证书应根据合规性认证要求安装在安全房间中。 如果需要安全的房间来安装证书，您可能已经知道证书是如何在您的设备中安装的。 您可能已经有了一个审计系统。 

#### <a name="length-of-certificate-validity"></a>证书有效期
与驾驶执照一样，证书具有创建证书时设置的到期日期。 以下是证书有效期的选项：
- 不需要续订。  此方法使用很长的续订期，因此您无需在设备的生存期内续订证书。 虽然这种方法很方便，但也很危险。  您可以通过在设备上使用像 HSM 这样的安全存储来降低风险。 但是，建议的做法是避免使用长寿命证书。
- 需要续订。  您需要在设备的生存期内续订证书。 证书有效期取决于上下文，您需要续订策略。  该策略应包括获取证书的位置，以及设备在续订过程中必须使用哪些类型的空中功能。 

### <a name="when-to-generate-certificates"></a>何时生成证书
工厂中的互联网连接功能将影响您生成证书的过程。 对于何时生成证书，有几个选项： 

- 预加载的证书。  某些 HSM 供应商提供高级服务，其中 HSM 供应商为客户安装证书。 首先，客户授予 HSM 供应商对签名证书的访问权限。 然后，HSM 供应商将由该签名证书签名的证书安装到客户购买的每个 HSM 上。 客户所要做的就是在设备上安装 HSM。 虽然这项服务增加了成本，但它有助于简化您的制造流程。  它解决了何时安装证书的问题。
- 设备生成的证书。  如果设备在内部生成证书，则必须从设备中提取公共 X.509 证书才能将其注册到 DPS 中。 
- 连接工厂。  如果您的工厂具有连接，您可以随时生成设备证书。
- 离线工厂与您自己的PKI。 如果您的工厂没有连接，并且您使用自己的 PKI 与脱机支持，则可以在需要时生成证书。
- 具有第三方 PKI 的脱机工厂。 如果工厂没有连接，并且正在使用第三方 PKI，则必须提前生成证书。 并且有必要从具有连接的位置生成证书。 

### <a name="when-to-install-certificates"></a>何时安装证书
为 IoT 设备生成证书后，可以在设备中安装它们。 

如果使用预加载的证书与 HSM，该过程将简化。 在设备中安装 HSM 后，设备代码可以访问它。 然后，您将调用 HSM API 来访问存储在 HSM 中的证书。 这种方法对您的制造过程最方便。 

如果不使用预加载的证书，则必须将证书安装为生产过程的一部分。 最简单的方法是在闪存初始固件映像的同时在 HSM 中安装证书。 您的进程必须添加一个步骤才能在每个设备上安装映像。 完成此步骤后，您可以在打包和装运设备之前运行最终质量检查和任何其他步骤。 

有可用的软件工具，允许您在单个步骤中运行安装过程和最终质量检查。 您可以修改这些工具以生成证书，或从预生成的证书存储中提取证书。 然后，软件可以在需要安装证书的地方安装证书。 这种类型的软件工具使您能够大规模运行生产质量制造。 

在设备上安装证书后，下一步是了解如何使用[DPS](about-iot-dps.md)注册设备。 

## <a name="integrating-a-tpm-into-the-manufacturing-process"></a>将 TPM 集成到制造流程中
如果您使用 TPM 对 IoT 设备进行身份验证，本节将提供指导。 本指南涵盖广泛使用的 TPM 2.0 设备，这些设备具有基于哈希的消息身份验证代码 （HMAC） 密钥支持。 TPM 芯片的 TPM 规范是由可信计算组维护的 ISO 标准。 有关 TPM 的更多，请参阅[TPM 2.0](https://trustedcomputinggroup.org/tpm-library-specification/)和[ISO/IEC 11889](https://www.iso.org/standard/66510.html)的规格。 

### <a name="taking-ownership-of-the-tpm"></a>取得 TPM 的所有权
制造带有 TPM 芯片的设备的一个关键步骤是拥有 TPM 的所有权。 此步骤是必需的，以便您可以向设备所有者提供密钥。 第一步是从设备中提取背书密钥 （EK）。 下一步是实际声明所有权。 如何做到这一点取决于您使用的 TPM 和操作系统。 如果需要，请与 TPM 制造商或设备操作系统的开发人员联系，以确定如何声明所有权。 

在制造过程中，您可以在不同时间提取 EK 并声明所有权，从而增加灵活性。 许多制造商通过添加硬件安全模块 （HSM） 来利用这种灵活性来增强其设备的安全性。 本节提供有关何时提取 EK、何时声明 TPM 所有权以及将这些步骤集成到制造时间线中的注意事项的指导。 

> [!IMPORTANT]
> 以下指南假定您使用离散、固件或集成的 TPM。 在适用的地方，本指南添加了有关使用非离散或软件 TPM 的说明。 如果您使用软件 TPM，则可能还包括本指南不包括的其他步骤。 软件 TM 具有超出本文范围的各种实现。  通常，可以将软件 TPM 集成到以下常规制造时间线中。 但是，虽然模拟 TPM 的软件适合原型设计和测试，但它无法提供与离散、固件或集成 TPM 相同的安全级别。 作为一般做法，避免在生产中使用软件 TPM。

### <a name="general-manufacturing-timeline"></a>一般制造时间表
以下时间线显示 TPM 如何通过生产过程，最终进入设备。 每个制造过程都是唯一的，并且此时间线显示最常见的模式。 时间线提供有关何时对键执行某些操作的指导。 

#### <a name="step-1-tpm-is-manufactured"></a>第 1 步：制造 TPM
- 如果您从制造商购买 TVM 供设备使用，请查看它们是否会为您提取公共背书密钥（EK_pubs）。 如果制造商提供带有已发货设备的EK_pubs列表，则非常有用。 
    > [!NOTE]
    > 您可以通过在预配服务中使用共享访问策略，向 TPM 制造商提供对注册列表的写入访问权限。  此方法允许他们将 TM 添加到您的注册列表中。  但是，这是制造过程的早期，它需要TPM制造商的信任。 风险自担。 

- 如果您制造 TM 以销售给设备制造商，请考虑向客户提供EK_pubs列表及其物理 TM。  为客户提供EK_pubs可节省其流程中的一个步骤。 
- 如果您制造 TM 以与您自己的设备一起使用，则确定流程中的哪个点最方便地提取EK_pub。 您可以在时间线中的任何剩余点提取EK_pub。 

#### <a name="step-2-tpm-is-installed-into-a-device"></a>第 2 步：TPM 已安装到设备中
在生产过程中的此时，您应该知道设备将使用哪个 DPS 实例。 因此，您可以将设备添加到自动预配的注册列表中。 有关自动设备预配的详细信息，请参阅[DPS 文档](about-iot-dps.md)。
- 如果你还没有提取EK_pub，现在是这样做的好时机。 
- 根据 TPM 的安装过程，此步骤也是获得 TPM 所有权的好时机。 

#### <a name="step-3-device-has-firmware-and-software-installed"></a>第 3 步：设备已安装固件和软件
在此过程中的此时，安装 DPS 客户端以及用于预配的 ID 范围和全局 URL。
- 现在是提取EK_pub的最后机会。 如果第三方将在您的设备上安装该软件，最好先提取EK_pub。
- 制造过程中的这一点是取得 TPM 所有权的理想选择。  
    > [!NOTE]
    > 如果您使用的是软件 TPM，则可以立即安装它。  同时提取EK_pub。

#### <a name="step-4-device-is-packaged-and-sent-to-the-warehouse"></a>第 4 步：设备打包并发送到仓库
设备可以在部署之前在仓库中存放 6-12 个月。 

#### <a name="step-5-device-is-installed-into-the-location"></a>步骤 5：设备安装到该位置
设备到达其最终位置后，它将通过 DPS 的自动预配。

有关详细信息，请参阅[自动预配概念](concepts-auto-provisioning.md)和[TPM 认证](concepts-tpm-attestation.md)。 

## <a name="resources"></a>资源

除了本文中推荐的安全实践外，Azure IoT 还提供资源来帮助选择安全硬件和创建安全的 IoT 部署： 
- Azure IoT[安全建议](../iot-fundamentals/security-recommendations.md)，用于指导部署过程。 
- [Azure 安全中心](https://azure.microsoft.com/services/security-center/)提供一项服务来帮助创建安全的 IoT 部署。 
- 有关评估硬件环境的帮助，请参阅[评估 IoT 安全性](https://download.microsoft.com/download/D/3/9/D3948E3C-D5DC-474E-B22F-81BA8ED7A446/Evaluating_Your_IOT_Security_whitepaper_EN_US.pdf)的白皮书。 
- 有关选择安全硬件的帮助，请参阅[IoT 部署的正确安全硬件](https://download.microsoft.com/download/C/0/5/C05276D6-E602-4BB1-98A4-C29C88E57566/The_right_secure_hardware_for_your_IoT_deployment_EN_US.pdf)。 