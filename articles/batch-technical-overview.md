<properties 
	pageTitle="Azure 批处理技术概述" 
	description="了解 Azure 批处理服务的概念、工作流和方案" 
	services="batch" 
	documentationCenter="" 
	authors="dlepow" 
	manager="timlt"/>

# Azure 批处理技术概述
Azure 批处理可帮助你在云中运行大规模并行和高性能计算 (HPC) 应用程序。它是一个平台服务，提供作业计划，并可以自动缩放受控的虚拟机 (VM) 集合以运行作业。通过使用批处理服务，你可以将批处理工作负载配置为按需或按计划在 Azure 中运行，而无需担心基础平台中计划作业和管理 VM 的复杂性。
 
>[AZURE.NOTE]批处理目前以预览版提供。若要使用批处理，你需要有一个 Azure 帐户，并且需要注册批处理预览版。如果你没有帐户，只需花费几分钟就能创建一个免费试用帐户。有关详细信息，请参阅[创建 Azure 帐户](/documentation/articles/php-create-account/)。 


<h2 id="BKMK_Scenarios">用例</h2>

批处理利用云的弹性和规模，帮助你进行*批处理*或 *批处理计算* - 运行大量类似的任务以获得某个所需的结果。命令行程序或脚本接受一组数据文件作为输入，以一系列的任务来处理数据，然后生成一组输出文件。输出文件可能是最终结果，也可能是较大工作流中的中间步骤。       
 
在按计划或按需处理、转换和分析大量数据的组织中，批处理计算是一种常见的模式。其中包括生命周期终止处理，例如银行的每日风险报表，或必须按计划完成的工资单。它还包括大型商业、科学和工程应用程序，通常需要计算群集或网格的工具和资源。应用程序包括传统的 HPC 应用程序（例如流体动力学仿真）和专业化工作负载（例如汽车设计、石油和天然气勘探、生命科学研究及数字内容创作等领域的工作负载）。 
 
批处理很适合处理本质上并行（有时称为"易并行"）的应用程序或工作负载，而这些本身就适合在多部计算机上以并行任务运行，例如批处理服务管理的计算 VM。请参阅图 1。  

![Parallel tasks][parallel]

**图 1.在多台计算机上运行的并行任务**

示例包括：

* 金融风险建模 
* 图像呈现和图像处理
* 媒体编码和转码
* 基因序列分析
* 软件测试

你还可以使用批处理来执行并行计算（最后加上归纳步骤），以及其他更复杂的非周期性并行工作负载。 

>[AZURE.NOTE]批处理预览版目前不支持消息传递接口 (MPI) 应用程序。

<h2 id="BKMK_Approaches">开发人员方案</h2>

基于 REST 的批处理 API 支持两种开发人员方案，可帮助你利用批处理服务来配置和运行批处理工作负载：
 
1. **将计算分散为工作项** - 使用 *批处理* API 来创建和管理弹性的计算 VM 池，并指定这些 VM 要执行的工作。这可以让你全面控制资源，并要求客户端管理任务执行管道 - 例如，使用工作流管理器或元计划程序，这可以通过批处理 REST API 或工作项的作业管理器（可选）来实现。你可以自动计划计算作业，并相应地扩大和缩小计算 VM 池来运行这些作业，而不需设置计算群集或编写代码来排队和计划工作。在指定工作项的过程中，可以定义所有依赖关系，并定义输入文件和输出文件的移动方式。 

2. **使用批处理服务发布和运行应用程序** -  *Batch Apps* API 在较高的层面工作，可帮助你包装现有的应用程序，使其作为批处理在后台管理的 VM 池中作为服务运行。批处理应用程序可能是目前在客户端工作站或计算群集上运行的应用程序。Batch Apps 框架将处理输入文件和输出文件的移动、作业执行、作业管理和数据持久性。Batch Apps 还可让你为数据分区任务以及作业中的多个步骤建模。其中包括基于 REST 的 API 和 Batch Apps 门户，这些都可以从 Azure 管理门户访问，可帮助你监视所提交的作业。


<h2 id="BKMK_Entities">批处理概念</h2>

以下部分汇总了有关使用批处理服务和 API 的重要概念。有关详细信息，请参阅 [Azure 批处理 API 基础知识](/documentation/articles/batch-api-basics)。 

* [批处理帐户](#BKMK_Account)
* [任务虚拟机和池](#BKMK_TVM)
* [工作项、作业和任务](#BKMK_Workitem)
* [文件和目录](#BKMK_Files)

<h3 id="BKMK_Account">批处理帐户</h3>
你需要有一个唯一的**批处理帐户**才能使用批处理服务。对批处理服务发出的所有请求必须使用帐户的名称及其访问密钥进行身份验证。
 
可以在 Azure 管理门户中创建批处理帐户和管理该帐户的访问密钥。

创建批处理帐户：

1. 登录到 [Azure 管理门户](https://manage.windowsazure.cn)。
2. 依次单击"新建"、"计算"、"批处理服务"、"快速创建"。
![Create a Batch account][account_portal]

3. 输入以下信息：

	* 在"帐户名"中，输入要在批处理帐户 URL 中使用的唯一名称。
	* 在"区域"中，选择已经推出了批处理服务的区域。
	* 如果你有多个订阅，请在"订阅"中，选择可用的订阅作为使用批处理时的计费帐户。

 
<h3 id="BKMK_TVM">任务虚拟机和池</h3>

**任务虚拟机** (TVM) 是批处理服务专用来为应用程序运行特定任务的 Azure VM，此处所指的应用程序是可执行文件 (.exe) 等，或者以 Batch Apps 来说，就是应用程序映像中的一个或多个程序。不同于一般的 Azure VM，你不需要直接设置或管理 TVM，而是由批处理服务创建 TVM，并将其作为配置方式类似于 VM 的**池**来管理，如图 2 所示。 

![Pool and TVMs][TVM_pool]

**图 2.TVM 池**

如果使用批处理 API，则可以直接创建池，或者在指定要执行的工作时自动创建池。如果使用 Batch Apps API，则当运行已启用云功能的 Batch Apps 时，将会自动创建池。


池的属性包括：

* TVM 的[大小](http://msdn.microsoft.com/library/azure/dn197896.aspx) 。 
* TVM 上运行的操作系统
* TVM 数目上限
* 池的缩放策略 - 基于当前工作负载和资源用量的公式，可动态调整负责处理任务的 TVM 数目
* TVM 上是否启用防火墙端口来允许池之间的通信
* TVM 上安装的证书 - 例如，验证对存储帐户的访问
* TVM 的启动任务，用于一次性操作，例如安装应用程序或下载任务使用的数据

>[AZURE.NOTE]当前，TVM 只能运行 Windows Server 2012 R2、Windows Server 2012 或 Windows Server 2008 R2 SP1 操作系统。

池只能由创建它的批处理帐户使用。一个批处理帐户可以有多个池。

系统将分配唯一的名称及关联的 IP 地址给加入至池的每个 TVM。从池中删除某个 TVM 后，该 TVM 将会丢失对操作系统、其本地文件、名称及其 IP 地址所做的更改。当某个 TVM 退出池时，它的生存期即告结束。


<h3 id="BKMK_Workitem">工作项、作业和任务</h3>

**工作项**是指定应用程序在池中的 TVM 上如何运行的模板。**作业**是计划的工作项，可能发生一次或重复发生。作业由**任务**的集合构成。图 3 显示基本关系。    
 
![Workitem, job, and tasks][job_task]

**图 3.工作项、作业和任务**

根据在批处理中用来开发的 API，你需要管理有关工作项、作业和任务的或多或少的详细信息。

* 如果使用批处理 API 开发应用程序，则需要以编程方式定义所有工作项、作业和任务，并配置运行任务的 TVM 池。

* 如果使用 Batch Apps API 和工具来集成客户端应用程序，则可以使用组件来自动将作业分割成任务、处理任务，以及将单个任务的结果合并成最终的作业结果。将工作负载提交给批处理服务时，Batch Apps 框架会管理作业，并在 TVM 上执行任务。 



<h3 id="BKMK_Files">文件和目录</h3>

文件是输入到作业任务中的数据片段。一个任务可能没有、有一个或有多个关联的输入文件。相同的文件也可以用于多个任务，例如，影片渲染作业中的任务可能有常用的纹理和模型。以数据分析作业中的任务而言，文件可能是一组观察值或测量值。

每个任务都有一个工作目录，其中包含该任务处理的输入数据，以及它创建的输出数据。在运行作业时，这些目录和文件可供其他任务使用。TVM 上的所有任务、文件和目录由单个用户帐户拥有。

同样，根据在批处理中用来开发的 API，你需要管理有关作业和任务输入与输出文件的或多或少的详细信息。如果使用 Batch API 进行开发，则需要显式指定这些依赖关系和文件移动。使用 Batch Apps 时，框架将为你处理其中的大多数详细信息。 

<h2 id="BKMK_Workflow_workitems">工作项工作流</h2>
图 4 显示了如何将应用程序提交到要在其中分发该应用程序以进行处理的池。此工作流使用了批处理 API。

![Workitems workflow][work_item_workflow]

**图 4.将工作项分发到池 VM 的工作流**

1.	将作业所需的输入文件（例如源数据或图像）上载到 Azure 存储帐户。这些文件必须在存储帐户中，批处理服务才能够访问它们。运行任务时，批处理服务将文件加载至 TVM。
2.	将相关二进制文件上载到存储帐户。二进制文件包括由任务运行的程序和相关程序集。这些文件也必须从存储访问，并已加载至 TVM。
3.	创建 TVM 池，并指定池中的 TVM 大小、它们运行的操作系统，以及其他属性。任务运行时，系统从这个池分配 TVM 给它。
4.	创建工作项。当你创建工作项时，系统会自动创建一个作业。你可以使用工作项管理任务作业。
5.	将任务添加到作业。每个任务都使用所上载的程序处理已上载的文件中的信息。
6.	运行该应用程序并监视输出结果。

<h2 id="BKMK_Workflow_cloudapps">发布和运行应用程序的工作流 </h2>
图 5 显示的基本工作流使用 Batch Apps API 发布应用程序，然后将作业提交到批处理启用的应用程序。

![Application publishing workflow][app_pub_workflow]

**图 5.使用 Batch Apps 发布和运行应用程序的工作流**

1.	准备**应用程序映像**，这是一个 zip 文件，包含现有应用程序可执行文件及其所需的任何支持文件。这些可能是在传统服务器场或群集中运行的相同可执行文件。
2.	创建**云程序集**的 zip 文件，该程序集会调用任务负载并将其分派给批处理服务。这包含两个可通过 SDK 获得的组件：

	a. **作业拆分器** - 将作业分解成可独立处理的任务。例如，在动画案例中，作业拆分器将使用影片渲染作业，并将影片分割成单个帧。

	b. **任务处理器**- 调用给定任务的应用程序可执行文件。例如，在动画案例中，任务处理器将调用一个渲染程序，以渲染任务指定的单个帧。 

3.	使用 Batch Apps API 或开发人员工具将前两个步骤中准备的 zip 文件上载到 Azure 存储帐户。这些文件必须在存储帐户中，批处理服务才能够访问它们。此任务通常由服务管理员为每个应用程序执行一次。
4.	提供一种方式以将作业提交给 Azure 中启用的应用程序服务。这可能是应用程序 UI 中的插件、Web 门户，或后端系统中的无人值守服务。SDK 随附了示例用于演示各个选项。 

	运行作业：

	a. 上载特定于用户作业的输入文件（例如源数据或图像）。这些文件必须在存储帐户中，批处理服务才能够访问它们。

	b. 连同所需的参数和文件列表一起提交作业。
	
	c. 使用 API 或 Batch Apps 门户监视作业进度。
	
	d. 下载输出。
	
<h2 id="BKMK_Resources">其他资源</h2>

* [适用于 .NET 的 Azure 批处理库入门](/documentation/articles/batch-dotnet-get-started/)
* [Azure 批处理开发库和工具](/documentation/articles/batch-development-libraries-tools/)
* [Azure 批处理 REST API 参考](https://msdn.microsoft.com/library/azure/dn820158.aspx)
* [Azure Batch Apps REST API 参考](https://msdn.microsoft.com/library/azure/dn820126.aspx)

[parallel]: ./media/batch-technical-overview/parallel.png
[TVM_pool]: ./media/batch-technical-overview/TVM_pool.png
[job_task]: ./media/batch-technical-overview/job_task.png
[account_portal]: ./media/batch-technical-overview/account_portal.png
[work_item_workflow]: ./media/batch-technical-overview/work_item_workflow.png
[app_pub_workflow]: ./media/batch-technical-overview/app_pub_workflow.png
