---
title: 自动部署设备组-Azure IoT Edge |Microsoft Docs
description: 使用 Azure IoT Edge 中的自动部署来管理基于共享标记的设备组
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 01/30/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 8aaac6100ba980301ff3e85a3ac3959bfee89b49
ms.sourcegitcommit: 67e9f4cc16f2cc6d8de99239b56cb87f3e9bff41
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/31/2020
ms.locfileid: "76895964"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>了解单个设备的 IoT Edge 自动部署或大规模部署

自动部署和分层部署可帮助你在大量 IoT Edge 设备上管理和配置模块。

Azure IoT Edge 提供了两种方法来配置要在 IoT Edge 设备上运行的模块。 第一种方法是在每个设备上部署模块。 创建部署清单，并按名称将其应用到特定设备。 第二种方法是将模块自动部署到满足一组定义的条件的任何已注册设备。 你将创建一个部署清单，然后根据设备克隆中的[标记](../iot-edge/how-to-deploy-monitor.md#identify-devices-using-tags)定义适用于它的设备。

本文重点介绍如何配置和监视设备的群，它们统称为*IoT Edge 自动部署*。 基本部署步骤如下所示：

1. 操作员定义用于描述一组模块和目标设备的部署。 每个部署都有一个反映此信息的部署清单。
2. IoT 中心服务与所有目标设备通信，以便将其配置为声明的模块。
3. IoT 中心服务从 IoT Edge 设备检索状态，并使它们可供操作员使用。  例如，操作员可以看到边缘设备未成功配置，或在运行时模块出现故障。
4. 在任何时候，都要为部署配置满足目标条件的新 IoT Edge 设备。

本文介绍了配置和监视部署所涉及的每个组件。 有关创建和更新部署的演练，请参阅[大规模部署和监视 IoT Edge 模块](how-to-deploy-monitor.md)。

## <a name="deployment"></a>部署

IoT Edge 自动部署将 IoT Edge 模块映像分配给目标 IoT Edge 设备集上的实例。 它的工作方式是将 IoT Edge 部署清单配置为包含包含相应初始化参数的模块的列表。 可以将部署分配到单个设备（基于设备 ID）或设备组（基于标记）。 IoT Edge 设备收到部署清单后，会从各自的容器存储库下载并安装容器映像，并对其进行相应配置。 创建部署后，操作员可以监视部署状态，以查看是否已正确配置目标设备。

只有 IoT Edge 设备才能配置部署。 必须先在设备上具备以下先决条件，然后才能接收部署：

* 基本操作系统
* 容器管理系统，如小鲸鱼或 Docker
* 设置 IoT Edge 运行时

### <a name="deployment-manifest"></a>部署清单

部署清单是一个 JSON 文档，用于描述要在目标 IoT Edge 设备上配置的模块。 它包含所有模块的配置元数据，其中包括所需的系统模块（特别是 IoT Edge 代理和 IoT Edge 中心）。  

每个模块的配置元数据包括：

* 版本
* 键入
* 状态（例如，正在运行或已停止）
* 重新启动策略
* 映像和容器注册表
* 数据输入和输出的路由

如果模块映像存储在专用容器注册表中，则 IoT Edge 代理会保留注册表凭据。

### <a name="target-condition"></a>目标条件

在部署的整个生命周期内会持续评估目标条件。 将包括任何满足要求的新设备，并删除任何不再执行的现有设备。 如果服务检测到任何目标条件更改，则会重新激活部署。

例如，你有一个具有目标条件标记的部署。环境 = "生产"。 启动部署时，有10个生产设备。 这些模块已成功安装在这10个设备中。 IoT Edge 代理状态显示10个设备，10个成功响应，0个失败响应，0个挂起响应。 现在再添加5个具有标记的设备。环境 = "生产"。 该服务检测到更改，IoT Edge 代理状态将变为15个设备，10个成功响应，0个失败响应，而在部署到五个新设备时，将会等待5个挂起的响应。

在设备克隆标记、设备克隆报表属性或 deviceId 上使用任何布尔条件来选择目标设备。 如果要将条件用于标记，需要在与属性相同的级别下的设备克隆中添加 "标记"：{} 部分。 [详细了解设备克隆中的标记](../iot-hub/iot-hub-devguide-device-twins.md)

目标条件的示例：

* deviceId = \ "linuxprod1"
* tags = "生产"
* tags = "生产" 和标记。 location = \ "westus"
* tags = "生产" 或标记。 location = \ "westus"
* tags = "John" 和标记。环境 = "生产" 而不是 deviceId = "linuxprod1"
* devicemodel = ' 4000x '

构造目标条件时，请考虑以下约束：

* 在设备克隆中，只能使用标记、报告的属性或 deviceId 生成目标条件。
* 目标条件的任何部分都不允许使用双引号。 使用单引号。
* 单引号表示目标条件的值。 因此，如果单引号是设备名称的一部分，则必须用另一个引号对单引号进行转义。 例如，若要以称为 `operator'sDevice`的设备为目标，请编写 `deviceId='operator''sDevice'`。
* 目标条件值中允许使用数字、字母和以下字符： `-:.+%_#*?!(),=@;$`。

### <a name="priority"></a>Priority

优先级定义是否应将部署应用于与其他部署相关的目标设备。 部署优先级是一个正整数，它具有更大的值，表示更高的优先级。 如果有多个部署的目标 IoT Edge 设备，则会应用具有最高优先级的部署。  优先级较低的部署不会应用，也不会合并。  如果设备面向具有相同优先级的两个或多个部署，则会应用最近创建的部署（由创建时间戳确定）。

### <a name="labels"></a>标志

标签是可用于对部署进行筛选和分组的字符串键/值对。 部署可以有多个标签。 标签是可选的，不会影响 IoT Edge 设备的实际配置。

### <a name="metrics"></a>基准

默认情况下，所有部署都按四个指标报告：

* **目标**显示与部署目标条件相匹配的 IoT Edge 设备。
* **应用**显示目标 IoT Edge 设备，这些设备不是以更高优先级的另一个部署为目标的设备。
* **报告成功**显示已报告已成功部署模块的 IoT Edge 设备。
* **报告失败**显示已报告一个或多个模块未成功部署的 IoT Edge 设备。 若要进一步调查错误，请远程连接到这些设备并查看日志文件。

此外，还可以定义自己的自定义指标来帮助监视和管理部署。

指标提供设备可能会因为应用部署配置而报告回来的各种状态的汇总计数。 度量值可以查询[edgeHub 模块克隆报告的属性](module-edgeagent-edgehub.md#edgehub-reported-properties)，例如*lastDesiredStatus*或*lastConnectTime*。 例如:

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

添加自己的度量值是可选的，并且不会影响 IoT Edge 设备的实际配置。

## <a name="layered-deployment"></a>分层部署

分层部署是可组合在一起以减少需要创建的唯一部署数的自动部署。 在许多自动部署的不同组合中重复使用相同的模块时，分层部署非常有用。

分层部署与任何自动部署具有相同的基本组件。 它们基于设备孪生中的标记定位设备，并提供与标签、指标和状态报告相同的功能。 分层部署也分配有优先级，但不使用优先级来确定应用到设备的部署，优先级决定了如何在设备上对多个部署进行排序。 例如，如果两个分层部署具有相同名称的模块或路由，则将应用优先级较高的分层部署，同时覆盖较低的优先级。

系统运行时模块 edgeAgent 和 edgeHub 未配置为分层部署的一部分。 分层部署所面向的任何 IoT Edge 设备都需要首先应用标准自动部署。 自动部署提供了可在其中添加分层部署的基础。

IoT Edge 设备只能应用一个标准自动部署，但它可以应用多个分层自动部署。 面向设备的任何分层部署的优先级必须高于该设备的自动部署。

例如，请考虑公司的以下方案来管理建筑物。 它们开发 IoT Edge 用于从安全摄像机、运动传感器和电梯收集数据的模块。 但是，并非所有的建筑物都可以使用所有这三个模块。 对于标准自动部署，公司需要为大楼所需的所有模块组合创建单独的部署。

![标准自动部署需要容纳每个模块组合](./media/module-deployment-monitoring/standard-deployment.png)

但是，一旦公司切换到分层的自动部署，他们就会发现，他们可以为建筑物创建相同的模块组合，且部署更少。 每个模块都有其自己的分层部署，设备标记用于识别哪些模块已添加到每个建筑中。

![分层自动部署可以简化相同模块以不同方式组合的方案](./media/module-deployment-monitoring/layered-deployment.png)

### <a name="module-twin-configuration"></a>模块克隆配置

使用分层部署时，您可以有意或其他方式将两个部署与面向设备的模块一起使用。 在这些情况下，你可以决定较高优先级的部署是否应覆盖模块克隆或追加到它上面。 例如，你可能有一个将同一模块应用于100不同设备的部署。 但是，其中10个设备位于安全设备中，需要额外配置才能通过代理服务器进行通信。 你可以使用分层部署来添加模块克隆属性，这两个设备可安全通信，而不会覆盖基本部署中现有的模块克隆信息。

可以在部署清单中追加模块克隆所需属性。 在标准部署中，你将在 "模块" 中的 "**所需的属性**" 部分中添加属性。在分层部署中，你可以声明所需属性的新子集。

例如，在标准部署中，你可以添加具有以下所需属性的模拟温度传感器模块，以使其在5秒的时间间隔内发送数据：

```json
"SimulatedTemperatureSensor": {
  "properties.desired": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

在面向部分或全部相同设备的分层部署中，你可以添加一个属性，该属性指示模拟传感器发送1000消息，然后停止。 您不希望覆盖现有的属性，因此您需要在名为 `layeredProperties`的所需属性（包含新属性）中创建一个新部分：

```json
"SimulatedTemperatureSensor": {
  "properties.desired.layeredProperties": {
    "StopAfterCount": 1000
  }
}
```

同时应用两个部署的设备将反映模拟温度传感器的模块克隆中的以下属性：

```json
"properties": {
  "desired": {
    "SendData": true,
    "SendInterval": 5,
    "layeredProperties": {
      "StopAfterCount": 1000
    }
  }
}
```

如果在分层部署中设置模块的 "`properties.desired`" 字段，它将在任何较低优先级的部署中覆盖该模块的所需属性。

## <a name="phased-rollout"></a>分阶段推出

分阶段推出是一个整体过程，通过该过程，操作员可以将更改部署到一组扩大 IoT Edge 设备上。 目标是逐渐做出更改，以减少进行大规模的重大更改的风险。 自动部署有助于跨一 IoT Edge 设备管理分阶段推出。

在以下阶段和步骤中执行分阶段推出：

1. 通过预配 IoT Edge 设备并设置 `tag.environment='test'`等设备克隆标记，建立该测试环境。 测试环境应镜像部署最终将面向的生产环境。
2. 创建包含所需模块和配置的部署。 目标条件应以测试 IoT Edge 设备环境为目标。
3. 在测试环境中验证新的模块配置。
4. 通过向目标条件添加新的标记，更新部署以包含生产 IoT Edge 设备的子集。 此外，请确保部署的优先级高于当前目标为这些设备的其他部署
5. 通过查看部署状态，验证部署是否在目标 IoT 设备上成功。
6. 更新部署以将所有剩余生产 IoT Edge 设备作为目标。

## <a name="rollback"></a>回退

如果收到错误或配置错误，则可以回滚部署。 由于部署定义了 IoT Edge 设备的绝对模块配置，因此还必须以较低的优先级将额外的部署目标设置为相同的设备，即使目标是删除所有模块。  

删除部署不会从目标设备中删除这些模块。 还必须有一个定义设备新配置的部署，即使它是空部署。

按照以下顺序执行回滚：

1. 确认另一个部署也针对同一设备集。 如果回滚的目标是删除所有模块，则第二个部署不应包含任何模块。
2. 修改或删除要回滚的部署的目标条件表达式，使设备不再满足目标条件。
3. 通过查看部署状态来验证回滚是否成功。
   * 回滚的部署不应再显示已回滚的设备的状态。
   * 第二个部署现在应包括已回滚设备的部署状态。

## <a name="next-steps"></a>后续步骤

* 逐步完成创建、更新或删除部署中的步骤，以便[大规模部署和监视 IoT Edge 模块](how-to-deploy-monitor.md)。
* 了解其他 IoT Edge 概念，如[IoT Edge 运行时](iot-edge-runtime.md)和[IoT Edge 模块](iot-edge-modules.md)。
