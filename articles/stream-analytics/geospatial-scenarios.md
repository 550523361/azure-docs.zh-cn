---
title: 通过 Azure 流分析进行地理围栏和地理空间聚合
description: 本文介绍如何使用 Azure 流分析进行地理围栏和地理空间聚合。
services: stream-analytics
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: d44b2fae677554594f0cc280c1129bbd6effddf2
ms.sourcegitcommit: 4c3d6c2657ae714f4a042f2c078cf1b0ad20b3a4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/25/2019
ms.locfileid: "72935075"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>Azure 流分析的地理围栏和地理空间聚合方案

利用内置的地理空间功能，可以使用 Azure 流分析来构建应用程序，以用于各种方案，如汽油管理、进行共享、连接汽车和资产跟踪。

## <a name="geofencing"></a>地理围栏

Azure 流分析在云和 IoT Edge 运行时中支持低延迟实时地理围栏计算。

### <a name="geofencing-scenario"></a>地理围栏方案

制造公司需要跟踪大楼上的资产。 他们将每台设备配备 GPS，并希望在设备离开某个区域时接收通知。

本示例中使用的引用数据包含建筑物的地域隔离区内信息，以及每个建筑物中允许使用的设备的信息。 请记住，引用数据可能是静态的或变化缓慢。 静态引用数据用于此方案。 数据流会持续发出设备 ID 及其当前位置。

### <a name="define-geofences-in-reference-data"></a>在引用数据中定义现成

可以使用 GeoJSON 对象定义地域隔离区内。 对于兼容性1.2 和更高版本的作业，还可以使用众所周知的文本（WKT）将现成定义为 `NVARCHAR(MAX)`。 WKT 是一种开放地理空间信息联盟（OGC）标准，用于以文本格式表示空间数据。

内置地理空间函数可以使用定义的现成，以确定元素是传入还是传出特定地域隔离区内多边形。

下表是可以存储在 Azure blob 存储或 Azure SQL 表中的地域隔离区内引用数据的示例。 每个站点都由地理空间多边形表示，每个设备与允许的站点 ID 相关联。

|SiteID|名|地域隔离区内|AllowedDeviceID|
|------|--------|--------|---------------|
|第|"Redmond 大楼 41"|"多边形（（-122.1337357922017 47.63782998329432，-122.13373042778369 47.637634793257305，-122.13346757130023 47.637642022530954，-122.13348902897235 47.637508280806806，-122.13361777500506 47.637508280806806，-122.1336124105870347.63732393354484,-122.13265754417773 47.63730947490855,-122.13266290859576 47.637519124743164,-122.13302232460376 47.637515510097955,-122.13301696018573 47.63764925180358,-122.13272728161212 47.63764925180358,-122.1327487392842447.63784082716388,-122.13373579220172 47.63782998329432))"|B|
|2|"Redmond 大楼 40"|"多边形（（-122.1336154507967 47.6366745947009，-122.13361008637867 47.636483015064535，-122.13349206918201 47.636479400347675，-122.13349743360004 47.63636372927573，-122.13372810357532 47.63636372927573，-122.1337334679933547.63617576323771,-122.13263912671528 47.63616491902258,-122.13264985555134 47.63635649982525,-122.13304682248554 47.636367344000604,-122.13305218690357 47.63650831807564,-122.13276250832996 47.636497473929516,-122.1327732371660247.63668543881025,-122.1336154507967 47.6366745947009))"|的|
|3|"Redmond 大楼 22"|"多边形（（-122.13611660248233 47.63758544698554，-122.13635263687564 47.6374083293018，-122.13622389084293 47.63733603619712，-122.13622389084293 47.63717699101473，-122.13581619507266 47.63692757827657，-122.1355962539334447.637046862778135,-122.13569281345798 47.637144458985965,-122.13570890671207 47.637314348246214,-122.13611660248233 47.63758544698554))"|Ansi-c|

### <a name="generate-alerts-with-geofence"></a>用地域隔离区内生成警报

设备可以通过名为 `DeviceStreamInput`的流每分钟发出其 ID 和位置。 下表是一个输入流。

|DeviceID|GeoPosition|
|--------|-----------|
|的|"POINT （-122.13292341559497 47.636318374032726）"|
|B|"POINT （-122.13338475554553 47.63743531308874）"|
|Ansi-c|"POINT （-122.13354001095752 47.63627622505007）"|

你可以编写一个查询，该查询将设备流与地域隔离区内引用数据联接起来，并在每次设备超出允许的生成时生成警报。

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

下图显示了现成。 您可以查看设备在哪个位置按照流数据输入。

![构建现成](./media/geospatial-scenarios/building-geofences.png)

设备 "C" 位于构建 ID 2 内，不允许使用引用数据。 此设备应位于大楼 ID 3 内。 运行此作业将生成此特定冲突的警报。

### <a name="site-with-multiple-allowed-devices"></a>具有多个允许设备的站点

如果站点允许多个设备，则可以在 `AllowedDeviceID` 中定义一组设备 Id，用户定义函数可用于 `WHERE` 子句，以验证流设备 ID 是否与该列表中的任何设备 ID 匹配。 有关详细信息，请查看云作业的[Javascript udf](stream-analytics-javascript-user-defined-functions.md)教程和边缘作业的[ C# UDF](stream-analytics-edge-csharp-udf.md)教程。

## <a name="geospatial-aggregation"></a>地理空间聚合

Azure 流分析在云和 IoT Edge 运行时中支持低延迟实时地理空间聚合。

### <a name="geospatial-aggregation-scenario"></a>地理空间聚合方案

Cab 公司希望构建一个实时应用程序，指导其 cab 驱动程序寻找当前经历更高需求的城市区域。

公司以引用数据的形式存储城市的逻辑区域。 每个区域由 RegionID、RegionName 和地域隔离区内定义。

### <a name="define-the-geofences"></a>定义现成

下表是可以存储在 Azure blob 存储或 Azure SQL 表中的地域隔离区内引用数据的示例。 每个区域由地理空间多边形表示，地理空间多边形用于与来自流数据的请求相关联。

这些多边形仅用于参考，不表示实际的城市逻辑或物理分分。

|RegionID|RegionName|地域隔离区内|
|--------|----------|--------|
|第|SoHo|"多边形（（-74.00279525078275 40.72833625216264，-74.00547745979765 40.721929158663244，-74.00125029839018 40.71893680218994，-73.9957785919998 40.72521409075776，-73.9972377137039 40.72557184584898，-74.00279525078275 40.72833625216264）)"|
|2|"Chinatown"|"多边形（（-73.99712367114876 40.71281582267133，-73.9901070123658 40.71336881907936，-73.99023575839851 40.71452359088633，-73.98976368961189 40.71554823078944，-73.99551434573982 40.717337246783735，-73.9948062425598940.718491949759304,-73.99652285632942 40.719109951574,-73.99776740131233 40.7168005470334,-73.99903340396736 40.71727219249899,-74.00193018970344 40.71938642421256,-74.00409741458748 40.71688186545551,-74.0005139833435840.71517415773184,-74.0004281526551 40.714377212470005,-73.99849696216438 40.713450141693166,-73.99748845157478 40.71405192594819,-73.99712367114876 40.71281582267133))"|
|3|Tribeca|"多边形（（-74.01091641815208 40.72583120006787，-74.01338405044578 40.71436586362705，-74.01370591552757 40.713617702123415，-74.00862044723533 40.711308107057235，-74.00194711120628 40.7194238654018，-74.0109164181520840.72583120006787))"|

### <a name="aggregate-data-over-a-window-of-time"></a>在时间窗口上聚合数据

下表包含 "搭乘" 的流式处理数据。

|UserID|FromLocation|ToLocation|TripRequestedTime|
|------|------------|----------|-----------------|
|的|"POINT （-74.00726861389182 40.71610611981975）"|"POINT （-73.98615095917779 40.703107386025835）"|"2019-03-12T07：00： 00Z"|
|B|"POINT （-74.00249841021645 40.723827238895666）"|"POINT （-74.01160699942085 40.71378884930115）"|"2019-03-12T07：01： 00Z"|
|Ansi-c|"POINT （-73.99680120565864 40.716439898624024）"|"POINT （-73.98289663412544 40.72582343969828）"|"2019-03-12T07：02： 00Z"|
|2-D|"POINT （-74.00741090068288 40.71615626755086）"|"POINT （-73.97999843120539 40.73477895807408）"|"2019-03-12T07：03： 00Z"|

下面的查询将设备流与地域隔离区内引用数据联接，并计算每个区域每分钟15分钟的每个区域的请求数。

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

此查询每隔一分钟输出城市内每个区域的请求计数。 此信息可以通过 Power BI 仪表板轻松显示，也可以通过与 Azure 函数之类的服务集成，将其作为短信广播给所有驱动程序。

下图演示了 Power BI 仪表板的查询的输出。 

![Power BI 仪表板上的结果输出](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>后续步骤

* [流分析地理空间功能简介](stream-analytics-geospatial-functions.md)
* [地理空间函数（Azure 流分析）](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
