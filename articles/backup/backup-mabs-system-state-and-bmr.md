---
title: 系统状态和裸机恢复保护
description: 使用 Azure 备份服务器备份系统状态并提供裸机恢复 （BMR） 保护。
ms.topic: conceptual
ms.date: 05/15/2017
ms.openlocfilehash: 358a1c96d598788170993fc48e60daae2b6b036c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/27/2020
ms.locfileid: "77505879"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-by-using-azure-backup-server"></a>使用 Azure 备份服务器备份系统状态并还原到裸机

Azure 备份服务器可备份系统状态并提供裸机恢复 (BMR) 保护。

* **系统状态备份**：备份操作系统文件。 此备份允许您在计算机启动时恢复，但系统文件和注册表丢失。 系统状态备份包括以下元素：
  * 域成员：启动文件、COM+ 类注册数据库、注册表
  * 域控制器：Windows Server Active Directory (NTDS)、启动文件、COM+ 类注册数据库、注册表、系统卷 (SYSVOL)
  * 运行群集服务的计算机：群集服务器元数据
  * 运行证书服务的计算机：证书数据
* **裸机备份**：备份操作系统文件和关键卷上的所有数据，用户数据除外。 根据定义，BMR 备份包括系统状态备份。 它可在计算机无法启动，而你必须恢复所有内容时提供保护。

下表总结了可以备份和恢复的内容。 有关系统状态和 BMR 可以保护的应用版本的信息，请参阅[Azure 备份服务器备份什么？](backup-mabs-protection-matrix.md)

|备份|问题|从 Azure 备份服务器备份进行恢复|从系统状态备份进行恢复|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**文件数据**<br /><br />常规数据备份<br /><br />BMR/系统状态备份|文件数据丢失|Y|N|N|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|服务器丢失（数据卷完整）|N|N|Y|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|服务器丢失（数据卷丢失）|Y|N|Y<br /><br />BMR，然后定期恢复备份的文件数据|
|**共享点数据**<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|站点、列表、列表项、文档丢失|Y|N|N|
|**共享点数据**<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|**共享点数据**<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|灾难恢复|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|VM 丢失|Y|N|N|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|Hyper-V 主机丢失（VM 完整）|N|N|Y|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|Hyper-V 主机丢失（VM 丢失）|N|N|Y<br /><br />BMR，接下来是常规 Azure 备份服务器恢复|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|应用数据丢失|Y|N|N|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志完整）|N|N|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志丢失）|N|N|Y<br /><br />BMR 恢复，接下来是常规 Azure 备份服务器恢复|

## <a name="how-system-state-backup-works"></a>系统状态备份的工作方式

系统状态备份运行时，备份服务器会与 Windows Server 备份进行通信以请求进行服务器系统状态备份。 默认情况下，备份服务器和 Windows Server 备份使用具有最多可用空闲空间的驱动器。 有关此驱动器的信息保存在*PSDataSourceConfig.xml*文件中。 

您可以自定义备份服务器用于系统状态备份的驱动器： 

1. 在受保护的服务器上，转到*C：\程序文件\微软数据保护管理器\MABS_数据源*。 
1. 打开*PSDataSourceConfig.xml*文件进行编辑。 
1. 更改驱动器号的 \<FilesToProtect\> 值。 
1. 保存并关闭该文件。 

如果保护组设置为保护计算机的系统状态，则运行一致性检查。 如果生成警报，则选择警报中的 **"修改保护组**"，然后在向导中完成页面。 然后再次运行一致性检查。

如果保护服务器位于群集中，则可能会选择群集驱动器作为具有最大可用空间的驱动器。 如果该驱动器所有权切换到另一个节点，并且系统状态备份运行，则驱动器不可用，备份失败。 在这种情况下，修改*PSDataSourceConfig.xml*以指向本地驱动器。

接下来，Windows 服务器备份在还原文件夹的根目录中创建一个名为*WindowsImageBackup*的文件夹。 Windows Server 备份创建备份时，所有数据都会置于此文件夹中。 备份完成后，文件将传输到备份服务器计算机。 请注意以下信息：

* 备份或传输完成后，不会清理此文件夹及其内容。 考虑这一点的最佳方法是，在下次备份完成时，空间将保留。
* 为每个备份创建该文件夹。 时间和日期戳反映上次系统状态备份的时间。

## <a name="how-bmr-backup-works"></a>BMR 备份的工作原理

对于 BMR（包括系统状态备份），备份作业会直接保存到备份服务器计算机上的共享中。 它未保存到受保护服务器上的文件夹。

备份服务器会调用 Windows Server 备份，并共享副本卷以用于该 BMR 备份。 在这种情况下，它不需要 Windows 服务器备份来使用具有最大可用空间的驱动器。 而是使用为作业创建的共享。

备份完成后，文件将传输到备份服务器计算机。 日志存储在*C：\Windows_Logs_WindowsServer 备份*中。

## <a name="prerequisites-and-limitations"></a>先决条件和限制

* 运行 Windows Server 2003 的计算机或运行客户端操作系统的计算机不支持 BMR。

* 无法在不同保护组中为相同计算机保护 BMR 和系统状态。

* 备份服务器计算机无法保护自己以进行 BMR。

* BMR 不支持对磁带（磁盘到磁带或 D2T）的短期保护。 支持对磁带的长期存储（磁盘到磁盘到磁带或 D2D2T）。

* 对于 BMR 保护，必须在受保护计算机上安装 Windows Server 备份。

* 对于 BMR 保护，与系统状态保护不同，备份服务器在受保护的计算机上没有空间要求。 Windows Server 备份会将备份直接传输到备份服务器计算机。 备份传输作业不会出现在备份服务器“作业”**** 视图中。

* 备份服务器会在副本卷上保留 30 GB 空间以用于 BMR。 您可以在"修改保护组向导"中的 **"磁盘分配**"页上更改此空间分配。 或者，您可以使用获取数据源磁盘分配和集数据源磁盘分配 PowerShell cmdlet。 在恢复点卷上，BMR 保护在五天保留期内需要大约 6 GB。
  * 不能将副本卷大小减少到小于 15 GB。
  * 备份服务器不会计算 BMR 数据源的大小。 它假定对所有服务器都使用 30 GB。 可基于在环境中期望的 BMR 备份大小更改该值。 您可以粗略地计算 BMR 备份的大小，作为所有关键卷上已用空间的总和。 关键卷 = 引导卷 + 系统卷 + 承载系统状态数据的卷（如 Active Directory）。

* 如果从系统状态保护更改为 BMR 保护，则 BMR 保护需要较少的*恢复点卷*上的空间。 但是，卷上的额外空间不会回收。 您可以在"修改保护组向导 **"的"修改磁盘分配**"页上手动缩小卷大小。 或者，您可以使用获取数据源磁盘分配和集数据源磁盘分配 PowerShell cmdlet。

    如果从系统状态保护更改为 BMR 保护，则 BMR 保护需要在*副本卷*上增加空间。 该卷会自动扩展。 如果要更改默认空间分配，请使用修改磁盘分配 PowerShell cmdlet。

* 如果从 BMR 保护更改为系统状态保护，则恢复点卷上需要更多的空间。 备份服务器可能会尝试自动增大该卷。 如果存储池没有足够的空间，则会发生错误。

    如果从 BMR 保护更改为系统状态保护，则需要受保护计算机上的空间。 您需要空间，因为系统状态保护首先将副本写入本地计算机，然后它将副本传输到备份服务器计算机。

## <a name="before-you-begin"></a>开始之前

1. **部分 Azure 备份服务器**。 验证是否正确部署了备份服务器。 有关详细信息，请参阅：
    * [Azure 备份服务器的系统要求](https://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)
    * [备份服务器保护矩阵](backup-mabs-protection-matrix.md)

1. **设置存储**。 可以将备份数据存储在磁盘上、磁带上和使用 Azure 的云中。 有关详细信息，请参阅[准备数据存储](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)。

1. **设置保护代理**。 在要备份的计算机上安装保护代理。 有关详细信息，请参阅[部署 DPM 保护代理](https://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)。

## <a name="back-up-system-state-and-bare-metal"></a>备份系统状态和裸机

要备份系统状态和裸机：

1. 要打开"创建新保护组向导"，请在"备份服务器管理员控制台"中选择 **"保护** > **操作** > **创建保护组**"。

1. 在“选择保护组类型”**** 页上，选择“服务器”****，然后选择“下一步”****。

1. 在“选择组成员”**** 页上，展开计算机，然后选择“BMR”**** 或“系统状态”****。

    请记住，无法在不同组中为相同计算机保护 BMR 和系统状态。 此外在选择 BMR 时，系统状态会自动启用。 有关详细信息，请参阅[部署保护组](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)。

1. 在 **"选择数据保护方法"** 页上，选择如何处理短期备份和长期备份。 

    短期备份始终首先用于磁盘，可以选择使用 Azure 备份（短期或长期）从磁盘备份到 Azure。 长期备份到云的替代方法是设置为长期备份到与备份服务器连接的独立磁带设备或磁带库。

1. 在 **"选择短期目标**"页上，选择如何备份到磁盘上的短期存储：
    * 对于**保留范围**，选择将数据保留在磁盘上的时间。
    * 对于**同步频率**，选择运行磁盘增量备份的频率。 如果不想设置备份间隔，可以选择**在恢复点之前**。 备份服务器将在计划每个恢复点之前运行快速完整备份。

1. 如果要将数据存储在磁带上以进行长期存储，请在 **"指定长期目标"** 页上选择保留磁带数据的时间（1 到 99 年）。
    1. 对于**备份频率**，选择运行备份到磁带的频率。 频率基于您选择的保留范围：
        * 当保留期为 1 到 99 年时，您可以每天、每周、每两周、每月、每季度、每半年或每年备份一次。
        * 当保留范围为 1 到 11 个月时，您可以每天、每周、每两周或每月备份一次。
        * 当保留范围为 1 到 4 周时，您可以每天或每周备份。

    1. 在 **"选择磁带和库详细信息"** 页上，选择要使用的磁带和库。 还要选择是否应压缩和加密数据。

1. 在 **"查看磁盘分配**"页上，查看可用于保护组的存储池磁盘空间。

    * “总数据大小”**** 是要备份的数据的大小。
    * “要在 Azure 备份服务器上设置的磁盘空间”**** 是备份服务器为保护组推荐的空间。 备份服务器使用这些设置来选择理想的备份卷。 您可以在**磁盘分配详细信息**中编辑备份卷选项。
    * 对于工作负载，在下拉菜单中选择首选存储。 编辑会更改“可用磁盘存储”**** 窗格中的“存储总量”**** 和“可用存储”**** 值。 未预配的空间是备份服务器建议您添加到卷以确保顺利备份的存储量。

1. 在 **"选择副本创建方法"** 页上，选择如何处理初始完整数据复制。 

    如果选择通过网络复制，则建议选择非高峰时间。 如果数据量很大或者网络状态欠佳，请考虑使用可移动介质脱机复制数据。

1. 在 **"选择一致性检查选项"** 页上，选择如何自动执行一致性检查。 

    可以选择在副本数据变得不一致时或按照计划运行检查。 如果不想配置自动一致性检查，则可以随时运行手动检查。 要运行手动检查，请在备份服务器管理员控制台的“保护”**** 区域中，右键单击保护组，然后选择“执行一致性检查”****。

1. 如果选择使用 Azure 备份备份备份到云，请在 **"指定联机保护数据"** 页上选择要备份到 Azure 的工作负荷。

1. 在 **"指定联机备份计划"** 页上，选择增量备份到 Azure 的频率。 

    您可以安排备份每天、每周、每月和年运行。 您还可以选择运行备份的时间和日期。 备份一天最多可以进行两次。 每次运行备份时，都会在 Azure 中从存储在备份服务器磁盘上的备份数据的副本创建数据恢复点。

1. 在 **"指定联机保留策略"** 页上，选择从每日、每周、每月和每年备份中创建的恢复点如何保存在 Azure 中。

1. 在“选择联机复制”**** 页上，选择如何进行数据的初始完整复制。 

    您可以通过网络复制或脱机备份（脱机种子设定）。 脱机备份使用 Azure 导入功能。 有关详细信息，请参阅 [Azure 备份中的脱机备份工作流](offline-backup-azure-data-box.md)。

1. 在“摘要”**** 页上，检查设置。 选择“创建组”**** 之后，进行数据的初始复制。 数据复制完成后，在 **"状态"** 页上，保护组状态**正常**。 然后根据保护组设置进行备份。

## <a name="recover-system-state-or-bmr"></a>恢复系统状态或 BMR

可以将 BMR 或系统状态恢复到网络位置。 如果备份了 BMR，则使用 Windows 恢复环境 （WinRE） 启动系统并将其连接到网络。 然后使用 Windows Server 备份 (WSB) 从网络位置恢复。 如果备份系统状态，则只需使用 Windows 服务器备份从网络位置恢复。

### <a name="restore-bmr"></a>还原 BMR

要在备份服务器计算机上运行恢复：

1. 在 **"恢复"** 窗格中，查找要恢复的计算机。 然后选择**裸机恢复**。

1. 可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

1. 在 **"选择恢复类型"** 页上，选择 **"复制到网络文件夹**"。

1. 在 **"指定目标"** 页上，选择复制数据的目标。 

    请记住，目的地需要有足够的空间来容纳数据。 我们建议您为目标创建新文件夹。

1. 在 **"指定恢复选项"** 页上，选择安全设置。 然后选择是否使用基于存储区域网络 （SAN） 的硬件快照，以便更快地恢复。 此选项仅在：
    * 您有一个提供此功能的 SAN。 
    * 您可以创建和拆分克隆，使其可写。
    * 受保护的计算机和备份服务器计算机连接到同一网络。

1. 设置通知选项。 
1. 在“确认”**** 页上，选择“恢复”****。

要设置共享位置：

1. 在还原位置中，转到包含备份的文件夹。

1. 共享*WindowsImageBackup*上方一个级别的文件夹，以便共享文件夹的根目录是*WindowsImageBackup*文件夹。 

    如果不共享此文件夹，还原将无法找到备份。 要使用 WinRE 进行连接，您需要一个共享，您可以使用正确的 IP 地址和凭据在 WinRE 中访问该共享。

要还原系统：

1. 使用要还原的系统使用 Windows DVD 启动要还原映像的计算机。

1. 在第一页上，验证语言和区域设置。 在“安装”**** 页上，选择“修复计算机”****。

1. 在“系统恢复选项”**** 页上，选择“使用以前创建的系统映像还原计算机”****。

1. 在“选择系统镜像备份”**** 页上，选择“选择系统映像”**** > “高级”**** > “在网络上搜索系统映像”****。 如果出现警告，请选择“是”****。 转到共享路径，输入凭据，然后选择恢复点。 系统扫描该恢复点中可用的特定备份。 选择要使用的恢复点。

1. 在 **"选择如何还原备份页"上**，选择 **"格式化"和"重新分区磁盘**"。 在下一页上，验证设置。

1. 若要开始还原，请选择“完成”****。 需要重新启动。

### <a name="restore-system-state"></a>还原系统状态

要在备份服务器中运行恢复：

1. 在“恢复”**** 窗格中，找到要恢复的计算机，然后选择“裸机恢复”****。

1. 可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

1. 在 **"选择恢复类型"** 页上，选择 **"复制到网络文件夹**"。

1. 在 **"指定目标"** 页上，选择复制数据的位置。 

    请记住，您选择的目标需要有足够的空间用于数据。 我们建议您为目标创建新文件夹。

1. 在 **"指定恢复选项"** 页上，选择安全设置。 然后选择是否使用基于 SAN 的硬件快照，以便更快地恢复。 此选项仅在： 
    * 您有一个提供此功能的 SAN。
    * 您可以创建和拆分克隆，使其可写。 
    * 受保护的计算机和备份服务器连接到同一网络。

1. 设置通知选项。 
1. 在“确认”**** 页上，选择“恢复”****。

要运行 Windows 服务器备份：

1. 选择**操作** > **恢复** > **此服务器** > **下一个**。

1. 选择“另一台服务器”****，选择“指定位置类型”**** 页，然后选择“远程共享文件夹”****。 输入包含恢复点的文件夹的路径。

1. 在“选择恢复类型”**** 页上，选择“系统状态”****。

1. 在“选择系统状态恢复的位置”**** 页上，选择“原始位置”****。

1. 在“确认”**** 页上，选择“恢复”****。 

1. 还原之后，重新启动服务器。

您还可以在命令提示符下运行系统状态还原： 

1. 在要恢复的计算机上启动 Windows 服务器备份。 

1. 若要获取版本标识符，请在命令提示符处输入：

   ```wbadmin get versions -backuptarget \<servername\sharename\>```

1. 使用版本标识符启动系统状态还原。 在命令提示符处，输入： 

    ```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>```

1. 确认要开始恢复。 可以在命令提示符窗口中查看过程。 会创建还原日志。 

1. 还原之后，重新启动服务器。
