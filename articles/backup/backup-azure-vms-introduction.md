---
title: 关于 Azure VM 备份
description: 本文介绍 Azure 备份服务如何备份 Azure 虚拟机，以及如何遵循最佳做法。
ms.topic: conceptual
ms.date: 09/13/2019
ms.openlocfilehash: 8ffbf0d0164cbf6f085518d57566b0befde6e124
ms.sourcegitcommit: 509b39e73b5cbf670c8d231b4af1e6cfafa82e5a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/05/2020
ms.locfileid: "78363683"
---
# <a name="an-overview-of-azure-vm-backup"></a>Azure VM 备份概述

本文介绍[Azure 备份服务](backup-introduction-to-azure-backup.md)如何备份 azure 虚拟机（vm）。

## <a name="backup-process"></a>备份过程

下面是 Azure 备份如何完成 Azure Vm 备份：

1. 对于选择进行备份的 Azure Vm，Azure 备份会根据指定的备份计划启动备份作业。
1. 在第一次备份过程中，如果 VM 正在运行，则将在 VM 上安装备份扩展。
    - 对于 Windows Vm，安装了_VMSnapshot_扩展。
    - 对于 Linux Vm，安装了_VMSnapshotLinux_扩展。
1. 对于正在运行的 Windows Vm，使用 Windows 卷影复制服务（VSS）的备份坐标来获取 VM 的应用一致性快照。
    - 默认情况下，备份会进行完整的 VSS 备份。
    - 如果备份无法获取应用一致的快照，则它将使用基础存储的文件一致性快照（因为在 VM 停止时不会进行任何应用程序写入）。
1. 对于 Linux Vm，备份会进行文件一致性备份。 对于应用一致的快照，需要手动自定义预/后脚本。
1. 备份拍摄快照后，它将数据传输到保管库。
    - 备份通过并行备份每个 VM 磁盘来进行优化。
    - 对于每个要备份的磁盘，Azure 备份将读取磁盘上的块，并仅标识和传输自上次备份以来更改的数据块（增量）。
    - 快照数据可能不会立即复制到保管库。 在高峰期，可能需要好几个小时才能完成复制。 对于每日备份策略，VM 的总备份时间将小于24小时。
1. 启用 Azure 备份后对 Windows VM 所做的更改包括：
    - Microsoft Visual C++ 2013 可再发行组件（x64）-12.0.40660 已安装在 VM 中
    - 卷影复制服务（VSS）启动类型已从手动更改为自动
    - 已添加 IaaSVmProvider Windows 服务

1. 数据传输完成后，会删除快照并创建恢复点。

![Azure 虚拟机备份体系结构](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Azure VM 备份的加密

使用 Azure 备份备份 Azure VM 时，将使用存储服务加密 (SSE) 对 VM 进行静态加密。 Azure 备份还可以备份使用 Azure 磁盘加密加密的 Azure Vm。

**加密** | **详细信息** | **支持**
--- | --- | ---
**Azure 磁盘加密** | Azure 磁盘加密对 Azure Vm 的 OS 和数据磁盘进行加密。<br/><br/> Azure 磁盘加密与 BitLocker 加密密钥（BEKs）集成在一起，以密钥保管库作为机密进行保护。 Azure 磁盘加密还与 Azure Key Vault 密钥加密密钥（Kek）集成。 | Azure 备份仅支持备份仅通过 BEKs 加密的托管和非托管 Azure Vm，或将 BEKs 与 Kek 一起用于。<br/><br/> BEKs 和 Kek 都是备份和加密的。<br/><br/> 由于已备份 Kek 和 BEKs，因此具有必要权限的用户可以根据需要将密钥和机密还原到密钥保管库。 这些用户也可以恢复已加密的 VM。<br/><br/> 未经授权的用户或 Azure 无法读取加密的密钥和机密。
**SSE** | 使用 SSE，Azure 存储通过在存储数据之前自动加密数据，提供静态加密。 Azure 存储还会在检索数据前对其进行解密。 | Azure 备份使用 SSE 进行静态加密的 Azure Vm。

对于托管和非托管 Azure Vm，备份仅支持通过 BEKs 加密的 Vm，或支持通过 BEKs 加密的 Vm 和 Kek。

已备份的 BEKs （密码）和 Kek （密钥）已加密。 只有经过授权的用户才能将其还原到密钥保管库，才能读取和使用它们。 未经授权的用户或 Azure 均无法读取或使用备份的密钥或机密。

还备份了 BEKs。 因此，如果 BEKs 丢失，则授权用户可以将 BEKs 还原到密钥保管库，并恢复已加密的 Vm。 只有具有所需权限级别的用户可以备份和还原加密的 Vm 或密钥和机密。

## <a name="snapshot-creation"></a>快照创建

Azure 备份根据备份计划拍摄快照。

- **Windows vm：** 对于 Windows Vm，备份服务会与 VSS 协调使用 VM 磁盘的应用一致性快照。  默认情况下，Azure 备份会进行完整的 VSS 备份（它会在备份时截断应用程序的日志，如 SQL Server，以获取应用程序级别一致的备份）。  如果在 Azure VM 备份上使用 SQL Server 数据库，则可以修改设置以执行 VSS 副本备份（以保留日志）。 有关详细信息，请参阅[此文章](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues)。

- **Linux vm：** 若要获取 Linux Vm 的应用一致性快照，请使用 Linux 前脚本和后脚本框架编写你自己的自定义脚本，以确保一致性。

  - Azure 备份仅调用你编写的预/后脚本。
  - 如果执行前脚本和后脚本成功执行，Azure 备份会将恢复点标记为应用程序一致。 但是，当你使用自定义脚本时，最终将负责应用程序一致性。
  - [了解](backup-azure-linux-app-consistent.md)有关如何配置脚本的详细信息。

### <a name="snapshot-consistency"></a>快照一致性

下表说明了不同类型的快照一致性：

**快照** | **详细信息** | **恢复** | **注意事项**
--- | --- | --- | ---
**应用程序一致** | 应用一致性备份捕获内存内容和挂起的 I/O 操作。 应用一致的快照使用 VSS 编写器（或适用于 Linux 的预/后脚本）来确保应用程序数据的一致性，然后再进行备份。 | 使用应用一致性快照恢复 VM 时，VM 将启动。 没有数据损坏或丢失。 应用以一致的状态启动。 | Windows：所有 VSS 编写器均已成功<br/><br/> Linux：预/后脚本已配置且已成功
**文件系统一致** | 文件系统一致性备份通过对所有文件同时拍摄快照提供一致性。<br/><br/> | 使用文件系统一致快照恢复 VM 时，VM 将启动。 没有数据损坏或丢失。 应用需要实现自己的“修复”机制以确保还原的数据一致。 | Windows：某些 VSS 编写器失败 <br/><br/> Linux：默认（如果预/后脚本未配置或失败）
**故障一致** | 如果 Azure VM 在备份时关闭，通常会发生崩溃一致的快照。 仅会捕获和备份备份时磁盘上已存在的数据。 | 从 VM 启动过程开始，后跟磁盘检查以修复损坏错误。 在崩溃之前未传输到磁盘的任何内存中数据或写入操作都将丢失。 应用实现自己的数据验证。 例如，数据库应用可以使用其事务日志进行验证。 如果事务日志中的条目不在数据库中，则数据库软件会将事务回滚，直到数据一致。 | VM 处于关闭（已停止/已解除分配）状态。

## <a name="backup-and-restore-considerations"></a>备份和还原注意事项

**注意事项** | **详细信息**
--- | ---
**磁盘** | VM 磁盘的备份是并行的。 例如，如果 VM 有四个磁盘，备份服务会尝试并行备份所有4个磁盘。 备份是增量式的（仅备份已更改的数据）。
**计划** |  若要减少备份流量，请在一天的不同时间备份不同的 Vm，并确保该时间不重叠。 同时备份 VM 会导致流量拥塞。
**准备备份** | 请记住准备备份所需的时间。 准备时间包括安装或更新备份扩展，并根据备份计划触发快照。
**数据传输** | 请考虑 Azure 备份所需的时间，以确定先前备份的增量更改。<br/><br/> 在增量备份中，Azure 备份通过计算块的校验和来确定更改。 如果更改了某个块，则会将其标记为传输到保管库。 服务将分析标识的块，以尝试进一步将传输的数据量降至最低。 评估所有已更改的块后，Azure 备份会将更改传输到保管库。<br/><br/> 创建快照之后，可能要经过一段滞后时间才会将它复制到保管库。<br/><br/> 在高峰时间，处理备份最多需要8个小时。 对于每日备份，VM 的备份时间小于 24 小时。
**初始备份** | 虽然增量备份的总备份时间小于24小时，但第一次备份可能不是这样。 初始备份所需的时间取决于数据大小和处理备份的时间。
**还原队列** | Azure 备份过程会同时从多个存储帐户还原作业，并将还原请求放入队列中。
**还原副本** | 在还原过程中，将保管库中的数据复制到存储帐户。<br/><br/> 还原的总时间取决于每秒 i/o 操作数（IOPS）和存储帐户的吞吐量。<br/><br/> 若要减少复制时间，请选择一个不带其他应用程序写入和读取负载的存储帐户。

### <a name="backup-performance"></a>备份性能

这些常见方案可能会影响总备份时间：

- **将新磁盘添加到受保护的 AZURE VM：** 如果 VM 正在进行增量备份，并且添加了新磁盘，则备份时间将会增加。 由于新磁盘的初始复制，以及现有磁盘的增量复制，总备份时间可能持续超过24小时。
- **碎片磁盘：** 磁盘更改连续时，备份操作的速度更快。 如果更改分散在磁盘的各个位置并出现碎片，则备份会变慢。
- **磁盘改动：** 如果正在进行增量备份的受保护磁盘的每日改动超过 200 GB，则备份可能需要很长时间（超过8小时）才能完成。
- **备份版本：** 最新版本的备份（称为即时还原版本）使用比校验和比较来识别更改的更优化的进程。 但是，如果使用的是即时还原，并且删除了备份快照，则备份将切换到校验和比较。 在这种情况下，备份操作将超过24小时（或失败）。

## <a name="best-practices"></a>最佳做法

配置 VM 备份时，我们建议遵循以下做法：

- 修改策略中设置的默认计划时间。 例如，如果策略中的默认时间为 12:00 AM，则将计时递增几分钟，以便以最佳方式使用资源。
- 如果要从单个保管库还原 Vm，强烈建议你使用不同的[常规用途 v2 存储帐户](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)，以确保不会限制目标存储帐户。 例如，每个 VM 必须具有不同的存储帐户。 例如，如果还原了10个 Vm，请使用10个不同的存储帐户。
- 对于使用高级存储的 Vm 的备份，使用 "即时还原"，我们建议分配总分配存储空间的*50%* 可用空间（**仅限**第一次备份需要）。 第一次备份完成后，不需要50% 的可用空间
- 对于在基础结构即服务（IaaS） VM 上运行的应用程序，每个存储帐户的磁盘数限制相对于磁盘的访问量。 一般来说，如果单个存储帐户上存在5到10个磁盘或更多磁盘，则通过将一些磁盘移动到不同的存储帐户来平衡负载。

## <a name="backup-costs"></a>备份成本

使用 Azure 备份备份的 Azure VM 采用 [Azure 备份定价](https://azure.microsoft.com/pricing/details/backup/)。

只有在第一次成功完成备份后，才会开始计费。 存储和受保护的 VM 也会在此同时开始计费。 只要 VM 的任何备份数据存储在保管库中，就会继续计费。 如果对 VM 停止保护，但保管库中存在该 VM 的备份数据，则会继续计费。

针对特定 VM 的计费仅在停止保护并且删除全部备份数据后才会停止。 当停止保护并且没有活动的备份作业时，最后一个成功的 VM 备份的大小将成为用于每月帐单的受保护实例大小。

受保护实例的大小计算基于 VM 的*实际*大小。 VM 的大小为 VM 中所有数据的总和，不包括临时存储。 定价基于数据磁盘上存储的实际数据，而不是附加到 VM 的每个数据磁盘的最大支持大小。

同样，备份存储计费基于 Azure 备份中存储的数据量，即每个恢复点中实际数据的总和。

例如，采用 A2 标准大小的 VM，其中包含两个附加的数据磁盘，每个数据磁盘的最大大小为 32 TB。 下表显示了每个磁盘上存储的实际数据：

**磁盘** | **最大大小** | **实际存在的数据**
--- | --- | ---
操作系统磁盘 | 32 TB | 17 GB
本地/临时磁盘 | 135 GB | 5 GB（不包括在备份中）
数据磁盘 1 | 32 TB| 30 GB
数据磁盘 2 | 32 TB | 0 GB

此示例中，VM 的实际大小为 17 GB + 30 GB + 0 GB = 47 GB。 此受保护实例的大小（47 GB）成为每月计费的基础。 随着 VM 中数据量的增长，用于计费更改的受保护实例大小将与之匹配。

## <a name="next-steps"></a>后续步骤

现在，[准备 AZURE VM 备份](backup-azure-arm-vms-prepare.md)。
