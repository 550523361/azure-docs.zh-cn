---
title: 关于 Azure VM 备份
description: 了解 Azure VM 备份，并记下一些最佳做法。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/04/2019
ms.author: raynew
ms.openlocfilehash: 93be913182db56941c346ef0cad47f70c0d614c9
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2019
ms.locfileid: "64706832"
---
# <a name="about-azure-vm-backup"></a>关于 Azure VM 备份

本文介绍如何[Azure 备份服务](backup-introduction-to-azure-backup.md)备份 Azure 虚拟机 (Vm)。

## <a name="backup-process"></a>备份过程

下面是如何备份 Azure 执行一次备份 Azure vm:

1. 对于选择进行备份的 Azure Vm，Azure 备份启动备份作业根据你指定的备份计划。
1. 在过程中的第一个备份，备份扩展被安装在 VM 上如果 VM 正在运行。
    - 适用于 Windows Vm _VMSnapshot_安装扩展。
    - 适用于 Linux Vm _VMSnapshotLinux_安装扩展。
1. 对于正在运行的 Windows Vm，备份协调与 Windows 卷影复制服务 (VSS) 来创建 VM 应用一致快照。
    - 默认情况下，备份将完整的 VSS 备份。
    - 如果备份不能使应用一致的快照，然后它采用文件的一致的快照基础存储的 （因为在 VM 停止时，会不发生任何应用程序写入）。
1. 对于 Linux Vm，备份所需的文件一致性备份。 对于应用一致性快照，您需要手动自定义前期/后期脚本。
1. 备份获取快照后，它将数据传输到保管库。
    - 通过并行每个 VM 磁盘备份，备份进行了优化。
    - 对于每个要备份的磁盘，Azure 备份读取磁盘上的块和标识并传输自上次备份以来发生更改 （增量） 的数据块。
    - 快照数据可能不会立即复制到保管库。 在高峰期，可能需要好几个小时才能完成复制。 为 vm 备份总时间将是 24 小时内每日备份策略。
 1. 后对其启用 Azure 备份到 Windows VM 所做的更改是：
    -   Microsoft Visual C++ 2013 Redistributable(x64)-12.0.40660 安装在 VM 中
    -   卷影复制服务 (VSS) 从手动更改为自动启动类型
    -   添加 IaaSVmProvider Windows 服务

1. 数据传输完成后，会删除快照，并创建恢复点。

![Azure 虚拟机备份体系结构](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Azure VM 备份的加密

使用 Azure 备份备份 Azure VM 时，将使用存储服务加密 (SSE) 对 VM 进行静态加密。 Azure 备份还可以备份使用 Azure 磁盘加密加密的 Azure Vm。

**加密** | **详细信息** | **支持**
--- | --- | ---
**Azure 磁盘加密** | Azure 磁盘加密加密的 Azure Vm 的 OS 和数据磁盘。<br/><br/> Azure 磁盘加密与 BitLocker 加密密钥 (BEKs)，密钥保管库中以机密形式进行保护。 Azure 磁盘加密还与 Azure 密钥保管库的密钥加密密钥 (Kek) 集成。 | Azure 备份支持加密仅，BEKs 或 BEKs Kek 以及托管和非托管 Azure Vm 的备份。<br/><br/> 备份和加密 BEKs 和 Kek。<br/><br/> 由于备份的 Kek 和 BEKs，具有所需的权限的用户可以还原密钥和机密回如果需要在密钥保管库。 这些用户也可以恢复加密的 VM。<br/><br/> 无法读取加密的密钥和机密，未经授权的用户或 azure。
**SSE** | 使用 SSE，Azure 存储通过自动存储在存储之前加密数据提供静态加密。 Azure 存储还检索之前解密数据。 | Azure 备份有关的 Azure Vm 的静态加密使用 SSE。

适用于托管和非托管 Azure Vm 备份支持仅使用 BEKs 加密的 Vm 或使用 BEKs 和 Kek 加密的 Vm。

备份 BEKs （密码） 和 Kek （键） 进行加密。 它们可以读取和仅当它们正在还原回密钥保管库获得授权的用户时使用。 未经授权的用户既不 Azure 可以读取或使用备份密钥或机密。

BEKs 还应备份。 因此，如果 BEKs 都将丢失，经过授权的用户可以将 BEKs 还原到密钥保管库和恢复加密的 Vm。 只有具有必要的权限级别的用户可以备份和还原加密 Vm 或密钥和机密。

## <a name="snapshot-creation"></a>快照创建

Azure 备份所需的备份计划日程的快照。

- **Windows Vm:** 对于 Windows Vm，备份服务可协调与 VSS 快照应用一致的 VM 磁盘。

  - 默认情况下，Azure 备份会获取完整的 VSS 备份。 [了解详细信息](https://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
  - 若要更改该设置，以便 Azure 备份获取 VSS 复制备份，请在命令提示符下设置以下注册表项：

    **REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**

- **Linux Vm:** 若要创建的 Linux Vm 应用一致性快照，使用 Linux 前脚本和操作后脚本框架来编写您自己自定义脚本，以确保一致性。

  - Azure 备份将调用由您编写的前期/后期脚本。
  - 如果前脚本和后脚本成功执行，Azure 备份将标记为应用程序一致的恢复点。 但是，当您使用自定义脚本，您最终负责应用程序一致性。
  - [了解详细信息](backup-azure-linux-app-consistent.md)有关如何配置脚本。

### <a name="snapshot-consistency"></a>快照一致性

下表介绍了不同类型的快照一致性：

**快照** | **详细信息** | **恢复** | **注意事项**
--- | --- | --- | ---
**应用程序一致** | 应用一致性备份捕获内存内容和挂起的 I/O 操作。 应用一致性快照使用 VSS 编写器 （或适用于 Linux 的前期/后期脚本） 以确保应用程序数据的一致性之前进行一次备份。 | 当您要恢复的应用一致性快照的 VM 时，VM 会启动。 没有数据损坏或丢失。 应用以一致的状态启动。 | Windows:所有 VSS 编写器均成功<br/><br/> Linux：前/后脚本已配置并成功
**文件系统一致** | 文件系统一致的备份提供了通过在同一时间拍摄快照的所有文件的一致性。<br/><br/> | 当您要恢复的文件系统一致快照的 VM 时，VM 会启动。 没有数据损坏或丢失。 应用需要实现自己的“修复”机制以确保还原的数据一致。 | Windows:部分 VSS 编写器失败 <br/><br/> Linux：默认值 （如果前期/后期脚本不是配置或失败）
**故障一致** | 如果 Azure VM 关闭在备份时，通常会出现崩溃一致的快照。 仅会捕获和备份备份时磁盘上已存在的数据。<br/><br/> 存在崩溃一致性问题的恢复点不能保证操作系统或应用的数据一致性。 | 虽然不能保证，但通常启动 VM，，然后它启动磁盘检查以修复损坏错误。 任何内存中数据或写入操作未传输到磁盘之前都将丢失在发生崩溃。 应用实现自己的数据验证。 例如，数据库应用程序可以使用其事务日志进行验证。 如果事务日志中的条目不在数据库中，数据库软件将执行返回直到数据一致回滚事务。 | VM 处于关闭状态

## <a name="backup-and-restore-considerations"></a>备份和还原注意事项

**注意事项** | **详细信息**
--- | ---
**磁盘** | VM 磁盘的备份是并行的。 例如，如果 VM 有四个磁盘，备份服务会尝试将备份并行中的所有四个磁盘。 备份是增量式的（仅备份已更改的数据）。
**计划** |  若要减少备份流量，在一天中的不同时间备份不同 Vm，并确保的时间不重叠。 同时备份 VM 会导致流量拥塞。
**准备备份** | 请注意若要准备备份所需的时间。 准备时间包括安装或更新备份扩展以及触发快照的备份计划日程。
**数据传输** | 请考虑 Azure 备份来标识以前的备份中的增量更改所需的时间。<br/><br/> 在增量备份，Azure 备份将确定所做的更改通过计算块的校验和。 如果块进行了更改，将被标记为传输到保管库。 该服务将分析标识的块，以进一步最小化要传输的数据量。 评估所有已更改的块之后, Azure 备份将更改传输到保管库。<br/><br/> 创建快照之后，可能要经过一段滞后时间才会将它复制到保管库。<br/><br/> 在高峰时间，可能需要最长八小时备份才能进行处理。 对于每日备份，VM 的备份时间小于 24 小时。
**初始备份** | 虽然增量备份的总备份时间是 24 小时内，但这可能不是第一次备份这种情况。 初始备份所需的时间将取决于数据和处理备份时的大小。
**还原队列** | Azure 备份进程一次从多个存储帐户还原作业并在队列中放入还原请求。
**还原副本** | 在还原过程中，将保管库中的数据复制到存储帐户。<br/><br/> 总还原时间取决于每秒 (操作数 IOPS) 和存储帐户的吞吐量的 I/O 操作数。<br/><br/> 若要减少复制时间，请选择一个不带其他应用程序写入和读取负载的存储帐户。

### <a name="backup-performance"></a>备份性能

这些常见的方案可能会影响备份总时间：

- **将新磁盘添加到受保护的 Azure VM:** 如果 VM 正在进行增量备份，添加新磁盘备份的时间会增加。 备份总时间可能会由于初始复制的新磁盘，以及现有磁盘的增量复制持续时间超过 24 小时。
- **零碎的磁盘：** 连续磁盘更改时，备份操作进行更快。 如果更改分散在磁盘的各个位置并出现碎片，则备份会变慢。
- **磁盘变动量：** 如果受保护的正在进行增量备份的磁盘有每日变动量超过 200 GB，备份可能需要很长时间 （超过 8 个小时） 才能完成。
- **备份版本：** 备份 （即所谓的即时还原版本） 的最新版本可用于校验和比较更优化的进程标识更改。 但如果您在使用即时还原并已删除的备份快照，备份将切换到校验和比较。 在这种情况下，备份操作将超过 24 小时 （或失败）。

## <a name="best-practices"></a>最佳做法

在配置 VM 备份时，我们建议遵循以下做法：

- 修改策略中设置的默认计划时间。 例如，如果在策略中的默认时间为上午 12:00，递增几分钟的时间，以便以最佳方式使用的资源。
- 对于使用高级存储的 Vm 的备份，我们建议运行最新版本的 Azure 备份 ([即时还原](backup-instant-restore-capability.md))。 如果你不运行的最新版本，备份会大约分配的总存储空间的 50%。 备份服务需要此空间来将快照复制到同一存储帐户并将其传输到保管库。
- 如果要从单个保管库还原 Vm，我们强烈建议你使用不同[常规用途 v2 存储帐户](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)以确保目标存储帐户不会受到限制。 例如，每个虚拟机必须具有不同的存储帐户。 例如，如果 10 个 Vm 已恢复，则使用 10 个不同的存储帐户。
- 将在几分钟内完成从常规用途 v1 存储层 （快照） 还原，因为快照处于相同的存储帐户。 从常规用途 v2 存储层 （保管库） 中的进行恢复要花费数小时。 在数据是在常规用途 v1 存储中可用的情况下，我们建议你使用[即时还原](backup-instant-restore-capability.md)用于快速还原功能。 （如果必须从保管库还原数据，然后它将需要更多的时间。）
- 对每个存储帐户磁盘数的限制是相对于程度磁盘正在访问的一个基础结构即服务 (IaaS) VM 运行的应用程序。 作为一种常规做法，情况下，如果在单个存储帐户上存在 5 到 10 个磁盘或多个，平衡负载通过移动一些单独的存储帐户的磁盘。

## <a name="backup-costs"></a>备份成本

使用 Azure 备份备份的 Azure VM 采用 [Azure 备份定价](https://azure.microsoft.com/pricing/details/backup/)。

第一个备份成功完成之前，不会开始计费。 存储和受保护的 VM 也会在此同时开始计费。 只要 VM 的任何备份数据存储在保管库，就会持续计费。 如果对 VM 停止保护，但保管库中存在该 VM 的备份数据，则会继续计费。

针对特定 VM 的计费仅在停止保护并且删除全部备份数据后才会停止。 当停止保护并且没有活动的备份作业时，最后一个成功的 VM 备份的大小将成为用于每月帐单的受保护实例大小。

受保护实例大小计算基于*实际*VM 的大小。 VM 的大小是在 VM 中，不包括临时存储的所有数据之和。 定价基于具有存储在数据磁盘上，不在最大值受支持的大小为每个数据磁盘附加到 VM 的实际数据。

与此类似，备份存储的收费根据存储在 Azure 备份，即每个恢复点中的实际数据之和的数据量。

例如，需要有两个附加数据磁盘的最大大小为 4 TB 的 A2 标准大小的 VM。 下表显示了每个这些磁盘上存储的实际数据：

**磁盘** | **最大大小** | **实际存在的数据**
--- | --- | ---
操作系统磁盘 | 4095 GB | 17 GB
本地/临时磁盘 | 135 GB | 5 GB（不包括在备份中）
数据磁盘 1 | 4095 GB | 30 GB
数据磁盘 2 | 4095 GB | 0 GB

此示例中，VM 的实际大小为 17 GB + 30 GB + 0 GB = 47 GB。 此受保护实例大小 (47 GB) 将成为每月帐单的基础。 当在 VM 中的数据量增大时，受保护实例大小使用的计费更改来匹配。

## <a name="next-steps"></a>后续步骤

现在，[为 Azure VM 备份准备](backup-azure-arm-vms-prepare.md)。
