---
title: 使用 MABS 备份超 V 虚拟机
description: 本文包含使用 Microsoft Azure 备份服务器 （MABS） 备份和恢复虚拟机的过程。
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: 00d1dd04522c51e4d68450a7b8f25d7159d63724
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2020
ms.locfileid: "78255062"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>使用 Azure 备份服务器备份超 V 虚拟机

本文介绍如何使用 Microsoft Azure 备份服务器 （MABS） 备份 Hyper-V 虚拟机。

## <a name="supported-scenarios"></a>支持的方案

MABS 可以在以下情况下备份在 Hyper-V 主机服务器上运行的虚拟机：

- **带有本地或直接存储的虚拟机** - 备份托管在具有本地存储或直接连接存储的 Hyper-V 主机独立服务器上的虚拟机。 例如：硬盘驱动器、存储区域网络 （SAN） 设备或网络连接存储 （NAS） 设备。 必须在所有主机上安装 MABS 保护代理。

- **群集中带有 CSV 存储的虚拟机** - 备份托管在具有群集共享卷 (CSV) 存储的 Hyper-V 群集上的虚拟机。 MABS 保护代理安装在每个群集节点上。

## <a name="host-versus-guest-backup"></a>主机与来宾备份

MABS 可以执行超 V VM 的主机或来宾级备份。 在主机级别，MABS 保护代理安装在 Hyper-V 主机服务器或群集上，并保护该主机上运行的整个 VM 和数据文件。   在来宾级别，代理安装在每台虚拟机上，并保护该计算机上存在的工作负载。

这两种方法各有优点和缺点：

- 主机级备份是灵活的，因为它们工作，无论来宾计算机上运行的操作系统类型如何，并且不需要在每个 VM 上安装 MABS 保护代理。 如果部署主机级备份，则可以恢复整个虚拟机或文件和文件夹（项目级恢复）。

- 如果要保护在虚拟机上运行的特定工作负载，来宾级备份非常有用。 在主机级别，您可以恢复整个 VM 或特定文件，但它不会在特定应用程序的上下文中提供恢复。 例如，要从备份的 VM 恢复特定的 SharePoint 项，应执行该 VM 的来宾级备份。 如果要保护存储在直通磁盘上的数据，请使用来宾级备份。 传递允许虚拟机直接访问存储设备，并且不会将虚拟卷数据存储在 VHD 文件中。

## <a name="how-the-backup-process-works"></a>备份过程的工作原理

MABS 使用 VSS 执行备份，如下所示。 对本说明中的步骤进行了编号以便于理解。

1. 基于 MABS 块的同步引擎是受保护虚拟机的初始副本，并确保虚拟机的副本完整且一致。

2. 制作和验证初始副本后，MABS 使用超 V VSS 编写器捕获备份。 VSS 编写器提供与 MABS 服务器同步的数据一致的磁盘块集。 此方法提供了 MABS 服务器"完全备份"的好处，同时最大限度地减少了必须通过网络传输的备份数据。

3. 运行 Hyper-V 的服务器上的 MABS 保护代理使用现有的 Hyper-V API 来确定受保护的虚拟机是否也支持 VSS。

   - 如果虚拟机符合联机备份的要求并安装了 Hyper-V 集成服务组件，则 Hyper-V VSS 编写器会以递归方式将 VSS 请求转发至虚拟机上所有可感知 VSS 的进程。 此操作无需在虚拟机上安装 MABS 保护代理。 此递归的 VSS 请求可让 Hyper-V VSS 编写器确保磁盘写入操作保持同步，从而在不会丢失数据的情况下捕获 VSS 快照。

     Hyper-V 集成服务组件在虚拟机上的卷影复制服务 (VSS) 中调用 Hyper-V VSS 编写器，以确保虚拟机的应用程序数据处于一致的状态。

   - 如果虚拟机不符合联机备份要求，MABS 会自动使用 Hyper-V API 在虚拟机捕获数据文件之前暂停虚拟机。

4. 在虚拟机的初始基线副本与 MABS 服务器同步后，对虚拟机资源所做的所有更改都捕获到新的恢复点中。 恢复点代表着虚拟机在特定时间的一致状态。 恢复点捕获每天可以至少发生一次。 创建新恢复点时，MABS 与 Hyper-V VSS 编写器一起使用块级复制，以确定在创建最后一个恢复点后，服务器上已更改了哪些块运行 Hyper-V。 然后，这些数据块将传输到 MABS 服务器，并应用于受保护数据的副本。

5. MABS 服务器在承载恢复数据的卷上使用 VSS，以便有多个卷影副本可用。 这些卷影副本的每一个都提供单独的恢复。 VSS 恢复点存储在 MABS 服务器上。 在运行 Hyper-V 的服务器上制作的临时副本仅在 MABS 同步期间存储。

>[!NOTE]
>
>从 Windows Server 2016 开始，Hyper-V 虚拟硬盘具有称为弹性更改跟踪 （RCT） 的内置更改跟踪。 MABS 使用 RCT（Hyper-V 中的本机更改跟踪），这减少了在 VM 崩溃等方案中耗时的一致性检查的需要。 与基于 VSS 快照的备份提供的更改跟踪相比，RCT 提供更好的复原能力。 在执行任何一致性检查期间，MABS V3 只会传输更改的数据，因而可以进一步优化网络和存储消耗。

## <a name="backup-prerequisites"></a>备份先决条件

以下是使用 MABS 备份超 V 虚拟机的先决条件：

|先决条件|详细信息|
|------------|-------|
|MABS 先决条件|- 如果要对虚拟机执行项目级恢复（恢复文件、文件夹、卷），则需要在 MABS 服务器上安装 Hyper-V 角色。  如果只想恢复虚拟机，而不是项目级别，则不需要该角色。<br />- 您可以在一台 MABS 服务器上保护多达 800 台 100 GB 的虚拟机，并允许支持更大群集的多个 MABS 服务器。<br />- MABS 将页面文件从增量备份中排除，以提高虚拟机备份性能。<br />- MABS 可以备份 Hyper-V 服务器或群集与 MABS 服务器位于同一域中，也可以备份在子域或受信任域中。 如果要在工作组或不受信任的域中备份 Hyper-V，则需要设置身份验证。 对于单个 Hyper-V 服务器，可以使用 NTLM 或证书身份验证。 对于群集，只能使用证书身份验证。<br />不支持在传递磁盘上使用主机级备份来备份虚拟机数据。 在这种情况下，我们建议您使用主机级备份来备份 VHD 文件和来宾级备份，以备份主机上不可见的其他数据。<br />   -您可以备份存储在重复数据消除卷上的 VM。|
|Hyper-V VM 先决条件|- 在虚拟机上运行的集成组件版本应与 Hyper-V 主机的版本相同。 <br />-   对于每个虚拟机备份，托管虚拟磁盘文件的卷上都需要有可用空间，以允许 Hyper-V 在备份期间为差异磁盘 (AVHD) 提供足够的空间。 该空间必须至少等于计算机**初始磁盘大小\*改动率\*备份**窗口时间。 如果在群集上运行多个备份，将需要足够的存储容量以容纳每个使用该计算的虚拟机的 AVHD。<br />- 要备份位于运行 Windows Server 2012 R2 的 Hyper-V 主机服务器上的虚拟机，虚拟机应指定 SCSI 控制器，即使它未连接到任何内容。 （在 Windows Server 2012 R2 联机备份中，Hyper-V 主机在 VM 中装载新的 VHD，然后将其卸载。 只有 SCSI 控制器可以支持此功能，因此虚拟机的在线备份是必需的。  如果没有此设置，当您尝试备份虚拟机时，将发出事件 ID 10103。|
|Linux 系统先决条件|- 您可以使用 MABS 备份 Linux 虚拟机。 仅支持文件一致的快照。|
|备份带有 CSV 存储的虚拟机|-   对于 CSV 存储，请在 Hyper-V 服务器上安装卷影复制服务 (VSS) 硬件提供程序。 请与你的存储区域网络 (SAN) 供应商联系，获取 VSS 硬件提供程序。<br />- 如果单个节点在 CSV 群集中意外关闭，MABS 将对该节点上运行的虚拟机执行一致性检查。<br />-   如果需要重启在 CSV 群集上启用了 BitLocker 驱动器加密的 Hyper-V 服务器，必须为 Hyper-V 虚拟机运行一致性检查。|
|备份带有 SMB 存储的虚拟机|-   开启运行 Hyper-V 的服务器上的自动装入功能，以启用虚拟机保护。<br />   -   禁用 TCP 烟囱卸载。<br />-   确保所有 Hyper-V machine$ 帐户都具有特定远程 SMB 文件共享的完全权限。<br />- 确保所有虚拟机组件在恢复到备用位置期间的文件路径小于 260 个字符。 如果没有，恢复可能会成功，但 Hyper-V 将无法装载虚拟机。<br />- 不支持以下方案：<br />     虚拟机的某些组件位于本地卷上且某些组件位于远程卷上的部署;用于存储位置文件服务器的 IPv4 或 IPv6 地址，以及将虚拟机恢复到使用远程 SMB 共享的计算机。<br />- 您需要在每个 SMB 服务器上启用文件服务器 VSS 代理服务 - 将其添加到**添加角色和功能** > **选择服务器角色** > **文件和存储服务** > **文件服务** > **文件服务** > **服务器 VSS 代理服务**。|

## <a name="back-up-virtual-machines"></a>备份虚拟机

1. 设置[MABS 服务器](backup-azure-microsoft-azure-backup.md)和[存储](backup-mabs-add-storage.md)。 设置存储时，请使用这些存储容量准则。
   - 平均虚拟机大小 - 100 GB
   - 每个 MABS 服务器的虚拟机数 - 800
   - 800 个虚拟机的总大小 - 80 TB
   - 备份存储所需的空间 - 80 TB

2. 在 Hyper-V 服务器或 Hyper-V 群集节点上设置 MABS 保护代理。 如果您正在执行来宾级备份，您将在要在来宾级别备份的 VM 上安装代理。

3. 在 MABS 管理员控制台中，单击 **"保护** > **创建保护组**"以打开 **"创建新保护组**"向导。

4. 在“选择组成员”**** 页上，选择想要从其所在的 HYPER-V 主机服务器中保护的虚拟机。 建议将具有相同保护策略的所有虚拟机放在一个保护组。 可以启用归置以有效地使用空间。 通过归置，可以查找同一磁盘或磁带存储上的不同保护组中的数据，从而使多个数据源具有一个副本和恢复点卷。

5. 在 **“选择数据保护方法”** 页上，指定保护组名称。 如果要使用 Azure 备份服务将数据备份到 Azure 中，请选择“我想使用磁盘进行短期保护” **** 并选择“我需要在线保护” **** 。

6. 在 **"指定短期目标** > **保留范围**"中，指定要保留磁盘数据的时间。 在**同步频率**中，指定应运行数据的增量备份的频率。 或者，可以启用“就在恢复点之前” **** 而不是选择增量备份的间隔。 启用此设置后，MABS 将在每个计划恢复点之前运行快速完整备份。

    > [!NOTE]
    >
    >要保护应用程序工作负荷时，如果应用程序支持增量备份，则会按照“同步频率”创建恢复点。 如果没有，则 MABS 运行快速完整备份，而不是增量备份，并根据快速备份计划创建恢复点。

7. 在 **"查看磁盘分配**"页中，查看为保护组分配的存储池磁盘空间。

   **总数据大小**是要备份的数据的大小，在**MABS 上预配的磁盘空间是 MABS**建议保护组的空间。 MABS 根据设置选择理想的备份卷。 但是，您可以在**磁盘分配详细信息**中编辑备份卷选项。 对于工作负荷，请在下拉菜单中选择首选的存储。 编辑会更改“可用磁盘存储”**** 窗格中的“存储总量”**** 和“可用存储”**** 值。 预配不足的空间是 MABS 建议您添加到卷中的存储量，以便将来顺利继续备份。

8. 在 **“选择副本创建方法”** 页上，指定如何在保护组中对数据进行初始复制。 如果您选择**通过网络自动复制**，我们建议您选择非高峰时间。 对于大量数据或低于最佳网络条件，请考虑选择**手动**，这需要使用可移动媒体脱机复制数据。

9. 在 **“一致性检查选项”** 页上，选择你希望如何自动执行一致性检查。 可以使检查仅当副本数据不一致时才运行，或按照计划运行。 如果不想配置自动一致性检查，可通过右键单击保护组，选择“执行一致性检查”****，来随时运行手动检查。

    创建保护组后，数据按照所选方法开始初始复制。 初始复制完成后，各个备份按照保护组设置进行。 如果需要恢复备份的数据，请注意以下事项：

## <a name="back-up-virtual-machines-configured-for-live-migration"></a>备份针对实时迁移配置的虚拟机

当虚拟机参与实时迁移时，只要在 Hyper-V 主机上安装 MABS 保护代理，MABS 将继续保护虚拟机。 MABS 保护虚拟机的方式取决于所涉及的实时迁移类型。

**群集内的实时迁移**- 当在群集 MABS 中迁移虚拟机时，MABS 会检测迁移，并从新的群集节点备份虚拟机，而无需用户干预。 由于存储位置未更改，MABS 将继续进行快速完整备份。

**群集外部的实时迁移**- 当虚拟机在独立服务器、不同群集之间迁移或独立服务器和群集之间时，MABS 会检测迁移，无需用户干预即可备份虚拟机。

### <a name="requirements-for-maintaining-protection"></a>维持保护的要求

以下是在实时迁移期间维持保护的要求：

- 虚拟机的 Hyper-V 主机必须位于系统中心 VMM 云中，位于 VMM 服务器上，至少使用 SP1 运行系统中心 2012。

- 必须在所有 Hyper-V 主机上安装 MABS 保护代理。

- MABS 服务器必须连接到 VMM 服务器。 VMM 云中的所有 Hyper-V 主机服务器也必须连接到 MABS 服务器。 这允许 MABS 与 VMM 服务器通信，以便 MABS 可以找出虚拟机当前正在运行的 Hyper-V 主机服务器，并从该 Hyper-V 服务器创建新备份。 如果无法与 Hyper-V 服务器建立连接，则备份将失败，并发出 MABS 保护代理无法访问的消息。

- 所有 MABS 服务器、VMM 服务器和超 V 主机服务器必须位于同一域中。

### <a name="details-about-live-migration"></a>实时迁移的详细信息

在实时迁移期间进行备份时，请注意以下几点：

- 如果实时迁移传输存储，MABS 会对虚拟机执行完全一致性检查，然后继续进行快速完整备份。 当发生存储的实时迁移时，Hyper-V 会重新组织虚拟硬盘 （VHD） 或 VHDX，从而导致 MABS 备份数据大小的一次性峰值。

- 在虚拟机主机上，开启自动装入功能以启用虚拟保护，并禁用 TCP 烟囱卸载。

- MABS 使用端口 6070 作为托管 DPM-VMM 帮助器服务的默认端口。 若要更改注册表，请执行以下操作：

    1. 导航到**HKLM_软件_微软_微软数据保护管理器\配置**。
    2. 创建一个 32 位 DWORD 值：DpmVmmHelperServicePort，并写入更新的端口号作为注册表项的一部分。
    3. 打开 ```<Install directory>\Azure Backup Server\DPM\DPM\VmmHelperService\VmmHelperServiceHost.exe.config```，然后将端口号从 6070 更改为新端口。 例如： ```<add baseAddress="net.tcp://localhost:6080/VmmHelperService/" />```
    4. 重启 DPM-VMM 帮助程序服务，并重启 DPM 服务。

### <a name="set-up-protection-for-live-migration"></a>Set up protection for live migration

若要设置实时迁移保护，请执行以下操作：

1. 设置 MABS 服务器及其存储，并在 VMM 云中的每个 Hyper-V 主机服务器或群集节点上安装 MABS 保护代理。 如果在群集中使用 SMB 存储，请在所有群集节点上安装 MABS 保护代理。

2. 将 VMM 控制台作为客户端组件安装在 MABS 服务器上，以便 MABS 能够与 VMM 服务器进行通信。 控制台的版本应与在 VMM 服务器上运行的控制台版本相同。

3. 将 MABSMachineName$ 帐户指定为 VMM 管理服务器上的只读管理员帐户。

4. 使用`Set-DPMGlobalProperty`PowerShell cmdlet 将所有 Hyper-V 主机服务器连接到所有 MABS 服务器。 cmdlet 接受多个 MABS 服务器名称。 使用以下格式：`Set-DPMGlobalProperty -dpmservername <MABSservername> -knownvmmservers <vmmservername>`。 有关详细信息，请参阅[Set-DPMGlobal属性](https://docs.microsoft.com/powershell/module/dataprotectionmanager/set-dpmglobalproperty?view=systemcenter-ps-2019)。

5. 当在 VMM 中发现 Hyper-V 主机在 VMM 云中运行的所有虚拟机后，设置一个保护组，并添加想要保护的虚拟机。 应在保护组级别启用自动一致性检查，以在虚拟机移动性方案下进行保护。

6. 配置设置后，当虚拟机从一个群集迁移到另一个群集时，所有备份都按预期继续。 你可以验证实时迁移是否按预期启用，如下所示：

   1. 检查 DPM-VMM 帮助程序服务是否正在运行。 如果不是，开始吧。

   2. 打开 Microsoft SQL 服务器管理工作室并连接到承载 MABS 数据库 （DPMDB） 的实例。 在 DPMDB 上，运行以下查询：`SELECT TOP 1000 [PropertyName] ,[PropertyValue] FROM[DPMDB].[dbo].[tbl_DLS_GlobalSetting]`。

      此查询包含名为`KnownVMMServer`的属性。 此值应与你使用 `Set-DPMGlobalProperty` cmdlet 提供的值相同。

   3. 运行以下查询，为特定虚拟机验证 `PhysicalPathXML` 中的 VMMIdentifier ** 参数。 将 `VMName` 替换为虚拟机的名称。

      ```sql
      select cast(PhysicalPath as XML) from tbl_IM_ProtectedObject where DataSourceId in (select datasourceid from tbl_IM_DataSource   where DataSourceName like '%<VMName>%')
      ```

   4. 打开此查询返回的 .xml 文件，并验证 *VMMIdentifier* 字段是否具有值。

### <a name="run-manual-migration"></a>运行手动迁移

完成前几节中的步骤，MABS 摘要管理器作业完成后，将启用迁移。 默认情况下，此作业在午夜启动并在每天早晨运行。 如果要运行手动迁移来检查所有内容是否按预期运行，请执行以下操作：

1. 打开 SQL 服务器管理工作室并连接到承载 MABS 数据库的实例。

2. 运行以下查询： `SELECT SCH.ScheduleId FROM tbl_JM_JobDefinition JD JOIN tbl_SCH_ScheduleDefinition SCH ON JD.JobDefinitionId = SCH.JobDefinitionId WHERE JD.Type = '282faac6-e3cb-4015-8c6d-4276fcca11d4' AND JD.IsDeleted = 0 AND SCH.IsDeleted = 0`。 此查询将返回 **ScheduleID**。 记录此 ID，因为你将在下一个步骤中使用它。

3. 在 SQL Server Management Studio 中，展开“**SQL Server 代理**，然后展开“**作业**”。 右键单击你记录的“**ScheduleID**”，然后选择“**作业开始步骤**”。

作业运行时，备份性能会受到影响。 部署的大小和规模决定着此作业需要多少时间来完成。

## <a name="back-up-replica-virtual-machines"></a>备份副本虚拟机

如果 MABS 在 Windows Server 2012 R2 或更高版本上运行，则可以备份副本虚拟机。 这样会产生以下有利结果：

**可降低备份对正在运行的工作负荷的影响** - 备份虚拟机可能会产生一些开销，因为这会创建快照。 通过将备份过程卸载到辅助远程站点，正在运行的工作负载不再受备份操作的影响。 这只适用于备份副本存储在远程站点上的部署。 例如，您可能每日进行备份并在本地存储数据以确保快速还原，而在远程存储的副本虚拟机中每月或每季度进行备份，以便长期保留。

**节省带宽** - 在典型的远程分公司/总部部署中，需要配置适量的带宽以便在站点之间传输备份数据。 如果除数据备份策略之外你还创建了复制和故障转移策略，则你可以减少通过网络发送的冗余数据的数量。 通过备份副本虚拟机数据而不是主副本，可以节省通过网络发送备份数据的开销。

**支持宿主备份** - 可以将承载的数据中心作为副本网站，而无需辅助的数据中心。 在这种情况下，主机 SLA 需要一致地备份副本虚拟机。

在启动故障转移之前，副本虚拟机处于关闭状态，并且 VSS 无法保证对副本虚拟机进行应用程序一致的备份。 因此，对副本虚拟机的备份仅限故障一致的备份。 如果无法保证故障一致，备份将失败，在以下几种情况下会出现这一状况：

- 副本虚拟机无法正常运行且情况严重。

- 副本虚拟机正在重新同步（正在重新同步或处于“需要重新同步”状态）。

- 主站点和辅助站点之间的初始复制正在进行或等待虚拟机处理。

- .hrl 日志正在应用于副本虚拟机，或者以前应用于虚拟磁盘上的 .hrl 日志的操作失败或已取消或中断。

- 副本虚拟机正在迁移或故障转移

## <a name="recover-backed-up-virtual-machines"></a>恢复已备份的虚拟机

当你可以恢复备份的虚拟机时，使用“恢复”向导选择虚拟机和特定的恢复点。 若要打开“恢复”向导并恢复虚拟机，请执行以下操作：

1. 在 MABS 管理员控制台中，键入 VM 的名称，或展开受保护项的列表，然后选择要恢复的 VM。

2. 在“**对应的恢复点**”窗格中的日历上单击任意日期，查看可用的恢复点。 然后在“**路径**”窗格中，选择想要在“恢复”向导中使用的恢复点。

3. 在“**操作**”菜单中，单击“**恢复**”打开“恢复”向导。

    你所选择的 VM 和恢复点将出现在“**审查恢复选择**”屏幕中。 单击“下一步”****。

4. 在“**选择恢复类型**”屏幕中，选择想要将数据还原至的位置，然后单击“**下一步**”。

    - **恢复到原始实例**：恢复到原始实例时，会删除原始 VHD。 MABS 使用超 V VSS 编写器将 VHD 和其他配置文件恢复到原始位置。 在恢复过程结束时，虚拟机仍高度可用。
        要进行恢复，必须存在资源组。 如果资源组不可用，请恢复到备用位置，然后使虚拟机高度可用。

    - **作为虚拟机恢复到任何主机**：MABS 支持备用位置恢复 （ALR），它提供受保护 Hyper-V 虚拟机的无缝恢复到不同的 Hyper-V 主机，而不受处理器架构的影响。 恢复到群集节点的 Hyper-V 虚拟机不会高度可用。 如果选择此选项，“恢复”向导将显示其他的屏幕来标识目标和目标路径。

    - **复制到网络文件夹**：MABS 支持项目级恢复 （ILR），这允许您对文件、文件夹、卷和虚拟硬盘 （VHD） 进行项目级恢复，从 Hyper-V 虚拟机的主机级备份到受 MABS 保护的服务器上的网络共享或卷。 MABS 保护代理不必安装在来宾内部才能执行项目级恢复。 如果选择此选项，“恢复”向导将显示其他的屏幕来标识目标和目标路径。

5. 在“**指定恢复选项**”中配置恢复选项然后单击“**下一步**”：

    - 如果你正在通过低宽带恢复 VM，则单击“**修改**”启用“**网络带宽使用限制**”。 启用限制选项后，可以指定想要提供的宽带量和宽带的可用时间。
    - 如果你已配置网络，则选择“**启用使用硬件快照的基于 SAN 的恢复”**。
    - 如果想要在恢复进程完成后立即发送电子邮件通知，则选择“**此恢复完成后发送电子邮件**”并提供电子邮件地址。

6. 在“摘要”屏幕中，确认所有详细信息正确无误。 如果详细信息存在错误，或者想要进行更改，则单击“**返回**”。 如果同意该设置，则单击“**恢复**”启动恢复进程。

7. “**恢复状态**”屏幕会提供恢复作业的相关信息。

## <a name="next-steps"></a>后续步骤

[从 Azure 备份服务器恢复数据](https://docs.microsoft.com/azure/backup/backup-azure-alternate-dpm-server)
