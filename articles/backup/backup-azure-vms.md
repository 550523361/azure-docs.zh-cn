<properties
	pageTitle="Azure 虚拟机备份 - 备份 | Microsoft Azure"
	description="了解如何在注册后备份 Azure 虚拟机"
	services="backup"
	documentationCenter=""
	authors="trinadhk"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.date="09/24/2015"
	wacn.date=""/>


# 备份 Azure 虚拟机
本文是有关备份 Azure 虚拟机的基本指南。在继续之前，请确定符合所有[先决条件](/documentation/articles/backup-azure-vms-introduction#prerequisites)。

备份 Azure 虚拟机的过程包括三个主要步骤：

![备份 Azure 虚拟机的三个步骤](./media/backup-azure-vms/3-steps-for-backup.png)

>[AZURE.NOTE] 虚拟机备份位于本地。指定的 Azure 区域中的备份保管库不允许你从另一个区域备份虚拟机。因此，对于每个需要备份 VM 的 Azure 区域，需要在该区域中至少创建 1 个备份保管库。

## 1.发现 Azure 虚拟机
发现过程将在 Azure 上查询订阅中的虚拟机列表和其他信息，例如云服务名称、区域等。始终应该先运行发现过程。这是为了确保识别任何已添加到订阅的新虚拟机。

### 启动发现过程

1. 导航到备份保管库（位于 Azure 门户的“恢复服务”下），然后单击“注册的项”选项卡。

2. 在下拉菜单中选择工作负荷类型“Azure 虚拟机”，然后单击“选择”按钮。

    ![选择工作负荷](./media/backup-azure-vms/discovery-select-workload.png)

3. 单击页面底部的“发现”按钮。
    ![发现按钮](./media/backup-azure-vms/discover-button-only.png)

4. 发现过程可能会运行几分钟，同时将以表格显示虚拟机。发现过程运行时，屏幕底部会出现 toast 通知。

    ![发现 VM](./media/backup-azure-vms/discovering-vms.png)

5. 发现过程完成后，将出现 toast 通知。

    ![discover-done](./media/backup-azure-vms/discovery-complete.png)

##  2.注册 Azure 虚拟机
必须先向 Azure 备份服务注册虚拟机才能保护该虚拟机。注册过程的主要目标是将虚拟机与 Azure 备份服务相关联。注册通常是一次性活动。

>[AZURE.NOTE] 在执行注册步骤期间不会安装备份扩展。备份代理的安装和更新现已成为计划备份作业的一部分。


### 注册虚拟机

1. 导航到备份保管库（位于 Azure 门户的“恢复服务”下），然后单击“注册的项”选项卡

2. 在下拉菜单中选择工作负荷类型“Azure 虚拟机”，然后单击“选择”按钮。

    ![选择工作负荷](./media/backup-azure-vms/discovery-select-workload.png)

3. 单击页面底部的“注册”按钮。

    ![注册按钮](./media/backup-azure-vms/register-button-only.png)

4. 在“注册项”快捷菜单中，选择你要注册的虚拟机。如果存在两个以上的同名虚拟机，请使用云服务来区别虚拟机。

    可以大规模执行**注册**操作，也就是说，可以一次选择多个要注册的虚拟机。这可以大幅减少每次为了准备要备份的虚拟机而投入的工作量。

5. 为每一个应该注册的虚拟机创建一个作业。toast 通知将显示此活动的状态。单击“查看作业”转到“作业”页。

    ![注册作业](./media/backup-azure-vms/register-create-job.png)

6. 虚拟机还会出现在注册的项列表中，此外会显示注册操作的状态。

    ![注册状态 1](./media/backup-azure-vms/register-status01.png)

7. 操作完成后，门户中的状态会改变以反映已注册状态。

    ![注册状态 2](./media/backup-azure-vms/register-status02.png)

## 3.保护：备份 Azure 虚拟机
此步骤包括设置虚拟机的备份和保留策略。可以使用单个保护操作一次性保护多个虚拟机。

>[AZURE.NOTE] 2015 年 5 月之后创建的 Azure 备份保管库内置了默认策略。此默认策略随附默认 30 天保留期和每日一次的备份计划。

若要保护虚拟机，请执行以下步骤：

1. 导航到备份保管库（位于 Azure 门户的“恢复服务”下），然后单击“注册的项”选项卡。
2. 在下拉菜单中选择工作负荷类型“Azure 虚拟机”，然后单击“选择”。

    ![在门户中选择工作负荷](./media/backup-azure-vms/select-workload.png)

3. 单击页面底部的“保护”。此时将显示“保护项”向导。此向导只列出已注册且不受保护的虚拟机。

4. 可以在“保护项”向导中选择要保护的虚拟机。如果存在两个以上的同名虚拟机，请使用云服务来区别虚拟机。

    可以执行批量**保护**操作，也就是说，可以一次选择多个要保护的虚拟机。这可以大幅减少为了保护虚拟机而投入的工作量。

    ![配置批量保护](./media/backup-azure-vms/protect-at-scale.png)

5. 在“保护项”向导的第二个屏幕中，选择备份计划来备份选定的虚拟机。从现有的一组策略中选择，或定义新的策略。

    每个备份保管库可以包含多个备份策略。策略反映了有关如何计划和保留备份的详细信息。例如，一个备份策略可能是每天下午 10:00 备份，另一个备份策略可能是每周六上午 6:00 备份。使用多个备份策略可让虚拟机基础结构在计划备份时更有弹性。

    每个备份策略可有多个关联的虚拟机。无论何时，虚拟机只能与一个策略关联。

    ![使用新策略进行保护](./media/backup-azure-vms/policy-schedule.png)

6. 在“保护项”向导的第三个屏幕中，选择要与备份关联的保留期范围。此屏幕支持基于行业标准 GFS（祖父-父-子）的保留方案。请阅读有关[长期保留](#long-term-retention)的文章。

    备份策略还涉及到计划备份的保留方案。在上一屏幕中选择现有的备份策略会禁用保留方案的修改，并且备份将遵循策略中定义的保留策略。

    ![使用弹性保留期进行保护](./media/backup-azure-vms/policy-retention.png)

7. 为每个虚拟机创建一个作业，用于配置保护策略并将虚拟机关联到该策略。单击“作业”选项卡，并选择适当的筛选器来查看“配置保护”作业列表。

    ![配置保护作业](./media/backup-azure-vms/protect-configureprotection.png)


## 保护后的活动

### 安装备份扩展
Azure 备份服务将顺利处理备份扩展的升级和修补，完全不需要任何繁琐的用户干预。这可以减轻备份产品经常对用户造成的“代理管理开销”。

#### 脱机 VM
如果 VM 正在运行，则会安装备份扩展。VM 运行时，还很有可能会获得应用程序一致的恢复点。但是，即使 VM 已关闭并且无法安装扩展（即脱机 VM），Azure 备份服务也会继续备份 VM。这种影响会体现在一致性方面 - 在这种情况下，恢复点是*崩溃一致性的*。

### 初始备份
使用策略保护虚拟机后，虚拟机将会出现在“受保护的项”选项卡下，其状态为“受保护 - (等待初始备份)”。默认情况下，第一个计划的备份是初始备份。若要在配置保护后立即触发初始备份，请使用“受保护的项”页面底部的“立即备份”按钮。

Azure 备份服务将为初始备份操作创建备份作业。单击“作业”选项卡查看作业列表。在执行备份操作的过程中，Azure 备份服务将向虚拟机中的备份扩展发出一条命令，以刷新所有写入并取得一致的快照。

![备份进行中](./media/backup-azure-vms/protect-inprogress.png)

完成初始备份后，“受保护的项”选项卡中的虚拟机“保护状态”将显示为“受保护”。

    ![Virtual machine is backed up with recovery point](./media/backup-azure-vms/protect-backedupvm.png)

### 查看备份状态和详细信息
虚拟机受保护后，“仪表板”页摘要中的虚拟机计数也会递增。此外，“仪表板”页还显示过去 24 小时内成功、失败和仍在进行的作业数目。单击任何一个类别可在“任务”页中深入查看该类别。

![“仪表板”页中的备份状态](./media/backup-azure-vms/dashboard-protectedvms.png)

>[AZURE.NOTE] 仪表板中的值每 24 小时刷新一次。

### 长期保留
保留策略指定备份必须存储的时间长短。客户可以根据备份的创建时间指定不同的保留策略，而不只是为所有备份点指定一个“通用保留策略”。例如，在每个季末创建的备份点可能需要保留更长的时间以用于审核目的，而每天创建的备份点（用作操作恢复点）需要保留 90 天。

![已使用恢复点备份虚拟机](./media/backup-azure-vms/long-term-retention.png)

1. **每天保留策略**：每天创建的备份存储 30 天。
2. **每周保留策略**：每个星期日创建备份并保留 104 周
3. **每月保留策略**：每月最后一个星期日创建备份并保留 120 个月
4. **每年保留策略**：每年 1 月份的第一个星期日创建备份并保留 99 年。


## 恢复点的一致性
处理备份数据时，客户担心 VM 还原之后的行为。客户经常提出的问题包括：

- 虚拟机启动吗？
- 数据保留在磁盘上吗？会丢失任何数据吗？
- 应用程序能够读取数据吗？数据会损坏吗？
- 应用程序还可辨识数据吗？应用程序读取的数据仍保持自我一致吗？

下表解释了 Azure VM 备份和还原期间发生的一致性类型。

| 一致性 | 基于 VSS | 解释和详细信息 |
|-------------|-----------|---------|
| 应用程序一致性 | 是 | 这是 Microsoft 工作负荷的理想位置，因为可确保：<ol><li>VM *启动*。<li>*不发生数据损坏*。<li>*不发生数据丢失*。<li> 对于使用数据的应用程序，数据将保持一致，因为备份时会使用 VSS 将应用程序纳入考虑。</ol> 卷快照服务 (VSS) 可确保将数据正确写入存储。大多数 Microsoft 工作负荷都有 VSS 写入器，负责执行与数据一致性相关的工作负荷特定操作。例如，Microsoft SQL Server 的 VSS 写入器可确保正确写入事务日志文件和数据库。<br><br> 对于 Azure VM 备份，获取应用程序一致恢复点意味着备份扩展可以调用 VSS 工作流，并在获取 VM 快照之前*正确*完成。当然，这也意味着会调用 Azure VM 中所有应用程序的 VSS 写入器。<br><br>了解 [VSS 的基础知识](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)，并详细了解其[工作原理](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)。 |
| 文件系统一致性 | 是 - 对于 Windows 计算机 | 在两种情况下，恢复点可以做到文件系统一致性：<ul><li>在 Azure 中备份 Linux VM，因为 Linux 没有相当于 VSS 的平台。<li>在 Azure 中备份 Windows VM 期间 VSS 失败。</li></ul> 在这两种情况下，最佳做法是确保：<ol><li>VM *启动*。<li>*不发生数据损坏*。<li>*不发生数据丢失*。</ol> 应用程序需要对还原的数据实施自己的“修复”机制。|
| 崩溃一致性 | 否 | 这种情况相当于计算机“崩溃”（通过软重置或硬重置）。这通常发生于 Azure 虚拟机在备份期间关闭时。对于 Azure 虚拟机备份，获取崩溃一致恢复点意味着 Azure 备份不保证存储媒体上的数据一致 - 无论从操作系统还是应用程序的观点来说都一样。备份时已存在磁盘上的数据才被捕获和备份。<br/> <br/>尽管不会保证，但大多数情况下操作系统都会启动。随后通常是运行磁盘检查过程（如 chkdsk）以修复任何损坏错误。内存中任何未完全刷新到磁盘的数据或写入操作都将丢失。如果需要执行数据回滚，应用程序通常会接着执行其自身的验证机制。对于 Azure VM 备份，获取崩溃一致恢复点意味着 Azure 备份不保证存储上的数据一致 - 无论从 OS 还是应用程序的观点来说都一样。这通常发生在备份时 Azure VM 关闭。<br><br>例如，如果事务日志中的条目不在数据库中，则数据库软件将执行回滚，直到数据一致。在处理跨多个虚拟磁盘的数据时（例如跨区卷），崩溃一致恢复点不保证数据的正确性。|


## 性能和资源利用率
与本地部署的备份软件一样，Azure 中 VM 的备份也需要在容量和资源利用率方面进行规划。[Azure 存储空间限制](azure-subscription-service-limits.md#storage-limits)将定义如何构建 VM 部署，以获得最大性能，同时对运行中的工作负荷造成最小的影响。有两个主要 Azure 存储空间限制会影响备份性能：

- 每个存储帐户的最大传出
- 每个存储帐户的总请求速率

从客户存储帐户复制备份数据将会计入该存储帐户的 IOPS 和出口（存储吞吐量）度量值。同时，虚拟机也会运行并消耗 IOPS 与吞吐量。其目的是确保总流量（备份和虚拟机）不会超过存储帐户限制。

备份具有贪婪性，为了尽快完成备份，它会试图尽量消耗掉它所能使用的资源。但是，*单个 Blob 的目标吞吐量*实施 IO 操作总次数限制为*每秒 60 MB*。为了加快备份过程，将会尝试对 VM 的每个磁盘执行*并行*备份。因此，如果 VM 有 4 个磁盘，则 Azure 备份将尝试并行备份所有 4 个磁盘。确定从客户存储帐户传出流量的唯一重要因素是从存储帐户备份的**磁盘数**。

影响性能的辅助因素是**备份计划**。如果你将所有 VM 配置为同时备份，则要*并行*备份的磁盘数将会增加 - 因为 Azure 备份会尝试备份尽可能多的磁盘。因此，减少存储帐户备份流量的一种方法是确保在一天的不同时间备份不同的 VM，且备份时间不会重叠。

### 容量规划
通盘考虑所有这些因素意味着需要正确规划存储帐户的使用。请下载 [VM 备份容量规划 excel 工作表](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33)，以了解磁盘和备份计划选择所造成的影响。

### 备份吞吐量
对于每个要备份的磁盘，Azure 备份将读取磁盘上的块，并只存储更改的数据（增量备份）。下表显示了 Azure 备份预期提供的平均吞吐量值：

| 备份操作 | 最有利情况下的吞吐量 |
| ---------------- | ---------- |
| 初始备份 | 160 Mbps |
| 增量备份 (DR) | 640 Mbps <br><br> 如果需要备份的磁盘上发生大量离散变换，此吞吐量可能会显著下降 |

使用此表可以估算备份给定大小的磁盘所需的时间。

### VM 备份总时间
尽管大部分时间花在读取和复制数据上，但其他一些操作也会影响备份 VM 所用的总时间：

1. 花费在[安装或更新备份扩展](backup-azure-vms.md#offline-vms)上的时间
2. 队列等待时间：由于备份服务要处理来自多个客户的备份，备份操作可能不会立即启动。在负载高峰期，由于要处理的备份数过多，等待时间可能会长达 8 小时。但是，每日备份策略规定的 VM 备份总时间不会超过 24 小时。

## 排查错误
获取在虚拟机备份期间遇到的错误的详细解决方法列表：

- [排查虚拟机备份问题](backup-azure-vms-troubleshoot.md)

## 后续步骤
若要了解有关如何开始使用 Azure 备份的详细信息，请参阅：

- [恢复虚拟机](/documentation/articles/backup-azure-restore-vms)
- [管理虚拟机](/documentation/articles/backup-azure-manage-vms)

<!---HONumber=82-->