<properties 
   pageTitle="Azure SQL 数据库索引顾问" 
   description="Azure SQL 数据库索引顾问建议你为现有 SQL 数据库使用新索引，这样可以提高当前查询性能。" 
   services="sql-database" 
   documentationCenter="" 
   authors="stevestein" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.date="01/23/2015"
   wacn.date=""/>

# SQL 数据库索引顾问

Azure SQL 数据库索引顾问为你的现有 SQL 数据库提供索引建议，这样可以提高当前的查询性能。SQL 数据库服务通过分析 SQL 数据库的使用历史记录来评估索引性能。提供的索引建议最适合运行数据库的典型工作负荷。

索引顾问通过以下方式协助你优化数据库性能：

- 建议创建哪些索引（建议仅适用于非群集索引）。
- 建议删除哪些索引（删除索引建议功能为预览版，目前仅适用于重复的索引）。
- 允许你选择在没有用户交互的情况下自动应用索引建议。（自动化建议要求[查询存储](https://msdn.microsoft.com/zh-cn/library/dn817826.aspx)已启用且正处于运行状态。）
- 自动回退对性能有负面影响的建议。 


本文介绍适用于 V12 服务器的索引顾问。索引建议可用于 V11 服务器，但必须运行提供的 Transact-SQL (T-SQL) 脚本来实施建议。索引顾问不会还原 V11 服务器上的索引操作，因此应监视其对性能的影响，并根据需要还原对性能的影响。


### 权限

若要查看和创建索引建议，需要 Azure 中正确的[基于角色的访问控制](/documentation/articles/role-based-access-control-configure)权限。

- 查看建议需要“读者”、“SQL DB 参与者”权限。
- 执行任何操作（如创建或删除索引、取消创建索引）需要“所有者”、“SQL DB 参与者”权限。


## 查看索引建议

你可以在索引建议页中根据索引对性能的潜在影响来查看排位靠前的建议的索引。你还可以查看最后几个索引操作的状态。选择要查看其详细信息的建议或状态。

查看索引建议的步骤：

1. 登录到 [Azure 门户](https://manage.windowsazure.cn)。
2. 单击“浏览”>“SQL 数据库”，然后选择数据库。
5. 单击“所有设置”>“索引顾问”查看适用于所选数据库的“索引建议”。

> [AZURE.NOTE] 若要获取索引建议，数据库需要具有一周左右的使用量，且该周内需要有一些活动。此外也需要一些一致的活动。索引顾问优化一致的查询模式比优化随机的突发活动更加轻松。如果建议不可用，“索引建议”页会提供一条说明原因的消息。

![建议的索引](./media/sql-database-index-advisor/recommendations.png)

按其对性能的潜在影响将建议分为以下 4 个类别：

| 影响 | 说明 |
| :--- | :--- |
| 高 | 高影响建议应提供最重要的性能影响。 |
| 极大 | 极大影响建议应显著提升性能。 |
| 中等 | 中等影响建议应提高性能，但提升程度不大。 |
| 低 | 低影响建议提供的性能比没有索引时更好，但改进可能不明显。 
使用影响标记来确定最适合用于创建新索引的候选建议。


### 从列表中删除索引建议

如果建议的索引的列表中包含你想要删除的索引，则可放弃建议：

1. 选择“建议的索引”列表中的建议。
2. 在“索引详细信息”边栏选项卡上单击“放弃索引”。


你可以根据需要将已放弃的索引重新添加到“建议的索引”列表中：

1. 在“索引建议”边栏选项卡上，单击“查看放弃的索引建议”。
1. 从列表中选择一个放弃的索引，查看其详细信息。
1. 根据需要单击“撤消放弃”，将索引重新添加到“索引建议”的主列表。



## 应用索引建议

索引顾问允许你通过以下 3 大选项之一全权控制索引建议的启用方式。

- 一次应用一个建议。
- 允许索引顾问自动应用索引建议。
- 针对数据库手动运行建议的 T-SQL 脚本以实施建议。

选择要查看其详细信息的建议，然后单击“查看脚本”查看具体详细信息，以了解如何创建建议。

当索引顾问应用建议时，数据库将保持联机状态 -- 使用索引顾问不会让数据库脱机。

### 应用单个建议

你可以逐个查看和接受建议。

1. 在“索引建议”边栏选项卡上单击某个建议。
2. 在“索引详细信息”边栏选项卡上单击“应用”。

    ![应用建议](./media/sql-database-index-advisor/apply.png)


### 启用自动索引管理

可以将索引顾问设置为自动实施建议。建议一出现就会自动应用。对于该服务所管理的所有索引操作，如果存在负面的性能影响，则会还原所受到的影响。

1. 在“索引建议”边栏选项卡上单击“顾问设置”：

    ![索引顾问设置](./media/sql-database-index-advisor/settings.png)

2. 将顾问设置为自动“创建”或“删除”索引：

    ![建议的索引](./media/sql-database-index-advisor/automation.png)




### 手动运行建议的 T-SQL 脚本

选择任意建议，然后单击“查看脚本”。针对数据库运行此脚本以手动应用建议。

不通过该服务监视和验证手动执行的索引的性能影响，因此建议你在创建后监视这些索引以验证它们是否提供性能提升，并调整或删除它们（如有必要）。有关创建索引的详细信息，请参阅[创建索引 (Transact-SQL)](https://msdn.microsoft.com/zh-cn/library/ms188783.aspx)。


### 取消创建索引

处于“挂起”状态的索引可以取消。正在创建的索引（“正在执行”状态）不能取消。

1. 在“索引操作”区域选择任意“挂起”的索引，以便打开“索引详细信息”边栏选项卡。
2. 单击“取消”中止索引创建过程。



## 监视索引操作

可能不会立刻应用建议。该门户提供了有关索引操作状态的详细信息。管理索引时，以下是索引可能处于的状态：

| 状态 | 说明 |
| :--- | :--- |
| 挂起 | 创建索引命令已被接收，计划对索引进行创建。 |
| 执行 | 创建索引命令正在运行，当前正在创建索引。 |
| 成功 | 已成功创建索引。 |
| 已失败 | 未能创建索引。这可能是暂时性问题，或可能是表的架构更改所致，并且脚本不再有效。 |
| 还原 | 索引创建过程已被取消，或被认为是非性能的且正被自动还原。 |

单击列表中的进程内建议以查看其详细信息：

![建议的索引](./media/sql-database-index-advisor/operations.png)



### 还原索引

如果你使用了索引顾问来创建索引（即并没有手动运行 T-SQL 脚本），索引顾问会在发现性能影响为负面时自动还原该索引。如果你因故需要还原索引顾问的操作，可执行以下操作。


1. 在“索引操作”列表中选择一个已成功创建的索引。
2. 单击“索引详细信息”边栏选项卡上的“还原”，或单击“查看脚本”以查看你能够运行的 DROP INDEX 脚本。

![建议的索引](./media/sql-database-index-advisor/details.png)


## 监视索引建议的性能影响

成功实施建议后，可单击“索引详细信息”边栏选项卡上的“Query Insights”以打开 [Query Performance Insights](/documentation/articles/sql-database-query-performance)，然后查看排位靠前的查询的性能影响。

![监视性能影响](./media/sql-database-index-advisor/query-insights.png)


## 摘要

索引顾问提供管理 SQL 数据库索引的索引建议和自动化体验。通过提供 T-SQL 脚本以及单个的和全自动化的索引管理选项，索引顾问可以有效地协助你优化数据库索引并最终改进查询性能。



## 后续步骤

监视索引建议并继续应用它们以优化性能。数据库工作负荷是动态的，并且不断地更改。索引顾问将继续监视和建议可能提高数据库性能的索引。

<!---HONumber=Mooncake_0321_2016-->