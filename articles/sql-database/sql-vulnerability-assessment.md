---
title: SQL 漏洞评估
description: 了解如何在 Azure SQL 数据库上配置 SQL 漏洞评估并解释评估报告。
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mibar
ms.author: mibar
ms.reviewer: vanto, carlrab
ms.date: 04/19/2020
tags: azure-synapse
ms.openlocfilehash: 80629898b56f81fc738cb30df63766ea39adea6d
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2020
ms.locfileid: "81684256"
---
# <a name="sql-vulnerability-assessment-helps-you-identify-database-vulnerabilities"></a>SQL 漏洞评估可帮助你确定数据库漏洞

SQL 漏洞评估是一项易于配置的服务，可以发现、跟踪和帮助您修正潜在的数据库漏洞。 可以使用此工具积极提升数据库安全性。

漏洞评估是[高级数据安全](sql-database-advanced-data-security.md)产品/服务的一部分，它是高级 SQL 安全功能的统一软件包。 可以通过 SQL 高级数据安全门户访问和管理漏洞评估。

> [!NOTE]
> Azure SQL 数据库、Azure SQL 数据库托管实例和 Azure Synapse 分析支持漏洞评估。 为简单起见，本文在提到任何这些托管数据库服务时都使用了 SQL 数据库。

## <a name="vulnerability-assessment"></a>漏洞评估

SQL 漏洞评估是一种服务，可提供安全状态的可见性。 漏洞评估包括用于解决安全问题并增强数据库安全性的可操作步骤。 此工具有助于： 

- 满足必须生成数据库扫描报告的符合性要求。
- 满足数据隐私标准。
- 监视变化难以跟踪的动态数据库环境。

漏洞评估是内置于 Azure SQL 数据库中的扫描服务。 该服务采用一个用于标记安全漏洞的规则知识库。 它突出显示了与最佳做法的偏差，如配置错误、权限过多以及未受保护的敏感数据。

这些规则基于 Microsoft 的最佳做法，并专注于对数据库及其重要数据有最大风险的安全问题。 它们涉及到数据库级问题和服务器级安全问题，如服务器防火墙设置和服务器级别权限。 这些规则还体现了各个监管机构提出的许多要求，旨在满足它们的符合性标准。

扫描结果包括旨在解决每个问题的可操作步骤，并提供自定义修正脚本（若适用）。 您可以通过为您的环境设置可接受的基线，为您的环境自定义评估报告：
* 权限配置。
* 功能配置。
* 数据库设置。

## <a name="implement-vulnerability-assessment"></a>实现漏洞评估

以下步骤实现对 SQL 数据库的漏洞评估。

### <a name="1-run-a-scan"></a>1. 运行扫描

在 Azure SQL 数据库窗格中的 "**安全**" 标题下，选择 "**高级数据安全性**"。 然后单击 "**漏洞评估**" 窗格上的 "**选择存储**"，打开整个 SQL Server 的 "漏洞评估设置" 窗格。

配置将存储服务器上所有数据库的扫描结果的存储帐户。 有关存储帐户的详细信息，请参阅[关于 Azure 存储帐户](../storage/common/storage-create-storage-account.md)。 配置存储后，选择 "**扫描**" 以扫描数据库中的漏洞。

![扫描数据库](./media/sql-vulnerability-assessment/pp_va_initialize.png)

  > [!NOTE]
  > 扫描是轻型的安全功能。 需要几秒钟时间才能运行，并且它完全是只读的。 它不会对数据库进行任何更改。

### <a name="2-view-the-report"></a>2. 查看报表

扫描完成后，扫描报告会自动显示在 Azure 门户中。 该报表提供安全状态的概述。 其中列出了发现的问题数及其各自的严重性。 结果包括与最佳做法的偏差相关的警告，以及与安全相关的设置的快照，如数据库主体和角色及其相关权限。 扫描报告还提供了在数据库中发现的敏感数据的映射。 其中包括使用[数据发现和分类](sql-database-data-discovery-and-classification.md)对数据进行分类的建议。

![查看报告](./media/sql-vulnerability-assessment/pp_main_getstarted.png)

### <a name="3-analyze-the-results-and-resolve-issues"></a>3. 分析结果并解决问题

查看结果，并确定报告中的哪些结果是环境中真实存在的安全问题。 深入查看每个失败的结果，了解该结果的影响，以及每个安全检查失败的原因。 使用报告提供的可操作修正信息来解决问题。

![分析报告](./media/sql-vulnerability-assessment/pp_fail_rule_show_remediation.png)

### <a name="4-set-your-baseline"></a>4. 设置基线

查看评估结果时，可以将特定结果标记为环境中可接受的*基线*。 基线其实就是自定义结果的报告方式。 与基线匹配的结果被视为通过后续扫描。 建立基线安全状态后，漏洞评估只报告基线的偏差。 通过这种方式，您可以集中关注相关问题。

![设置基线](./media/sql-vulnerability-assessment/pp_fail_rule_show_baseline.png)

### <a name="5-run-a-new-scan-to-see-your-customized-tracking-report"></a>5. 运行新扫描以查看自定义跟踪报告

设置完**规则基线**后，运行新扫描以查看自定义报告。 漏洞评估现在仅报告偏离已批准基线状态的安全问题。

![查看自定义报告](./media/sql-vulnerability-assessment/pp_pass_main_with_baselines.png)

漏洞评估现在可用于监视数据库是否始终保持高级别的安全性，并且是否满足组织策略。 如果需要相容性报告，则漏洞评估报告有助于实现合规性过程。

### <a name="6-set-up-periodic-recurring-scans"></a>6. 设置定期定期扫描

转到 "漏洞评估" 设置，启用**定期定期扫描**。 此设置将漏洞评估配置为每周自动运行一次数据库扫描。 扫描结果摘要将发送到你提供的电子邮件地址。

![查看自定义报告](./media/sql-vulnerability-assessment/pp_recurring_scans.png)

### <a name="7-export-an-assessment-report"></a>7. 导出评估报表

选择 "**导出扫描结果**"，创建扫描结果的可下载的 Excel 报表。 此报表包含一个摘要选项卡，该选项卡显示评估摘要。 报表包含所有失败的检查。 它还包括一个 "**结果**" 选项卡，其中包含扫描的完整结果集。 结果包括所有已运行的检查和每个检查的结果详细信息。

### <a name="8-view-scan-history"></a>8. 查看扫描历史记录

在 "漏洞评估" 窗格中选择 "**扫描历史记录**" 以查看之前在此数据库上运行的所有扫描的历史记录。 选择列表中某个特定扫描，查看该扫描的详细结果。

漏洞评估现在可用于监视数据库是否始终保持高级别的安全性，并且是否满足组织策略。 如果需要相容性报告，则漏洞评估报告有助于实现合规性过程。

## <a name="manage-vulnerability-assessments-by-using-azure-powershell"></a>使用 Azure PowerShell 管理漏洞评估

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> PowerShell Azure 资源管理器模块仍受 Azure SQL 数据库的支持，但所有未来的开发都是针对 Az.Sql 模块的。 若要了解这些 cmdlet，请参阅 [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/)。 Az 模块和 AzureRm 模块中的命令参数大体上是相同的。

可以使用 Azure PowerShell cmdlet 以编程方式管理漏洞评估。 受支持的 cmdlet 如下：

| Cmdlet 名称作为链接 | 说明 |
| :-------------------- | :---------- |
| [Clear-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 清除漏洞评估规则基线。<br/>首先，在使用此 cmdlet 将基线清除之前，设置基线。 |
| [Clear-AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentSetting) | 清除数据库的漏洞评估设置。 |
| [Convert-AzSqlDatabaseVulnerabilityAssessmentScan](https://docs.microsoft.com/powershell/module/az.sql/Convert-azSqlDatabaseVulnerabilityAssessmentScan) | 将漏洞评估扫描结果转换为 Excel 文件。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 获取给定规则的漏洞评估规则基线。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentScanRecord](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentScanRecord) | 获取与给定数据库相关联的所有漏洞评估扫描记录。 |
| [Get-AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentSetting) | 返回数据库的漏洞评估设置。 |
| [Set-AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Set-azSqlDatabaseVulnerabilityAssessmentRuleBaseline) | 设置漏洞评估规则基线。 |
| [Start-AzSqlDatabaseVulnerabilityAssessmentScan](https://docs.microsoft.com/powershell/module/az.sql/Start-azSqlDatabaseVulnerabilityAssessmentScan) | 触发漏洞评估扫描的启动。 |
| [Update-AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Update-azSqlDatabaseVulnerabilityAssessmentSetting) | 更新数据库的漏洞评估设置。 |
| &nbsp; | &nbsp; |

有关脚本示例，请参阅 [Azure SQL 漏洞评估 PowerShell 支持](https://blogs.msdn.microsoft.com/sqlsecurity/20../../azure-sql-vulnerability-assessment-now-with-powershell-support/)。

## <a name="manage-vulnerability-assessment-baseline-rules-by-using-resource-manager-templates"></a>使用资源管理器模板管理漏洞评估基线规则

若要使用 Azure 资源管理器模板配置漏洞评估基线，请使用`Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines`类型。

在添加基线之前， `vulnerabilityAssessments`请确保已在运行 SQL Server 的计算机上启用了。

下面是一个示例，用于将基线规则 VA2065 定义为 masterdb，将 VA1143 定义为 userdb 作为资源管理器模板中的资源：

```json
   "resources": [
      {
         "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
         "apiVersion": "2018-06-01-preview",
         "name": "[concat(parameters('server_name'),'/', parameters('database_name') , '/default/VA2065/master')]",
         "properties": {
            "baselineResults": [
               {
                  "result": [
                     "FirewallRuleName3",
                     "StartIpAddress",
                     "EndIpAddress"
                  ]
               },
               {
                  "result": [
                     "FirewallRuleName4",
                     "62.92.15.68",
                     "62.92.15.68"
                  ]
               }
            ]
         },
         "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
         "apiVersion": "2018-06-01-preview",
         "name": "[concat(parameters('server_name'),'/', parameters('database_name'), '/default/VA2130/Default')]",
         "dependsOn": [
            "[resourceId('Microsoft.Sql/servers/vulnerabilityAssessments', parameters('server_name'), 'Default')]"
         ],
         "properties": {
            "baselineResults": [
               {
                  "result": [
                     "dbo"
                  ]
               }
            ]
         }
      }
   ]
```

对于 master 数据库和用户数据库，资源名称定义方式不同：

* Master 数据库-"name"： "[concat （parameters （' server_name '）、'/'、parameters （' database_name '）、'/default/VA2065/<b>master</b>'）]"
* 用户数据库-"name"： "[concat （parameters （' server_name '）、'/'、parameters （' database_name '）、'/default/VA2065/<b>default</b>'）]"
 
 
 若要将布尔类型处理为 true/false，请将基线结果设置为二进制输入，如 "1"/"0"。
 
```json
   {
      "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
      "apiVersion": "2018-06-01-preview",
      "name": "[concat(parameters('server_name'),'/', parameters('database_name'), '/default/VA1143/Default')]",

      "dependsOn": [
         "[resourceId('Microsoft.Sql/servers/vulnerabilityAssessments', parameters('server_name'), 'Default')]"
      ],

      "properties": {
         "baselineResults": [
            {
               "result": [
                  "1"
               ]
            }
         ]
      }

   }
```

## <a name="next-steps"></a>后续步骤  

- 详细了解[高级数据安全性](sql-database-advanced-data-security.md)。
- 了解有关[数据发现和分类](sql-database-data-discovery-and-classification.md)的详细信息。
