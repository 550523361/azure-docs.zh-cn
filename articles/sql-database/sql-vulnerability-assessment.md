---
title: SQL 漏洞评估
description: 了解如何在 SQL 数据库上配置 SQL 漏洞评估，并解释评估报告。
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mibar
ms.author: mibar
ms.reviewer: vanto, carlrab
ms.date: 03/12/2019
ms.openlocfilehash: f67882d51c14b50c8a65120b663096d08363d07d
ms.sourcegitcommit: dfa543fad47cb2df5a574931ba57d40d6a47daef
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/18/2020
ms.locfileid: "77431445"
---
# <a name="sql-vulnerability-assessment-service-helps-you-identify-database-vulnerabilities"></a>SQL 漏洞评估服务可帮助你识别数据库漏洞

SQL 漏洞评估是一项易于配置的服务，可以发现、跟踪并帮助修正潜在的数据库漏洞。 可以使用此工具积极提升数据库安全性。

漏洞评估是[高级数据安全](sql-database-advanced-data-security.md) (ADS) 产品/服务（它是高级 SQL 安全功能的一个统一包）的一部分。 可通过中心 SQL ADS 门户访问和管理漏洞评估。

> [!NOTE]
> 支持针对 Azure SQL 数据库、Azure SQL 托管实例和 Azure SQL 数据仓库进行漏洞评估。 为简单起见，本文在提到任何这些托管数据库服务时都使用了 SQL 数据库。

## <a name="the-vulnerability-assessment-service"></a>漏洞评估服务

SQL 漏洞评估 (VA) 是一项可直观查看安全状态的服务，包括解决安全问题的可操作步骤，并可增强数据库安全性。 此工具有助于：  

- 满足必须生成数据库扫描报告的符合性要求。  
- 满足数据隐私标准。  
- 监视变化难以跟踪的动态数据库环境。  

漏洞评估是内置于 Azure SQL 数据库服务中的扫描服务。 此服务采用规则知识库，可标记安全漏洞，并突出显示不符合最佳做法的情况（如配置错误、权限过多和敏感数据不受保护）。 这些规则基于 Microsoft 的最佳做法，并专注于对数据库及其重要数据有最大风险的安全问题。 其中涵盖数据库级别的问题以及服务器级别的安全问题，如服务器防火墙设置和服务器级别的权限。 这些规则还体现了各个监管机构提出的许多要求，旨在满足它们的符合性标准。  

扫描结果包括旨在解决每个问题的可操作步骤，并提供自定义修正脚本（若适用）。 设置权限配置、功能配置和数据库设置可接受的基准，以此针对环境自定义评估报告。

## <a name="implementing-vulnerability-assessment"></a>实施漏洞评估

以下步骤可在 SQL 数据库上实现 VA。  

### <a name="1-run-a-scan"></a>1. 运行扫描  

导航到 Azure SQL 数据库窗格“安全”标题下的“高级数据安全”，开始使用 VA。 单击以启用“高级数据安全”，然后单击“选择存储”或“漏洞评估”卡，这会自动打开整个 SQL 服务器的“漏洞评估”设置卡。

首先配置一个存储帐户，以在其中存储针对服务器上的所有数据库的扫描结果。 有关存储帐户的详细信息，请参阅[关于 Azure 存储帐户](../storage/common/storage-create-storage-account.md)。 配置存储后，单击“扫描”，扫描数据库中的漏洞。
  
![扫描数据库](./media/sql-vulnerability-assessment/pp_va_initialize.png)  

  > [!NOTE]
  > 扫描是轻型的安全功能。 只需几秒即可运行，且为完全只读。 此功能不会对数据库做出任何更改。  

### <a name="2-view-the-report"></a>2. 查看报表

扫描完成后，扫描报告将自动显示在 Azure 门户中， 其中概要列出了安全状态，发现的问题个数及其各自的严重性。 结果中包括偏离最佳做法的警告，以及与安全相关的设置的屏幕截图，例如数据库主体和角色及其相关权限。扫描报告还会提供数据库中发现的敏感数据的映射，并建议使用[数据发现和分类](sql-database-data-discovery-and-classification.md)对该数据进行分类。

![查看报告](./media/sql-vulnerability-assessment/pp_main_getstarted.png)  

### <a name="3-analyze-the-results-and-resolve-issues"></a>3. 分析结果并解决问题

查看结果，并确定报告中的哪些结果是环境中真实存在的安全问题。 深入查看每个失败的结果，了解该结果的影响，以及每个安全检查失败的原因。 使用报告提供的可操作修正信息来解决问题。  

![分析报告](./media/sql-vulnerability-assessment/pp_fail_rule_show_remediation.png)

### <a name="4-set-your-baseline"></a>4. 设置基线

在查看评估结果时，可将特定结果标记为环境中可接受的基线。 基线其实就是自定义结果的报告方式。 与基线匹配的结果被视为通过后续扫描。 建立基线安全状态后，VA 只会报告与基线的偏差，这样你可以专注于处理相关问题。  

![设置基线](./media/sql-vulnerability-assessment/pp_fail_rule_show_baseline.png)  

### <a name="5-run-a-new-scan-to-see-your-customized-tracking-report"></a>5. 运行新扫描以查看自定义跟踪报告

完成规则基线设置后，运行新的扫描以查看自定义报告。 VA 现在仅报告与批准的基线状态偏离的安全问题。

![查看自定义报告](./media/sql-vulnerability-assessment/pp_pass_main_with_baselines.png)  

漏洞评估现在可用于监视数据库是否始终保持高级别的安全性，并且是否满足组织策略。 如果要求必须有符合性报告，VA 报告有助于推动执行符合性流程。  

### <a name="6-set-up-periodic-recurring-scans"></a>6. 设置定期定期扫描

导航到“漏洞评估”设置，打开“定期扫描”。 此配置会使漏洞评估每周自动运行一次数据库扫描。 扫描结果摘要会发送到你提供的电子邮件地址。

![查看自定义报告](./media/sql-vulnerability-assessment/pp_recurring_scans.png)

### <a name="7-export-an-assessment-report"></a>7. 导出评估报表

单击“导出扫描结果”，创建可供下载的扫描结果 Excel 报表。 此报表包含显示评估摘要的摘要选项卡，其中包括所有失败的检查。 报表中还包括一个“结果”选项，其中包含全部扫描结果，包括运行的所有检查以及每个检查的详细结果。

### <a name="8-view-scan-history"></a>8. 查看扫描历史记录

单击 VA 窗格中的“扫描历史记录”，查看之前此数据库上运行的所有扫描。 选择列表中某个特定扫描，查看该扫描的详细结果。

漏洞评估现在可用于监视数据库是否始终保持高级别的安全性，并且是否满足组织策略。 如果要求必须有符合性报告，VA 报告有助于推动执行符合性流程。

## <a name="manage-vulnerability-assessments-using-azure-powershell"></a>使用 Azure PowerShell 管理漏洞评估

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Azure SQL 数据库仍支持 PowerShell Azure 资源管理器模块，但所有将来的开发都适用于 Az .Sql 模块。 有关这些 cmdlet，请参阅[AzureRM](https://docs.microsoft.com/powershell/module/AzureRM.Sql/)。 Az 模块和 AzureRm 模块中的命令的参数完全相同。

可以使用 Azure PowerShell cmdlet 以编程方式管理漏洞评估。 受支持的 cmdlet 如下：

- [更新-AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Update-azSqlDatabaseVulnerabilityAssessmentSetting)

  更新数据库的漏洞评估设置
- [AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentSetting)

  返回数据库的漏洞评估设置
- [AzSqlDatabaseVulnerabilityAssessmentSetting](https://docs.microsoft.com/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentSetting)

  清除数据库的漏洞评估设置
- [AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Set-azSqlDatabaseVulnerabilityAssessmentRuleBaseline)

  设置漏洞评估规则基线。
- [AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentRuleBaseline)

  获取给定规则的漏洞评估规则基线。
- [AzSqlDatabaseVulnerabilityAssessmentRuleBaseline](https://docs.microsoft.com/powershell/module/az.sql/Clear-azSqlDatabaseVulnerabilityAssessmentRuleBaseline)

  清除漏洞评估规则基线。 在使用此 cmdlet 清除基线之前请先设置基线。
- [AzSqlDatabaseVulnerabilityAssessmentScan](https://docs.microsoft.com/powershell/module/az.sql/Start-azSqlDatabaseVulnerabilityAssessmentScan)

  触发漏洞评估扫描开始
- [AzSqlDatabaseVulnerabilityAssessmentScanRecord](https://docs.microsoft.com/powershell/module/az.sql/Get-azSqlDatabaseVulnerabilityAssessmentScanRecord)

   获取与给定数据库关联的所有漏洞评估扫描记录。
- [转换-AzSqlDatabaseVulnerabilityAssessmentScan](https://docs.microsoft.com/powershell/module/az.sql/Convert-azSqlDatabaseVulnerabilityAssessmentScan)

  将漏洞评估扫描结果转换为 Excel 文件

有关脚本示例，请参阅 [Azure SQL 漏洞评估 PowerShell 支持](https://blogs.msdn.microsoft.com/sqlsecurity/20../../azure-sql-vulnerability-assessment-now-with-powershell-support/)。

## <a name="manage-vulnerability-assessments-baseline-rules-using-azure-resource-manager-templates"></a>使用 Azure 资源管理器模板管理漏洞评估基线规则

使用 Azure 资源管理器模板 configurng 漏洞评估基线时，需要使用 `Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines` 类型。

在添加基线之前，请确保已在 SQL Server 上启用了 vulnerabilityAssements。

请参阅将基线规则 VA2065 定义为 masterdb 和 VA1143 userdb 作为 ARM 模板中资源的示例：

```json
    "resources": [
        {
            "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
            "apiVersion": "2018-06-01-preview",
            "name": "[concat(parameters('server_name'),'/', parameters('database_name') , '/default/VA2065/master')]",
            "properties": {
                "baselineResults": [
                    {
                        "result": [
                                "FirewallRuleName3",
                                "StartIpAddress",
                                "EndIpAddress"
                                  ]
                    },{
                         "result": [
                                "FirewallRuleName4",
                                "62.92.15.68",
                                "62.92.15.68"
                            ]
                        
                    }
                ]
            },
        {
            "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/rules/baselines",
            "apiVersion": "2018-06-01-preview",
            "name": "[concat(parameters('server_name'),'/', parameters('database_name'), '/default/VA1143/Default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/vulnerabilityAssessments', parameters('server_name'), 'Default')]"
            ],
            "properties": {
                "baselineResults": [
                    {
                        "result": [
                            "dbo"
                        ]
                    }
                ]
            }
        }
    ]
}   
```

对于用户数据库和 master 数据库，资源名称定义方式不同：

* Master 数据库-"name"： "[concat （parameters （' server_name '）、'/'、parameters （' database_name '）、'/default/VA2065/<b>master</b>'）]"
* 用户数据库-"name"： "[concat （parameters （' server_name '）、'/'、parameters （' database_name '）、'/default/VA2065/<b>default</b>'）]"
 
## <a name="next-steps"></a>后续步骤  

- 详细了解[高级数据安全](sql-database-advanced-data-security.md)
- 详细了解[数据发现和分类](sql-database-data-discovery-and-classification.md)
