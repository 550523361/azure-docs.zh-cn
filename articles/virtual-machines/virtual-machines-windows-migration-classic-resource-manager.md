<!-- not suitable for Mooncake -->

<properties
	pageTitle="平台支持从经典部署模型迁移到 Azure Resource Manager 的 IaaS 资源"
	description="本文逐步讲解平台支持的迁移服务功能：从服务管理迁移到 Azure Resource Manager"
	services="virtual-machines-windows"
	documentationCenter=""
	authors="mahthi"
	manager="drewm"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.date="05/04/2016"
	wacn.date=""/>

# 平台支持从经典部署模型迁移到 Azure Resource Manager 的 IaaS 资源

自从我们宣布了在 Azure Resource Manager 下面支持虚拟机之后，时间已过了将近一年。可以在此处详细了解这段时间内的进展和它支持的其他功能。此外，我们还提供了指导来告诉你如何进行最佳连接，以及如何使用虚拟网络的站点到站点网关在订阅中并置两个部署模型的资源。本文将说明如何将 IaaS 资源从经典模型迁移到 Resource Manager。

## 迁移的目标是什么？

对于虚拟机上可用的新体验和 API 所提供的能力和功能，我们感到很兴奋。我们相信这可以改变使用云的许多方式。使用发布的新模型时，你可以在资源组中部署、管理和监视相关的服务。Resource Manager 实现了通过模板部署复杂应用程序、可使用 VM 扩展配置虚拟机，并包含了访问管理和标记。它还可以将虚拟机的可缩放并行部署包含在可用性集内。此外，新模型还针对计算、网络和存储单独提供生命周期管理。最后，将重点介绍为了按默认启用安全性而要在虚拟网络中实施虚拟机的做法。

从功能角度看，来自经典部署模型的几乎所有功能都支持 Azure Resource Manager 中的计算、网络和存储，仅有几个功能例外，而我们正积极尝试在未来的几个月内实现其支持。此外，我们将持续改善用户体验，并在 Azure 门户中添加更多功能，以衔接这些体验。

由于新的 Azure Resource Manager 具有此新功能，并且部署基础也在不断发展，因此我们希望客户能够迁移经典模型中的现有部署。

>[AZURE.NOTE] 我们同时宣布，迁移服务的公共预览版即将推出。在公共预览期，我们只建议迁移 Azure 订阅中的非生产工作负荷。

## 自动化与工具在迁移之后的变化

请注意，在将资源从经典迁移到 Resource Manager 模型的过程中，必须做出的重要更改之一是更新现有的自动化或工具，以确保即使在资源迁移之后，它仍可继续工作。

## 将 IaaS 资源从经典模型迁移到 Resource Manager 有何意义？

在详细了解详细信息之前，我们想要先简短地说明 IaaS 资源的数据平面和管理平面操作之间的差异。了解这些差异非常重要，因为这说明我们打算支持迁移的方式。

- 管理平面 - 描述进入管理平面或 API 以修改资源的调用。例如 – 创建 VM、重新启动 VM、使用新子网来更新虚拟网络等等。这些操作全都管理正在运行的资源，但不直接影响实例的连接。
- 数据平面（应用程序）– 描述应用程序本身的“运行时”，并涉及到与不通过 Azure API 的实例的交互。访问网站或从运行中的 SQL Server 或 mongoDB 服务器提取数据，全都被视为数据平面或应用程序交互。从存储帐户复制 Blob，以及访问公共 IP 地址以通过 RDP 或 SSH 连接到虚拟机也属于数据平面。这些操作可让应用程序继续跨计算、网络和存储运行。

>[AZURE.NOTE] 在某些迁移方案中（不支持的配置中有详细说明），我们将停止解除分配并重新启动虚拟机，而这会造成短暂的数据平面停机。

## 支持的迁移范围是什么？

在公共预览期，我们提供两个迁移范围，其目标主要是计算和网络。存储帐户的迁移支持已在计划中，很快就会推出。但是，为了让迁移顺畅进行，我们已让经典的存储帐户能够包含 Resource Manager VM 的磁盘。你可以在下面找到更多详细信息。

### 迁移（不在虚拟网络中的）虚拟机

在 Resource Manager 部署模型中，我们默认在应用程序中强制实施安全性。因此，在 Resource Manager 模型中，所有 VM 都必须位在虚拟网络内。也就是说，在迁移过程中，我们将重新启动（停止解除分配并启动）VM。在虚拟网络方面，有几个选择：
- 你可以请求平台创建新的虚拟网络，并将虚拟机迁移到新的虚拟网络（或）
- 将虚拟机迁移到 Resource Manager 中的现有虚拟网络

- 你可以请求平台创建新的虚拟网络，并将 VM 迁移到新的虚拟网络（或）
- 将 VM 迁移到 Resource Manager 中的现有虚拟网络

>[AZURE.NOTE] 在此迁移范围内，迁移进行期间可能有一段时间不允许进行“管理平面”和“数据平面”操作。

### 迁移（虚拟网络中的）虚拟机

在此范围内，针对大多数的 VM 配置，我们只在经典和 Resource Manager 之间迁移元数据。基础 VM 在相同硬件、相同网络上，使用相同的存储来运行。因此，当我们提到将元数据从经典迁移到 Resource Manager 时，迁移期间可能有一段时间不允许进行“管理平面”操作。但是，“数据平面”仍可继续运行，也就是说，在 VM（经典）之上运行的应用程序，不会在迁移期间造成停机。

目前，以下配置还不受支持。当我们在将来添加支持这些配置时，可能会造成此配置中的某些 VM 停机（停止解除分配并重新启动）：

-	如果你在单个云服务中有 1 个以上的可用性集
-	如果你在单个云服务中有“1 个或多个可用性集”和“不在可用性集中的 VM”

>[AZURE.NOTE] 在此迁移范围内，迁移进行期间可能有一段时间不允许进行“管理平面”操作。针对上述某些特殊配置，这会造成“数据平面”停机。

### 存储帐户和迁移

本公共预览版目前不支持存储帐户迁移。但是，存储帐户的迁移支持已在计划中，应该很快就会推出。关于迁移和其存储帐户行为有两个重要层面。

- 让 Resource Manager VM 可部署在经典存储帐户中。为了让迁移顺畅进行，我们已启用在经典存储帐户中部署 Resource Manager VM 的功能。通过此功能，就可以迁移计算和网络资源，而不必受到存储帐户的约束。
- 存储帐户迁移最佳实践
	- 支持存储帐户的迁移后，平台会强制将存储帐户与计算和网络资源分开，以便实现顺畅的体验。

## 不支持的功能和配置

目前我们不支持一组特定的功能和配置。我们正在努力添加对它们的支持，但是，我们将在以下部分中提供相关的建议和计划。

### 不支持的功能

公共预览版不支持以下功能列表。你可以选择性地删除这些设置、迁移 VM，然后让 VM 在 Resource Manager 部署模型中重新启用。对这些功能的支持大多已在计划中，可供使用后即会推出。

资源提供程序 | 功能
---------- | ------------
计算 | 启动诊断
计算 | 不关联的虚拟机磁盘
计算 | 虚拟机映像
网络 | 不关联的保留 IP [如果未附加到 VM]。支持已附加到 VM 的保留 IP。
网络 | 不关联的网络安全组 [如果未附加到虚拟网络或网络接口]。支持 VNET 引用的 NSG。
网络 | 终结点 ACL
网络 | 虚拟网络网关（站点到站点、Express Route、点到站点）
存储 | 存储帐户

### 不支持的配置

公共预览版不支持以下配置列表。可以在下面找到我们的建议。对这些配置的支持有一部分已在计划中，可供使用后即会推出。

服务 | 配置 | 建议
---------- | ------------ | ------------
资源管理器 | 经典资源的基于角色的访问控制 | 因为在迁移后修改了资源的 URI。我们建议事先计划需要在迁移之后进行的 RBAC 策略更新。
计算 | 与 VM 关联的多个子网 | 应该将子网配置更新为只引用子网。
计算 | 属于虚拟网络，但未分配显式子网的虚拟机。 | 你可以选择性地删除 VM。此功能支持目前已在计划中。
计算 | 具有警报、自动缩放策略的虚拟机 | 目前，迁移可以进行，但这些设置将被丢弃。因此强烈建议在迁移之前先评估你的环境。或者，也可以在迁移完成之后重新配置警报设置。
计算 | XML VM 扩展 [VS 调试器、WebDeploy 和 RemoteDebug] | 此配置不受支持。建议先从虚拟机中删除这些扩展，然后继续迁移。
计算 | 包含 Web 角色/辅助角色的云服务 | 此配置目前不受支持，仍在计划中。
网络 | 包含虚拟机和 Web 角色/辅助角色的虚拟网络 | 此配置目前不受支持，仍在计划中。
网络 | 名称中包含空格的子网 | 此功能支持已在计划中。
Azure | 包含 Azure 环境的虚拟网络 | 此配置目前不受支持，仍在计划中。
HDInsight 服务 | 包含 HDInsight 服务的虚拟网络 | 此配置目前不受支持，仍在计划中。
动态生命周期服务 | 包含由动态周期服务管理的虚拟机的虚拟网络 | 此配置目前不受支持，仍在计划中。

## 迁移体验

在开始迁移体验之前，我们强烈建议遵循几个步骤：

1. 确保正在规划迁移的资源未使用任何不受支持的功能或配置。在大多数情况下，平台将检测这些问题，并引发错误。
2. 如果你有不在虚拟网络中的 VM，它们在准备操作期间停止解除分配。因此，如果不想丢失公共 IP 地址，请先保留 IP 地址再触发准备操作。但是，如果 VM 位于虚拟网络中，则不停止解除分配。
3. Azure 建议暂时先不要尝试迁移生产资源。
4. 规划在非工作时间迁移，以便应对迁移期间可能发生的任何意外失败。
5. 使用 PowerShell、CLI 命令或 REST API 下载最新的 VM 配置，以便能够在完成准备步骤之后轻松进行验证。
6. 先更新用于处理 Resource Manager 部署模型的自动化/操作化脚本，再开始迁移。此外，也可以选择在资源处于准备就绪状态下执行 GET 操作。
7. 在迁移完成之后，评估经典 IaaS 资源上配置的 RBAC 策略并准备好计划。

随着公共预览版宣布推出，我们已添加通过 REST API、PowerShell 和 Azure CLI 触发迁移的支持。我们目前已计划支持从经典部署模型到 ARM 的迁移，以便让你以可视化方式查看和逐步进行迁移。

![显示迁移工作流的屏幕截图](./media/virtual-machines-windows-migration-classic-resource-manager/migration-workflow.png)

1.	准备
	* 这是迁移过程的第一个步骤。此步骤的目标是要模拟将 IaaS 资源从经典资源转换为 Resource Manager 资源，并以并排方式呈现此转换过程以让用可视化方式查看。下面描述了详细的操作流程。
  * 你将选择要准备进行迁移的虚拟网络或托管服务（如果它不是 VNET）。
  *	一开始，平台始终在进行迁移之资源的后台执行数据分析，并在资源能够进行迁移时返回成功/失败。
	*	如果资源无法迁移，我们将列出它不支持迁移的原因。
	* 如果资源可迁移，平台将先锁定进行迁移的资源的管理平面操作。例如：无法将数据磁盘添加到进行迁移的 VM。
  *	然后，平台开始将迁移中资源的元数据从经典模型迁移到 Resource Manager。  
  *	准备操作完成之后，你可以选择在经典模型和 Resource Manager 中将资源可视化。对于经典部署模型中的每个云服务，我们将创建模式为 `cloud-service-name>-migrated` 的资源组名称。

2.	手动检查或通过脚本检查
  * 在此步骤中，你可以选择使用前面下载的配置来验证迁移是否正常。或者，你也可以登录到门户并检查属性和资源，来验证元数据的迁移是否正常。
	* 如果你要迁移虚拟网络，大多数虚拟机配置不会重新启动。对于这些 VM 上的应用程序，你可以验证应用程序是否仍已启动并在运行。
	* 可以测试监视/自动化和操作脚本，以查看 VM 是否按预期运行，以及更新后的脚本是否正常运行。请注意，仅当资源处于准备就绪状态时，才支持 GET 操作。
  * 你可以慢慢考虑是否要“提交”迁移，因为系统对此并没有时间限制。可以在此状态下停留任何时间。但请注意，这些资源的管理平面将遭到锁定，直到“中止”或“提交”为止。
  * 如果你发现任何问题，始终可以“中止”迁移，并返回到“经典”部署模型。在你返回后，我们将打开资源的平面管理操作，使你可以继续在经典部署模型中对这些 VM 恢复正常操作。

3. 中止
  * 这是可选步骤，可让你将更改还原为经典部署模型，并中止迁移。请注意，一旦触发“提交”操作，就无法执行此操作。 	

4.	提交
  * 一旦完成验证，就可以“提交”迁移，之后，资源将不再出现在经典模型中，而只在 Resource Manager 部署模型中提供使用。这也意味着只能在新门户中管理迁移的资源。
	* 如果此操作失败，建议你重试几次。如果一直失败，请创建支持票证，或在[此处](https://social.msdn.microsoft.com/Forums/azure/zh-cn/home?forum=WAVirtualMachinesforWindows)创建标记为 ClassicIaaSMigration 的论坛贴子。

>[AZURE.NOTE] 请注意，下述所有操作都是幂等的。如果你遇到不支持的功能或配置错误以外的任何情况，建议再试一次准备、中止或提交操作，然后平台将重试操作。


## 常见问题

**此迁移计划是否影响 Azure 虚拟机上运行的任何现有服务或应用程序？**

不会。VM（经典）是完全受支持的 GA 服务，并且可以继续利用这些资源来扩展 Microsoft Azure 云中的资源使用量。

**如果我近期不打算迁移，我的 VM 会出现什么情况？**

我们近期不会淘汰现有的经典 API 和资源模型。我们想要通过 Resource Manager 部署模型中提供的高级功能，让迁移变得非常简单。因此，我们强烈建议你查看[此处](/documentation/articles/virtual-machines-windows-compare-deployment-models)提供的 Resource Manager IaaS 相关进展。

**对于我现有的工具而言，此迁移计划有何意义？**

将工具更新为 Resource Manager 部署模型，是必须在迁移计划中考虑的最重要更改之一。

**管理平面的停机时间持续多久？**

这取决于迁移的资源数量。对于较小型部署（几十个 VM），整个迁移过程从头到尾应该不超过一小时。但是，对于大规模部署（几百个 VM），则可能需要几个小时。根据公共预览版中提供的服务，我们强烈建议在开发或测试订阅中执行此操作，以评估其影响。

**在 Resource Manager 中提交迁移的资源之后，是否还可以回滚？**

只要资源处于“已准备”状态，就可以中止迁移。但是，在使用“提交”操作成功迁移资源之后，就不支持回滚。

**提交操作失败时，是否可以回滚迁移？**

如果提交操作失败，就无法中止迁移。包括提交操作在内的所有迁移操作都是幂等的。因此，建议在片刻之后重试操作。如果仍遇到错误，请创建支持票证，或在[此处](https://social.msdn.microsoft.com/Forums/azure/zh-cn/home?forum=WAVirtualMachinesforWindows)创建标记为 ClassicIaaSMigration 的论坛贴子。

**如果我必须利用 Resource manager 下面的 IaaS，是否必须购买其他 Express Route 线路？**

不需要。我们最近已启用[跨经典模型和 Resource Manager 共存的 Express Route 线路](/documentation/articles/expressroute-howto-coexist-resource-manager)。如果你已有 Express Route 线路，则不需要购买新的线路。

**你们是否制定了路线图来说明何时将不支持的方案添加到迁移列表？**

目前来看，我们将在 H1 CY 2016 推出第一组方案。在推出第一组之后，我们继续添加对不受支持功能的支持。

**如果我已经为经典的 IaaS 资源配置基于角色的访问控制策略，该怎么办？**

在迁移期间，资源从经典转换为 Resource Manager。因此，我们建议事先计划需要在迁移之后进行的 RBAC 策略更新。

**如果我目前正在使用 Azure 上的 Azure Site Recovery 或备份服务，该怎么办？**

Resource Manager 中的 VM 最近已添加对 Azure Site Recovery 和备份的支持。我们正在积极与各团队合作，以便一并启用将 VM 迁移到 Resource Manager 的支持功能。目前，如果你正在利用这些功能，我们建议不要运行迁移。

**我是否可以验证订阅或资源，以查看其是否能够迁移？**

准备操作目前将隐式验证正在准备进行迁移的资源。在平台支持的迁移选项中，准备迁移的第一个步骤，就是验证资源是否能够进行迁移。如果验证失败，则完全不处理资源。但是，我们也正在计划推出新的验证操作，以让验证操作变得更简单。

**如果我在准备要迁移的 IaaS 资源时遇到配额错误，会发生什么情况？**

建议你中止迁移。然后记录支持请求，以在要迁移 VM 的区域中增加配额。配额请求经过批准后，请重新开始执行迁移步骤。

**如果我没有支持合同，该如何报告问题？**

请在[此处](https://social.msdn.microsoft.com/Forums/azure/zh-cn/home?forum=WAVirtualMachinesforWindows)的 VM 论坛上，使用关键字 ClassicIaaSMigration 发布有关迁移的问题和疑惑。我们建议在此论坛中发布所有问题，但是，如果你有支持合同，我们也非常欢迎你记录支持票证。

**如果我不喜欢平台在迁移期间为我的资源组选择的名称，该怎么做？**

我们很快就会推出在资源组之间移动资源的支持。在开始支持此功能之后，你可以将资源移到所选的资源组。

**如果我不喜欢平台在迁移期间选择的资源名称，该怎么做？**

在经典部署模型中显式提供名称的所有资源都会在迁移期间得到保留。在某些情况下，会创建新资源。例如：为每个 VM 创建网络接口。目前，我们不支持控制迁移期间所创建的新资源名称。请在[此处](http://feedback.azure.com)投票支持此功能。


## 后续步骤
了解经典 IaaS 资源到 Resource Manager 的迁移后，你可以开始迁移资源。

- [有关平台支持的从经典部署模型到 Azure Resource Manager 的迁移的技术深入探讨](/documentation/articles/virtual-machines-windows-migration-classic-resource-manager-deep-dive)
- [使用 PowerShell 将 IaaS 资源从经典部署模型迁移到 Azure Resource Manager](/documentation/articles/virtual-machines-windows-ps-migration-classic-resource-manager)
- [使用 CLI 将 IaaS 资源从经典部署模型迁移到 Azure Resource Manager](/documentation/articles/virtual-machines-linux-cli-migration-classic-resource-manager)
- [使用 Community PowerShell 脚本将经典虚拟机克隆到 Azure Resource Manager](/documentation/articles/virtual-machines-windows-migration-scripts)

<!---HONumber=Mooncake_0613_2016-->