---
title: 不可变的 blob 存储-Azure 存储
description: Azure 存储提供对 Blob 对象存储的 WORM（一次写入，多次读取）支持，可让用户根据指定的时间间隔，以不可擦除、不可修改的状态存储数据。
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 11/18/2019
ms.author: tamram
ms.reviewer: hux
ms.subservice: blobs
ms.openlocfilehash: 9d0919651842a6f6f935c9f1e338c9d335b80f47
ms.sourcegitcommit: 380e3c893dfeed631b4d8f5983c02f978f3188bf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/08/2020
ms.locfileid: "75749160"
---
# <a name="store-business-critical-blob-data-with-immutable-storage"></a>将业务关键 blob 数据存储在不可变的存储中

使用 Azure Blob 存储的不可变存储，用户可以在蠕虫（写入一次，读取多个）状态下存储关键业务数据对象。 此状态可以根据用户指定的时间间隔使数据保持不可擦除且不可修改的状态。 在保留间隔期间，可以创建和读取 blob，但不能修改或删除它们。 不可变存储可用于所有 Azure 区域中的常规用途 v2 和 Blob 存储帐户。

有关如何使用 Azure 门户、PowerShell 或 Azure CLI 设置和清除法律持有或创建基于时间的保留策略的信息，请参阅[设置和管理 Blob 存储的不可变性策略](storage-blob-immutability-policies-manage.md)。

## <a name="about-immutable-blob-storage"></a>关于不可变 Blob 存储

不可变的存储可帮助医疗保健组织、金融机构和相关行业&mdash;特别&mdash;的经纪人组织可以安全地存储数据。 在任何情况下，也可以利用不可变的存储来防止修改或删除关键数据。

典型的应用程序包含：

- **法规遵从**：Azure Blob 存储的不可变存储可帮助组织达到 SEC 17a-4(f)、CFTC 1.31(d)、FINRA 和其他法规要求。 Cohasset 技术白皮书通过[Microsoft 服务信任门户](https://aka.ms/AzureWormStorage)来关联不可变存储如何满足这些法规要求。 [Azure 信任中心](https://www.microsoft.com/trustcenter/compliance/compliance-overview)包含有关我们的符合性认证的详细信息。

- **保护文档保留**： Azure Blob 存储的不可变存储确保任何用户（包括具有帐户管理权限的用户）不能修改或删除数据。

- **法定持有**：对于 Azure Blob 存储，不可变的存储使用户能够将敏感信息存储在所需持续时间内的诉讼或业务使用状态，直到删除保留为止。 此功能不仅限于法律用例，还可以被视为基于事件的保留或企业锁，需要根据事件触发器或公司策略来保护数据。

不可变存储支持以下功能：

- **[基于时间的保留策略支持](#time-based-retention-policies)** ：用户可以将策略设置为在指定的时间间隔内存储数据。 设置基于时间的保留策略时，可以创建和读取 blob，但不能修改或删除 blob。 保持期到期后，可以删除但不能覆盖 blob。

- **[法律封存政策支持](#legal-holds)** ：如果保留间隔未知，则用户可以设置法律持有来存储不可变的数据，直到清除法定持有。  设置合法保留策略后，可以创建和读取 blob，但不能修改或删除 blob。 每个法律封存都与用作标识符字符串的用户定义的字母数字标记（如事例 ID、事件名称等）相关联。 

- **支持所有 Blob 层：** WORM 策略独立于 Azure Blob 存储层，将应用到所有层：热层、冷层和存档层。 用户可将工作负荷的数据转换为最具成本效益的层，同时保持数据的不可变性。

- **容器级配置：** 用户可在容器级别配置基于时间的保留策略和法定保留标记。 通过使用简单的容器级设置，用户可以创建并锁定基于时间的保留策略、扩展保留时间间隔、设置并清除法定保留，等等。 这些策略将应用到容器中的所有 Blob，不管是现有的还是新的 Blob。

- **审核日志记录支持**：每个容器都包含策略审核日志。 它为锁定的基于时间的保留策略显示最多7个基于时间的保留命令，并包含用户 ID、命令类型、时间戳和保留间隔。 对于法定保留，日志包含用户 ID、命令类型、时间戳和法定保留标记。 此日志在策略的生存期内保留，并依照 SEC 17a-4 （f）规范。 " [Azure 活动日志](../../azure-monitor/platform/platform-logs-overview.md)" 显示了所有控制平面活动的更全面的日志;启用[Azure 诊断日志](../../azure-monitor/platform/platform-logs-overview.md)时，会保留并显示数据平面操作。 由用户负责根据法规要求或其他要求永久存储这些日志。

## <a name="how-it-works"></a>如何运作

Azure Blob 存储的不可变存储支持两类 WORM 或不可变策略：基于时间的保留和法定保留。 当在容器上应用基于时间的保留策略或法定保留时，所有现有 blob 将在30秒内进入不可变蠕虫状态。 所有上传到该容器的新 blob 也将进入不可变状态。 所有 blob 都移到不可变状态后，将会确认不可变策略，并且不允许对不可变容器中的现有对象和新对象执行所有覆盖或删除操作。

如果容器或存储帐户中的任何 blob 受不可变的策略保护，则不允许删除容器和存储帐户。 如果具有锁定的基于时间的保留策略或合法保留，则容器删除操作将失败。 如果至少有一个蠕虫容器具有合法保留或具有活动保留间隔的 blob，则存储帐户删除操作将失败。

### <a name="time-based-retention-policies"></a>基于时间的保留策略

> [!IMPORTANT]
> 必须*锁定*基于时间的保留策略，以使 blob 处于符合的不可变（"写入并删除保护"）状态，以满足 SEC 17a-4 （f）和其他法规遵从性要求。 建议你在合理的时间内（通常小于24小时）锁定策略。 已应用基于时间的保留策略的初始状态为 "已*解除锁定*"，使你能够在锁定之前测试功能并对策略进行更改。 当未*锁定*状态提供永久性保护时，建议不要对短期功能试用以外的任何目的使用*解锁*状态。 

在容器上应用基于时间的保留策略时，容器中的所有 Blob 都会保持在不可变的状态，其持续时间就是有效保留期。 现有 Blob 的有效保持期就是 Blob 创建时间和用户指定的保留时间间隔之间的差异。

就新 Blob 来说，有效保持期为用户指定的保留时间间隔。 由于用户可以延长保留时间间隔，因此不可变存储使用用户指定的保留时间间隔的最新值来计算有效保留期。

例如，假设用户创建了一个基于时间的保留策略，保留间隔为5年。 该容器中的现有 blob _testblob1_是一年前创建的。 _Testblob1_的有效保持期为四年。 将新的 blob _testblob2_上载到容器时，新的 blob 的有效保持期为5年。

建议仅对功能测试使用未锁定的基于时间的保留策略，并且必须锁定策略才能符合 SEC 17a-4 （f）和其他法规遵从性。 锁定基于时间的保留策略后，将无法删除策略，并允许最多5个有效的保留期的增长。 有关如何设置和锁定基于时间的保留策略的详细信息，请参阅[设置和管理 Blob 存储的不可变性策略](storage-blob-immutability-policies-manage.md)。

以下限制适用于保留策略：

- 对于存储帐户，具有锁定的基于时间的不可变策略的容器的最大数目为1000。
- 最小保留时间间隔为 1 天。 最大值为146000天（400年）。
- 对于容器，为锁定的基于时间的不可变策略延长保留间隔的最大编辑次数为5。
- 对于容器，每个锁定的策略最多保留7个基于时间的保留策略审核日志。

### <a name="legal-holds"></a>法定保留

如果设置了法定保留，所有现有的和新的 Blob 会一直保持在不可变状态，直至法定保留被清除。 有关如何设置和清除法律持有的详细信息，请参阅为[Blob 存储设置和管理永久性策略](storage-blob-immutability-policies-manage.md)。

容器可能会同时有法定保留策略和基于时间的保留策略。 该容器中的所有 Blob 会一直保持不可变状态，直至所有法定保留被清除，即使有效保留期已过。 与之相反，即使所有法定保留已被清除，Blob 也会保持不可变状态，直至有效保留期已过。

下表显示了针对不同不可变方案禁用的 Blob 存储操作的类型。 有关详细信息，请参阅[Azure Blob 服务 REST API](https://docs.microsoft.com/rest/api/storageservices/blob-service-rest-api)文档。

|方案  |Blob 状态  |不允许 Blob 操作  |
|---------|---------|---------|
|Blob 的有效保留时间间隔尚未到期，并且/或者法定保留已设置     |不可变：不可删除和写入         | Put Blob<sup>1</sup>，put 块<sup>1</sup>，put 块列表<sup>1</sup>，删除容器，删除 blob，设置 blob 元数据，Put 页，设置 Blob 属性，快照 Blob，增量复制 Blob，追加块         |
|Blob 的有效保留时间间隔尚未到期     |仅仅不可写入（允许删除操作）         |放置 Blob<sup>1</sup>、放置块<sup>1</sup>、放置块列表<sup>1</sup>、设置 Blob 元数据、放置页、设置 Blob 属性、快照 Blob、增量复制 Blob、追加块         |
|清除了所有法定保留，未在容器上设置任何基于时间的保留策略     |可变         |无         |
|未创建任何 WORM 策略（基于时间的保留或法定保留）     |可变         |无         |

<sup>1</sup>应用程序允许这些操作创建一次新的 blob。 不允许对不可变容器中的现有 blob 路径执行所有后续的覆盖操作。

以下限制适用于法律持有：

- 对于某个存储帐户而言，使用法定保留设置的最大容器数为 1,000。
- 对于某个容器而言，最大法定保留标记数为 10。
- 合法保留标记的最小长度为三个字母数字字符。 最大长度为23个字母数字字符。
- 对于容器，在策略的持续时间内最多保留10个合法保留策略审核日志。

## <a name="pricing"></a>价格

使用此功能不会产生额外的费用。 不可变数据的定价方式与可变数据相同。 有关 Azure Blob 存储的定价详细信息，请参阅[Azure 存储定价页](https://azure.microsoft.com/pricing/details/storage/blobs/)。

## <a name="faq"></a>常见问题

**能否提供蠕虫符合性的文档？**

可以。 为了记录相容性，Microsoft 保留了一个领先的独立评估事务所，该公司专用于记录管理和信息管理、Cohasset 关联，以评估不可变的 Blob 存储及其与特定于金融服务行业。 Cohasset 验证当用于在蠕虫状态下保留基于时间的 Blob 时，不可变的 Blob 存储满足 CFTC 规则1.31 （c）-（d）、FINRA 规则4511和 SEC 规则17a-4 的相关存储要求。 Microsoft 以这组规则为目标，因为它们表示针对金融机构的记录保留内容的最具规范性指导。 [Microsoft 服务信任中心](https://aka.ms/AzureWormStorage)提供了 Cohasset 报告。 若要从 Microsoft 请求有关蠕虫符合性的证明，请联系 Azure 支持部门。

**此功能是只适用于块 Blob，还是也适用于页 Blob 和追加 Blob？**

不可变存储可与任何 blob 类型一起使用，因为它是在容器级别设置的，但我们建议你将蠕虫用于主要存储块 blob 的容器。 与块 blob 不同，任何新的页 blob 和追加 blob 都需要在蠕虫容器外部创建，然后复制到中。 将这些 blob 复制到蠕虫容器后，不再允许追加*到追加*blob 或对页 blob 进行更改。 不建议在为任何活动的虚拟机存储 Vhd （页 blob）的容器上设置蠕虫策略，因为它会锁定 VM 磁盘。

**是否需要创建新的存储帐户才能使用此功能？**

不可以，可以将不可变存储用于任何现有的或新创建的常规用途 v2 或 Blob 存储帐户。 此功能适用于 GPv2 和 Blob 存储帐户中的块 blob。 常规用途 v1 存储帐户不受支持，但可以轻松升级到常规用途 v2。 有关升级现有常规用途 v1 存储帐户的信息，请参阅[升级存储帐户](../common/storage-account-upgrade.md)。

**是否可以同时应用合法保留和基于时间的保留策略？**

是的，容器可以同时具有法定保留和基于时间的保留策略。 该容器中的所有 Blob 会一直保持不可变状态，直至所有法定保留被清除，即使有效保留期已过。 与之相反，即使所有法定保留已被清除，Blob 也会保持不可变状态，直至有效保留期已过。

**合法保留策略是否仅适用于法律程序或是否有其他使用情况？**

不需要，合法保留只是用于非基于时间的保留策略的一般术语。 它不需要仅用于诉讼相关的诉讼。 合法保留策略有助于禁用覆盖和删除，以便保护重要的企业蠕虫数据，其中的保留期是未知的。 在自定义事件触发器需要使用基于时间的保留策略之前，你可以将其用作企业策略来保护你的任务关键型蠕虫工作负荷，或将其用作过渡策略。 

**能否删除_锁定_的基于时间的保留策略或合法保留？**

仅可从容器中删除未锁定的基于时间的保留策略。 锁定基于时间的保留策略后，无法将其删除;仅允许有效的保留期扩展。 可删除合法保留标记。 删除所有合法标记后，将删除合法保留。

**如果尝试删除某个容器，而该容器使用锁定的基于时间的保留策略或法定保留，会发生什么情况？**

如果至少存在一个 Blob 使用锁定的基于时间的保留策略或法定保留，则“删除容器”操作会失败。 仅当没有 Blob 存在活动的保留时间间隔，也没有法定保留时，“删除容器”操作才会成功。 必须先删除 Blob，然后才能删除容器。

**如果尝试删除的存储帐户有一个 WORM 容器，而该容器使用锁定的基于时间的保留策略或法定保留，会发生什么情况？**

如果至少有一个 WORM 容器有法定保留，或者有一个 Blob 有活动的保留时间间隔，则存储帐户删除操作会失败。 必须先删除所有 WORM 容器，然后才能删除存储帐户。 有关删除容器的信息，请查看上一个问题。

**当 Blob 处于不可变状态时，是否可以跨不同的 Blob 层（热、凉、冷）来移动数据？**

是的，可以使用 "设置 Blob 层" 命令在 Blob 层间移动数据，同时使数据处于符合的不可变状态。 热、冷和存档 Blob 层均支持不可变存储。

**如果我无法付款，但我的保留时间间隔尚未到期，会发生什么情况？**

在未付款的情况下，会根据你与 Microsoft 签署的合同条款与条件应用常规的数据保留策略。

**你们是否为只想试用此功能的用户提供试用期或宽限期？**

可以。 首次创建基于时间的保留策略时，该策略处于*解锁*状态。 在这种状态下，可以对保留时间间隔进行所需的更改，例如延长或缩短保留时间间隔，甚至可以删除策略。 策略被锁定后，它将保持锁定状态，直到保留时间间隔到期为止。 此锁定策略可防止删除和修改保留间隔。 我们强烈建议仅在试用的情况下使用未锁定状态，并在 24 小时内锁定策略。 这种做法有助于遵守 SEC 17a-4(f) 及其他法规。

**是否可以使用可变 blob 策略的软删除？**

可以。 [Azure Blob 存储的软删除](storage-blob-soft-delete.md)适用于存储帐户中的所有容器，而不考虑合法保留或基于时间的保留策略。 建议在应用和确认任何不可变的蠕虫策略之前，启用软删除以进行额外保护。

**此功能可用在何处？**

Azure 公共区域、中国区域和政府区域均提供不可变存储。 如果区域中没有不可变的存储，请联系支持人员和电子邮件 azurestoragefeedback@microsoft.com。

## <a name="next-steps"></a>后续步骤

[为 Blob 存储设置和管理永久性策略](storage-blob-immutability-policies-manage.md)