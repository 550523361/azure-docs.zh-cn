---
title: 自动缩放和区域冗余应用程序网关 v2
description: 本文介绍 Azure 应用程序 Standard_v2 和 WAF_v2 SKU，其中包括自动缩放和区域冗余功能。
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: conceptual
ms.date: 06/06/2020
ms.author: victorh
ms.custom: fasttrack-edit, references_regions
ms.openlocfilehash: 4caed3f330dd3e50fe2652a2cd33c0e4249f2fd9
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/02/2020
ms.locfileid: "85254338"
---
# <a name="autoscaling-and-zone-redundant-application-gateway-v2"></a>自动缩放和区域冗余应用程序网关 v2 

应用程序网关和 Web 应用程序防火墙 (WAF) 也可在 Standard_v2 和 WAF_v2 SKU 下使用。 v2 SKU 可增强性能并添加对关键新功能（如自动缩放、区域冗余）的支持，并支持静态 VIP。 新 v2 SKU 将继续支持标准和 WAF SKU 下的现有功能，除了[比较](#differences-from-v1-sku)部分中列出的几种例外情况。

新的 v2 SKU 包括以下增强功能：

- 自动缩放：凭借自动缩放 SKU，应用程序网关或 WAF 部署可根据变化中的流量负载模式增加或减少。 自动缩放还无需在预配期间要求选择部署大小或实例计数。 此 SKU 提供了真正的弹性。 在 Standard_v2 和 WAF_v2 SKU 中，应用程序网关可同时在固定容量（自动缩放已禁用）和已启用自动缩放的模式下进行操作。 固定容量模式对具有一致性和可预测工作负荷的方案非常有用。 自动缩放模式有利于在应用程序流量中出现变化的应用程序。
- **区域冗余**：应用程序网关或 WAF 部署可跨多个可用性区域，因此不需使用流量管理器在每个区域预配单独的应用程序网关实例。 可以选择一个区域或多个区域来部署应用程序网关实例，这使它在发生区域故障时具有更强的复原能力。 应用程序的后端池可以通过类似方式分布在多个可用性区域中。

  区域冗余仅适用于 Azure 区域可用的情况。 在其他区域中，支持所有其他功能。 有关详细信息，请参阅 [Azure 中的区域和可用性区域](../availability-zones/az-overview.md)
- **静态 VIP**：应用程序网关 v2 SKU 支持独占形式的静态 VIP 类型。 这样可确保与应用程序网关关联的 VIP 在部署的生命周期内不会更改（即使是在重启之后）。  v1 中没有静态 VIP，因此必须使用应用程序网关 URL（而不是 IP 地址），以便通过应用程序网关将域名路由到应用服务。
- 标头重写：借助 v2 SKU，可以通过应用程序网关添加、删除或更新 HTTP 请求和响应标头。 有关详细信息，请参阅[使用应用程序网关重写 HTTP 标头](rewrite-http-headers.md)
- 密钥保管库集成：应用程序网关 v2 支持与密钥保管库集成，以获取附加到支持 HTTPS 的侦听器的服务器证书。 有关详细信息，请参阅[使用密钥保管库证书实现 TLS 终止](key-vault-certs.md)。
- Azure Kubernetes 服务入口控制器：应用程序网关 v2 入口控制器允许将 Azure 应用程序网关用作 Azure Kubernetes 服务 (AKS) 的入口（称为 AKS 群集）。 有关详细信息，请参阅[？](ingress-controller-overview.md)。
- **性能增强**：与标准/WAF SKU 相比，v2 SKU 可提供高达 5 倍的 TLS 卸载性能。
- 缩短部署和更新时间：与标准/WAF SKU 相比，v2 SKU 缩短了部署和更新时间。 这还包括 WAF 配置更改。

![自动缩放区域的图示。](./media/application-gateway-autoscaling-zone-redundant/application-gateway-autoscaling-zone-redundant.png)

## <a name="supported-regions"></a>支持的区域

已在以下区域推出 Standard_v2 和 WAF_v2 SKU：美国中北部、美国中南部、美国西部、美国西部 2、美国东部、美国东部 2、美国中部、欧洲北部、欧洲西部、东南亚、法国中部、英国西部、日本东部、日本西部、澳大利亚东部、澳大利亚东南部、巴西南部、加拿大中部、加拿大东部、东亚、韩国中部、韩国南部、英国南部、印度中部、印度西部、印度南部。

## <a name="pricing"></a>定价

使用 v2 SKU 时，定价模型取决于消耗量，不再附加到实例计数或大小。 v2 SKU 定价有两个组成部分：

- 固定价格 - 这是用于预配 Standard_v2 或 WAF_v2 网关的每小时（或部分小时）价格。 请注意，0 个额外最小实例仍可确保服务的高可用性，这始终包含在固定价格中。
- 容量单位价格 - 这是用于基于消耗量的成本，计费时会在固定成本的基础上加上该成本。 容量单位费用也按每小时或部分每小时进行计算。 容量单位有三个维度：计算单位、持续连接数和吞吐量。 计算单位用于度量已使用的处理器容量。 影响计算单位的因素包括 TLS 连接数/秒、URL 重写计算以及 WAF 规则处理。 持续连接数用于度量在给定计费间隔内与应用程序网关之间已建立的 TCP 连接数。 吞吐量是在给定计费间隔内，平均每秒由系统处理的兆位数。  对于超出保留实例计数的任何内容，都会在容量单位级别进行计费。

每个容量单位最多包括：1个计算单元、2500持久连接和 2.22-Mbps 吞吐量。

计算单位指南：

- Standard_v2 - 每个计算单位每秒能够建立大约 50 个连接（使用 RSA 2048 位密钥 TLS 证书）。
- WAF_v2 - 每个计算单位每秒可以支持大约 10 个并发请求（对于 70-30% 的流量混合，其中 70% 请求小于 2 KB GET/POST，而其余请求会更高）。 WAF 性能当前不受响应大小影响。

> [!NOTE]
> 每个实例当前可以支持大约 10 个容量单位。
> 计算单位可处理的请求数取决于各种条件，例如 TLS 证书密钥大小、密钥交换算法、标头重写以及 WAF 传入请求大小。 建议执行应用程序测试来确定每个计算单位的请求速率。 开始计费之前，容量单位和计算单位都作为指标提供。

下表显示示例价格，仅用于说明。

美国东部定价：

|              SKU 名称                             | 固定价格（美元/小时）  | 容量单位价格（美元/CU 小时）   |
| ------------------------------------------------- | ------------------- | ------------------------------- |
| Standard_v2                                       |    0.20             | 0.0080                          |
| WAF_v2                                            |    0.36             | 0.0144                          |

有关详细定价信息，请参阅[定价页面](https://azure.microsoft.com/pricing/details/application-gateway/)。 

**示例 1**

应用程序网关 Standard_v2 会在手动缩放模式下进行预配（没有自动缩放），具有五个实例的固定容量。

固定价格 = 744（小时）* 0.20 美元 = 148.8 美元 <br>
容量单位 = 744（小时）* 10 个容量单位/实例 * 5 个实例 * 0.008 美元/容量单位小时 = 297.6 美元

总价 = 148.8 美元 + 297.6 美元 = 446.4 美元

**示例 2**

应用程序网关 standard_v2 预配了一个月，最少有零个实例，在这段时间内它每秒接收 25 个新 TLS 连接，数据传输平均为 8.88 Mbps。 假设连接生命周期较短，则价格将为：

固定价格 = 744（小时）* 0.20 美元 = 148.8 美元

容量单位价格 = 744（小时）* Max(用于每秒连接数的 25/50 个计算单位, 用于吞吐量的 8.88/2.22 个容量单位) * 0.008 美元 = 744 * 4 * 0.008 = 23.81 美元

总价 = 148.8 美元 + 23.81 美元 = 172.61 美元

如你所见，只对四个容量单位计费，而不是针对整个实例计费。 

> [!NOTE]
> Max 函数返回一对值中的较大值。


**示例 3**

应用程序网关 standard_v2 预配了一个月，最少有五个实例。 假设没有流量且连接生命周期较短，则价格将为：

固定价格 = 744（小时）* 0.20 美元 = 148.8 美元

容量单位价格 = 744（小时）* Max(用于每秒连接数的 0/50 个计算单位, 用于吞吐量的 0/2.22 个容量单位) * 0.008 美元 = 744 * 50 * 0.008 = 297.60 美元

总价 = 148.80 美元 + 297.60 美元 = 446.4 美元

在这种情况下，对所有五个实例计费，即使没有流量也是如此。

**示例 4**

应用程序网关 standard_v2 预配了一个月，最少有五个实例，但是在这段时间内数据传输平均为 125 Mbps，并且每秒建立 25 个 TLS 连接。 假设没有流量且连接生命周期较短，则价格将为：

固定价格 = 744（小时）* 0.20 美元 = 148.8 美元

容量单位价格 = 744（小时）* Max(用于每秒连接数的 25/50 个计算单位, 用于吞吐量的 125/2.22 个容量单位) * 0.008 美元 = 744 * 57 * 0.008 = 339.26 美元

总价 = 148.80 美元 + 339.26 美元 = 488.06 美元

在这种情况下，对所有五个实例计费，再加上七个容量单位（这是实例的 7/10）。  

**示例 5**

应用程序网关 WAF_v2 预配了一个月。 在这段时间内，它每秒接收 25 个新 TLS 连接，平均数据传输为 8.88 Mbps，并且每秒执行 80 个请求。 假设连接的生命周期较短，并且应用程序的计算单位计算支持每个计算单位 10 RPS，则价格将为：

固定价格 = 744（小时）* 0.36 美元 = 267.84 美元

容量单位价格 = 744（小时）* Max(Max(用于每秒连接数的 25/50, 80/10 WAF RPS) 个计算单位, 用于吞吐量的 8.88/2.22 个容量单位) * 0.0144 美元 = 744 * 8 * 0.0144 = 85.71 美元

总价 = 267.84 美元 + 85.71 美元 = 353.55 美元

> [!NOTE]
> Max 函数返回一对值中的较大值。

## <a name="scaling-application-gateway-and-waf-v2"></a>缩放应用程序网关和 WAF v2

应用程序网关和 WAF 可配置为在两种模式下进行缩放：

- 自动缩放 - 启用自动缩放后，应用程序网关和 WAF v2 SKU 会基于应用程序流量要求增加或缩减。 此模式可为应用程序提供更好的弹性，无需猜测应用程序网关大小或实例计数。 此模式使你可以不要求网关在用于预期最大流量负载的峰值预配容量上运行，从而可节省成本。 必须指定最小实例计数，可以选择指定最大实例计数。 最小容量可确保应用程序网关和 WAF v2 不低于指定的最小实例计数，即使在没有流量时也是如此。 每个实例大致相当于 10 个额外的保留容量单位。 零表示没有保留容量，在本质上是纯自动缩放。 还可以选择指定最大实例计数，以确保应用程序网关不会缩放到超出指定实例数。 只会对网关处理的流量计费。 实例计数的范围介于 0 到 125 之间。 如果未指定，则最大实例计数的默认值为 20。
- 手动 - 或者可以选择网关不自动缩放的手动模式。 在此模式下，如果流量超出了应用程序网关或 WAF 可以处理的流量，则可能会导致流量损失。 对于手动模式，必须指定实例计数。 实例计数可以在 1 到 125 个实例间变化。

## <a name="autoscaling-and-high-availability"></a>自动缩放和高可用性

Azure 应用程序网关始终以高度可用的方式进行部署。 该服务由按照配置（如果禁用了自动缩放）或应用程序负载要求（如果启用了自动缩放）而创建的多个实例组成。 请注意，从用户的角度来看，你不一定可查看各个实例，而是只能查看整个应用程序网关服务。 如果某个实例出现问题并停止运行，Azure 应用程序网关将以透明方式创建新实例。

请注意，即使配置最小实例数为零的自动缩放，服务仍具有高可用性，这始终包含在固定价格中。

但是，创建新实例可能需要一些时间（大约六到七分钟）。 因此，如果不想应付此停机时间，则可以将最小实例计数配置为 2（理想情况是具有可用性区域支持）。 这样在正常情况下，Azure 应用程序网关中至少有两个实例，因此，如果其中一个实例遇到问题，则在创建新实例的过程中，另一个实例将尝试处理流量。 请注意，Azure 应用程序网关实例可支持大约 10 个容量单位，因此，根据通常处理的流量，你可能要将最小实例自动缩放设置配置为大于 2 的值。

## <a name="feature-comparison-between-v1-sku-and-v2-sku"></a>v1 SKU 与 v2 SKU 之间的功能比较

下表比较了每个 SKU 的可用功能。

|                                                   | v1 SKU   | v2 SKU   |
| ------------------------------------------------- | -------- | -------- |
| 自动缩放                                       |          | &#x2713; |
| 区域冗余                                   |          | &#x2713; |
| 静态 VIP                                        |          | &#x2713; |
| Azure Kubernetes 服务 (AKS) 入口控制器 |          | &#x2713; |
| Azure 密钥保管库集成                       |          | &#x2713; |
| 重写 HTTP(S) 标头                           |          | &#x2713; |
| 基于 URL 的路由                                 | &#x2713; | &#x2713; |
| 多站点托管                             | &#x2713; | &#x2713; |
| 流量重定向                               | &#x2713; | &#x2713; |
| Web 应用程序防火墙 (WAF)                    | &#x2713; | &#x2713; |
| WAF 自定义规则                                  |          | &#x2713; |
| 传输层安全性 (TLS)/安全套接字层 (SSL) 终止            | &#x2713; | &#x2713; |
| 端到端 TLS 加密                         | &#x2713; | &#x2713; |
| 会话相关性                                  | &#x2713; | &#x2713; |
| 自定义错误页                                | &#x2713; | &#x2713; |
| WebSocket 支持                                 | &#x2713; | &#x2713; |
| HTTP/2 支持                                    | &#x2713; | &#x2713; |
| 连接清空                               | &#x2713; | &#x2713; |

> [!NOTE]
> 自动缩放 v2 SKU 现在支持[默认运行状况探测](application-gateway-probe-overview.md#default-health-probe)，以自动监视其后端池中所有资源的运行状况，并突出显示被视为运行不正常的后端成员。 对于没有任何自定义探测配置的后端，将自动配置默认运行状况探测。 若要了解详细信息，请参阅[应用程序网关中的 运行状况探测](application-gateway-probe-overview.md)。

## <a name="differences-from-v1-sku"></a>与 v1 SKU 的差异

此部分介绍 v2 SKU 与 v1 SKU 不同的功能和限制。

|差异|详细信息|
|--|--|
|身份验证证书|不支持。<br>有关详细信息，请参阅[应用程序网关的端到端 TLS 概述](ssl-overview.md#end-to-end-tls-with-the-v2-sku)。|
|在同一子网上混合使用 Standard_v2 和标准应用程序网关|不支持|
|应用程序网关子网上的用户定义路由 (UDR)|支持（特定方案）。 预览版。<br> 有关支持的方案的详细信息，请参阅[应用程序网关配置概述](configuration-overview.md#user-defined-routes-supported-on-the-application-gateway-subnet)。|
|入站端口范围的 NSG| 对于 Standard_v2 SKU，为 - 65200 到 65535<br>对于标准 SKU，为 - 65503 到 65534<br>有关详细信息，请参阅[常见问题](application-gateway-faq.md#are-network-security-groups-supported-on-the-application-gateway-subnet)。|
|Azure 诊断中的性能日志|不支持。<br>应当使用 Azure 指标。|
|计费|计划于 2019 年 7 月 1 日开始计费。|
|FIPS 模式|目前不支持。|
|“仅 ILB”模式|目前不支持。 同时支持公共和 ILB 模式。|
|网络观察程序集成|不支持。|
|Azure 安全中心集成|尚不可用。

## <a name="migrate-from-v1-to-v2"></a>从 v1 迁移到 v2

PowerShell 库中提供一个 Azure PowerShell 脚本，可帮助你从 v1 应用程序网关/WAF 迁移到 v2 自动缩放 SKU。 此脚本可帮助你从 v1 网关复制配置。 流量迁移仍由你负责。 有关详细信息，请参阅[将 Azure 应用程序网关从 v1 迁移到 v2](migrate-v1-v2.md)。

## <a name="next-steps"></a>后续步骤

- [快速入门：使用 Azure 应用程序网关定向 Web 流量 - Azure 门户](quick-create-portal.md)
- [使用 Azure PowerShell 创建具有预留虚拟 IP 地址的自动缩放区域冗余应用程序网关](tutorial-autoscale-ps.md)
- 了解有关[应用程序网关](overview.md)的详细信息。
- 了解有关 [Azure 防火墙](../firewall/overview.md)的详细信息。
