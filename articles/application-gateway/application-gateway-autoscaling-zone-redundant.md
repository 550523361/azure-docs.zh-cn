---
title: 自动缩放和区域冗余应用程序网关 v2
description: 本文介绍了 Azure 应用程序 Standard_v2 和 WAF_v2 SKU，其中包括自动缩放和区域冗余功能。
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 02/26/2020
ms.author: victorh
ms.openlocfilehash: 39b7e94747f556b61f661968f7126d122156d9cf
ms.sourcegitcommit: 5a71ec1a28da2d6ede03b3128126e0531ce4387d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/26/2020
ms.locfileid: "77622019"
---
# <a name="autoscaling-and-zone-redundant-application-gateway-v2"></a>自动缩放和区域冗余应用程序网关 v2 

应用程序网关和 Web 应用程序防火墙（WAF）也可在 Standard_v2 和 WAF_v2 SKU 中使用。 V2 SKU 提供了性能增强功能，并添加了对关键新功能（如自动缩放、区域冗余和对静态 Vip 的支持）的支持。 标准版和 WAF SKU 下的现有功能继续在新的 v2 SKU 中受支持，但在 "[比较](#differences-with-v1-sku)" 一节中列出了一些例外。

新的 v2 SKU 包括以下增强功能：

- 自动缩放：凭借自动缩放 SKU，应用程序网关或 WAF 部署可根据变化中的流量负载模式增加或减少。 自动缩放还无需在预配期间要求选择部署大小或实例计数。 此 SKU 提供 true 弹性。 在 Standard_v2 和 WAF_v2 SKU 中，应用程序网关可在固定容量（禁用自动缩放）和启用自动缩放模式下运行。 固定容量模式对具有一致性和可预测工作负荷的方案非常有用。 在应用程序中，自动缩放模式对于查看应用程序流量的变化很有用。
- **区域冗余**：应用程序网关或 WAF 部署可跨多个可用性区域，从而无需在每个区域中使用流量管理器设置单独的应用程序网关实例。 你可以选择在其中部署应用程序网关实例的单个区域或多个区域，这使得它能够更灵活地应对区域故障。 应用程序的后端池可以通过类似方式分布在多个可用性区域中。

  区域冗余仅适用于 Azure 区域可用的位置。 在其他区域中，支持所有其他功能。 有关详细信息，请参阅 [Azure 中的可用性区域是什么？](../availability-zones/az-overview.md#services-support-by-region)
- **静态 vip**：应用程序网关 v2 SKU 仅支持静态 vip 类型。 这可以确保即使在重启后，与应用程序网关关联的 VIP 也不会在部署的生命周期内更改。  V1 中没有静态 VIP，因此你必须使用应用程序网关 URL，而不是通过应用程序网关将域名路由到应用服务的 IP 地址。
- **标头重写**：通过应用程序网关，可以通过 v2 SKU 添加、删除或更新 HTTP 请求和响应标头。 有关详细信息，请参阅[在应用程序网关上重写 HTTP 标头](rewrite-http-headers.md)
- **Key Vault 集成**：对于附加到启用 HTTPS 的侦听器的服务器证书，应用程序网关 v2 支持与 Key Vault 集成。 有关详细信息，请参阅[SSL 终止，并 Key Vault 证书](key-vault-certs.md)。
- **Azure Kubernetes 服务入口控制器**：应用程序网关 V2 入口控制器允许 Azure 应用程序网关用作 Azure Kubernetes 服务（AKS）的入口（称为 AKS 群集）。 有关详细信息，请参阅[什么是应用程序网关入口控制器？](ingress-controller-overview.md)。
- **性能增强**：与标准/WAF sku 相比，v2 SKU 提供多达5倍的 SSL 卸载性能。
- **更快的部署和更新时间**与标准/WAF SKU 相比，v2 SKU 提供更快的部署和更新时间。 这还包括 WAF 配置更改。

![](./media/application-gateway-autoscaling-zone-redundant/application-gateway-autoscaling-zone-redundant.png)

## <a name="supported-regions"></a>支持的区域

Standard_v2 和 WAF_v2 SKU 在以下区域提供：美国中北部、美国中南部、美国西部、美国西部2、美国东部、美国东部2、美国中部、北欧、西欧、东南亚、法国中部、英国西部、日本东部、日本西部、澳大利亚东部、澳大利亚东南部、巴西南部、加拿大中部、加拿大东部、东亚、韩国中部、韩国南部、英国南部、印度中部、印度西部、印度南部、印度西部、印度南部、印度西部、印度南部。

## <a name="pricing"></a>定价

使用 v2 SKU，定价模型由消耗驱动，不再附加到实例计数或大小。 V2 SKU 定价有两个组件：

- **固定价格**-预配 Standard_v2 或 WAF_v2 网关需要按小时（或部分小时）价格。 请注意，0个额外的最小实例仍可确保服务的高可用性，该服务始终附带固定价格。
- **容量单位价格**-这是一种基于消耗的成本，除固定成本之外，还需要支付费用。 容量单位费用也按每小时或每小时部分计算。 容量单元计算单元、持续连接和吞吐量有三个维度。 计算单位是使用的处理器容量度量值。 影响计算单元的因素包括 TLS 连接数/秒、URL 重写计算和 WAF 规则处理。 永久性连接是指按照给定计费间隔，与应用程序网关建立的 TCP 连接的度量。 吞吐量是系统在给定计费间隔内处理的平均兆位/秒。  对于超出保留实例计数的任何内容，将在容量单元级别完成计费。

每个容量单位的最大数目为：1个计算单元、2500持续连接或 2.22-Mbps 吞吐量。

计算单元指南：

- **Standard_v2** -每个计算单元每秒可以有大约50个连接，并且具有 RSA 2048 位密钥 TLS 证书。
- **WAF_v2** -每个计算单元可支持每秒大约10个并发请求，以70-30% 的流量混合，70% 请求小于 2 KB GET/POST 和更高版本。 目前，WAF 性能不受响应大小的影响。

> [!NOTE]
> 每个实例当前可支持大约10个容量单位。
> 计算单元可处理的请求数取决于各种条件，例如 TLS 证书密钥大小、密钥交换算法、标头重写以及 WAF 传入请求大小。 建议你执行应用程序测试来确定每个计算单元的请求速率。 开始计费之前，容量单元和计算单元将作为指标提供。

下表显示了示例价格，仅用于说明目的。

**美国东部价格**：

|              SKU 名称                             | 固定价格（$ 美元/小时）  | 容量单位价格（$/CU-hr）   |
| ------------------------------------------------- | ------------------- | ------------------------------- |
| Standard_v2                                       |    0.20             | 0.0080                          |
| WAF_v2                                            |    0.36             | 0.0144                          |

有关定价的详细信息，请参阅[定价页](https://azure.microsoft.com/pricing/details/application-gateway/)。 

**示例 1**

预配应用程序网关 Standard_v2，无需在手动缩放模式下自动缩放，且具有固定容量的五个实例。

固定价格 = 744 （小时） * $0.20 = $148。8 <br>
容量单位 = 744 （小时） * 每个实例10个容量单位 * 5 个实例 * $0.008 每个容量单位小时 = $297。6

总价 = $148.8 + $297.6 = $446。4

**示例 2**

应用程序网关 standard_v2 预配了一个月，最小实例数为零，在这段时间内它每秒接收了25个新的 SSL 连接，平均为 8.88-Mbps 的数据传输。 假设连接寿命较短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大值（25/50 的计算单元数/秒，8.88/2.22 容量单位） * $0.008 = 744 * 4 * 0.008 = $23.81

总价 = $ 148.8 + 23.81 = $172.61

如您所见，只对四个容量单元计费，而不是针对整个实例计费。 

> [!NOTE]
> Max 函数返回一对值中的最大值。


**示例 3**

应用程序网关 standard_v2 预配了一个月，其中至少有五个实例。 假设没有流量，并且连接的生存期很短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大值（0/50 的计算单元数/秒，0/2.22 容量单位） * $0.008 = 744 * 50 * 0.008 = $297.60

总价 = $ 148.80 + 297.60 = $446。4

在这种情况下，即使没有流量，也只需支付5个实例的全部费用。

**示例 4**

应用程序网关 standard_v2 预配了一个月，其中至少有五个实例，但这一次平均使用了 125-mbps 数据传输，每秒25个 SSL 连接。 假设没有流量，并且连接的生存期很短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大（25/50 个用于连接的计算单元/秒，125/2.22 容量单位用于吞吐量） * $0.008 = 744 * 57 * 0.008 = $339.26

总价 = $ 148.80 + 339.26 = $488.06

在这种情况下，系统会对完整的五个实例进行计费，并向你收取7个容量单位（实例为7/10）。  

**示例 5**

应用程序网关 WAF_v2 预配了一个月。 在此期间，它将接收25个新的 SSL 连接数/秒，平均为 8.88-Mbps 数据传输，每秒执行80个请求。 假设连接的生存期很短，并且应用程序的计算单元计算支持每个计算单元10个 RPS，则价格将为：

固定价格 = 744 （小时） * $0.36 = $267.84

容量单位价格 = 744 （小时） * 最大值（计算单位上限（25/50 for connections/sec，80/10 WAF RPS），8.88/2.22 容量单位为吞吐量） * $0.0144 = 744 * 8 * 0.0144 = $85.71

总价 = $267.84 + $85.71 = $353.55

> [!NOTE]
> Max 函数返回一对值中的最大值。

## <a name="scaling-application-gateway-and-waf-v2"></a>缩放应用程序网关和 WAF v2

应用程序网关和 WAF 可以配置为在两种模式下进行缩放：

- 自动**缩放**-启用自动缩放后，应用程序网关和 WAF v2 sku 会根据应用程序流量需求增加或减少。 此模式为应用程序提供更好的弹性，无需猜测应用程序网关大小或实例计数。 通过此模式，还可以节省成本，因为无需在配置最大的容量的情况下运行网关来实现预期的最大流量负载。 您必须指定最小和最大实例计数。 最小容量确保应用程序网关和 WAF v2 不低于指定的最小实例计数，即使在没有流量时也是如此。 每个实例都计为10个额外的保留容量单位。 零表示没有保留的容量并且在本质上是纯自动缩放。 请注意，零个额外的最小实例仍可确保服务的高可用性，该服务始终附带固定价格。 还可以选择指定最大实例计数，以确保应用程序网关不会扩展到超出指定数量的实例。 你将继续根据网关提供的流量数量向你收费。 实例计数的范围介于0到125之间。 如果未指定，则 "最大实例计数" 的默认值为20。
- **手动**-你可以选择 "手动" 模式，在该模式下网关不会自动缩放。 在此模式下，如果流量超出了应用程序网关或 WAF 可以处理的流量，可能会导致流量损失。 对于手动模式，指定实例计数是必需的。 实例数可能因1到125实例而异。

## <a name="feature-comparison-between-v1-sku-and-v2-sku"></a>V1 SKU 和 v2 SKU 之间的功能比较

下表比较了每个 SKU 的可用功能。

|                                                   | v1 SKU   | v2 SKU   |
| ------------------------------------------------- | -------- | -------- |
| 自动缩放                                       |          | &#x2713; |
| 区域冗余                                   |          | &#x2713; |
| 静态 VIP                                        |          | &#x2713; |
| Azure Kubernetes 服务（AKS）入口控制器 |          | &#x2713; |
| Azure 密钥保管库集成                       |          | &#x2713; |
| 重写 HTTP （S）标头                           |          | &#x2713; |
| 基于 URL 的路由                                 | &#x2713; | &#x2713; |
| 多站点托管                             | &#x2713; | &#x2713; |
| 流量重定向                               | &#x2713; | &#x2713; |
| Web 应用程序防火墙 (WAF)                    | &#x2713; | &#x2713; |
| WAF 自定义规则                                  |          | &#x2713; |
| 安全套接字层 (SSL) 终止            | &#x2713; | &#x2713; |
| 端到端 SSL 加密                         | &#x2713; | &#x2713; |
| 会话相关性                                  | &#x2713; | &#x2713; |
| 自定义错误页                                | &#x2713; | &#x2713; |
| WebSocket 支持                                 | &#x2713; | &#x2713; |
| HTTP/2 支持                                    | &#x2713; | &#x2713; |
| 连接清空                               | &#x2713; | &#x2713; |

> [!NOTE]
> 自动缩放 v2 SKU 现在支持[默认的运行状况探测](application-gateway-probe-overview.md#default-health-probe)，以自动监视其后端池中所有资源的运行状况，并突出显示那些被视为不正常的后端成员。 对于没有任何自定义探测配置的后端，将自动配置默认运行状况探测。 若要了解详细信息，请参阅[应用程序网关上的运行状况探测](application-gateway-probe-overview.md)。

## <a name="differences-with-v1-sku"></a>与 v1 SKU 之间的差异

|差别|详细信息|
|--|--|
|身份验证证书|不支持。<br>有关详细信息，请参阅[应用程序网关的端到端 SSL 概述](ssl-overview.md#end-to-end-ssl-with-the-v2-sku)。|
|在同一子网上混合使用 Standard_v2 和标准应用程序网关|不支持|
|应用程序网关子网上的用户定义路由 (UDR)|不支持|
|入站端口范围的 NSG| 对于 Standard_v2 SKU，为 - 65200 到 65535<br>对于标准 SKU，为 - 65503 到 65534<br>有关详细信息，请参阅[常见问题](application-gateway-faq.md#are-network-security-groups-supported-on-the-application-gateway-subnet)。|
|Azure 诊断中的性能日志|不支持。<br>应当使用 Azure 指标。|
|计费|计费计划于2019年7月1日开始。|
|FIPS 模式|目前不支持。|
|“仅 ILB”模式|目前不支持。 同时支持公共和 ILB 模式。|
|Netwatcher 集成|不支持。|
|Azure 安全中心集成|尚不可用。

## <a name="migrate-from-v1-to-v2"></a>从 v1 迁移到 v2

PowerShell 库中提供了一个 Azure PowerShell 脚本，可帮助你从 v1 应用程序网关/WAF 迁移到 v2 自动缩放 SKU。 此脚本可帮助你从 v1 网关上复制配置。 流量迁移仍是您的责任。 有关详细信息，请参阅[将 Azure 应用程序网关从 V1 迁移到 v2](migrate-v1-v2.md)。

## <a name="next-steps"></a>后续步骤

- [快速入门：通过 Azure 应用程序网关的直接 web 流量-Azure 门户](quick-create-portal.md)
- [使用 Azure PowerShell 创建具有预留虚拟 IP 地址的自动缩放区域冗余应用程序网关](tutorial-autoscale-ps.md)
- 了解有关[应用程序网关](overview.md)的详细信息。
- 了解有关 [Azure 防火墙](../firewall/overview.md)的详细信息。
