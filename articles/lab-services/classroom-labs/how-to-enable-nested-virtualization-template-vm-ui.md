---
title: 在 Azure 实验室服务 （UI） 中的模板 VM 上启用嵌套虚拟化 |微软文档
description: 了解如何创建包含多个 VM 的模板 VM。  换句话说，在 Azure 实验室服务中的模板 VM 上启用嵌套虚拟化。
services: lab-services
author: emaher
ms.service: lab-services
ms.topic: article
ms.date: 1/23/2020
ms.author: enewman
ms.openlocfilehash: 10f8d2760474631fbcabac4d66139aedf4c7560c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2020
ms.locfileid: "79503070"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services-manually"></a>在 Azure 实验室服务中的模板虚拟机上手动启用嵌套虚拟化

嵌套虚拟化使您能够在实验室的模板虚拟机内创建多 VM 环境。 发布模板将为实验室中的每个用户提供一个虚拟机，其中设置多个 VM。  有关嵌套虚拟化和 Azure 实验室服务的详细信息，请参阅在[Azure 实验室服务中的模板虚拟机上启用嵌套虚拟化](how-to-enable-nested-virtualization-template-vm.md)。

本文介绍如何使用 Windows 角色和工具在 Azure 实验室服务中的模板计算机上设置嵌套虚拟化。  要使类能够使用嵌套虚拟化，需要一些操作。  以下步骤将介绍如何使用 Hyper-V 手动设置实验室服务计算机模板。  步骤适用于 Windows 服务器 2016 或 Windows 服务器 2019。  

>[!IMPORTANT]
>创建实验室时，为虚拟机大小选择 **"大型（嵌套虚拟化）"** 或 **"中型"（嵌套虚拟化）。**  嵌套虚拟化将不起作用。  

## <a name="enable-hyper-v-role"></a>启用 Hyper-V 角色

以下步骤描述了使用任一服务器管理器在 Windows 服务器上启用 Hyper-V 所需的操作。  安装成功后，Hyper-V 管理器将可用于添加、修改和删除客户端虚拟机。

1. 在 **"服务器管理器**"中，单击"**添加角色和功能**"。
2. 在?开始之前?**** 页上，单击“下一步”****。
3. 在 **"选择安装类型"** 页上，保留基于角色或基于功能的安装的默认选择，然后单击"**下一步**"。
4. 在 **"选择目标服务器"** 页上，从服务器池中选择服务器。   当前服务器将已被选中。  单击“下一步”。
5. 在“选择服务器角色”**** 页上，选择 Hyper-V****。  
6. 将显示"**添加角色和功能向导"** 弹出窗口。  选择 **"包括管理工具（如果适用）**"。  单击"**添加功能"** 按钮。
7. 在“选择服务器角色”**** 页面上，单击“下一步”****。
8. 在 **"选择功能"页上**，单击 **"下一步**"。
9. 在“Hyper-V”**** 页上，单击“下一步”****。
10. 在 **"创建虚拟切换"** 页上，接受默认值，然后单击"**下一步**"。
11. 在 **"虚拟机迁移**"页上，接受默认值，然后单击"**下一步**"。
12. 在 **"默认存储"** 页上，接受默认值，然后单击"**下一步**"。
13. 在 **"确认安装选择"** 页上，根据需要**自动选择重新启动目标服务器**。
14. 当"**添加角色和功能向导"** 弹出窗口出现时，单击"**是**"。
15. 单击 **“安装”**。
16. 等待 **"安装进度"** 页以指示 Hyper-V 角色已完成。  机器可能在安装中重新启动。
17. 单击 **“关闭”**。

## <a name="enable-dhcp-role"></a>启用 DHCP 角色

创建的任何 Hyper-V 客户端虚拟机都需要 NAT 网络中的 IP 地址。  稍后我们将创建 NAT 网络。  分配 IP 地址的一种方法是将主机（本例中为实验室虚拟机模板）设置为 DHCP 服务器。  以下是启用 DHCP 角色所需的步骤。

1. 在 **"服务器管理器**"中**Dashboard**，单击"**添加角色和功能**"。
2. 在?开始之前?**** 页上，单击“下一步”****。
3. 在“选择安装类型”**** 页上，选择“基于角色或功能的安装”****，然后单击“下一步”****。
4. 在 **"选择目标服务器"** 页上，从服务器池中选择当前服务器，然后单击"**下一步**"。
5. 在 **"选择服务器角色**"页上，选择**DHCP 服务器**。  
6. 将显示"**添加角色和功能向导"** 弹出窗口。  选择 **"包括管理工具（如果适用）**"。  单击 **“添加功能”**。

    >[!NOTE]
    >您可能会看到一个验证错误，指出未找到静态 IP 地址。  对于我们的方案，可以忽略此警告。

7. 在“选择服务器角色”**** 页面上，单击“下一步”****。
8. 在“选择功能”**** 页上，单击“下一步”****。
9. 在**DHCP 服务器**页上，单击 **"下一步**"。
10. 在 **“确认安装选择”** 页上，单击 **“安装”**。
11. 等待 **"安装进度"页**以指示 DHCP 角色已完成。
12. 单击“关闭”。

## <a name="enable-routing-and-remote-access-role"></a>启用路由和远程访问角色

1. 在 **"服务器管理器**"中**Dashboard**，单击"**添加角色和功能**"。
2. 在?开始之前?**** 页上，单击“下一步”****。
3. 在“选择安装类型”**** 页上，选择“基于角色或功能的安装”****，然后单击“下一步”****。
4. 在 **"选择目标服务器"** 页上，从服务器池中选择当前服务器，然后单击"**下一步**"。
5. 在 **"选择服务器角色**"页上，选择 **"远程访问**"。 单击“确定”。
6. 在“选择功能”**** 页上，单击“下一步”****。
7. 在 **"远程访问"** 页上，单击"**下一步**"。
8. 在**角色服务**页上，选择 **"路由**"。
9. 将显示"**添加角色和功能向导"** 弹出窗口。  选择 **"包括管理工具（如果适用）**"。  单击 **“添加功能”**。
10. 单击“下一步”****。
11. 在“Web 服务器角色 (IIS)”**** 页面上，单击“下一步”****。
12. 在 **“选择角色服务”** 页上，单击 **“下一步”**。
13. 在 **“确认安装选择”** 页上，单击 **“安装”**。
14. 等待 **"安装进度"** 页以指示远程访问角色已完成。  
15. 单击 **“关闭”**。

## <a name="create-virtual-nat-network"></a>创建虚拟 NAT 网络

现在，所有必要的角色都已安装完毕，是时候创建 NAT 网络了。  创建过程将涉及创建交换机和 NAT 网络本身。  NAT（网络地址转换）网络将公共 IP 地址分配给专用网络上的一组 VM，以便连接到互联网。  在我们的例子中，私有 VM 组将是嵌套 VM。  NAT 网络将允许嵌套 VM 相互通信。 交换机是处理网络中流量接收和路由的网络设备。

### <a name="create-a-new-virtual-switch"></a>创建新虚拟交换机

1. 从 Windows 管理工具打开**超 V 管理器**。
2. 在左侧导航菜单中选择当前服务器。
3. 单击**虚拟交换机管理器...** 从**Hyper-V 管理器**右侧的 **"操作"** 菜单。
4. 在**虚拟交换机管理器**弹出窗口上，为要创建的交换机类型选择 **"内部**"。  单击“创建虚拟交换机”****。
5. 对于新创建的虚拟交换机，将名称设置为令人难忘的内容。  在此示例中，我们将使用"实验室服务交换机"。  单击“确定”。
6. 将创建新的网络适配器。  该名称将类似于"v以太网（实验室服务交换机）"。  要验证打开**控制面板**，请单击 **"网络和互联网**"，单击"**查看网络状态和任务**"。  在左侧，单击"**更改适配器设置**"。

### <a name="create-a-nat-network"></a>创建 NAT 网络

1. 从 Windows 管理工具打开**路由和远程访问**工具。
2. 在左侧导航页中选择本地服务器。
3. 选择**操作** -> **配置和启用路由和远程访问**。
4. 当**出现路由和远程访问服务器设置向导时**，单击 **"下一步**"。
5. 在 **"配置"** 页上，选择**网络地址转换 （NAT）** 配置。  单击“下一步”****。

    >[!WARNING]
    >不要选择"虚拟专用网络 （VPN） 访问和 NAT"选项。

6. 在**NAT 互联网连接**页面上，选择"以太网"。  不要选择我们在 Hyper-V 管理器中创建的"vEthernet（实验室服务交换机）"连接。 单击“下一步”****。
7. 单击向导最后一页上的 **"完成**"。
8. 当出现 **"开始服务**"对话框时，单击"**开始服务**"。
9. 等待服务启动。

## <a name="update-network-adapter-settings"></a>更新网络适配器设置

网络适配器将与用于之前创建的 NAT 网络的默认网关 IP 的 IP 相关联。  在此示例中，我们创建一个 IP 地址 192.168.0.1，子网掩码为 255.255.255.0。  我们将使用前面创建的虚拟交换机。

1. 打开**控制面板**，单击 **"网络和互联网**"，单击 **"查看网络状态和任务**"。
2. 在左侧，单击"**更改适配器设置**"。  
3. 在 **"网络连接**"窗口中，双击"v以太网（实验室服务交换机）"以显示**vEthernet（实验室服务交换机）状态**详细信息对话框。
4. 单击"**属性"** 按钮。
5. 选择**Internet 协议版本 4 （TCP/IPv4）** 项目，然后单击"**属性**"按钮。
6. 在**Internet 协议版本 4 （TCP/IPv4） 属性**对话框中，选择 **"使用以下 IP 地址**"。  对于 ip 地址，请输入 192.168.0.1。 对于子网掩码，输入 255.255.255.0。  将默认网关留空。  将 DNS 服务器留空。

    >[!NOTE]
    > 我们的 NAT 网络范围将以 CIDR 符号表示法 192.168.0.0/24 表示。  这将创建一系列可用的 IP 地址，从 192.168.0.1 到 192.168.0.254。  按照惯例，网关具有子网范围内的第一个 IP 地址。

7. 单击“确定”。

## <a name="create-dhcp-scope"></a>创建 DHCP 作用域

以下步骤是添加 DHCP 作用域的说明。  在本文中，我们的 NAT 网络在 CIDR 符号中为 192.168.0/24。  这将创建一系列可用的 IP 地址，从 192.168.0.1 到 192.168.0.254。  创建的范围必须位于该可用地址范围内，不包括之前已创建的 IP 地址。

1. 打开**管理工具**并打开**DHCP**管理工具。
2. 在**DHCP**工具中，展开当前服务器的节点并选择**IPv4**。
3. 在"操作"菜单中，选择 **"新范围..."...**
4. 出现 **"新范围"向导**时，单击 **"欢迎**页面的 **"下一步**"。
5. 在 **"范围名称**"页上，输入"LabServicesDhcpScope"或其他令人难忘的名称。  单击“下一步”****。
6. 在**IP 地址范围**页上，输入以下值。

    - 192.168.0.100 用于启动 IP 地址
    - 192.168.0.200 用于最终 IP 地址
    - 长度 24 表示
    - 255.255.255.0 用于子网掩码

7. 单击“下一步”****。
8. 在"**添加排除项和延迟"** 页上，单击 **"下一步**"。
9. 在 **"租约持续时间"** 页上，单击 **"下一步**"。
10. 在 **"配置 DHCP 选项**"页上，选择 **"是"，我现在要配置这些选项**。 单击“下一步”****。
11. 在**路由器上（默认网关）**
12. 添加 192.168.0.1（如果尚未完成）。 单击“下一步”****。
13. 在**域名和 DNS 服务器**页面上，添加 168.63.129.16 作为 DNS 服务器 IP 地址（如果尚未完成）。  168.63.129.16 是 Azure 静态 DNS 服务器的 IP 地址。 单击“下一步”****。
14. 在**WINS 服务器**页面上，单击 **"下一步**"。
15. 一个 **"激活范围**"页，选择 **"是"，我现在要激活此作用域**。  单击“下一步”****。
16. 在 **"完成新范围向导"** 页上，单击"**完成**"。

## <a name="conclusion"></a>结束语

现在，您的模板计算机已准备好创建超 V 虚拟机。   有关如何创建 Hyper-V 虚拟机的说明，请参阅[在 Hyper-V 中创建](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v)虚拟机。  另请参阅[Microsoft 评估中心](https://www.microsoft.com/evalcenter/)，查看可用的操作系统和软件。

## <a name="next-steps"></a>后续步骤

后续步骤是设置任何实验室的常见步骤。

- [添加用户](tutorial-setup-classroom-lab.md#add-users-to-the-lab)
- [设置配额](how-to-configure-student-usage.md#set-quotas-for-users)
- [设置计划](tutorial-setup-classroom-lab.md#set-a-schedule-for-the-lab)
- [电子邮件注册链接给学生](how-to-configure-student-usage.md#send-invitations-to-users)