---
title: 提高 Azure 机器学习中计算机视觉和分类模型的准确度
description: 了解如何使用用于计算机视觉的 Azure 机器学习包提高计算机视觉图像分类、对象检测和图像相似性模型的准确度。
services: machine-learning
ms.service: machine-learning
ms.component: core
ms.topic: conceptual
ms.reviewer: jmartens
ms.author: netahw
author: nhaiby
ms.date: 04/23/2018
ms.openlocfilehash: e134e1e544c51d6756d5021fef8c049fe7d8afb0
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2018
ms.locfileid: "33783576"
---
# <a name="improve-the-accuracy-of-computer-vision-models"></a>提高计算机视觉模型的准确度

使用用于计算机视觉的 Azure 机器学习包可构建和部署图像分类、对象检测和图像相似性模型。 详细了解此包及其安装方式。

本文介绍如何对这些模型进行微调，以提高其准确度。 

## <a name="accuracy-of-image-classification-models"></a>图像分类模型的准确度

计算机视觉包用于各种数据集时都表现良好，这点已得到证明。 但是，对大多数机器学习项目而言，要让新数据集实现最佳效果需要仔细调整参数并评估不同的设计决策。 以下部分介绍如何提高给定数据集的准确度，即应首先优化哪些参数、应尝试使用哪些参数值以及应避免哪些陷阱。

一般而言，培训深度学习模型时需权衡培训时间和模型准确度。 计算机视觉包具有预先设定的默认参数（参见下表第一行），这些参数侧重于实现较快的培训速度，并且通常能生成高准确度的模型。 这种准确度通常可以通过使用更高的图像分辨率或更深度的模型等方式进一步提高，但代价是培训时间会增加 10 倍或以上。

建议首先使用默认参数、对模型进行培训、检查结果、根据需要纠正正确标注，然后再尝试使用会增加培训时间的参数（参见下表中建议使用的参数值）。 建议理解这些参数，虽然从技术上来说并无此要求。


### <a name="best-practices-and-tips"></a>最佳做法和提示

* 数据质量：训练和测试集应具有较高的质量。 即图像应得到正确标注，模糊的图像应被删除（例如，人眼不能明确分辨是网球还是柠檬的图像），并且属性之间应相互排斥（即每个图像恰好属于一个属性）。

* 优化 DNN 前，应使用预先训练的固定 DNN 作为特征器来训练 SVM 分类器。 计算机视觉包中支持此操作，并且因为 DNN 本身未作修改，因此培训不会需要很长时间。 这种方法虽然简单，但通常情况下准确度不错，因此是强基线。 下一步是优化 DNN，使其实现更好的准确度。

* 如果相关对象在图像中很小，可知图像分类方法无法实现良好效果。 在这种情况下，可考虑使用对象检测方法，例如计算机视觉包基于 Tensorflow 的 Faster R-CNN。

* 训练数据越多越好。 经验法则是，每个类中应至少有 100 个示例，即 100 张“狗”的图像、100 张“猫”的图像等。使用更少的图像训练模型是可以的，但可能结果不佳。

* 训练图像需保留在带 GPU 的本地计算机和固态硬盘（不是硬盘驱动器）上。 否则，图像读取的延迟会明显降低训练速度（甚至降低 100 倍）。


### <a name="parameters-to-optimize"></a>要优化的参数

找到这些参数的最佳值非常重要，最佳值通常可以显著提高准确度：
* 学习速率 (`lr_per_mb`)：最重要的参数。 如果 DNN 优化之后，训练集的准确度在 5% 以上，那么很可能学习速率太高或训练时期数太低。 尤其是在数据集较小的情况下，DNN 往往与训练数据过拟合，但实际上模型在测试集上表现良好。 我们通常使用 15 个时期，并在此期间将最初的学习速率下调两次；在某些情况下，使用更多时期进行训练可以得到更好的表现。

* 输入分辨率 (`image_dims`)：默认图像分辨率为 224 x 224 像素。 使用更高的图像分辨率（例如，500 x 500 或 1000 x 1000 像素）可以显著提高准确度，但会降低 DNN 优化速度。 计算机视觉包期望的输入分辨率是一个 (颜色频道, 图像宽度, 图像高度) 元组，例如 (3, 224, 224)，其中颜色频道的数值必须设置为 3（红-绿-蓝带）。

* 模型体系结构 (`base_model_name`)：尝试使用更深层的 DNN，例如 ResNet-34 或 ResNet-50，而不是默认的 ResNet-18 模型。 Resnet-50 模型不仅更深层，而且其倒数第二层的输出大小为 2048 浮点数（而 ResNet-18 和 ResNet-34 模型为 512 浮点数）。 在保持 DNN 不变而对 SVM 分类器进行训练的情况下，这种增加的维度尤其有利。

* 小批数据大小 (`mb_size`)：小批数据大小越高，训练速度越快，但代价是 DNN 内存消耗增加。 因此，选择更深层的模型（例如 ResNet-50 而非 ResNet-18）和/或更高的图像分辨率（500\*500 像素而非 224\*224 像素）时，通常需要降低小批数据大小，以避免内存不足错误。 更改小批数据大小时，通常还需调整学习速率，如下表所示。
* 丢弃率 (`dropout_rate`) 和 L2 正则化 (`l2_reg_weight`)：使用 0.5（计算机视觉包中的默认值为 0.5）或以上作为丢弃率和增加正则化权重（计算机视觉包中的默认值为 0.0005）可减少 DNN 过拟合情况。 请注意，尤其是在数据集较小的情况下，要避免 DNN 过拟合非常难，通常无法做到。


### <a name="parameter-definitions"></a>参数定义

- **学习速率**：梯度下降学习期间使用的梯度大小。 如果设置得过低，训练将耗费许多时期，如果设置得过高，则模型效果不佳。 通常会使用一个计划表，其中设定在特定数量的时期之后降低学习速率。 例如学习速率计划表 `[0.05]*7 + [0.005]*7 + [0.0005]` 表示：前七个时期使用 0.05 的初始学习速率，接下来的七个时期将学习速率降低 10 倍（即 0.005），最后一个时期将学习速率降低 100 倍（即 0.0005）并对模型进行微调。

- **小批数据大小**：GPU 可并行处理多个图像，以加快计算速度。 并行处理的这些图像也叫做小批数据。 小批数据大小越高，训练速度越快，但代价是 DNN 内存消耗增加。

### <a name="recommended-parameter-values"></a>建议的参数值

下表提供多个参数集，已有证据证明这些参数集可在不同的图像分类任务中生成高准确度的模型。 最佳参数取决于具体的数据集和实际使用的 GPU，因此该表仅供参考。 尝试使用这些参数后，可考虑使用超过 500x500 像素的图像分辨率，或尝试使用更深层的模型，例如 Resnet-101 或 Resnet-152。

表中第一行对应计算机视觉包中设置的默认参数。 其他所有行的训练时间都更长，但优点是准确度都更高（第二列是三个内部数据集的平均准确度）。 例如，最后一行的参数需要的培训时间是 5-15 倍，但将三个内部测试集的平均准确度从 82.6% 提高到了 92.8%。

更深层的模型和更高的输入分辨率会占用更多的 DNN 内存，因此需要降低小批数据的大小并增加模型的复杂性，以避免内存不足错误。 如下表所示，将小批数据大小降低两倍，同时将学习速率降低两倍效果明显。 GPU 的内存更小时，可能需要进一步降低小批数据大小。

| 训练时间（粗略估算） | 示例准确性 | 小批数据大小 (mb_size) | 学习速率 (lr_per_mb) | 图像分辨率 (image_dims) | DNN 体系结构 (base_model_name) |
|------------- |:-------------:|:-------------:|:-----:|:-----:|:---:|
| 1 倍（参考） | 82.6% | 32 | [0.05]\*7  + [0.005]\*7  + [0.0005]  | (3, 224, 224) | ResNet18_ImageNet_CNTK |
| 2-5 倍    | 90.2% | 16 | [0.025]\*7 + [0.0025]\*7 + [0.00025] | (3, 500, 500) | ResNet18_ImageNet_CNTK |
| 2-5 倍    | 87.5% | 16 | [0.025]\*7 + [0.0025]\*7 + [0.00025] | (3, 224, 224) | ResNet50_ImageNet_CNTK |
| 5-15 倍        | 92.8% |  8 | [0.01]\*7  + [0.001]\*7  + [0.0001]  | (3, 500, 500) | ResNet50_ImageNet_CNTK |


## <a name="next-steps"></a>后续步骤

如需有关用于计算机视觉的 Azure 机器学习包的信息：
+ 请查阅参考文档

+ 了解 [Azure 机器学习的其他 Python 包](reference-python-package-overview.md)