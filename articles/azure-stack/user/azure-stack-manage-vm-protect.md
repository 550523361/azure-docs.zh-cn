---
title: "保护 Azure 堆栈上部署的 Vm |Microsoft 文档"
description: "有关如何保护部署在 Azure 堆栈上的虚拟机的指南。"
services: azure-stack
documentationcenter: 
author: mattbriggs
manager: femila
editor: 
ms.assetid: 4e5833cf-4790-4146-82d6-737975fb06ba
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: 02get-started-article
ms.date: 02/27/2018
ms.author: mabrigg
ms.reviewer: hector.linares
ms.openlocfilehash: e7c437e3310fbf5c921920a3f08ecb8fe1f0d931
ms.sourcegitcommit: 8c3267c34fc46c681ea476fee87f5fb0bf858f9e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/09/2018
---
# <a name="protect-virtual-machines-deployed-on-azure-stack"></a>保护部署在 Azure 堆栈上的虚拟机

*适用于：Azure Stack 集成系统和 Azure Stack 开发工具包*

本文介绍如何指导说明了如何保护部署在 Azure 堆栈上的用户 Vm。

若要防止数据丢失和非计划停机时间，你需要实现你的用户应用程序和数据的备份恢复或灾难恢复计划。 此计划对于每个应用程序是唯一的但遵循一个框架，你的组织的整体业务连续性和灾难恢复 （业务连续性灾难恢复） 策略建立的。 有关常规模式和实践应用程序可用性和复原参阅[设计灵活的应用程序，azure](https://docs.microsoft.com/azure/architecture/resiliency)在 Azure 的体系结构中心中。

## <a name="azure-stack-infrastructure-recovery"></a>Azure 堆栈的基础结构恢复

用户将需要从 Azure 堆栈的基础结构服务单独保护其虚拟机。

如果 Azure 堆栈云是脱机很长的时间或永久性不可恢复，你将需要的位置，以使应用程序维护停机时间最短的用户请求制定计划。 Azure 堆栈云的运算符负责为 Azure 堆栈的底层基础结构和服务准备恢复计划。 若要了解详细信息，请阅读本文[从灾难性数据丢失中恢复](https://docs.microsoft.com/azure/azure-stack/azure-stack-backup-recover-data)。 

Azure 堆栈基础结构服务的恢复计划不包括的用户 Vm、 存储帐户或数据库的恢复。 作为应用程序所有者，你负责实现应用程序和数据的恢复计划。
 
## <a name="sourcetarget-combinations"></a>源/目标组合

每个 Azure 堆栈云部署到一个数据中心中。 一个独立的环境不需要的因此你可以恢复你的应用程序。 环境可以是单独的 Azure 堆栈云处于不同数据中心或 Azure 公有云。 你的数据自主性和数据的隐私要求将确定你的应用程序恢复环境。 启用每个应用程序的保护，你可以灵活地选择为每个特定恢复选项。 你可以备份到另一个数据中心的数据的一个订阅中有应用程序。 在另一个订阅中，可以将数据复制到 Azure 公有云。 
 
规划每个应用程序以确定针对每个应用程序的备份恢复和灾难恢复策略。 这将帮助你组织正确大小所需的存储容量本地和项目在公有云中的消耗。 

|  | 全球 Azure | Azure 堆栈部署到 CSP 数据中心内，并且由 CSP 的 | Azure 堆栈部署到客户数据中心，并且由客户 |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **Azure 堆栈部署到 CSP 数据中心内，并且由 CSP 的** | 用户 Vm 部署到操作的 CSP Azure 堆栈。 从备份中还原或故障转移到 Azure 直接用户虚拟机。 | CSP 进行操作的主要和辅助实例的 Azure 堆栈中其自己数据中心。 用户 Vm 是还原或两个 Azure 堆栈实例之间故障转移。 | CSP 操作在主站点中的 Azure 堆栈。 客户的数据中心是还原或故障转移目标。 |
| **Azure 堆栈部署到客户数据中心，并且由客户** | 用户 Vm 部署到客户操作 Azure 堆栈。 从备份中还原或故障转移到 Azure 直接用户虚拟机。 | 客户进行操作的主要和辅助实例的 Azure 堆栈中其自己数据中心。 用户 Vm 是还原或两个 Azure 堆栈实例之间故障转移。 | 客户进行操作在主站点中的 Azure 堆栈。 CSP 的数据中心是还原或故障转移目标。 |

![源目标组合](media\azure-stack-manage-vm-backup\vm_backupdataflow_01.png)

## <a name="application-recovery-objectives"></a>应用程序恢复目标

你将需要确定你的组织可以容忍对于每个应用程序，以确定进行保护你 Azure 堆栈上的应用程序的最佳方式的停机时间和数据丢失量。 中心的量和数据丢失值的量所需找出，以便开发和实现最大程度减少对你的组织的影响的恢复计划。 对于每个应用程序，请考虑：  
 - **恢复时间目标 (RTO)**  
RTO 是应用程序可以在事件发生后不可用的最长可接受时间。 如果 RTO 是 90 分钟，则从发生灾难开始，必须能够在 90 分钟内将应用程序还原到正常运行状态。 如果你有较低的 RTO，可能会使待机状态，以防止区域中断持续运行的第二个部署。
 - **恢复点目标 (RPO)**  
RPO 是在灾难期间，是可接受的数据丢失的最大持续时间。 例如，如果在单个数据库中存储数据并且未将数据复制到其他数据库，而是执行每小时备份，则最长可能会丢失一小时的数据。
 
RTO 和 RPO 属于业务要求。 执行风险评估定义应用程序的 RTO 和 RPO。 另一个常见的度量值是**平均恢复时间**即还原出现故障后的应用程序所花费的平均时间 (MTTR)。 MTTR 是反映系统状态的经验事实。 如果 MTTR 超过 RTO，则系统发生故障会导致不可接受的业务中断，因为无法在定义的 RTO 内将系统还原。

### <a name="backup-restore"></a>Backup-restore

基于 VM 的应用程序的最常见保护方案是使用备份软件。 备份 VM 通常包括操作系统、 操作系统配置、 应用程序二进制文件和应用程序数据。 通过拍摄快照的卷、 磁盘或整个 VM 创建备份。 具有 Azure 堆栈，你已从备份中的上下文的来宾操作系统或从 Azure 堆栈存储的灵活性，并且计算 Api。 Azure 堆栈不支持在虚拟机监控程序级别拍摄备份。 
 
![Backup-restor](media\azure-stack-manage-vm-backup\vm_backupdataflow_03.png)
 
恢复应用程序，则需要还原一个或多个 Vm，到相同的云或新的云。 你可以在你的数据中心或公共云目标云。 面向哪些云完全在控件内，并且根据数据隐私和自主性要求。 
 
 - 以秒为单位的 RTO： 停机时间 
 - RPO： 最小的数据丢失
 - 部署拓扑： 主动/被动 

#### <a name="planning-your-backup-strategy"></a>规划你的备份策略

规划你的备份策略和定义缩放要求启动与量化需要保护的 VM 实例数。 所有 Vm 都备份环境中的所有服务器是很常见的策略。 但是，使用 Azure 堆栈时，需要备份一些虚拟机。 例如，Vm 缩放集中都被视为暂时资源，可以发送和接收，有时恕不另行通知。 需要保护的任何持久数据存储在单独的数据库或对象的存储区等存储库中。 备份 Azure 堆栈上的 Vm 的重要注意事项：

 - **Categorization**
    - 请考虑在用户参与到 VM 备份的模型。
    - 定义应用程序或对业务的影响的优先级基于 SLA 的恢复。
 - **缩放**
    - 当初始启用大量新的虚拟机 （如果需要备份），请考虑种交错式的备份。
    - 评估备份产品，可以有效地捕获和传输备份数据，以尽可能减小对解决方案的资源内容。
    - 评估高效地存储使用增量备份或差异备份来最大程度减少需要在环境中的所有 Vm 间请求完整备份的备份数据的备份产品。
 - **Restore**
    - 虚拟磁盘，在现有 VM，或整个虚拟机资源的应用程序数据和关联的虚拟磁盘，则可以还原备份产品。 你需要的还原方案取决于你计划还原应用程序并将影响你的应用程序的恢复时间。 例如，它可能是更轻松地重新部署模板中的 SQL server，然后将还原的数据库而不是还原整个 VM 或 Vm 集。


### <a name="replicationmanual-failover"></a>复制/手动故障转移

支持高可用性的备用方法是将你的应用程序虚拟机复制到另一个云，并依赖于手动触发故障转移。 可以在 VM 级别或来宾 OS 级别执行的操作系统、 应用程序二进制文件和应用程序数据复制。 管理使用独立于应用程序的其他软件的故障转移。
 
使用此方法时，应用程序在仅部署到一个云。 VM 随后会复制到其他云你数据中心的中一对一或公有云。 如果触发故障转移时，辅助虚拟机将需要使其通电在第二个云。 在某些情况下，故障转移将创建虚拟机，并将它们附加到磁盘。 此过程可能需要一段较的长的时间才能完成，尤其是在具有与特定的启动序列的多层应用程序。 可能在应用程序准备好开始处理请求之前必须执行的其他步骤。

![复制手动故障转移](media\azure-stack-manage-vm-backup\vm_backupdataflow_02.png)

 - 以分钟为单位的 RTO： 停机时间 
 - RPO： 变量数据丢失
 - 部署拓扑： 主动/被动备用的
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自动故障转移

对于你的业务可以容忍几秒钟或几分钟的停机时间和最小的数据丢失的其中的应用程序，你将需要考虑高可用性配置。 高可用性应用程序旨在快速自动地从错误中恢复。 对于本地硬件故障，Azure 堆栈的基础结构实现中使用两个顶部架交换机的物理网络高可用性。 对于计算级别的故障，Azure 堆栈在缩放单位中使用多个节点。 在 VM 级别中，你可以使用缩放集结合使用的容错域以确保节点故障不会减小应用程序。 
 
在与缩放集结合使用，你的应用程序将需要本机支持高可用性或支持使用群集软件。 例如，Microsoft SQL Server 支持高可用性本机数据库使用同步提交模式。 但是，如果你仅可以支持异步复制，然后将有一些数据丢失。 此外可以将应用程序部署到其中的聚类分析的软件将处理应用程序的自动故障转移的故障转移群集中。 
 
使用此方法，一个云，应用程序才 active 但软件部署到多个云。 其他云中处于备用模式准备好触发故障转移后启动应用程序。

 - 以秒为单位的 RTO： 停机时间 
 - RPO： 最小的数据丢失
 - 部署拓扑： 主动/主动备用的

### <a name="fault-tolerance"></a>容错

针对硬件故障的磁盘，如级别错误仅保护物理冗余和基础结构服务可用性的 azure 堆栈电源发生故障、 失败网络端口或失败节点。 但是，如果你的应用程序必须始终可用，并且永远不会丢失任何数据，你将需要在你的应用程序中的本机实现容错或启用与其他软件的容错能力。 
 
首先，你需要确保虚拟机将部署使用缩放的应用程序设置以针对节点级故障提供保护。 若要保护对云进入脱机状态，同一个应用程序必须已将部署到另一个云，以便它可以继续处理请求而不会中断。 这通常称为主动-主动部署。
 
请记住，每个 Azure 堆栈云是的可以彼此独立，因此云始终被视为活动从基础结构的角度。 在这种情况下，多个活动实例的应用程序部署到一个或多个活动的云。 
 
 - RTO： 无需停机
 - RPO： 无数据丢失
 - 部署拓扑： 主动/主动

### <a name="no-recovery"></a>不恢复

有些应用程序在你的环境可能不需要对非计划停机时间或数据丢失防护。 例如，虚拟机用于开发和测试通常不需要恢复。 它是你决定不使用应用程序或特定的 VM 的保护。 Azure 堆栈不提供从底层基础结构的备份或复制的虚拟机。 类似于 Azure，你将需要选择加入到每个订阅中的每台虚拟机的保护。  
 
 - RTO： 无法恢复 
 - RPO： 数据完全丢失
 
## <a name="recommended-topologies"></a>建议的拓扑 

你的 Azure 堆栈部署的的重要注意事项：

|     | 建议 | 注释 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 备份/还原 Vm 到已在你的数据中心中部署的外部备份目标 | 建议 | 充分利用现有的备份基础结构和操作技能。 请确保大小备份基础结构，以便随时可保护的其他 VM 实例。 请确保备份基础结构不在紧靠您的源。 你可以还原到源 Azure 堆栈到辅助 Azure 堆栈实例或 Azure Vm。 |
| 备份/还原 Vm 到专用于 Azure 堆栈的外部备份目标 | 建议 | 你可以为 Azure 堆栈购买新的备份基础结构或预配专用备份基础结构。 请确保备份基础结构不在紧靠您的源。 你可以还原到源 Azure 堆栈到辅助 Azure 堆栈实例或 Azure Vm。 |
| 备份/还原直接向全球 Azure 或受信任的服务提供程序的 Vm | 建议 | 只要可以满足你的数据的保密性和法规要求，你可以将备份存储在全球 Azure 或受信任的服务提供程序。 理想情况下服务提供程序也运行 Azure 堆栈，因此还原时在操作体验获得一致性。 |
| 复制/故障转移到单独的 Azure 堆栈实例的虚拟机 | 建议 | 在故障转移情况下，你将需要具有完全可操作的第二个 Azure 堆栈云，因此可以避免扩展的应用程序停机时间。 |
| 直接到 Azure 或受信任的服务提供商的复制/故障转移虚拟机 | 建议 | 只要可以满足你的数据的保密性和法规要求，可以将你的数据复制到全局 Azure 或受信任的服务提供程序。 理想情况下服务提供程序也运行 Azure 堆栈，因此在故障转移后在操作体验获得一致性。 |
| 部署应用程序数据与相同的 Azure 堆栈云上的备份目标 | 不建议这样做 | 避免将相同的 Azure 堆栈云内的备份存储。 非计划停机时间的云可以使你保持从主数据和备份数据中。 如果你选择部署 （用于优化用于备份和还原的目的） 的虚拟设备作为备份目标，则必须确保所有数据连续都复制到外部备份位置。 |
| 部署到同一机架 Azure 堆栈解决方案的安装位置的物理备份设备 | 不支持 | 在此时间点，你无法连接到不是原始解决方案的一部分的架交换机顶部的任何其他设备。 |
 
## <a name="next-steps"></a>后续步骤 

在本文中，我们将介绍如何保护部署在 Azure 堆栈上的用户 Vm 的准则。 有关如何保护你的 Vm 使用 Azure 服务的详细信息，请参阅：
 - [对 Azure 堆栈的 azure 备份服务器支持](https://docs.microsoft.com/en-us/azure/backup/ ) 
 - [对 Azure 堆栈的 azure Site Recovery 支持](https://docs.microsoft.com/en-us/azure/site-recovery/)  
 
若要了解有关提供 Azure 堆栈上的 VM 保护的合作伙伴产品的详细信息，请参阅"[保护应用程序和 Azure 堆栈上的数据](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/)。"
