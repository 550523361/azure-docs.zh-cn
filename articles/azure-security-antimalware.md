<properties
   pageTitle="适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 | Microsoft Azure"
   description="本文提供适用于 Azure 的 Microsoft 反恶意软件的体系结构概述，包括为 Azure 云服务和虚拟机启用、配置和部署保护时支持的方案与配置。我们将介绍可通过 Microsoft Azure 服务管理 API、PowerShell 脚本、Azure 管理门户和 Visual Studio 访问的基本配置、管理与监视功能。"
   services="virtual-machines, cloud-services, storage"
   documentationCenter="na"
   authors="YuriDio"
   manager="swadhwa"
   editor=""/>

<tags
   ms.service="azure-security"
   ms.date="12/10/2015"
   wacn.date=""/>

#适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件

现代云环境的威胁局势非常多变，企业 IT 云订阅者为了遵循法规和达到安全要求，在维护有效保护机制方面承受着许多压力。用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件是一种实时保护功能，当已知恶意软件或不需要的软件试图在你的 Azure 系统上安装自身或运行时，它可使用可配置的警报帮助识别和删除病毒、间谍软件和其他恶意软件。

该解决方案构建于 Microsoft Security Essentials [MSE]、Microsoft Forefront Endpoint Protection、Microsoft System Center Endpoint Protection、Windows Intune 和适用于 Windows 8.0 及更高版本的 Windows Defender 所用的同一个反恶意软件平台基础之上。适用于 Azure 的 Microsoft 反恶意软件是一个针对应用程序和租户环境所提供的单一代理解决方案，可在在后台运行而无需人工干预。你可以根据应用程序工作负荷的需求，选择默认的基本安全性或高级的自定义配置（包括反恶意软件监视）来部署保护。

为应用程序部署并启用适用于 Azure 的 Microsoft 反恶意软件后，便可以使用以下几项核心功能：

**实时保护** - 监视云服务和虚拟机上的活动，以检测和阻止恶意软件的执行。

**计划的扫描** - 定期执行有针对性的扫描，以检测恶意软件，包括主动运行的程序。

**恶意软件消除** - 自动针对检测到的恶意软件采取措施，例如删除或隔离恶意文件以及清除恶意注册表项。

**签名更新** - 自动安装最新的保护签名（病毒定义）以确保按预定的频率保持最新保护状态。

**反恶意软件引擎更新** - 自动更新 Microsoft 反恶意软件引擎。

**反恶意软件平台更新** – 自动更新 Microsoft 反恶意软件平台。

**主动保护** - 将检测到的威胁和可疑资源的遥测元数据报告给 Microsoft Azure，以确保针对不断演变的威胁局势做出快速响应，并通过 Microsoft Active Protection System (MAPS) 启用实时同步签名传递。

**示例报告** - 将示例提供并报告给 Microsoftt 反恶意软件服务，以帮助改善服务并实现故障排除。

**排除项** - 允许应用程序和服务管理员配置特定的文件、进程与驱动器，以便出于性能和/或其他原因将其从保护和扫描中排除。

**恶意软件事件收集** -在操作系统事件日志中记录反恶意软件服务的运行状况、可疑活动及采取的补救措施，并将这些数据收集到客户的 Azure 存储帐户。

##体系结构

适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件解决方案包含 Microsoft 反恶意软件客户端和服务、反恶意软件服务管理扩展、反恶意软件 PowerShell cmdlet 和 Azure 诊断扩展。Windows Server 2008 R2、Windows Server 2012 和 Windows Server 2012 R2 操作系统系列支持 Microsoft 反恶意软件解决方案。Windows Server 2008 操作系统不支持此解决方案。目前仍不支持 Windows Server 技术预览版，但预期将来会提供支持。

默认情况下，Microsoft 反恶意软件客户端和服务以禁用状态安装在云服务平台中所有受支持的 Azure 来宾操作系统系列上。

默认情况下，Microsoft 反恶意软件客户端和服务未安装在虚拟机平台中，而是通过 Azure 管理门户和 Visual Studio 虚拟机配置中的“安全扩展”作为一个可选功能来提供。

###Microsoft 反恶意软件工作流

Azure 服务管理员可以使用以下选项，针对虚拟机和云服务通过默认或自定义配置来启用 Azure 的反恶意软件：

-   虚拟机 – 在Azure 管理门户中的“安全扩展”下

-   虚拟机 – 在服务器资源管理器中使用 Visual Studio 虚拟机配置

-   虚拟机和云服务 – 使用反恶意软件服务管理 API (SMAPI)

-   虚拟机和云服务 – 使用反恶意软件 PowerShell cmdlet

Azure 管理门户或 PowerShell cmdlet 将反恶意软件扩展包文件推送到 Azure 系统中的预定固定位置。Azure 来宾代理（或结构代理）启动反恶意软件扩展，并将提供的反恶意软件配置设置应用为输入。此步骤将以默认或自定义配置设置来启用反恶意软件服务。若未提供任何自定义配置，则将以默认配置设置来启用反恶意软件服务。有关详细信息，请参阅[适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 – 代码示例](http://aka.ms/amazsamples "适用于 Azure 云服务和 VM 的 Microsoft 反恶意软件代码示例")中的*反恶意软件配置*部分。

运行后，Microsoft 反恶意软件客户端将从 Internet 下载最新的保护引擎和签名定义，并将其加载到 Azure 系统上。Microsoft 反恶意软件服务会将服务相关的事件写入“Microsoft 反恶意软件”事件源下的系统 OS 事件日志中。事件包括反恶意软件客户端运行状况、保护和补救状态、新的和旧的配置设置、引擎更新和签名定义及其他信息。

你可以为云服务或虚拟机启用反恶意软件监视，以便将生成的反恶意软件事件日志事件写入 Azure 存储帐户。反恶意软件服务使用 Azure 诊断扩展将 Azure 系统中的反恶意软件事件收集到客户 Azure 存储帐户中的表内。

本文档的[反恶意软件部署方案](#_Antimalware_Deployment_Scenarios)部分介绍了上述方案支持的部署工作流，包括配置步骤和选项。

![Azure 中的 Microsoft Antimalware](./media/azure-security-antimalware/sec-azantimal-fig1.PNG)

###默认和自定义的反恶意软件配置

如果你未提供自定义配置设置，将会应用默认的配置设置以启用适用于 Azure 云服务或虚拟机的反恶意软件。默认配置设置已预先经过优化，可在 Azure 环境中运行。或者，可以根据 Azure 应用程序或服务部署的需要自定义这些默认配置设置，并将其应用到其他部署方案。

下表汇总了反恶意软件服务可用的配置设置。标有“默认”的列下面标记了默认的配置设置。

![表 1](./media/azure-security-antimalware/sec-azantimal-tb18.PNG)

##反恶意软件部署方案

本部分将介绍启用和配置反恶意软件的方案，包括监视 Azure 云服务和虚拟机。

###虚拟机 - 启用和配置反恶意软件

**使用 Azure 预览门户进行部署**

若要启用反恶意软件服务，请在“扩展”边栏选项卡上单击“添加”，在“新建资源”边栏选项卡上选择“Microsoft 反恶意软件”，然后在“Microsoft 反恶意软件”边栏选项卡上单击“创建”。单击“创建”但不输入任何配置值以使用默认设置启用反恶意软件，或者如下图 2 中所示针对配置的虚拟机输入反恶意软件配置设置。请参阅“添加扩展”边栏选项卡中针对每项配置设置提供的工具提示来查看支持的配置值。

![Microsoft 反恶意软件的虚拟机配置设置](./media/azure-security-antimalware/sec-azantimal-fig2.PNG)

**使用 Azure 管理门户进行部署**

若要在预配虚拟机时使用 Azure 管理门户来启用和配置适用于 Azure 虚拟机的 Microsoft 反恶意软件，请遵循以下步骤：

1\. 登录 Azure 管理门户 (<https://manage.windowsazure.cn>)。

2\. 若要创建新的虚拟机，请依次单击“新建”、“计算”、“虚拟机”、“从库中”（不要使用“快速创建”），如下所示：

![新建虚拟机](./media/azure-security-antimalware/sec-azantimal-fig3.PNG)


3\. 在“选择映像”页面上选择“Microsoft Windows Server”映像。

4\. 单击向右箭头并输入虚拟机配置。

5\. 选中虚拟机配置页面上“安全扩展”下面的“Microsoft 反恶意软件”复选框。

6\. 单击“提交”按钮，以使用默认配置设置来启用和配置适用于 Azure 虚拟机的 Microsoft 反恶意软件。

![虚拟机配置](./media/azure-security-antimalware/sec-azantimal-fig4.PNG)

**使用 Visual Studio 虚拟机配置进行部署**

若要使用 Visual Studio 启用和配置 Microsoft 反恶意软件服务，请执行以下操作：

1\. 在 Visual Studio 中连接到 Microsoft Azure。

2\. 在“服务器资源管理器”的“虚拟机”节点中，选择你的虚拟机

![Visual Studio 中的虚拟机配置](./media/azure-security-antimalware/sec-azantimal-fig5.PNG)

3\. 右键单击“配置”，以查看虚拟机配置页面

4\. 从“已安装的扩展”下面的下拉列表中，选择“Microsoft 反恶意软件”扩展，然后单击“添加”以使用默认的反恶意软件配置来进行配置。

![已安装的扩展](./media/azure-security-antimalware/sec-azantimal-fig6.PNG)

5\. 若要自定义默认的反恶意软件配置，请在已安装的扩展列表中选择（突出显示）反恶意软件扩展，然后单击“配置”。

6\. 在“公共配置”文本框中，使用自定义配置（支持的 JSON 格式）来替换默认的反恶意软件配置，然后单击“确定”。

7\. 单击“更新”按钮，以将配置更新推送到虚拟机。

![虚拟机配置扩展](./media/azure-security-antimalware/sec-azantimal-fig7.PNG)

**注意：**适用于反恶意软件的 Visual Studio 虚拟机配置仅支持 JSON 格式配置。[适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例](http://aka.ms/amazsamples "适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例")中包含了反恶意软件 JSON 配置设置模板，其中显示了支持的反恶意软件配置设置。

**使用 PowerShell cmdlet 进行部署**

Azure 应用程序或服务可以使用 PowerShell cmdlet 来启用和配置适用于 Azure 虚拟机的 Microsoft 反恶意软件。

若要使用反恶意软件 PowerShell cmdlet 来启用和配置 Microsoft 反恶意软件，请执行以下操作：

1. 设置你的 PowerShell 环境 - 请参阅 <https://github.com/Azure/azure-sdk-tools#get-started> 上的文档

2. 如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771718.aspx> 中所述，使用 AzureVMMicrosoftAntimalwareExtension 反恶意软件 cmdlet 来启用和配置适用于虚拟机的 Microsoft 反恶意软件

**注意：**适用于反恶意软件的 Azure 虚拟机配置仅支持 JSON 格式配置。[适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例](http://aka.ms/amazsamples "适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例")中包含了反恶意软件 JSON 配置设置模板，其中显示了支持的反恶意软件配置设置。

###使用 PowerShell cmdlet 来启用和配置反恶意软件

Azure 应用程序或服务可以使用 PowerShell cmdlet 来启用和配置适用于 Azure 云服务的 Microsoft 反恶意软件。请注意，Microsoft 反恶意软件以禁用状态安装在云服务平台中，需要 Azure 应用程序执行某个操作来启用它。

若要使用 PowerShell cmdlet 来启用和配置 Microsoft 反恶意软件，请执行以下操作：

1.  设置你的 PowerShell 环境 - 请参阅 <https://github.com/Azure/azure-sdk-tools#get-started> 上的文档

2.  如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771718.aspx> 中所述，使用 AzureServiceAntimalwareExtension 反恶意软件 cmdlet 来启用和配置适用于云服务的 Microsoft 反恶意软件

[适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例](http://aka.ms/amazsamples "适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例")中包含了反恶意软件 XML 配置设置模板，其中显示了支持的反恶意软件配置设置。

###云服务和虚拟机 - 使用 PowerShell cmdlet 进行配置

Azure 应用程序或服务可以使用 PowerShell cmdlet 来检索适用于云服务和虚拟机的 Microsoft 反恶意软件配置。

若要使用 PowerShell cmdlet 来检索 Microsoft 反恶意软件配置，请执行以下操作：

1.  设置你的 PowerShell 环境 - 请参阅 <https://github.com/Azure/azure-sdk-tools#get-started> 上的文档

2.  **对于虚拟机**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771719.aspx> 中所述，使用 Get-AzureVMMicrosoftAntimalwareExtension 反恶意软件 cmdlet 来获取反恶意软件配置

3.  **对于云服务**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771722.aspx> 中所述，使用 Get-AzureServiceAntimalwareConfig 反恶意软件 cmdlet 来获取反恶意软件配置

###使用 PowerShell cmdlet 删除 Microsoft 反恶意软件配置

Azure 应用程序或服务可从相关的 Azure 反恶意软件以及与云服务或虚拟机关联的诊断服务扩展中，删除反恶意软件配置和任何关联的反恶意软件监视。

若要使用 PowerShell cmdlet 删除 Microsoft 反恶意软件，请执行以下操作：

1.  设置你的 PowerShell 环境 - 请参阅 <https://github.com/Azure/azure-sdk-tools#get-started> 上的文档

2.  **对于虚拟机**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771720.aspx> 中所述，使用 Remove-AzureVMMicrosoftAntimalwareExtension 反恶意软件 cmdlet

3.  **对于云服务**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771717.aspx> 中所述，使用 Remove-AzureServiceAntimalwareExtension 反恶意软件 cmdlet

若要使用 Azure 预览门户来**启用**适用于虚拟机的反恶意软件事件收集，请执行以下操作：

1.  在“虚拟机”边栏选项卡中单击“监视”透镜的任何部位

2.  在“度量值”边栏选项卡中单击“诊断”命令

3.  为“状态”选择“打开”，并选中 Windows 事件系统日志的对应选项。你可以取消选中列表中的所有其他选项，或者根据应用程序服务的需要将它们保持启用状态。

4.  将在你的 Azure 存储帐户中捕获“错误”、“警告”、“信息”等反恶意软件事件类别。

反恶意软件事件将从 Windows 事件系统日志收集到你的 Azure 存储帐户中。你可以通过选择相应的存储帐户，为虚拟机配置存储帐户以收集反恶意软件事件。

![度量值和诊断](./media/azure-security-antimalware/sec-azantimal-fig8.PNG)

###使用 PowerShell cmdlet 来启用和配置反恶意软件监视

你可以通过反恶意软件 PowerShell cmdlet，使用 Azure 诊断来为云服务或虚拟机启用 Microsoft 反恶意软件事件收集。可以配置 Azure 诊断扩展，以将事件从系统事件日志源“Microsoft 反恶意软件”捕获到你的 Azure 存储帐户。将在你的 Azure 存储帐户中捕获“错误”、“警告”、“信息”等反恶意软件事件类别。

若要使用 PowerShell cmdlet 在 Azure 存储帐户中启用反恶意软件事件收集，请执行以下操作：

1.  设置你的 PowerShell 环境 - 请参阅 <https://github.com/Azure/azure-sdk-tools#get-started>

2.  **对于虚拟机**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771716.aspx> 中所述，在已启用“打开监视”选项的情况下使用 Set-AzureVMMicrosoftAntimalwareExtension 反恶意软件 cmdlet

3.  **对于云服务**：请如 <http://msdn.microsoft.com/zh-cn/library/azure/dn771718.aspx> 中所述，在已启用“打开监视”选项的情况下使用 Set-AzureServiceAntimalwareExtension 反恶意软件 cmdlet

可以通过在为了启用反恶意软件监视而配置的 Azure 存储帐户中查看 WADWindowsEventLogsTable 表，来查看反恶意软件原始事件。这样便可以有效地验证反恶意软件事件收集是否正常运行，包括深入了解反恶意软件服务的运行状况。有关详细信息，包括有关如何从存储帐户提取反恶意软件事件的示例代码，请参阅[适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例](http://aka.ms/amazsamples "适用于 Azure 云服务和虚拟机的 Microsoft 反恶意软件 - 代码示例")。

<!---HONumber=Mooncake_0118_2016-->