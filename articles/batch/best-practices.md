---
title: 最佳做法-Azure Batch
description: 了解开发 Azure Batch 解决方案的最佳做法和有用的技巧。
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: 16fb2786f180b1e28b76d9246d599a871278d00d
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/05/2020
ms.locfileid: "77022726"
---
# <a name="azure-batch-best-practices"></a>Azure Batch 最佳实践

本文介绍有效有效地使用 Azure Batch 服务的最佳实践集合。 这些最佳做法源自我们的批处理和 Batch 客户体验。 务必了解这篇文章，以避免开发和使用批处理时的设计缺陷、潜在的性能问题和反模式。

本文内容：

> [!div class="checklist"]
> - 最佳做法是什么
> - 为什么应使用最佳做法
> - 如果无法遵循最佳做法，会发生什么情况
> - 如何遵循最佳做法

## <a name="pools"></a>池

Batch 池是用于在批处理服务上执行作业的计算资源。 以下各部分提供了有关使用批处理池时遵循的最佳最佳方案的指导。

### <a name="pool-configuration-and-naming"></a>池配置和命名

- 池分配模式  
    创建批处理帐户时，可以在两个池分配模式之间进行选择： **Batch 服务**或**用户订阅**。 在大多数情况下，应使用默认 Batch 服务模式，在此模式下，将在批处理管理的订阅中将池中分配到后台。 在备用的“用户订阅”模式下，会在创建池后直接在订阅中创建 Batch VM 和其他资源。 用户订阅帐户主要用于实现重要的一小部分方案。 可以在 "[用户订阅" 模式下的 "其他配置](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)" 中阅读有关用户订阅模式的详细信息。

- **确定作业和任务运行时，请考虑到池映射。**  
    如果你的作业主要包含短时间运行的任务，且预期的总任务计数较小，因此，作业的总体预期运行时间不长，请不要为每个作业分配新的池。 节点的分配时间将会降低作业的运行时间。

- **池应具有多个计算节点。**  
    不保证各个节点始终可用。 虽然不常见，但硬件故障、操作系统更新和其他问题可能会导致各个节点脱机。 如果批处理工作负荷需要确定的确定性进度，则应为具有多个节点的池分配。

- **不要重复使用资源名称。**  
    批处理资源（作业、池等）通常会随时间推移而变化。 例如，你可以在星期一创建一个池，在星期二删除它，然后在星期四创建另一个池。 应为创建的每个新资源指定一个以前未使用过的唯一名称。 这可以通过使用 GUID （作为整个资源名称或其一部分）来实现，也可以在资源名称中嵌入资源的创建时间。 Batch 支持[DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet)，此名称可用于为资源指定用户可读名称，即使实际的资源 ID 不是人友好的资源 ID 也是如此。 使用唯一名称使你可以更轻松地区分哪些特定资源对日志和指标进行了操作。 如果需要为资源提供支持案例，还会消除歧义。

- **池维护和故障期间的连续性。**  
    最好将作业动态地用于池。 如果作业使用同一个池来完成所有操作，则如果池出现问题，则可能不会运行作业。 这对于时间敏感的工作负载尤其重要。 若要解决此问题，请在计划每个作业时动态选择或创建池，或使用替代池名称的方法，以便可以绕过不正常的池。

- **池维护和故障期间的业务连续性**  
    有许多可能的原因会阻止池增长到所需的大小，例如内部错误、容量限制等。出于此原因，应准备好在不同的池中重定位作业（可能使用不同的 VM 大小，Batch 通过[UpdateJob](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)支持此项）（如果需要）。 避免使用静态池 ID，假定永远不会将其删除，也不会更改。

### <a name="pool-lifetime-and-billing"></a>池生存期和计费

池生存期可能会根据分配的方法和应用于池配置的选项而有所不同。 池可以在任何时间点在池中拥有任意生存期和不同数量的计算节点。 你负责显式管理池中的计算节点，或者通过服务提供的功能（自动缩放或 autopool）来管理计算节点。

- **保持池全新。**  
    应每隔几个月将池的大小调整为零，以确保获取最新的节点代理更新和 bug 修复。 池不会接收节点代理更新，除非重新创建它，或者调整到0个计算节点。 重新创建或调整池大小之前，建议出于调试目的下载任何节点代理日志，如 "[节点](#nodes)" 一节中所述。

- **池重新创建**  
    与此类似，建议不要每天删除并重新创建池。 相反，请创建新的池，更新现有作业，使之指向新池。 将所有任务移到新池后，删除旧的池。

- **池效率和计费**  
    Batch 本身不会产生额外的费用，但你对使用的计算资源会产生费用。 将为池中的每个计算节点计费，而不考虑它的状态。 这包括节点运行所需的任何费用，如存储和网络成本。 若要了解更好的最佳实践，请参阅[Azure Batch 的成本分析和预算](budget.md)。

### <a name="pool-allocation-failures"></a>池分配失败

在第一次分配或后续调整大小的过程中，可能会发生池分配失败。 这可能是由于区域中的临时容量消耗或批处理依赖的其他 Azure 服务中的故障造成的。 核心配额并不是一个保证，而是限制。

### <a name="unplanned-downtime"></a>计划外停机

在 Azure 中，批处理池可能会遇到停机事件。 在为批处理规划和开发方案或工作流时，必须记住这一点。

如果某个节点出现故障，批处理会自动尝试代表您恢复这些计算节点。 这可能会触发在恢复的节点上重新计划任何正在运行的任务。 有关中断的任务的详细信息，请参阅[设计重试](#designing-for-retries-and-re-execution)。

- **Azure 区域依赖关系**  
    如果你有时间敏感的或生产工作负荷，建议不要依赖单个 Azure 区域。 虽然很少出现，但仍有一些问题会影响整个区域。 例如，如果您的处理需要在特定时间启动，请考虑在您的*开始时间之前，先*在主要区域中向上扩展池。 如果池规模出现故障，你可以回退到在备份区域（或区域）中纵向扩展池。 如果其他池出现问题，则在不同区域中跨多个帐户的池可提供一个易于访问的现成备份。 有关详细信息，请参阅[设计应用程序以实现高可用性](high-availability-disaster-recovery.md)。

## <a name="jobs"></a>工作

作业是一个容器，旨在包含几百、上千甚至数百万个任务。

- **在作业中放置多个任务**  
    使用作业运行单个任务的效率较低。 例如，使用包含1000任务的单个作业，而不是创建每个包含10个任务的100作业，效率更高。 运行1000个作业，每个作业都有一个任务，这是最不有效、最慢且最昂贵的方法。  

    不要设计需要同时使用上千个活动作业的批处理解决方案。 对于任务没有配额，因此在尽可能少的作业下执行尽可能多的任务会有效地使用你的[作业和作业计划配额](batch-quota-limit.md#resource-quotas)。

- **作业生存期**  
    批处理作业在从系统中删除之前处于无限生存期。 作业的状态指定是否可以接受更多任务来进行计划。 除非显式终止，否则作业不会自动移动到已完成状态。 这可以通过[onAllTasksComplete](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet)属性或[maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints)自动触发。

存在默认的[活动作业和作业计划配额](batch-quota-limit.md#resource-quotas)。 处于 "已完成" 状态的作业和作业计划不计入此配额。

## <a name="tasks"></a>任务

任务是构成作业的单个工作单元。 任务由用户提交，并按批处理方式计划到计算节点。 创建和执行任务时，需要考虑几个设计注意事项。 以下各节介绍常见方案以及如何设计任务来处理问题并有效地执行。

- **在任务中保存任务数据。**  
    计算节点的性质是暂时的。 批处理中有许多功能，如 autopool 和自动缩放，使节点变得简单。 当节点离开池时（由于调整大小或池删除），这些节点上的所有文件也会被删除。 因此，建议在任务完成之前，将其输出从它运行所在的节点移到持久存储，同样，如果任务失败，则应将需要的日志移动到将失败诊断到持久存储区。 批处理已集成支持 Azure 存储，可通过[OutputFiles](batch-task-output-files.md)、各种共享文件系统上传数据，也可在任务中自行执行上传。

### <a name="task-lifetime"></a>任务生存期

- **完成后删除任务。**  
    删除不再需要的任务，或设置[retentionTime](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet)任务约束。 如果设置了 `retentionTime`，则当 `retentionTime` 过期时，批处理会自动清除该任务使用的磁盘空间。  

    删除任务完成两项操作。 它可确保在作业中没有任务的生成，使查询/找出感兴趣的任务（因为必须通过已完成的任务进行筛选）。 它还会清除节点上的相应任务数据（提供的 `retentionTime` 尚未命中）。 这可确保你的节点不会填满任务数据并耗尽磁盘空间。

### <a name="task-submission"></a>任务提交

- **在集合中提交大量任务。**  
    可以单独或按集合提交任务。 在对任务进行大容量提交时，每次在 100[集合](https://docs.microsoft.com/rest/api/batchservice/task/addcollection)中提交任务，以减少开销和提交时间。

### <a name="task-execution"></a>任务执行

- **选择每个节点的最大任务数**  
    Batch 支持节点上的需要超额订阅任务（运行的任务比节点具有多个内核的多个任务）。 你需要确保任务 "适合" 到池中的节点。 例如，如果你试图计划八个任务，每个任务都消耗25% 的 CPU 使用率，则你可能会遇到性能下降的 `maxTasksPerNode = 8`情况。

### <a name="designing-for-retries-and-re-execution"></a>设计重试和重新执行

可以通过批处理自动重试任务。 重试分为两种类型：用户控制的和内部的。 用户控制的重试由任务的[maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)指定。 如果任务中指定的程序以非零退出代码退出，该任务将重试到 `maxTaskRetryCount`的值。

尽管极少出现这种情况，但由于计算节点上的故障，可能会在内部重试任务，例如，在运行任务时无法更新内部状态或节点上的故障。 如果可能，会在同一计算节点上重试该任务，在放弃该任务并将任务推迟到其他计算节点上时，将在该节点上重试。

- **构建持久任务**  
    任务应该设计为可经受故障并适应重试。 这对于长时间运行的任务尤其重要。 为此，请确保任务生成相同的单个结果，即使它们多次运行也是如此。 实现此目的的一种方法是使任务 "目标查找"。 另一种方法是确保任务是幂等的（无论任务运行多少次，任务都将具有相同的结果）。

    常见的示例是将文件复制到计算节点的任务。 一种简单的方法是在每次运行时复制所有指定文件，这是低效的，不能承受发生故障。 而是创建一个任务以确保文件位于计算节点上;不会重新复制已存在的文件的任务。 通过这种方式，任务会在中断时从中断的位置继续进行。

- **低优先级节点**  
    在专用或低优先级节点上执行任务时，没有任何设计差别。 无论是在低优先级节点上运行时任务被抢占，还是由于专用节点上的故障而中断，都可以通过将任务设计为承受故障来缓解这两种情况。

- **任务执行时间**  
    避免具有短执行时间的任务。 仅运行一到两秒的任务并不理想。 应尝试在单个任务中执行大量的工作（最多10秒，最多可达几小时或几天）。 如果每个任务执行一分钟（或更多），则作为总体计算时间的一小部分的计划开销很小。

## <a name="nodes"></a>节点数

- **启动任务应该是幂等的**  
    与其他任务类似，节点启动任务应该是幂等的，因为每次节点启动时将重新运行该任务。 幂等任务只是一种在多次运行时产生一致结果的任务。

- **通过操作系统服务接口管理长时间运行的服务。**  
    有时需要在节点中的批处理代理旁边运行另一个代理，例如，从节点收集数据并进行报告。 建议将这些代理部署为 OS 服务，例如 Windows 服务或 Linux `systemd` 服务。  

    运行这些服务时，这些服务不能对节点上的批处理管理目录中的任何文件执行文件锁定，因为否则由于文件锁定，批处理将无法删除这些目录。 例如，如果在启动任务中安装 Windows 服务，而不是直接从启动任务工作目录中启动该服务，请将文件复制到其他位置（如果这些文件只是跳过复制）。 从该位置安装服务。 当 Batch 重新运行启动任务时，它会删除启动任务工作目录并再次创建。 这样做的原因是，服务在另一个目录中具有文件锁定，而不是启动任务工作目录。

- **避免在 Windows 中创建目录联接**  
    目录联接（有时称为目录硬链接）在任务和作业清除期间难以处理。 使用符号链接（软链接）而不是硬链接。

- **如果存在问题，则收集批处理代理日志**  
    如果你注意到某个节点的行为涉及到节点上运行的任务，则建议在解除相关节点的分配之前收集批处理代理日志。 可以使用 "上载批处理服务日志" API 收集批处理代理日志。 这些日志可提供给 Microsoft 的支持票证的一部分，并可帮助解决问题和解决问题。

## <a name="security"></a>安全性

### <a name="security-isolation"></a>安全隔离

出于隔离的目的，如果方案需要彼此隔离作业，则应将这些作业隔离在不同的池中。 池是批处理中的安全隔离边界，默认情况下，两个池不可见或无法相互通信。 避免使用单独的批处理帐户作为隔离方法。

## <a name="moving"></a>动

### <a name="move-batch-account-across-regions"></a>跨区域移动批处理帐户 

在各种情况下，你希望将现有批处理帐户从一个区域移到另一个区域。 例如，你可能想要在灾难恢复规划过程中移到另一个区域。

不能将 Azure Batch 帐户从一个区域移到另一个区域。 但是，可以使用 Azure 资源管理器模板来导出 Batch 帐户的现有配置。  然后，你可以在另一个区域中暂存资源，方法是将批处理帐户导出到模板，修改参数以匹配目标区域，然后将模板部署到新区域。 将模板上传到新区域后，必须重新创建证书、作业计划和应用程序包。 若要提交更改并完成批处理帐户的移动，请记得删除原始批处理帐户或资源组。  

有关资源管理器和模板的详细信息，请参阅[快速入门：使用 Azure 门户创建和部署 Azure 资源管理器模板](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)。


