---
title: 最佳实践 - Azure 批处理
description: 了解开发 Azure Batch 解决方案的最佳做法和有用提示。
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: 16fb2786f180b1e28b76d9246d599a871278d00d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/27/2020
ms.locfileid: "77022726"
---
# <a name="azure-batch-best-practices"></a>Azure 批处理最佳实践

本文讨论了有效和高效地使用 Azure Batch 服务的最佳做法的集合。 这些最佳实践源自我们在 Batch 方面的经验和 Batch 客户的经验。 请务必了解本文，以避免在为 Batch 开发和使用 Batch 时设计缺陷、潜在的性能问题和反模式。

本文内容：

> [!div class="checklist"]
> - 最佳实践是什么？
> - 为什么要使用最佳实践
> - 如果您未能遵循最佳实践，会发生什么情况
> - 如何遵循最佳实践

## <a name="pools"></a>池

批处理池是用于在批处理服务上执行作业的计算资源。 以下各节提供有关使用 Batch 池时应遵循的顶级最佳实践的指导。

### <a name="pool-configuration-and-naming"></a>池配置和命名

- 池分配模式****  
    创建 Batch 帐户时，可以选择两种池分配模式：**批处理服务**或**用户订阅**。 在大多数情况下，应使用默认 Batch 服务模式，其中池在批处理托管订阅中后台分配。 在备用的“用户订阅”模式下，会在创建池后直接在订阅中创建 Batch VM 和其他资源。 用户订阅帐户主要用于启用重要但很小的方案子集。 您可以在[用户订阅模式的其他配置中阅读更多有关用户订阅模式](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)的订阅模式。

- **在确定作业到池映射时，请考虑作业和任务运行时间。**  
    如果作业主要由短运行任务组成，并且预期的总任务计数较小，因此作业的总体预期运行时间不长，请不要为每个作业分配新池。 节点的分配时间将减少作业的运行时。

- **池应具有多个计算节点。**  
    不能保证单个节点始终可用。 硬件故障、操作系统更新和许多其他问题都会导致单个节点脱机，虽然这种情况并不常见。 如果 Batch 工作负荷需要确定性、有保证的进度，则应分配具有多个节点的池。

- **不要重用资源名称。**  
    批处理资源（作业、池等）经常随时间推来往往。 例如，您可以在星期一创建池，在星期二删除它，然后在星期四创建另一个池。 您创建的每个新资源都应获得以前未使用的唯一名称。 这可以通过使用 GUID（作为整个资源名称，或作为资源的一部分）或嵌入在资源名称中创建资源的时间来实现。 Batch 支持[DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet)，它可用于为资源指定一个可读的可读名称，即使实际资源 ID 不是对人类友好的东西。 使用唯一名称可以更轻松地区分哪些特定资源在日志和指标中做了某些操作。 如果您必须为资源提交支持案例，它还会消除歧义。

- **池维护和故障期间的连续性。**  
    最好让作业动态使用池。 如果您的作业对一切使用相同的池，则如果池出现问题，您的作业很可能不会运行。 这对时间敏感的工作负载尤其重要。 要解决此问题，请在计划每个作业时动态选择或创建池，或者有一种方法来覆盖池名称，以便绕过不正常的池。

- **池维护和故障期间的业务连续性**  
    有许多可能的原因可能阻止池增长到所需的大小，例如内部错误、容量限制等。因此，您应该准备好在不同的池中重新定位作业（可能具有不同的 VM 大小 - Batch 在必要时通过[UpdateJob](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)支持此功能）。 避免使用静态池 ID，希望它永远不会被删除，永远不会更改。

### <a name="pool-lifetime-and-billing"></a>池生存期和计费

池生存期可能因分配方法和应用于池配置的选项而异。 池可以具有任意生存期和池中任何时间点中数量不同的计算节点。 您有责任显式或通过服务（自动缩放或自动池）提供的功能管理池中的计算节点。

- **保持池新鲜。**  
    应每隔几个月将池大小调整到零，以确保获得最新的节点代理更新和错误修复。 池不会接收节点代理更新，除非重新创建，或调整为 0 个计算节点。 在重新创建或调整池大小之前，建议下载任何节点代理日志以进行调试，如["节点"](#nodes)部分所述。

- **池重新创建**  
    同样，不建议每天删除和重新创建池。 相反，请创建新池，更新现有作业以指向新池。 将所有任务移动到新池后，删除旧池。

- **池效率和计费**  
    批处理本身不会产生额外费用，但您确实会为所使用的计算资源产生费用。 无论池中的每个计算节点处于何种状态，您都会按该节点计费。 这包括节点运行所需的任何费用，如存储和网络成本。 要了解更多最佳做法，请参阅[Azure 批处理的成本分析和预算](budget.md)。

### <a name="pool-allocation-failures"></a>池分配失败

在第一次分配或后续调整调整期间，池分配失败随时可能发生。 这可能是由于区域中临时耗尽的容量或 Batch 所依赖的其他 Azure 服务中的故障。 您的核心配额不是保证，而是限制。

### <a name="unplanned-downtime"></a>计划外故障时间

批处理池在 Azure 中可能会遇到停机事件。 在为 Batch 规划和开发方案或工作流时，请务必记住这一点。

如果节点发生故障，Batch 会自动尝试代表您恢复这些计算节点。 这可能会触发重新安排恢复的节点上的任何正在运行的任务。 请参阅[设计重试](#designing-for-retries-and-re-execution)以了解有关中断任务的更多详细信息。

- **Azure 区域依赖项**  
    如果您有时间敏感或生产工作负荷，建议不要依赖于单个 Azure 区域。 虽然很少，但有些问题可能会影响整个区域。 例如，如果处理需要在特定时间开始，请考虑*在开始时间之前*扩展主区域中的池。 如果该池规模失败，您可以回落到向上扩展备份区域（或区域）中的池。 跨不同区域的多个帐户的池提供了一个现成的、易于访问的备份，如果另一个池出现问题。 有关详细信息，请参阅[为高可用性设计应用程序](high-availability-disaster-recovery.md)。

## <a name="jobs"></a>作业

作业是一个容器，旨在包含数百、数千甚至数百万个任务。

- **将许多任务放入作业中**  
    使用作业运行单个任务的效率很低。 例如，使用包含 1000 个任务的单个作业比创建包含 10 个作业的作业更有效。 运行 1000 个作业（每个作业都有一个任务）将是效率最低、最慢、成本最高的方法。  

    不要设计需要同时数千个活动作业的 Batch 解决方案。 没有任务的配额，因此在尽可能少的工作下执行尽可能多的任务，可以有效地使用[作业和作业计划配额](batch-quota-limit.md#resource-quotas)。

- **工作生命周期**  
    Batch 作业具有无限期的生存期，直到从系统中删除为止。 作业的状态指定是否可以接受更多用于计划的任务。 除非显式终止，否则作业不会自动移动到已完成状态。 这可以通过[onAllTasks完成](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet)属性或[maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints)自动触发。

存在默认[的活动作业和作业计划配额](batch-quota-limit.md#resource-quotas)。 已完成状态的作业和作业计划不计入此配额。

## <a name="tasks"></a>任务

任务是构成工作的单个工作单元。 任务由用户提交，Batch 计划到计算节点。 创建和执行任务时需要考虑几个设计注意事项。 以下各节介绍常见方案以及如何设计任务以处理问题并高效执行。

- **将任务数据保存为任务的一部分。**  
    计算节点本质上是短暂的。 Batch 中有许多功能，如自动池和自动缩放，使节点很容易消失。 当节点离开池（由于调整大小或删除池）时，这些节点上的所有文件也会被删除。 因此，建议在任务完成之前，它将其输出从正在运行的节点移动到持久存储，同样，如果任务失败，应将诊断故障所需的日志移动到持久存储。 Batch 集成了支持 Azure 存储，以便通过[OutputFiles](batch-task-output-files.md)以及各种共享文件系统上传数据，或者您可以在任务中自行执行上载。

### <a name="task-lifetime"></a>任务生存期

- **任务完成后删除它们。**  
    在不再需要任务时删除任务，或设置[保留时间](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet)任务约束。 如果设置了`retentionTime`，Batch 会在`retentionTime`过期时自动清理任务使用的磁盘空间。  

    删除任务可以完成两件事。 它确保您没有作业中的任务堆积，从而使查询/查找您感兴趣的任务变得更加困难（因为您必须筛选完成的任务）。 它还清理节点上的相应任务数据（提供`retentionTime`尚未命中）。 这可确保节点不会填满任务数据并耗尽磁盘空间。

### <a name="task-submission"></a>任务提交

- **在集合中提交大量任务。**  
    任务可以单独提交，也可以在集合中提交。 在批量提交任务时，一次最多提交 100 个[集合](https://docs.microsoft.com/rest/api/batchservice/task/addcollection)中的任务，以减少开销和提交时间。

### <a name="task-execution"></a>执行任务

- **选择每个节点的最大任务**  
    Batch 支持在节点上过度订阅任务（运行的任务多于节点具有内核的任务）。 由您确保任务"适合"到池中的节点中。 例如，如果您尝试将 8 个任务（每个任务消耗 25% 的 CPU 使用率）安排到一个节点上（`maxTasksPerNode = 8`在具有 的池中），则可能会经历降级。

### <a name="designing-for-retries-and-re-execution"></a>为重试和重新执行设计

批处理可以自动重试任务。 有两种类型的重试：用户控制和内部重试。 用户控制的重试由任务的[maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)指定。 当任务中指定的程序退出具有非零退出代码时，将重试该任务，最多达到 的值`maxTaskRetryCount`。

尽管很少，但由于计算节点上的故障（如无法在任务运行时更新内部状态或节点上故障），可以在内部重试任务。 如果可能，任务将在同一计算节点上重试，最多达到内部限制，然后再放弃任务，并将任务推迟到 Batch 重新安排，可能在不同的计算节点上。

- **生成持久任务**  
    任务应设计为能够承受故障并适应重试。 这对长时间运行的任务尤其重要。 为此，请确保任务生成相同的单一结果，即使它们运行多次也是如此。 实现这一目标的一个方法是使您的任务"寻求目标"。 另一种方法是确保任务是幂等的（任务无论运行多少次，都将具有相同的结果）。

    常见示例是将文件复制到计算节点的任务。 一个简单的方法是每次运行时复制所有指定文件的任务，它效率低，无法承受故障。 相反，创建一个任务以确保文件位于计算节点上;不重新复制已存在的文件的任务。 这样，如果任务被中断，任务将从中断的位置开始。

- **低优先级节点**  
    在专用或低优先级节点上执行任务时，没有设计差异。 无论任务是在低优先级节点上运行时抢占的，还是由于专用节点上的故障而中断，通过设计任务以承受故障来缓解这两种情况。

- **任务执行时间**  
    避免执行时间短的任务。 只运行一到两秒钟的任务并不理想。 您应该尝试在单个任务中执行大量工作（最少 10 秒，最多时或数天）。 如果每个任务执行一分钟（或更多），则作为总体计算时间一小部分的调度开销很小。

## <a name="nodes"></a>Nodes

- **启动任务应具有幂等**  
    与其他任务类似，节点启动任务应具有幂等性，因为它将在每次节点启动时重新运行。 幂等任务只是在多次运行时产生一致结果的任务。

- **通过操作系统服务接口管理长时间运行的服务。**  
    有时，需要在节点中的 Batch 代理旁边运行另一个代理，例如，从节点收集数据并报告数据。 我们建议将这些代理部署为操作系统服务，如 Windows 服务或 Linux`systemd`服务。  

    运行这些服务时，它们不得对节点上的 Batch 托管目录中的任何文件执行文件锁，否则 Batch 将无法删除这些目录，因为文件锁。 例如，如果在启动任务中安装 Windows 服务，而不是直接从启动任务工作目录中启动该服务，请将文件复制到其他位置（如果文件存在，则仅跳过副本）。 从该位置安装服务。 当 Batch 重新运行您的开始任务时，它将删除开始任务工作目录并再次创建它。 这之所以有效，是因为服务在其他目录上具有文件锁，而不是启动任务工作目录。

- **避免在 Windows 中创建目录连接**  
    目录连接（有时称为目录硬链接）在任务和作业清理过程中难以处理。 使用符号链接（软链接），而不是硬链接。

- **如果出现问题，收集批处理代理日志**  
    如果您发现涉及节点或在节点上运行的任务的行为问题，建议在取消分配相关节点之前收集 Batch 代理日志。 可以使用上载批处理服务日志 API 收集批处理代理日志。 这些日志可以作为 Microsoft 支持票证的一部分提供，并有助于解决问题。

## <a name="security"></a>安全性

### <a name="security-isolation"></a>安全隔离

出于隔离的目的，如果方案需要将作业彼此隔离，则应通过将作业隔离到单独的池中来隔离这些作业。 池是 Batch 中的安全隔离边界，默认情况下，两个池不可见或无法相互通信。 避免使用单独的批处理帐户作为隔离方法。

## <a name="moving"></a>移动

### <a name="move-batch-account-across-regions"></a>跨区域移动批处理帐户 

在各种方案中，您希望将现有的 Batch 帐户从一个区域移动到另一个区域。 例如，您可能希望移动到其他区域，作为灾难恢复规划的一部分。

Azure 批处理帐户不能从一个区域移动到另一个区域。 但是，可以使用 Azure 资源管理器模板导出 Batch 帐户的现有配置。  然后，您可以通过将 Batch 帐户导出到模板、修改参数以匹配目标区域，然后将模板部署到新区域，在另一个区域中暂占资源。 将模板上载到新区域后，必须重新创建证书、作业计划和应用程序包。 要提交更改并完成批处理帐户的移动，请记住删除原始 Batch 帐户或资源组。  

有关资源管理器和模板的详细信息，请参阅[快速入门：使用 Azure 门户创建和部署 Azure 资源管理器模板](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)。


