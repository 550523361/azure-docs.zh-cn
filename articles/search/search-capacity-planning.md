---
title: 调整查询和索引工作负荷的容量
titleSuffix: Azure Cognitive Search
description: 在 Azure 认知搜索中调整分区和副本计算机资源，其中每个资源以可计费搜索单位定价。
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: bc90ecb029afe70ed61e94a727c67c53bb968b96
ms.sourcegitcommit: 0eb0673e7dd9ca21525001a1cab6ad1c54f2e929
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/14/2020
ms.locfileid: "77212545"
---
# <a name="adjust-capacity-in-azure-cognitive-search"></a>调整 Azure 认知搜索中的容量

[预配搜索服务](search-create-service-portal.md)并在特定定价层中锁定之前，需花费几分钟的时间来了解服务中副本和分区的角色，无论你需要按比例增加还是更快速地分区，以及如何配置服务以实现预期的负载。

容量是[所选层](search-sku-tier.md)的一个功能（层决定硬件特征）以及预计的工作负荷所需的副本和分区组合。 本文重点介绍副本和分区的组合以及交互。

## <a name="terminology-replicas-and-partitions"></a>术语：副本和分区

|||
|-|-|
|*分区* | 为读/写操作（例如在重建或刷新索引时）提供索引存储和 I/O。 每个分区都有总计索引的份额。 如果分配三个分区，则索引将分为三分之二。 |
|*副本* | 是搜索服务的实例，主要用于对查询操作进行负载均衡。 每个副本都是索引的一个副本。 如果分配三个副本，则可以使用三个索引副本来处理查询请求。|

## <a name="how-to-allocate-replicas-and-partitions"></a>如何分配副本和分区

最初，为服务分配一个包含一个分区和一个副本的最小级别的资源。 

单个服务必须具有足够的资源才能处理所有工作负荷（索引和查询）。 工作负荷不会在后台运行。 如果查询请求的频率不是很频繁，则可以计划索引时间，但该服务不会对另一任务设置优先级。

当修改副本和分区的分配时，我们建议使用 Azure 门户。 门户对允许的组合强制实施限制，这些组合保持低于最大层限制。 但是，如果需要基于脚本或基于代码的预配方法，则[Azure PowerShell](search-manage-powershell.md)或[管理 REST API](https://docs.microsoft.com/rest/api/searchmanagement/services)是替代解决方案。

作为一般规则，搜索应用程序往往需要比分区更多的副本，尤其是在服务操作倾向于查询工作负荷时。 [高可用性](#HA)部分将解释原因。

1. 登录到 [Azure 门户](https://portal.azure.com/)，并选择搜索服务。

1. 在 "**设置**" 中，打开 "**缩放**" 页以修改副本和分区。 

   以下屏幕截图显示了一项预配的标准服务，其中包含一个副本和分区。 底部的公式指示正在使用的搜索单位数（1）。 如果单位价格为 $100 （而不是实际价格），则运行此服务的每月费用将平均为 $100。

   ![显示当前值的缩放页面](media/search-capacity-planning/1-initial-values.png "显示当前值的缩放页面")

1. 使用滑块可以增加或减少分区数。 底部的公式指示正在使用的搜索单位数。

   此示例将容量加倍，其中每个都有两个副本和分区。 请注意搜索单位数;因为计费公式是副本乘以分区（2 x 2），所以现在为四个。 增加容量比运行服务的成本要高得多。 如果搜索单位成本为 $100，则新的月度帐单现在为 $400。

   有关每个层的当前每单位成本，请访问[定价页](https://azure.microsoft.com/pricing/details/search/)。

   ![添加副本和分区](media/search-capacity-planning/2-add-2-each.png "添加副本和分区")

1. 单击 "**保存**" 以确认所做的更改。

   ![确认对缩放和计费的更改](media/search-capacity-planning/3-save-confirm.png "确认对缩放和计费的更改")

   容量更改需要花费几个小时才能完成。 启动进程后，将无法进行取消操作，并且不会对副本和分区调整进行实时监视。 但是，当更改正在进行时，以下消息仍然可见。

   ![门户中的状态消息](media/search-capacity-planning/4-updating.png "门户中的状态消息")

> [!NOTE]
> 预配服务后，无法将其升级到更高的层。 必须在新层中创建搜索服务，并重新加载索引。 若要帮助进行服务预配，请参阅[在门户中创建 Azure 认知搜索服务](search-create-service-portal.md)。
>
> 另外，分区和副本由服务以独占方式进行管理。 没有处理器关联的概念，也没有将工作负荷分配到特定节点。
>

<a id="chart"></a>

## <a name="partition-and-replica-combinations"></a>分区和副本组合

“基本”服务可以包含一个分区以及最多三个副本，上限为三个 SU。 唯一可调整的资源是副本。 至少需要两个副本才能实现查询的高可用性。

所有标准和存储优化搜索服务都可以根据 36-SU 限制，采用以下副本和分区的组合。 

|   | **1 个分区** | **2 个分区** | **3 个分区** | **4 个分区** | **6 个分区** | **12 个分区** |
| --- | --- | --- | --- | --- | --- | --- |
| **1 个副本** |1 个 SU |2 SU |3 SU |4 SU |6 SU |12 SU |
| **2 个副本** |2 SU |4 SU |6 SU |8 SU |12 SU |24 SU |
| **3 个副本** |3 SU |6 SU |9 SU |12 SU |18 SU |36 个 SU |
| **4 个副本** |4 SU |8 SU |12 SU |16 SU |24 SU |空值 |
| **5 副本** |5 SU |10 SU |15 SU |20 SU |30 SU |空值 |
| **6 个副本** |6 SU |12 SU |18 SU |24 SU |36 个 SU |空值 |
| **12 副本** |12 SU |24 SU |36 个 SU |空值 |空值 |空值 |

Azure 网站上详细说明了 SU、定价和容量。 有关详细信息，请参阅 [Pricing Details](https://azure.microsoft.com/pricing/details/search/)（定价详细信息）。

> [!NOTE]
> 副本数和分区数必须能被 12 整除（具体而言，为 1、2、3、4、6、12）。 这是因为，Azure 认知搜索将每个索引预先分割为12个分片，以便可以将其分散到所有分区的相等部分。 例如，如果服务有三个分区，而你创建了新索引，则每个分区将包含该索引的四个分片。 Azure 认知搜索分片索引的方式是实现细节，在将来的版本中可能会有所更改。 尽管目前的分区数为 12，但请不要料想将来该数字永远都是 12。
>

<a id="HA"></a>

## <a name="high-availability"></a>高可用性

由于扩展的过程比较简单而且相对较快，因此我们通常建议从一个分区以及一个或两个副本开始，并随着不断构建查询卷而进行扩展。 查询工作负荷主要是在副本上运行。 如果需要更高的吞吐量或高可用性，也许需要增加副本。

针对高可用性的一般建议是：

* 对于只读工作负荷（查询），需要有两个副本才能实现高可用性

* 对于读/写工作负荷（查询以及添加、更新或删除单个文档时的索引编制），需有三个或更多个副本才能实现高可用性

适用于 Azure 认知搜索的服务级别协议（SLA）面向查询操作和包含添加、更新或删除文档的索引更新。

基本层最多能有一个分区和三个副本。 如果希望灵活地立即响应对索引编制和查询吞吐量的需求波动，请考虑使用标准层中的一个。  如果发现存储要求的增长速度快于查询吞吐量的增长速度，请考虑采用存储优化的一层。

## <a name="disaster-recovery"></a>灾难恢复

目前没有任何内置的机制可实现灾难恢复。 添加分区或副本并不是实现灾难恢复目标的正确策略。 最常见的方法是通过在另一区域中设置另一个搜索服务，在服务级别添加冗余。 与索引重建期间的可用性一样，重定向或故障转移逻辑必须来自代码。

## <a name="estimate-replicas"></a>估计副本

在生产服务中，出于 SLA 目的应分配三个副本。 如果查询性能较慢，一项补救措施是添加副本，以便使索引的其他副本联机以支持更大的查询工作负荷，并对多个副本的请求进行负载均衡。

我们不提供满足查询负载所需的副本数的指导。 查询性能取决于查询复杂性和争用工作负荷。 尽管添加副本会明显提高性能，但结果不一定有线性改善：添加三个副本并不保证带来三倍的吞吐量。

有关评估解决方案的 QPS 的指导，请参阅[性能](search-performance-optimization.md)和[监视器查询](search-monitor-queries.md)的缩放

## <a name="estimate-partitions"></a>估计分区

[你选择的层](search-sku-tier.md)决定分区大小和速度，每个层都围绕一组适用于各种方案的特征进行了优化。 如果选择更高的层级，则可能需要的分区比使用 S1 更少。

需要以近乎实时的速度刷新数据的搜索应用程序，需要的分区数在比例上要多于副本。 添加分区可将读/写操作分配到更多的计算资源。 此外，还能提供更多磁盘空间来存储更多的索引和文档。

索引越大，查询所需的时间就越长。 因此，可能发现，每次增加分区都需要按比例少量增加副本。 查询和查询卷的复杂性影响查询执行的速度。

## <a name="next-steps"></a>后续步骤

> [!div class="nextstepaction"]
> [选择 Azure 认知搜索的定价层](search-sku-tier.md)