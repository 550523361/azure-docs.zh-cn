<properties title="将您的 Azure 网站与 Azure 虚拟网络相集成" pageTitle="将 Azure 网站与 Azure 虚拟网络相集成" description="展示如何将 Azure 网站连接到新的或现有的 Azure 虚拟网络" metaKeywords="" services="web-sites,virtual-network" solutions="web,integration,infrastructure" documentationCenter="" authors="cephalin" videoId="" scriptId="" manager="wpickett" />

<tags ms.service="web-sites" ms.workload="web" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="09/24/2014" ms.author="cephalin" />

# 将您的 Azure 网站与 Azure 虚拟网络相集成 #
本文档将介绍虚拟网络集成预览功能，并说明如何借助您的 Azure 网站对其进行设置。如果您不熟悉 Azure 虚拟网络，该功能可支持您借助 Azure 和本地资源构建混合解决方案。  

该集成功能允许您的网站访问虚拟网络中的资源，但不允许通过虚拟网络访问您的网站。在一些标准情况下，您的网站需要访问数据库或 web 服务，它们运行于您的虚拟网络或甚至数据中心的虚拟机。它不允许您安装驱动器。它目前还不支持启用与虚拟网络的身份验证系统相集成。尽管该功能还处于预览状态，但到达 GA 之间将继续进行改进。

更多关于 Azure 虚拟网络的详细信息，请参阅"虚拟网络概述"，了解 Azure 虚拟网络的使用案例与优势。

## 入门 ##
将网站连接到虚拟网络之前，您需要牢记以下几点。

1.	如果网站正基于'标准'定价层中的 web 托管计划运行，那么它们只能连接到虚拟网络。免费、共享和基本站点无法连接到虚拟网络。
2.	如果您的目标虚拟网络已经存在，必须在连接到网站之前借助动态路由网关使网络处于点到站点启用状态。如果网关由静态路由配置，那么您将无法启用点到站点 VPN。
3.	您最多只有 5 个在 web 托管计划中配置的网络。网站一次只能连接到一个网络。同一 web 托管计划中任意数量的网站均可使用这 5 个网络。  

您可以选择连接到新的或现有的虚拟网络。如果创建新的网络，网关将预先配置。请注意，创建和配置新的虚拟网络将耗费几分钟的时间。  

如果您的网站不在标准层，用户界面可帮助您了解并访问您应该点击的定价层。

![](./media/web-sites-integrate-with-vnet/upgrade-to-standard.png) 

## 系统的工作方式 ##
实际上，该功能使用点到站点 VPN 技术将您的 Azure 网站连接到虚拟网络。Azure 网站系统体系结构属于多租户性质，这样与虚拟机同时使用时可防止直接在 VNET 设置网站。通过基于点到站点技术的构建，我们将网络访问限制在托管网站的那台虚拟机。这样，这些网络托管进一步限制了网络访问，因此您的网站仅可以访问您对可访问性进行了配置的网站。  

将网络保护在仅需要访问的网站范围之内而采取的措施可以防止创建 SMB 连接。尽管您可以访问远程资源，但这不包括安装远程驱动器。

![](./media/web-sites-integrate-with-vnet/how-it-works.png)
 
如果尚未使用虚拟网络配置 DNS 服务器，您需要使用 IP 地址。请确保您所需的终结点的端口能够越过防火墙显示。测试连接时，目前可用的唯一方法是使用网站或 webjob调用您所需的终结点。目前无法通过 Kudu 控制台使用 ping 或 nslookup 等工具。这点将会在不久的将来有所改进。  

## 连接到预先存在的网络 ##
若要连接网站和虚拟网络，请转到您的网站分页，单击网络部分的虚拟网络尾标，然后选择其中一个预先存在的网络。

![](./media/web-sites-integrate-with-vnet/connect-to-existing-vnet.png)
 
如果虚拟网络是订阅的第一个网络，系统将创建证书对该 虚拟网络进行身份验证，以与该网络建立连接。若要查看证书，请转到当前的门户，导航到虚拟网络，选择网络，然后选择"证书"选项卡。  

在上图中，您可以看到名为 cantConnectVnet 的网络为灰色，无法进行选择。原因有两点。这意味着您无法在网络上启用点到站点 VPN，或您尚未在 虚拟网络中设置动态路由网关。如果这两点得到满足，您将能够选择将虚拟网络与您的网站进行集成。

## 创建并连接到新的虚拟网络 ##
除了连接到预先存在的虚拟网络，您还可以通过网站用户界面创建新的虚拟网络，并自动连接。若要创建新的虚拟网络，请按照相同路径访问虚拟网络用户界面，然后选择创建新的虚拟网络。您可以打开用户界面命名网络、指定地址空间，并为虚拟网络要使用的 DNS 服务器设置地址。

![](./media/web-sites-integrate-with-vnet/create-new-vnet.png)
 
借助配置过的网关创建新的虚拟网络可能需要 30 分钟才能完成。在这期间，用户界面会显示是否正在正常运行，并显示下列消息。

![](./media/web-sites-integrate-with-vnet/new-vnet-progress.png)

网络联接到该网站后，网站将能够通过 TCP 或 UDP 访问虚拟网络中的资源。如果您想要访问本地系统（从站点到站点 VPN 到虚拟网络均可用）中的资源，您需要为自己的公司网络添加路由，以允许流量从网络转到在虚拟网络中配置的点到站点地址。

成功集成后，该门户将显示有关连接的基本信息，并提供两种断开网站的网络连接以及将用于对连接进行身份验证的证书进行同步的方法。如果证书已过期或被撤销，可能需要进行同步。  

![](./media/web-sites-integrate-with-vnet/vnet-status-portal.png)

管理虚拟网络连接
通过访问 web 托管计划的分页，您可以看到目前在 web 托管计划中与网站关联的所有虚拟网络。您最多有 5 个与标准 web 托管计划关联的网络。

如果 web 托管计划缩放到层级较低的计划，例如免费、共享或基本计划，那么该计划中网站所使用的虚拟网络连接将被禁用。如果缩放到标准计划，那么这些网络连接将会重新建立。

如果此次无法在 Azure 中采用现有虚拟机，那么请移动到虚拟网络中。创建期间，虚拟机需设置到该虚拟网络。  

## 访问本地资源 ##
使用已配置了站点到站点 VPN 的虚拟网络时，您需要多执行一个步骤，以能够从您的 Azure 网站访问本地资源。本地网络需添加路由，以支持流量从您的网络转到在虚拟网络中配置的点到站点地址。若要查看点到站点连接性的 IP 范围，请转到当前门户的网络区域，如下所示。

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise.png)

## 证书 ##
为了与您的虚拟网络建立安全的连接，需要交换证书。如下所示，您可以看到 Azure 网站通过当前网络门中生成的公用证书的指纹。  

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise-certificate.png)

如果证书因为某种原因（比如意外从网络门户中删除）而不同步，连接性将会被破坏。如要解决问题，可在您的网站虚拟网络界面中执行同步连接操作，这样将重新建立连接。

如果为虚拟网络添加 DNS，或为网络添加站点到站点 VPN，此操作也必须执行。  

![](./media/web-sites-integrate-with-vnet/vnet-sync-connection.png)

## 与混合连接的比较和对比 ##
Azure 网站还可提供另外一项功能：混合连接，该功能在某些方面与虚拟网络集成类似。尽管它们的有些使用案例相互重叠，但两者无法相互替代。您可以借助混合连接在网络组合中建立与多个应用程序终结点的连接。虚拟网络功能够将您的网站连接到虚拟网络，该虚拟网络还可以连接到您的本地网络。如果资源全部位于网络之中，该功能将十分有效。  

两者还存在另一个差别，即您需要为混合连接安装中继代理。此代理需要在 Windows Server 实例上运行。而虚拟网络功能不需要安装任何东西，无论运行哪种托管操作系统，该功能均支持访问远程资源。  

两者的定价也不同。因为即使是最便宜的混合连接功能，也可对开发/测试方案发挥巨大作用，此外，它仅支持访问少量终结点。而虚拟网络功能支持您访问虚拟网络之中或与虚拟网络连接的所有内容。  
