---
title: "配置 Operations Management Suite (OMS) 中的服务映射 | Microsoft Docs"
description: "服务映射是 Operations Management Suite (OMS) 解决方案，可自动发现 Windows 和 Linux 系统上的应用程序组件并映射服务之间的通信。  本文提供了有关在环境中部署服务映射并在各种方案中使用它的详细信息。"
services: operations-management-suite
documentationcenter: 
author: daveirwin1
manager: jwhit
editor: tysonn
ms.assetid: d3d66b45-9874-4aad-9c00-124734944b2e
ms.service: operations-management-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/18/2016
ms.author: daseidma;bwren;dairwin
translationtype: Human Translation
ms.sourcegitcommit: 496e00c2b9a0b374450f9a6f9dff5d41c805261c
ms.openlocfilehash: 591f3440977b1c952b1b360f6d3f221cdbc5a7a7


---
# <a name="configuring-service-map-solution-in-operations-management-suite-oms"></a>配置 Operations Management Suite (OMS) 中的服务映射解决方案
服务映射自动发现 Windows 和 Linux 系统上的应用程序组件并映射服务之间的通信。 它允许你如所想一般作为提供重要服务的互连系统查看服务器。  服务映射显示任何 TCP 连接的体系结构中服务器、进程和端口之间的连接，只需安装代理，无需任何其他配置。

本文介绍了配置服务映射和载入代理的详细信息。  有关使用服务映射的信息，请参阅[使用 Operations Management Suite (OMS) 中的服务映射解决方案](operations-management-suite-service-map.md)


## <a name="connected-sources"></a>连接的源
下表介绍了服务映射解决方案支持的连接的源。

| 连接的源 | 支持 | 说明 |
|:--|:--|:--|
| [Windows 代理](../log-analytics/log-analytics-windows-agents.md) | 是 | 服务映射从 Windows 代理计算机分析和收集数据。  <br><br>除了 OMS 代理，Windows 代理还需要 Microsoft 依赖关系代理。  有关操作系统版本的完整列表，请参阅[受支持的操作系统](#supported-operating-systems)。 |
| [Linux 代理](../log-analytics/log-analytics-linux-agents.md) | 是 | 服务映射从 Linux 代理计算机分析和收集数据。  <br><br>除了 OMS 代理，Linux 代理还需要 Microsoft 依赖关系代理。  有关操作系统版本的完整列表，请参阅[受支持的操作系统](#supported-operating-systems)。 |
| [SCOM 管理组](../log-analytics/log-analytics-om-agents.md) | 是 | 服务映射在连接的 System Center Operations Manager (SCOM) 管理组中从 Windows 和 Linux 代理分析和收集数据。 <br><br>需要从 SCOM 代理计算机直接连接到 OMS。 数据直接从管理组转发到 OMS 存储库。|
| [Azure 存储帐户](../log-analytics/log-analytics-azure-storage.md) | 否 | 服务映射从代理计算机收集数据，因此其中任何数据都不会从 Azure 存储中收集。 |

服务映射仅支持 64 位平台。

在 Windows 上，SCOM 和 OMS 使用 Microsoft Monitoring Agent (MMA) 收集和发送监视数据。  （此代理称为 SCOM 代理、OMS 代理、MMA 或直接代理，具体取决于上下文。）SCOM 和 OMS 提供不同的全新 MMA 版本，但这些版本可分别报告给 SCOM、OMS，或同时报告给这两者。  在 Linux 上，适用于 Linux 的 OMS 代理收集监视数据并将其发送到 OMS。  可在具有 OMS 直接代理的服务器或已通过 SCOM 管理组连接到 OMS 的服务器上使用服务映射。  在本文档中，我们引用所有代理作为“OMS 代理”（不管是使用 Linux 还是 Windows，也不管是连接到 SCOM MG 还是直接连接到 OMS），除非上下文需要代理的特定部署名称。

服务映射代理本身不传输任何数据，它不需要对防火墙或端口做出任何更改。  服务映射数据始终由 OMS 代理直接或通过 OMS 网关传输到 OMS。

![服务映射代理](media/oms-service-map/agents.png)

如果你是使用已连接到 OMS 的管理组的 SCOM 客户：

- 如果你的 SCOM 代理可以访问连接到 OMS 的 Internet，无需进行额外配置。  
- 如果 SCOM 代理无法通过 Internet 访问 OMS，需要配置 OMS 网关才能使用 SCOM。
  
如果你使用的是 OMS 直接代理，需要配置 OMS 代理本身才能连接到 OMS 或 OMS 网关。  可从 [https://www.microsoft.com/zh-cn/download/details.aspx?id=52666](https://www.microsoft.com/en-us/download/details.aspx?id=52666) 下载 OMS 网关


### <a name="avoiding-duplicate-data"></a>避免重复数据

如果你是 SCOM 客户，不应将 SCOM 代理配置为直接与 OMS 通信，否则数据将报告两次。  在服务映射中，这将导致计算机在计算机列表中出现两次。

应仅在以下位置之一中配置 OMS：

- 托管计算机的 SCOM 控制台 Operations Management Suite 面板
- MMA 属性中的 Azure 操作见解配置

在两个配置中使用相同的工作区将导致数据重复。 将两个配置用于不同的工作区可能导致配置冲突（一个启用了服务映射解决方案，而另一个却没有），这可能阻止数据完全流向服务映射。  

即使 SCOM 控制台的 OMS 配置中未指定计算机本身，但如果实例组（如“Windows Server 实例组”）处于活动状态，仍可能导致计算机通过 SCOM 接收 OMS 配置。



## <a name="management-packs"></a>管理包
在 OMS 工作区中激活服务映射时，将向该工作区中的所有 Microsoft 监视代理发送 300KB 的管理包。  如果在[连接的管理组](../log-analytics/log-analytics-om-agents.md)中使用 SCOM 代理，则将从 SCOM 部署服务映射管理包。  如果代理直接连接，MP 将由 OMS 传送。

MP 名为 Microsoft.IntelligencePacks.ApplicationDependencyMonitor*。它将写入 *%Programfiles%\Microsoft Monitoring Agent\Agent\Health Service State\Management Packs\*。  管理包所使用的数据源是 *%Program files%\Microsoft Monitoring Agent\Agent\Health Service State\Resources\<AutoGeneratedID>\Microsoft.EnterpriseManagement.Advisor.ApplicationDependencyMonitorDataSource.dll*。



## <a name="configuration"></a>配置
除了 Windows 和 Linux 计算机已安装代理并连接到 OMS 之外，还必须从服务映射解决方案下载依赖关系代理安装程序，然后将其作为根或管理安装在每个托管服务器上。  在向 OMS 报告的服务器上安装了服务映射代理后，服务映射依赖关系映射将在 10 分钟内显示。


### <a name="migrating-from-bluestripe-factfinder"></a>从 BlueStripe FactFinder 迁移
在各个阶段中，服务映射将 BlueStripe 技术传送到 OMS。 FactFinder 仍受现有客户支持，但不再用于单独购买。  此预览版本的依赖关系代理仅与 OMS 通信。  如果是现有 FactFinder 客户，请针对服务映射标识一组未由 FactFinder 托管的测试服务器。 

### <a name="download-the-dependency-agent"></a>下载依赖关系代理
除了提供计算机和 OMS 之间连接的 Microsoft 管理代理 (MMA) 和 OMS Linux 代理外，服务映射分析的所有计算机还必须安装依赖关系代理。  在 Linux 上，适用于 Linux 的 OMS 代理必须在依赖关系代理之前安装。 

![“服务映射”磁贴](media/oms-service-map/additional_configuration.png)

若要下载依赖关系代理，请单击“服务映射”磁贴中的“配置解决方案”，打开“依赖关系代理”边栏选项卡。  “依赖关系代理”边栏选项卡具有 Windows 和 Linux 代理的链接。 有关在不同的系统上安装代理的详细信息，请参阅以下部分。

### <a name="install-the-dependency-agent"></a>安装依赖关系代理

#### <a name="microsoft-windows"></a>Microsoft Windows
需要管理员特权才能安装或卸载代理。

使用 InstallDependencyAgent-Windows.exe 在 Windows 计算机上安装依赖关系代理。 如果在没有任何选项的情况下运行此可执行文件，它将启动一个向导，此向导以交互方式指导用户进行安装。  

使用以下步骤在每台 Windows 计算机上安装依赖关系代理：

1.  确保按照“将计算机直接连接到 OMS”中的说明安装 OMS 代理。
2.  下载 Windows 代理，并使用以下命令运行它： <br>*InstallDependencyAgent-Windows.exe*
3.  按照向导安装代理。
4.  如果依赖关系代理无法启动，请检查日志以获取详细的错误信息。 在 Windows 代理上，日志目录是 *C:\Program Files\Microsoft Dependency Agent\logs*。 

管理员可通过“控制面板”卸载适用于 Windows 的依赖关系代理。


#### <a name="linux"></a>Linux
需要根目录访问才能安装或配置代理。

使用 InstallDependencyAgent-Linux64.bin（具有自解压二进制文件的 Shell 脚本）在 Linux 计算机上安装依赖关系代理。 可运行具有 sh 的文件或将执行权限添加到文件本身。
 
使用以下步骤在每台 Linux 计算机上安装依赖关系代理：

1.  确保按照[从 Linux 计算机收集和管理数据。OMS 代理需要在 Linux 依赖关系代理之前安装](https://technet.microsoft.com/library/mt622052.aspx)中的说明安装 OMS 代理。
2.  使用以下命令将 Linux 依赖关系代理安装为根：<br>*sh InstallDependencyAgent-Linux64.bin*。
3.  如果依赖关系代理无法启动，请检查日志以获取详细的错误信息。 在 Linux 代理上，日志目录是 */var/opt/microsoft/dependency-agent/log*。

### <a name="uninstalling-the-dependency-agent-on-linux"></a>卸载 Linux 上的依赖关系代理
若要从 Linux 中彻底卸载依赖关系代理，必须删除代理本身以及随该代理自动安装的连接器。  可使用以下单个命令同时卸载这两项：

    rpm -e dependency-agent dependency-agent-connector


### <a name="installing-from-a-command-line"></a>从命令行安装
上一部分提供了有关使用默认选项安装依赖关系监视器代理的指南。  以下部分提供了有关使用自定义选项从命令行安装代理的指南。

#### <a name="windows"></a>Windows
使用下表中的选项从命令行进行安装。 若要查看安装标志列表，请运行带有 /? 标志的安装程序，如下所示。

    InstallDependencyAgent-Windows.exe /?

| 标志 | 说明 |
|:--|:--|
| /S | 执行无提示安装，无用户提示。 |

默认情况下，Windows 依赖关系代理的文件放置在 *C:\Program Files\Microsoft Dependency Agent* 中。


#### <a name="linux"></a>Linux
使用下表中的选项进行安装。 若要查看安装标志列表，请运行带有 -help 标志的安装程序，如下所示。

    InstallDependencyAgent-Linux64.bin -help

| 标志说明
|:--|:--|
| -s | 执行无提示安装，无用户提示。 |
| --check | 检查权限和操作系统，但不安装代理。 |

依赖关系代理的文件放置在以下目录中：

| 文件 | 位置 |
|:--|:--|
| 核心文件 | /opt/microsoft/dependency-agent |
| 日志文件 | /var/opt/microsoft/dependency-agent/log |
| 配置文件 | /etc/opt/microsoft/dependency-agent/config |
| 服务可执行文件 | /opt/microsoft/dependency-agent/bin/microsoft-dependency-agent<br>/opt/microsoft/dependency-agent/bin/microsoft-dependency-agent-manager |
| 二进制存储文件 | /var/opt/microsoft/dependency-agent/storage |



## <a name="troubleshooting"></a>故障排除
如果遇到服务映射问题，可使用以下信息从多个组件中收集疑难解答信息。

### <a name="windows-agents"></a>Windows 代理

#### <a name="microsoft-dependency-agent"></a>Microsoft 依赖关系代理
若要从依赖关系代理生成疑难解答数据，请以管理员身份打开“命令提示符”并使用以下命令运行 CollectDependencyAgentData.vbs 脚本。  可添加 --help 标志，显示其他选项。

    cd C:\Program Files\Microsoft Dependency Agent\scripts
    cscript CollectDependencyData.vbs

支持数据包保存在 %USERPROFILE% 目录中，可供当前用户使用。  你可以使用 --file <filename> 选项将它保存到其他位置。

#### <a name="microsoft-dependency-agent-management-pack-for-mma"></a>适用于 MMA 的 Microsoft 依赖关系代理管理包
依赖关系代理管理包在 Microsoft 管理代理中运行。  它从依赖关系代理接收数据，并将其转发到服务映射云服务。
  
请验证是否通过执行以下步骤下载管理包：

1.  在 C:\Program Files\Microsoft Monitoring Agent\Agent\Health Service State\Management Packs 中查找名为 Microsoft.IntelligencePacks.ApplicationDependencyMonitor.mp 的文件。  
2.  如果该文件不存在并且代理已连接到 SCOM 管理组，则验证是否已通过在操作控制台的管理工作区中检查管理包将其导入到 SCOM。

服务映射 MP 将事件写入 Operations Manager Windows 事件日志。  该日志可通过系统日志解决方案[在 OMS 中搜索](../log-analytics/log-analytics-log-searches.md)，你可以在其中配置要上传的日志文件。  如果启用了调试事件，它们将写入应用程序事件日志，事件源为 *ADMConnector*。

#### <a name="microsoft-monitoring-agent"></a>Microsoft Monitoring Agent
若要收集诊断跟踪，请以管理员身份打开“命令提示符”并运行以下命令： 

    cd \Program Files\Microsoft Monitoring Agent\Agent\Tools
    net stop healthservice 
    StartTracing.cmd ERR
    net start healthservice

跟踪将写入 c:\Windows\Logs\OpsMgrTrace。  可使用 StopTracing.cmd 停止跟踪。


### <a name="linux-agents"></a>Linux 代理

#### <a name="microsoft-dependency-agent"></a>Microsoft 依赖关系代理
若要从依赖关系代理生成疑难解答数据，请使用具有 sudo 或 root 权限的帐户登录并运行以下命令。  可添加 --help 标志，显示其他选项。

    /opt/microsoft/dependency-agent/scripts/collect-dependency-agent-data.sh

支持数据包将保存到代理的安装目录下的 /var/opt/microsoft/dependency-agent/log（如果是根目录），或运行脚本的用户的主目录（如果是非根目录）。  你可以使用 --file <filename> 选项将它保存到其他位置。

#### <a name="microsoft-dependency-agent-fluentd-plug-in-for-linux"></a>适用于 Linux 的 Microsoft 依赖关系代理 Fluentd 插件
依赖关系代理 Fluentd 插件在 OMS Linux 代理中运行。  它从依赖关系代理接收数据，并将其转发到服务映射云服务。  

日志将写入以下两个文件。

- /var/opt/microsoft/omsagent/log/omsagent.log
- /var/log/messages

#### <a name="oms-agent-for-linux"></a>适用于 Linux 的 OMS 代理
可在此处找到有关将 Linux 服务器连接到 OMS 的疑难解答资源：[https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/Troubleshooting.md](https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/Troubleshooting.md) 

适用于 Linux 的 OMS 代理的日志位于 */var/opt/microsoft/omsagent/log/*。  

omsconfig（代理配置）的日志位于 */var/opt/microsoft/omsconfig/log/*。
 
可提供性能指标数据的 OMI 和 SCX 组件的日志位于 */var/opt/omi/log/* 和 */var/opt/microsoft/scx/log*。


## <a name="data-collection"></a>数据收集
根据系统依赖关系的复杂性，可预计每个代理每天传输大约 25MB。  每个代理每 15 秒发送一次服务映射依赖关系数据。  

依赖关系代理通常消耗 0.1% 的系统内存和 0.1% 的系统 CPU。


## <a name="supported-operating-systems"></a>支持的操作系统
以下部分列出了依赖关系代理支持的操作系统。   任何操作系统都不支持&32; 位体系结构。

### <a name="windows-server"></a>Windows Server
- Windows Server 2016
- Windows Server 2012 R2
- Windows Server 2012
- Windows Server 2008 R2 SP1

### <a name="windows-desktop"></a>Windows 桌面
- Windows 10
- Windows 8.1
- Windows 8
- Windows 7

### <a name="red-hat-enterprise-linux-centos-linux-and-oracle-linux-with-rhel-kernel"></a>Red Hat Enterprise Linux、CentOS Linux 和 Oracle Linux（具有 RHEL 内核）
- 仅默认版本和 SMP Linux 内核版本受支持。
- 任何 Linux 分发版都不支持非标准内核版本（例如 PAE 和 Xen）。 例如，不支持版本字符串为“2.6.16.21-0.8-xen”的系统。
- 不支持自定义内核（包括标准内核的重新编译）
- 不支持 Centos Plus 内核。
- Oracle Unbreakable Kernel (UEK) 将在下面的其他部分中介绍。


#### <a name="red-hat-linux-7"></a>Red Hat Linux 7
| OS 版本。 | 内核版本 |
|:--|:--|
| 7.0 | 3.10.0-123 |
| 7.1 | 3.10.0-229 |
| 7.2 | 3.10.0-327 |

#### <a name="red-hat-linux-6"></a>Red Hat Linux 6
| OS 版本。 | 内核版本 |
|:--|:--|
| 6.0 | 2.6.32-71 |
| 6.1 | 2.6.32-131 |
| 6.2 | 2.6.32-220 |
| 6.3 | 2.6.32-279 |
| 6.4 | 2.6.32-358 |
| 6.5 | 2.6.32-431 |
| 6.6 | 2.6.32-504 |
| 6.7 | 2.6.32-573 |
| 6.8 | 2.6.32-642 |

#### <a name="red-hat-linux-5"></a>Red Hat Linux 5
| OS 版本。 | 内核版本 |
|:--|:--|
| 5.8 | 2.6.18-308 |
| 5.9 | 2.6.18-348 |
| 5.10 | 2.6.18-371 |
| 5.11 | 2.6.18-398<br>2.6.18-400<br>2.6.18-402<br>2.6.18-404<br>2.6.18-406<br>2.6.18-407<br>2.6.18-408<br>2.6.18-409<br>2.6.18-410<br>2.6.18-411<br>2.6.18-412<br>2.6.18-416 |

#### <a name="oracle-enterprise-linux-w-unbreakable-kernel-uek"></a>具有 Unbreakable Kernel (UEK) 的 Oracle Enterprise Linux

#### <a name="oracle-linux-6"></a>Oracle Linux 6
| OS 版本。 | 内核版本
|:--|:--|
| 6.2 | Oracle 2.6.32-300 (UEK R1) |
| 6.3 | Oracle 2.6.39-200 (UEK R2) |
| 6.4 | Oracle 2.6.39-400 (UEK R2) |
| 6.5 | Oracle 2.6.39-400 (UEK R2 i386) |
| 6.6 | Oracle 2.6.39-400 (UEK R2 i386) |

#### <a name="oracle-linux-5"></a>Oracle Linux 5

| OS 版本。 | 内核版本
|:--|:--|
| 5.8 | Oracle 2.6.32-300 (UEK R1) |
| 5.9 | Oracle 2.6.39-300 (UEK R2) |
| 5.10 | Oracle 2.6.39-400 (UEK R2) |
| 5.11 | Oracle 2.6.39-400 (UEK R2) |

#### <a name="suse-linux-enterprise-server"></a>SUSE Linux Enterprise Server

#### <a name="suse-linux-11"></a>SUSE Linux 11
| OS 版本。 | 内核版本
|:--|:--|
| 11 | 2.6.27 |
| 11 SP1 | 2.6.32 |
| 11 SP2 | 3.0.13 |
| 11 SP3 | 3.0.76 |
| 11 SP4 | 3.0.101 |

#### <a name="suse-linux-10"></a>SUSE Linux 10
| OS 版本。 | 内核版本
|:--|:--|
| 10 SP4 | 2.6.16.60 |

## <a name="diagnostic-and-usage-data"></a>诊断和使用情况数据
Microsoft 通过使用服务映射服务，自动收集使用情况和性能数据。 Microsoft 使用此数据提供和改进服务映射服务的质量、安全性和完整性。 数据包括有关软件配置的信息（如操作系统和版本），还包括 IP 地址、DNS 名称和工作站名称，以便提供准确高效的疑难解答功能。 我们不收集姓名、地址或其他联系信息。

有关数据收集和使用的详细信息，请参阅 [Microsoft Online Services 隐私声明](https://go.microsoft.com/fwlink/?LinkId=512132)。



## <a name="next-steps"></a>后续步骤
- 部署和配置服务映射后，了解如何[使用服务映射](operations-management-suite-service-map.md)。



<!--HONumber=Jan17_HO3-->


