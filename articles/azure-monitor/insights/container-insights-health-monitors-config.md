---
title: 容器运行状况监视器配置的 Azure 监视器 |微软文档
description: 本文提供描述容器 Azure 监视器中运行状况监视器的详细配置的内容。
ms.topic: conceptual
ms.date: 12/01/2019
ms.openlocfilehash: 99ea6e96f5a8a486784cb3d633a6e031b60eaad7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/28/2020
ms.locfileid: "80055702"
---
# <a name="azure-monitor-for-containers-health-monitor-configuration-guide"></a>容器运行状况监视器配置指南的 Azure 监视器

监视器是测量容器 Azure 监视器中的运行状况和检测错误的主要元素。 本文可帮助您了解如何测量运行状况的概念，以及构成运行状况模型的元素，以便使用["运行状况（预览"](container-insights-health.md)功能）监视和报告 Kubernetes 群集的运行状况。

>[!NOTE]
>此时，"运行状况"功能处于公共预览版中。
>

## <a name="monitors"></a>监视器

监视器衡量托管对象某个方面的运行状况。 监视器各具有两个或三个运行状况状态。 无论何时，监视器将处于一种且仅处于一种其潜在状态。 当容器化代理加载的监视器时，它将初始化为正常状态。 仅当检测到另一种状态的指定条件时，状态才会更改。

特定对象的总体运行状况的确定依据是其每个监视器的运行状况。 此层次结构在容器 Azure 监视器中的"运行状况层次结构"窗格中进行了说明。 如何汇总运行状况的策略是聚合监视器配置的一部分。

## <a name="types-of-monitors"></a>监视器类型

|监视 | 描述 | 
|--------|-------------|
| 单元监视器 |单元监视器测量资源或应用程序的某些方面。 这可能检查性能计数器以确定资源的性能或其可用性。 |
|聚合监视器 | 聚合监视器对多个监视器进行分组，以提供单个运行状况聚合运行状况状态。 单元监视器通常配置在特定聚合监视器下。 例如，节点聚合监视器会汇总节点 CPU 利用率、内存利用率和节点状态的状态。
 |

### <a name="aggregate-monitor-health-rollup-policy"></a>聚合监视器运行状况汇总策略

每个聚合监视器定义运行状况汇总策略，这是用于根据监视器下监视器的运行状况确定聚合监视器运行状况的逻辑。 聚合监视器的可能运行状况汇总策略如下所示：

#### <a name="worst-state-policy"></a>最差国家政策

聚合监视器的状态将子监视器的状态与最差的运行状况状态匹配。 这是聚合监视器最常用的策略。

![聚合监视器汇总最差状态的示例](./media/container-insights-health-monitoring-cfg/aggregate-monitor-rollup-worstof.png)

### <a name="percentage-policy"></a>百分比策略

源对象匹配处于最佳状态的目标对象的指定百分比的单个成员的最坏状态。 当目标对象的一定百分比必须正常，目标对象必须被视为正常时，使用此策略。 百分比策略按状态严重性降序对监视器进行排序，聚合监视器的状态计算为最差状态 N%（N 由配置参数*StateThreshold%* 决定）。

例如，假设容器映像有五个容器实例，并且其各自的状态是 **"严重**、**警告**、**健康**、**健康、健康"。""。"** **Healthy**  容器 CPU 利用率监视器的状态将**至关重要**，因为在按严重性降序排序时，90% 的容器的最坏状态**是"关键**"。

## <a name="understand-the-monitoring-configuration"></a>了解监视配置

容器的 Azure 监视器包括许多关键监视方案，这些方案配置如下。

### <a name="unit-monitors"></a>单元监视器

|**监视器名称** | 监视器类型 | **说明** | **参数** | **价值** |
|-----------------|--------------|-----------------|---------------|-----------|
|节点内存利用率 |单元监视器 |此监视器使用 cadvisor 报告的数据，每分钟评估节点的内存利用率。 |状态转换的连续样本<br> 失败，如果大于百分比<br> 警告如果大于百分比 | 3<br> 90<br> 80  ||
|节点 CPU 利用率 |单元监视器 |此监视器使用 cadvisor 报告的数据每分钟检查节点的 CPU 利用率。 | 状态转换的连续样本<br> 失败，如果大于百分比<br> 警告如果大于百分比 | 3<br> 90<br> 80  ||
|节点状态 |单元监视器 |此监视器检查库伯内斯报告的节点条件。<br> 当前检查以下节点条件：磁盘压力、内存压力、PID 压力、磁盘外、网络不可用、节点就绪状态。<br> 在上述条件下，如果 *"磁盘不足*"或 *"网络不可用"***为 true，** 则监视器将更改为 **"严重"** 状态。<br> 如果任何其他条件等于**true**，但 **"就绪"** 状态之外，监视器将更改为**警告**状态。 | 节点条件类型 用于失败状态 | 磁盘外，网络不可用 ||
|容器内存利用率 |单元监视器 |此监视器报告容器实例的内存利用率 （RSS） 的组合运行状况。<br> 它执行一个简单的比较，将每个示例与单个阈值进行比较，并由配置参数 **"连续采样ForState转换**"指定。<br> 其状态计算为容器 （StateThresholdB%）实例的最差状态 90%，按容器运行状况状态严重性（即"严重"、"警告"、"正常"）的降序排序。<br> 如果未从容器实例接收任何记录，则容器实例的运行状况状态将报告为 **"未知**"，并且排序顺序中的优先级高于 **"严重"** 状态。<br> 使用配置中指定的阈值计算每个单独的容器实例的状态。 如果使用量超过临界阈值 （90%），则实例处于**严重**状态，如果小于关键阈值 （90%）但大于警告阈值 （80%），则实例处于**警告**状态。 否则，它处于 **"正常状态**"。 |状态转换的连续样本<br> 失败，百分比<br> 状态阈值百分比<br> 警告如果大于百分比| 3<br> 90<br> 90<br> 80 ||
|容器 CPU 利用率 |单元监视器 |此监视器报告容器实例的 CPU 利用率合并运行状况。<br> 它执行一个简单的比较，将每个示例与单个阈值进行比较，并由配置参数 **"连续采样ForState转换**"指定。<br> 其状态计算为容器 （StateThresholdB%）实例的最差状态 90%，按容器运行状况状态严重性（即"严重"、"警告"、"正常"）的降序排序。<br> 如果未从容器实例接收任何记录，则容器实例的运行状况状态将报告为 **"未知**"，并且排序顺序中的优先级高于 **"严重"** 状态。<br> 使用配置中指定的阈值计算每个单独的容器实例的状态。 如果使用量超过临界阈值 （90%），则实例处于**严重**状态，如果小于关键阈值 （90%）但大于警告阈值 （80%），则实例处于**警告**状态。 否则，它处于 **"正常状态**"。 |状态转换的连续样本<br> 失败，百分比<br> 状态阈值百分比<br> 警告如果大于百分比| 3<br> 90<br> 90<br> 80 ||
|系统工作负载窗格已准备就绪 |单元监视器 |此监视器根据给定工作负载中处于就绪状态的 pod 的百分比报告状态。 如果少于 100% 的窗格处于 **"正常**状态"，则其状态设置为 **"严重"** |状态转换的连续样本<br> 失败，百分比 |2<br> 100 ||
|库贝 API 状态 |单元监视器 |此监视器报告库贝 API 服务的状态。 如果 Kube API 终结点不可用，监视器处于严重状态。 对于此特定监视器，通过查询 kube-api 服务器的"节点"终结点来确定状态。 除了 OK 响应代码之外，任何其他内容都将监视器更改为 **"严重"** 状态。 | 无配置属性 |||

### <a name="aggregate-monitors"></a>聚合监视器

|**监视器名称** | **说明** | **算法** |
|-----------------|-----------------|---------------|
|节点 |此监视器是所有节点监视器的聚合。 它将子监视器的状态与最差的运行状况状态相匹配：<br> 节点 CPU 利用率<br> 节点内存利用率<br> 节点状态 | 最差|
|节点池 |此监视器报告节点池*代理池*中所有节点的组合运行状况。 这是一个三种状态监视器，其状态基于节点池中 80% 的节点的最坏状态，按节点状态严重性（即严重、警告、正常）的降序排序。|百分比 |
|节点（节点池的父节点） |这是所有节点池的聚合监视器。 其状态基于其子监视器（即群集中存在的节点池）的最坏状态。 |最差 |
|群集（节点的父节点/<br> 库伯内特斯基础设施） |这是将子监视器的状态与最差运行状况状态（即库伯奈斯基础结构和节点）匹配的父监视器。 |最差 |
|库伯内特斯基础设施 |此监视器报告群集的托管基础结构组件的组合运行状况。 其状态计算为"最差"的子监视器状态，即 kube 系统工作负载和 API 服务器状态。 |最差|
|系统工作负载 |此监视器报告库贝系统工作负载的运行状况状态。 此监视器将子监视器的状态与最差的运行状况状态（即**处于就绪状态的 Pods（** 监视器和工作负载中的容器）相匹配。 |最差 |
|容器 |此监视器报告给定工作负载中容器的总体运行状况。 此监视器将子监视器的状态与最差的运行状况状态（即**CPU 利用率**和**内存利用率**监视器）相匹配。 |最差 |

## <a name="next-steps"></a>后续步骤

查看[监视器群集运行状况](container-insights-health.md)，了解查看 Kubernetes 群集的运行状况。
