---
title: 信任如何为 Azure AD 域服务工作 |微软文档
description: 详细了解林信任如何与 Azure AD 域服务一起工作
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 03/30/2020
ms.author: iainfou
ms.openlocfilehash: 903881a1d15c1f043e381f50e5b69d661cd08192
ms.sourcegitcommit: efefce53f1b75e5d90e27d3fd3719e146983a780
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/01/2020
ms.locfileid: "80476438"
---
# <a name="how-trust-relationships-work-for-resource-forests-in-azure-active-directory-domain-services"></a>信任关系如何适用于 Azure 活动目录域服务中的资源林

活动目录域服务 （AD DS） 通过域和林信任关系跨多个域或林提供安全。 在跨信任进行身份验证之前，Windows 必须首先检查用户、计算机或服务请求的域是否与请求帐户的域具有信任关系。

为了检查此信任关系，Windows 安全系统计算接收请求的服务器的域控制器 （DC） 与请求帐户域中的 DC 之间的信任路径。

AD DS 和 Windows 分布式安全模型提供的访问控制机制为域和林信任的操作提供了环境。 要使这些信任正常工作，每个资源或计算机都必须具有到其所在的域中的 DC 的直接信任路径。

信任路径由 Net Logon 服务使用经过身份验证的远程过程调用 （RPC） 连接到受信任的域颁发机构实现。 安全通道还通过域间信任关系扩展到其他 AD DS 域。 此安全通道用于获取和验证安全信息，包括用户和组的安全标识符 （SI）。

## <a name="trust-relationship-flows"></a>信任关系流

通过信托进行安全通信的流动决定了信任的弹性。 如何创建或配置信任确定通信在林内或跨林延伸的范围。

信托的沟通流由信任的方向决定。 信任可以是单向的，也可以是双向的，也可以是传递的，也可以是非传递的。

下图显示*树 1*和*树 2*中的所有域默认情况下都具有传递信任关系。 因此，*树 1*中的用户可以访问*树 2*中的域中的资源，树*1*中的用户可以访问*树 2*中的资源，在资源处分配适当的权限时。

![两个林之间的信任关系图](./media/concepts-forest-trust/trust-relationships.png)

### <a name="one-way-and-two-way-trusts"></a>单向和双向信任

支持访问资源的信任关系可以是单向的，也可以是双向的。

单向信任是在两个域之间创建的单向身份验证路径。 在*域 A*和*域 B*之间的单向信任中，*域 A*中的用户可以访问域*B*中的资源。但是，域*B*中的用户无法访问*域 A*中的资源。

某些单向信任可以是非传递的，也可以是传递的，具体取决于所创建的信任类型。

在双向信任中，域*A*信任*域 B*和*域 B*信任域*A*。此配置意味着身份验证请求可以在两个方向的两个域之间传递。 某些双向关系可以是非传递关系，也可以是传递关系，具体取决于所创建的信任类型。

AD DS 林中的所有域信任都是双向的传递信任。 创建新的子域时，系统将在新的子域和父域之间自动创建双向可传递信任。

### <a name="transitive-and-non-transitive-trusts"></a>过境和非过境信托

传递性决定了信任是否可以扩展到其形成的两个域之外。

* 传递信任可用于扩展与其他域的信任关系。
* 非传递信任可用于拒绝与其他域的信任关系。

每次在林中创建新域时，新域及其父域之间都会自动创建双向传递信任关系。 如果将子域添加到新域中，则信任路径通过域层次结构向上流动，从而扩展在新域及其父域之间创建的初始信任路径。 建立可传递信任关系时，此信任关系将向上流入域树，在域树中所有域之间创建可传递信任。

身份验证请求遵循这些信任路径，因此林中的任何域中的帐户都可以由林中的任何其他域进行身份验证。 通过单一登录过程，具有适当权限的帐户可以访问林中任何域中的资源。

## <a name="forest-trusts"></a>林信任

林信任可帮助您管理分段的 AD DS 基础结构，并支持跨多个林访问资源和其他对象。 林信任对于服务提供商、进行合并或收购的公司、协作业务外联网以及寻求管理自治解决方案的公司非常有用。

使用林信任，可以链接两个不同的林以形成单向或双向传递信任关系。 林信任允许管理员将两个 AD DS 林与单个信任关系连接，从而在整个林中提供无缝的身份验证和授权体验。

林信任只能在一个林中的林根域和另一个林中的林根域之间创建。 林信任只能在两个林之间创建，不能隐式扩展到第三个林。 此行为意味着，如果在*林 1*和*林 2*之间创建了林信任，并且在*林 2*和林*3*之间创建了另一个林信任，*则林 1*对*林 3*没有隐式信任。

下图显示了单个组织中三个 AD DS 林之间的两个单独的林信任关系。

![单个组织内林信任关系图](./media/concepts-forest-trust/forest-trusts.png)

此示例配置提供以下访问：

* 林*2*中的用户可以访问*林 1*或*林 3*中的任何域中的资源
* 林*3*中的用户可以访问*林 2*中的任何域中的资源
* 林*1*中的用户可以访问*林 2*中的任何域中的资源

此配置不允许*林 1*中的用户访问*林 3*中的资源，反之亦然。 为了允许*林 1*和*林 3*中的用户共享资源，必须在两个林之间创建双向传递信任。

如果在两个林之间创建单向林信任，则受信任的林的成员可以利用位于信任林中的资源。 但是，这种信任仅可向一个方向操作。

例如，当单向时，*在林 1（* 受信任的林）和*林 2（* 信任林）之间创建林信任：

* 林*1*的成员可以访问*位于林 2*中的资源。
* 林*2*的成员无法使用相同的信任访问林*1*中的资源。

> [!IMPORTANT]
> Azure AD 域服务资源林仅支持对本地活动目录的单向林信任。

### <a name="forest-trust-requirements"></a>林信任要求

在创建林信任之前，您需要验证是否具备了正确的域名系统 （DNS） 基础结构。 仅当以下 DNS 配置之一可用时，才能创建林信任：

* 单个根 DNS 服务器是两个林 DNS 命名空间的根 DNS 服务器 - 根区域包含每个 DNS 命名空间的委派，所有 DNS 服务器的根提示包括根 DNS 服务器。
* 如果没有共享根 DNS 服务器，并且每个林 DNS 命名空间的根 DNS 服务器使用每个 DNS 命名空间的 DNS 条件转发器来路由其他命名空间中的名称查询。

    > [!IMPORTANT]
    > Azure AD 域服务资源林必须使用此 DNS 配置。 托管资源林 DNS 命名空间以外的 DNS 命名空间不是 Azure AD 域服务的一项功能。 条件转发器是适当的配置。

* 如果没有共享的根 DNS 服务器，并且每个林 DNS 命名空间的根 DNS 服务器使用 DNS 辅助区域在每个 DNS 命名空间中配置，以路由查询其他命名空间中的名称。

要创建林信任，您必须是域管理员组（在林根域中）或活动目录中的企业管理员组的成员。 为每个信任分配了两个林中的管理员必须知道的密码。 两个林中的企业管理员成员可以同时创建两个林中的信任，在这种情况下，将自动生成密码，并同时为两个林写入加密随机的密码。

Azure AD 域服务的出站林信任在 Azure 门户中创建。 您不会手动使用托管域本身创建信任。 传入林信任必须由具有以前在本地活动目录中注明的权限的用户配置。

## <a name="trust-processes-and-interactions"></a>信任流程和交互

许多域间和林间事务依赖于域或林信任来完成各种任务。 本节介绍在跨信任访问资源和评估身份验证引用时发生的过程和交互。

### <a name="overview-of-authentication-referral-processing"></a>身份验证引用处理概述

当身份验证请求被引用到域时，该域中的域控制器必须确定是否存在与来自请求的域存在信任关系。 在验证用户访问域中的资源之前，还必须确定信任的方向以及信任是传递的还是非传递的。 受信任域之间发生的身份验证过程因正在使用的身份验证协议而异。 Kerberos V5 和 NTLM 协议以不同的方式处理对域进行身份验证的引用

### <a name="kerberos-v5-referral-processing"></a>Kerberos V5 转介处理

Kerberos V5 身份验证协议依赖于域控制器上的 Net Logon 服务，用于客户端身份验证和授权信息。 Kerberos 协议连接到联机密钥分发中心 （KDC） 和活动目录帐户存储，用于会话票证。

Kerberos 协议还使用信任进行跨域票证授予服务 （TGS）和跨安全通道验证特权属性证书 （PAC）。 Kerberos 协议仅对非 Windows 品牌操作系统 Kerberos 领域（如 MIT Kerberos 领域）执行跨域身份验证，无需与 Net Logon 服务进行交互。

如果客户端使用 Kerberos V5 进行身份验证，它将从其帐户域中的域控制器向目标域中的服务器请求票证。 Kerberos KDC 充当客户端和服务器之间的可信中介，并提供会话密钥，使双方能够相互进行身份验证。 如果目标域与当前域不同，KDC 将遵循一个逻辑过程来确定是否可以引用身份验证请求：

1. 当前域是否直接受请求服务器域信任？
    * 如果是，请向客户端发送对请求域的引用。
    * 如果没有，则转到下一步。

2. 当前域与信任路径上的下一个域之间是否存在传递信任关系？
    * 如果是，则将引用发送到信任路径上的下一个域。
    * 如果没有，请向客户端发送拒绝登录的消息。

### <a name="ntlm-referral-processing"></a>NTLM 转介处理

NTLM 身份验证协议依赖于域控制器上的 Net Logon 服务，用于客户端身份验证和授权信息。 此协议对不使用 Kerberos 身份验证的客户端进行身份验证。 NTLM 使用信任在域之间传递身份验证请求。

如果客户端使用 NTLM 进行身份验证，则初始身份验证请求直接从客户端转到目标域中的资源服务器。 此服务器会创建客户端响应的挑战。 然后，服务器将用户的响应发送到其计算机帐户域中的域控制器。 此域控制器根据其安全帐户数据库检查用户帐户。

如果数据库中不存在该帐户，域控制器将确定是使用以下逻辑执行直通身份验证、转发请求还是拒绝请求：

1. 当前域是否与用户的域有直接的信任关系？
    * 如果是，域控制器会将客户端的凭据发送到用户域中的域控制器进行传递身份验证。
    * 如果没有，则转到下一步。

2. 当前域是否与用户的域具有传递信任关系？
    * 如果是，将身份验证请求传递到信任路径中的下一个域。 此域控制器通过检查用户对自己的安全帐户数据库的凭据来重复此过程。
    * 如果没有，请向客户端发送拒绝登录的消息。

### <a name="kerberos-based-processing-of-authentication-requests-over-forest-trusts"></a>基于 Kerberos 的通过林信任处理身份验证请求

当两个林由林信任连接时，使用 Kerberos V5 或 NTLM 协议进行的身份验证请求可以在林之间路由，以提供对两个林中的资源的访问。

首次建立林信任时，每个林都会收集其伙伴林中的所有受信任命名空间，并将信息存储在[受信任的域对象](#trusted-domain-object)中。 受信任的命名空间包括域树名、用户主体名称 （UPN） 后缀、服务主体名称 （SPN） 后缀以及其他林中使用的安全 ID （SID） 命名空间。 TDO 对象将复制到全局目录。

在身份验证协议可以遵循林信任路径之前，必须将资源计算机的服务主体名称 （SPN） 解析为其他林中的位置。 SPN 可以是以下原因之一：

* 主机的 DNS 名称。
* 域的 DNS 名称。
* 服务连接点对象的可分辨名称。

当一个林中的工作站尝试访问另一个林中的资源计算机上的数据时，Kerberos 身份验证过程会与域控制器联系，获取服务票证到资源计算机的 SPN。 一旦域控制器查询全局目录并确定 SPN 与域控制器不在相同的林中，域控制器就会将其父域的引用发送回工作站。 此时，工作站会查询服务票证的父域，并继续遵循引用链，直到到达资源所在的域。

以下关系图和步骤详细介绍了运行 Windows 的计算机尝试从位于另一个林中的计算机访问资源时使用的 Kerberos 身份验证过程。

![林信任上的 Kerberos 过程图](media/concepts-forest-trust/kerberos-over-forest-trust-process.png)

1. *用户 1*使用*europe.tailspintoys.com*域中的凭据登录到*工作站1。* 然后，用户尝试访问位于*usa.wingtiptoys.com*林的*FileServer1*上的共享资源。

2. *工作站1*在其域*ChildDC1*的域控制器上与 Kerberos KDC 联系，并请求*FileServer1* SPN 的服务票证。

3. *子DC1*在其域数据库中找不到 SPN，并查询全局编录以查看*tailspintoys.com*林中是否有任何域包含此 SPN。 由于全局目录仅限于其自己的林，因此找不到 SPN。

    然后，全局编录检查其数据库，以获取有关与其林建立的任何林信任的信息。 如果找到，它将林信任受信任域对象 （TDO） 中列出的名称后缀与目标 SPN 的后缀进行比较，以查找匹配项。 找到匹配项后，全局编录将提供回*子DC1*的路由提示。

    路由提示有助于将身份验证请求定向到目标林。 仅当所有传统身份验证通道（如本地域控制器和全局目录）都找不到 SPN 时，才会使用提示。

4. *子DC1*将其父域的引用发送回*工作站1*。

5. *工作站1*与*ForestRootDC1（* 其父域）中的域控制器联系，以将其引用到*wingtiptoys.com*林林根域中的域控制器 *（ForestRootDC2）。*

6. *工作站1*在*wingtiptoys.com*林中联系*ForestRootDC2，* 以获得请求的服务票证。

7. *ForestRootDC2*与其全局目录联系以查找 SPN，全局目录查找 SPN 的匹配项并将其发送回*ForestRootDC2*。

8. *然后，ForestRootDC2*将推荐发送到*usa.wingtiptoys.com*回*工作站1。*

9. *工作站1*与*ChildDC2*上的 KDC 联系，并协商*用户 1*的票证以访问*FileServer1*。

10. *一旦工作站1*有服务票证，它将服务票证发送到*FileServer1，* 该文件服务器读取*User1*的安全凭据并相应地构造访问令牌。

## <a name="trusted-domain-object"></a>受信任的域对象

组织中的每个域或林信任都由存储在其域中的*系统*容器中的受信任域对象 （TDO） 表示。

### <a name="tdo-contents"></a>TDO 内容

TDO 中包含的信息因是由域信任还是林信任创建的 TDO 而异。

创建域信任时，TDO 中会表示 DNS 域名、域 SID、信任类型、信任传递性和互惠域名等属性。 林信任 TDO 存储其他属性，以标识合作伙伴林中的所有受信任的命名空间。 这些属性包括域树名、用户主体名称 （UPN） 后缀、服务主体名称 （SPN） 后缀和安全 ID （SID） 命名空间。

由于信任作为 TDO 存储在活动目录中，因此林中的所有域都了解整个林中已存在的信任关系。 同样，当两个或多个林通过林信任联接在一起时，每个林中的林根域都了解信任关系，这些关系在受信任的林中的所有域中都存在。

### <a name="tdo-password-changes"></a>TDO 密码更改

信任关系中的两个域共享一个密码，该密码存储在活动目录中的 TDO 对象中。 作为帐户维护过程的一部分，信任域控制器每 30 天更改存储在 TDO 中的密码。 由于所有双向信任实际上是两个双向信任，因此双向信任的过程会发生两次。

信任具有信任和可信任的一面。 在受信任的方面，任何可写域控制器都可用于该过程。 在信任端，PDC 仿真器执行密码更改。

要更改密码，域控制器完成以下过程：

1. 信任域中的主域控制器 （PDC） 仿真程序创建新密码。 受信任域中的域控制器永远不会启动密码更改。 它总是由信任域 PDC 仿真器启动。

2. 信任域中的 PDC 仿真器将 TDO 对象的*旧密码*字段设置为当前 *"新密码"* 字段。

3. 信任域中的 PDC 仿真器将 TDO 对象的 *"新密码"* 字段设置为新密码。 如果受信任域中的域控制器无法接收更改，或者在发出使用新信任密码的请求之前未复制更改，则保留以前密码的副本可以还原到旧密码。

4. 信任域中的 PDC 仿真程序对受信任域中的域控制器进行远程调用，要求其将信任帐户上的密码设置为新密码。

5. 受信任域中的域控制器将信任密码更改为新密码。

6. 在信任的每一侧，更新将复制到域中的其他域控制器。 在信任域中，更改触发受信任域对象的紧急复制。

现在，两个域控制器上的密码都已更改。 正常复制将 TDO 对象分发到域中的其他域控制器。 但是，信任域中的域控制器可以在不成功更新受信任域中的域控制器的情况下更改密码。 由于无法建立处理密码更改所需的安全通道，可能会发生此情况。 受信任域中的域控制器也可能在此过程中的某个时间点不可用，并且可能无法接收更新的密码。

为了处理密码更改未成功传达的情况，信任域中的域控制器永远不会更改新密码，除非它已使用新密码成功进行身份验证（设置安全通道）。 此行为是新旧密码都保存在信任域的 TDO 对象中的原因。

在使用密码的身份验证成功之前，密码更改不会完成。 旧的存储密码可以在安全通道上使用，直到受信任域中的域控制器收到新密码，从而实现不间断的服务。

如果使用新密码的身份验证失败，因为密码无效，则信任域控制器会尝试使用旧密码进行身份验证。 如果使用旧密码成功进行身份验证，它将在 15 分钟内恢复密码更改过程。

信任密码更新需要在 30 天内复制到信任双方的域控制器。 如果信任密码在 30 天后更改，并且域控制器只有 N-2 密码，则它不能使用信任端的信任，也不能在受信任的端创建安全通道。

## <a name="network-ports-used-by-trusts"></a>信托使用的网络端口

由于信任必须跨各种网络边界部署，因此它们可能必须跨越一个或多个防火墙。 在这种情况下，您可以跨防火墙隧道信任流量，也可以打开防火墙中的特定端口，以允许流量通过。

> [!IMPORTANT]
> 活动目录域服务不支持将活动目录 RPC 流量限制为特定端口。

阅读 Microsoft 支持文章的**Windows Server 2008 和更高版本**部分[，如何为 Active Directory 域和信任配置防火墙](https://support.microsoft.com/help/179442/how-to-configure-a-firewall-for-domains-and-trusts)，以了解林信任所需的端口。

## <a name="supporting-services-and-tools"></a>支持服务和工具

为了支持信任和身份验证，使用了一些附加功能和管理工具。

### <a name="net-logon"></a>Net Logon

Net 登录服务维护从基于 Windows 的计算机到 DC 的安全通道。 它还用于以下信任相关流程：

* 信任设置和管理 - Net Logon 通过与 LSA 流程和 TDO 交互，帮助维护信任密码、收集信任信息并验证信任。

    对于林信任，信任信息包括林信任信息 （*FTInfo*） 记录，其中包括受信任林声明要管理的命名空间集，用指示每个声明是否受信任林信任的字段进行批带。

* 身份验证 – 通过安全通道向域控制器提供用户凭据，并为用户返回域 SI 和用户权限。

* 域控制器位置 – 有助于查找或定位域或域中的域控制器。

* 直通验证 – 其他域中的用户的凭据由 Net Logon 处理。 当信任域需要验证用户的标识时，它会通过 Net Logon 将用户的凭据传递到受信任的域进行验证。

* 特权属性证书 （PAC） 验证 - 当使用 Kerberos 协议进行身份验证的服务器需要在服务票证中验证 PAC 时，它将通过安全通道将 PAC 发送到其域控制器进行验证。

### <a name="local-security-authority"></a>本地安全机构

本地安全机构 （LSA） 是一个受保护的子系统，用于维护有关系统上本地安全的所有方面的信息。 LSA 统称为本地安全策略，提供各种服务，用于在名称和标识符之间进行转换。

LSA 安全子系统在内核模式和用户模式下提供服务，以验证对对象的访问、检查用户权限和生成审核消息。 LSA 负责检查受信任或不受信任的域中的服务提供的所有会话票证的有效性。

### <a name="management-tools"></a>管理工具

管理员可以使用*活动目录域和信任**、Netdom*和*Nltest*公开、创建、删除或修改信任。

* *活动目录域和信托*是 Microsoft 管理控制台 （MMC），用于管理域信任、域和林功能级别以及用户主体名称后缀。
* *Netdom*和*Nltest*命令行工具可用于查找、显示、创建和管理信任。 这些工具直接与域控制器上的 LSA 权限通信。

## <a name="next-steps"></a>后续步骤

要了解有关资源林的更多信息，请参阅[林信任如何在 Azure AD DS 中工作？][concepts-trust]

要开始使用资源林创建 Azure AD DS 托管域，请参阅[创建和配置 Azure AD DS 托管域][tutorial-create-advanced]。 然后，您可以[创建到本地域的出站林信任（预览）。][create-forest-trust]

<!-- LINKS - INTERNAL -->
[concepts-trust]: concepts-forest-trust.md
[tutorial-create-advanced]: tutorial-create-instance-advanced.md
[create-forest-trust]: tutorial-create-forest-trust.md
