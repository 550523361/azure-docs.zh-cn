<properties
   pageTitle="自动缩放指南 | Azure"
   description="有关如何自动缩放以动态分配应用程序所需的资源的指南。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="christb"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.date="07/13/2016"
   wacn.date=""/>

# 自动缩放指南

[AZURE.INCLUDE [pnp-header](../includes/guidance-pnp-header-include.md)]

## 概述
自动缩放是动态分配应用程序所需的资源，以符合性能要求，满足服务级别协议 (SLA)，同时将运行时成本降到最低的过程。当工作量增大时，应用程序可能需要额外的资源才能及时执行其任务。当需求降低时，可以取消分配资源，使成本降到最低，同时保持适当的性能并符合 SLA。
自动缩放可以利用云托管环境的弹性，同时可以降低管理开销。为实现此目的，它可以减少操作员持续监视系统性能的需要，并做出有关添加或删除资源的决策。
>[AZURE.NOTE] 自动缩放将应用到应用程序使用的所有资源，而不只是计算资源。例如，如果系统使用消息队列来发送和接收信息，则可以在缩放时创建更多队列。

## 缩放类型
缩放通常采用以下两种形式之一：

- **垂直缩放**（通常称为_向上和向下缩放_）。这种缩放形式需要修改硬件（扩展或缩小硬件的容量和性能），或使用具有适当容量和性能的替代硬件来重新部署解决方案。在云环境中，硬件平台通常是虚拟环境。除非原始硬件已大幅超出设置，否则随着因应性前期资本支出，这种环境中的垂直向上缩放将涉及到设置功能更强大的资源，然后将系统转移到这些新资源。垂直缩放通常是破坏性的过程，会在重新部署时使系统暂时不可用。在设置新硬件并将其联机时，也许可以将原始系统保持运行，但在将旧环境的处理转换到新系统时，仍有可能会导致某种形式的中断。使用自动缩放来实施垂直缩放策略并不常见。
- **水平缩放**（通常称为_向外和向内缩放_）。这种形式需要在更多或更少的资源上部署解决方案，这些资源通常是商用资源，而不是高能系统。在设置这些资源时，解决方案可以继续运行而不中断。设置过程完成后，可将构成方案的元素副本部署到这些附加的资源上并提供使用。如果需求降低，则在使用附加资源的元素完全关闭后，可以回收这些资源。许多基于云的系统（包括 Microsoft Azure）支持这种缩放形式的自动化。

## 实施自动缩放策略
实施自动缩放策略通常涉及到以下组件和过程：

- 位于应用程序、服务和基础结构级别的检测和监视系统。这些系统可捕获响应时间、队列长度、CPU 利用率和内存使用量等关键指标。
- 决策逻辑，可以根据预定义的系统阈值或计划来评估受监视的缩放系数，并做出有关是否要缩放的决策。
- 负责执行与缩放系统（例如设置或取消设置资源）相关任务的组件。
- 测试、监视和优化自动缩放策略，以确保它按预期工作。

大多数基于云的环境（例如 Azure）提供用于处理常见方案的内置自动缩放机制。如果使用的环境或服务不提供所需的自动缩放功能，或者有超出其功能范围的极端自动缩放要求，则可能需要使用自定义实现。使用此自定义实现可以收集操作和系统指标、分析这些指标以识别相关数据，然后相应地缩放资源。


## 配置 Azure 解决方案的自动缩放
可以使用多个选项为 Azure 解决方案配置自动缩放：

- **Azure 自动缩放**支持基于计划的最常见缩放方案，并可以选择性地支持基于运行时指标（例如处理器利用率、队列长度，或内置和自定义的计数器）触发的缩放操作。你可以使用 Azure 门户快速轻松地配置解决方案的简单自动缩放策略。若要进行更精细的控制，可以使用 [Azure 服务管理 REST API](https://msdn.microsoft.com/library/azure/ee460799.aspx) 或 [Azure Resource Manager REST API](https://msdn.microsoft.com//library/azure/dn790568.aspx)。[Azure 监视服务管理库](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring)和 [Microsoft Insights 库](https://www.nuget.org/packages/Microsoft.Azure.Insights/)（预览版）是可让用户从不同的资源收集指标以及利用 REST API 执行自动缩放的 SDK。对于不支持 Azure Resource Manager 的资源，或者当你使用 Azure 云服务时，可以使用服务管理 REST API 进行自动缩放。在其他所有情况下，请使用 Azure Resource Manager。
- 基于对应用程序的检测和 Azure 管理功能的**自定义解决方案**可能很有用。例如，你可以将 Azure 诊断或应用程序中的其他检测方法与自定义代码配合使用，以持续监视和导出应用程序的指标。你可以让处理这些指标的自定义规则使用服务管理或 Resource Manager REST API 来触发自动缩放。用于触发缩放操作的度量值可以是任何内置或自定义的计数器，或者是在应用程序中实施的其他检测。但是，自定义解决方案并不容易实施，只应在前述方法都无法满足要求时才加以考虑。[自动缩放应用程序块](http://msdn.microsoft.com/library/hh680892%28v=pandp.50%29.aspx)利用了这种方法。
- **第三方服务**（例如 [Paraleap AzureWatch](http://www.paraleap.com/AzureWatch)）可让用户根据计划、服务负载和系统性能指标、自定义规则以及不同规则类型的组合来缩放解决方案。

选择要采用哪种自动缩放解决方案时，请注意以下几点：

- 如果平台的内置自动缩放功能可以符合要求，就使用此内置功能。否则，请仔细考虑是否真正需要更复杂的缩放功能。其他要求的示例包括更高粒度的控制、检测缩放触发事件的其他方式、跨订阅缩放和缩放其他类型的资源。
- 考虑是否可以足够精确地预测应用程序负载，以便只依赖于计划的自动缩放（添加和删除实例以满足需求的预期高峰）。如果不可行，则根据在运行时收集的指标使用被动自动缩放，使应用程序能够处理无法预测的需求变化。通常情况下，你可以组合使用这些方法。例如，如果你知道应用程序何时最繁忙，则可以创建一个策略，以根据计划添加计算、存储和队列等资源。这有助于确保容量在需要时可供使用，并且不会在启动新实例时遇到延迟。此外，对于每个计划的规则，请定义在该期间允许被动自动缩放的度量值，以确保应用程序能够处理持续但无法预测的需求高峰。
- 通常很难了解指标与容量要求之间的关系，尤其是在最初部署应用程序后。建议在一开始多设置一些附加容量，然后监视并调整自动缩放规则，使容量更接近实际负载的需要。

### 使用 Azure 自动缩放
自动缩放可让你配置解决方案的向外缩放和向内缩放选项。自动缩放可以在 Azure App Service 中自动添加和删除 Azure 云服务 Web 角色和辅助角色、Azure 移动服务和 Web Apps 功能的实例。它还可以通过启动和停止 Azure 虚拟机的实例来启用自动缩放。Azure 自动缩放策略包括两组因素：

- 基于计划的自动缩放，可确保提供附加实例来满足预期高峰使用量，并可在高峰时间过后向内缩放。这可以让你确保拥有足够的运行中实例，而无需等待系统向负载做出反应。
- 基于指标的自动缩放，对最后一个小时的平均 CPU 利用率或 Azure 存储空间或 Azure 服务总线队列中解决方案正在处理的消息待处理项等因素做出反应。这样，应用程序便可以独立于计划的自动缩放规则，适应计划外或无法预见的需求变化。

使用自动缩放时，请注意以下几点：

- 自动缩放策略结合了计划的缩放和基于度量值的缩放。你可以为服务指定两种规则。
- 你应该配置自动缩放规则，然后监视应用程序在一段时间内的性能。如果需要，请使用这种监视的结果来调整系统的缩放方式。但请记住，自动缩放不是即时起效的过程。它需要时间来对指标（例如平均 CPU 利用率超过或低于指定的阈值）做出反应。
- 使用基于测得触发器属性（例如 CPU 使用量或队列长度）的检测机制的自动缩放规则使用一段时间内的聚合值而不是即时值来触发自动缩放操作。默认情况下，聚合是值的平均值。这可以防止系统反应太快，或导致快速震荡。这还可以使自动启动的新实例顺利进入运行模式，避免当新实例正在启动时，又发生其他自动缩放操作。对于 Azure 云服务和 Azure 虚拟机，聚合的默认期限为 45 分钟，指标需要经过这段时间后才为了响应需求高峰而触发自动缩放。可以使用 SDK 更改聚合期限，但请注意，低于 25 分钟可能导致不可预测的结果（有关详细信息，请参阅 [Auto Scaling Cloud Services on CPU Percentage with the Azure Monitoring Services Management Library](http://rickrainey.com/2013/12/15/auto-scaling-cloud-services-on-cpu-percentage-with-the-windows-azure-monitoring-services-management-library/)（使用 Azure 监视服务管理库根据 CPU 百分比自动缩放云服务））。对于 Web Apps，平均期限要短得多，这样便可以在平均触发测量值更改约五分钟后提供新实例。
- 如果使用 SDK 而不是 Web 门户配置自动缩放，则可以指定更详细的计划，在执行该计划期间，规则将处于活动状态。你还可以创建自己的度量值，并将其与自动缩放规则中的现有度量值一起使用，或单独使用。例如，你可能希望使用替代计数器（例如每秒请求数或平均内存可用性）或使用自定义计数器来计算特定的业务进程。
- 自动缩放 Azure 虚拟机时，必须部署相当于允许自动缩放启动的最大数的虚拟机实例数。这些实例必须属于同一个可用性集。虚拟机自动缩放机制不会创建或删除虚拟机的实例；而你配置的自动缩放规则将启动和停止相应数目的实例。有关详细信息，请参阅[自动缩放运行 Web 角色、辅助角色或虚拟机的应用程序](./cloud-services/cloud-services-how-to-scale.md)。
- 如果无法启动新的实例，则原因可能是已达到订阅的最大值，或者在启动期间发生错误，而门户可能显示自动缩放操作成功。但是，门户中显示的后续 **ChangeDeploymentConfiguration** 事件只显示已请求服务启动，而不会有任何事件指示是否已成功完成。
- 可以使用 Web 门户 UI 将 SQL 数据库实例和队列等资源链接到计算服务实例。这样，你便可以更轻松地访问每个链接资源的各个手动和自动缩放配置选项。有关详细信息，请参阅 [How to: Link a resource to a cloud service](cloud-services-how-to-manage.md#linkresources)（如何：将资源链接到云服务）和 [How to Scale an Application](./cloud-services/cloud-services-how-to-scale.md)（如何缩放应用程序）。
- 当你配置多个策略和规则时，它们可能相互冲突。自动缩放使用以下冲突解决规则来确保始终有足量的运行中实例：
  - 向外缩放操作始终优先于向内缩放操作。
  - 当向外缩放操作发生冲突时，使实例数增幅最大的规则优先。
  - 当向内缩放操作发生冲突时，使实例数降幅最小的规则优先。

<a name="the-azure-monitoring-services-management-library"></a>

## 应用程序设计注意事项：如何实施自动缩放
自动缩放不是即时见效的解决方案。只是将资源添加到系统或运行进程的更多实例并不能保证提高系统性能。设计自动缩放策略时，请注意以下几点：

- 系统必须设计为可以水平缩放。不要在实例相关性方面做出假设；不要设计需要代码始终在特定的进程实例中运行的解决方案。水平缩放云服务或网站时，不要假设一系列来自同一源的请求始终路由到同一实例。出于相同原因，请将服务设计为无状态，以避免需要将一系列来自应用程序的请求始终路由到同一服务实例。在设计从队列读取并处理消息的服务时，不要假设哪个服务实例处理哪个特定消息。自动缩放可能会在队列长度增大时启动其他服务实例。[Competing Consumers Pattern](http://msdn.microsoft.com/library/dn568101.aspx)（使用者竞争模式）说明了如何解决这种情况。
- 如果解决方案实施长时间运行的任务，请将此任务设计为同时支持向外和向内缩放。如果不保持应有的谨慎，这种任务在系统向内缩放时会阻止进程实例完全关闭；如果进程被强行终止，则可能会丢失数据。理想的情况是，重构长时间运行的任务并分解处理，使其以较小且不连续的块执行。[Pipes and Filters Pattern](http://msdn.microsoft.com/library/dn568100.aspx)（管道和筛选器模式）提供了有关如何实现此目的的示例。
- 或者，你可以实施检查点机制，用于定期记录任务的状态信息，并将此状态保存在运行任务的任何进程实例可以访问的持久性存储中。这样，如果进程关闭，它所执行的工作可以使用另一个实例，从最后一个检查点继续进行。
- 当后台任务在独立的计算实例（例如云服务托管应用程序的辅助角色）上运行时，可能需要使用不同的缩放策略来缩放应用程序的不同部分。例如，你可能需要部署其他用户界面 (UI) 计算实例而不增加后台计算实例数，或是相反。如果你提供不同级别的服务（例如基本和高级服务包），可能需要使用比基本服务包更主动的高级服务包的计算资源才能符合 SLA。
- 考虑使用 UI 和后台计算实例通信的队列长度作为自动缩放策略的条件。这可以最好地反映当前负载与后台任务处理容量之间的不平衡或差异。
- 如果自动缩放策略基于度量业务进程（例如每小时订单数或复杂事务的平均执行时间）的计数器，请确保完全了解这些计数器类型的结果与实际计算容量要求之间的关系。可能需要缩放多个组件或计算单位来应对业务进程计数器的变化。
- 若要防止系统过度地向外缩放并避免由于运行数千个实例而产生的关联成本，请考虑限制可以自动添加的实例数上限。大多数自动缩放机制允许你指定规则的实例数上限和下限。此外，如果部署的实例数已达到上限而系统仍然过载，请考虑适当地降低系统提供的功能。
- 请记住，自动缩放可能不是处理工作负荷中突发高峰的最适当机制。设置并启动新服务实例或将资源添加到系统都需要花费时间，而当这些附加资源可供使用时，高峰需求可能已成为过去。在这种情况下，限制服务可能更适合。有关详细信息，请参阅 [Throttling Pattern](http://msdn.microsoft.com/library/dn589798.aspx)（限制模式）。
- 相比之下，如果你希望在事务量快速波动时有足够的容量处理所有请求，并且成本不是主要考虑因素，那么，请考虑使用激进的自动缩放策略来更快速地启动附加实例。你还可以使用计划的策略在最大负载来临前预先启动足量的实例。
- 自动缩放机制应该监视自动缩放过程，并记录每个自动缩放事件的详细信息（触发的事件、添加或删除了哪些资源，以及时间）。在创建自定义自动缩放机制时，请确保它包含此功能。分析信息以帮助度量自动缩放策略的有效性，并根据需要进行优化。在短时间内使用模式变得明显，以及长期业务拓展或对应用程序的要求变化时，可以进行优化。如果应用程序达到定义的自动缩放上限，机制可以提醒操作人员，让操作人员手动启动其他资源（如果必要）。请注意，在这种情况下，操作人员可能还要负责在工作负荷减轻后手动删除这些资源。

## 相关模式和指南
实施自动缩放时，以下模式和指南也可能与你的方案相关：

- [限制模式](http://msdn.microsoft.com/zh-cn/library/dn589798.aspx)。此模式描述当需求增大而对资源产生极大负载时，应用程序如何继续工作并满足 SLA。限制可与自动缩放配合使用，以避免系统向外缩放时失控。
- [使用者竞争模式](http://msdn.microsoft.com/zh-cn/library/dn568101.aspx)。此模式描述如何实施服务实例池，以便处理来自任何应用程序实例的消息。自动缩放可用于启动和停止服务实例，以符合预期的工作负荷。此模式可让系统同时处理多个消息，以优化吞吐量、提高可缩放性和可用性，以及平衡工作负荷。
- [检测和遥测指南](http://msdn.microsoft.com/zh-cn/library/dn589775.aspx)。检测和遥测在收集信息以促成自动缩放过程方面至关重要。

## 详细信息
- [如何缩放应用程序](/documentation/articles/cloud-services-how-to-scale/)
- [自动缩放运行 Web 角色、辅助角色或虚拟机的应用程序](/documentation/articles/cloud-services-how-to-manage/#linkresources)
- [如何：将资源链接到云服务](/documentation/articles/cloud-services-how-to-manage/#linkresources)
- [缩放链接的资源](/documentation/articles/cloud-services-how-to-scale/#scalelink)
- [Azure 监视服务管理库](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring)
- [Azure 服务管理 REST API](http://msdn.microsoft.com/zh-cn/library/azure/ee460799.aspx)
- [Azure 资源管理器 REST API](https://msdn.microsoft.com/zh-cn/library/azure/dn790568.aspx)
- [Microsoft Insights 库](https://www.nuget.org/packages/Microsoft.Azure.Insights/)
- [自动缩放的相关操作](http://msdn.microsoft.com/zh-cn/library/azure/dn510374.aspx)
- [Microsoft.WindowsAzure.Management.Monitoring.Autoscale 命名空间](http://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.management.monitoring.autoscale.aspx)

<!---HONumber=Mooncake_0919_2016-->