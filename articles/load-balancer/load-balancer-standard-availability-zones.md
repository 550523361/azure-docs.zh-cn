---
title: Azure 标准负载均衡器和可用性区域 | Microsoft Docs
description: 标准负载均衡器和可用性区域
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/08/2018
ms.author: kumud
ms.openlocfilehash: 1f34a9319b8bbfba3f4a6f7446f949fc576aa4fa
ms.sourcegitcommit: 0bb8db9fe3369ee90f4a5973a69c26bff43eae00
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/08/2018
ms.locfileid: "48869051"
---
# <a name="standard-load-balancer-and-availability-zones"></a>标准负载均衡器和可用性区域

Azure 负载均衡器的标准 SKU 支持[可用性区域](../availability-zones/az-overview.md)场景。 标准负载均衡器使用多种新的概念，可让资源适应区域并在区域之间分配资源，从而在端到端场景中优化可用性。  请查看[可用性区域](../availability-zones/az-overview.md)来了解可用性区域的定义、目前哪些区域支持可用性区域，以及其他相关的概念和产品。 可用性区域与标准负载均衡器的结合是一个可扩展的灵活功能集，可以创建多种不同的场景。  请查看本文档了解这些[概念](#concepts)和基本场景的[设计指南](#design)。

>[!NOTE]
>有关其他相关主题，请查看[可用性区域](https://aka.ms/availabilityzones)。 

## <a name="concepts"></a> 适用于负载均衡器的可用性区域概念

负载均衡器资源与实际基础结构之间不存在直接的关系，创建负载均衡器不会创建实例。 负载均衡器资源是一些对象，可在其中表述 Azure 应如何设定其预建的多租户基础结构，以实现想要创建的场景。  这一点在可用性区域的上下文中非常重要，因为单个负载均衡器资源可以控制多个可用性区域中基础结构的编程，同时，从客户角度看，区域冗余的服务显示为一个资源。

负载均衡器资源的功能表示为前端、规则、运行状况探测和后端池定义。

在可用性区域的上下文中，负载均衡器资源的行为和属性描述为区域冗余或局域性。  区域冗余和局域性描述属性的局域性。  在负载均衡器的上下文中，区域冗余始终表示所有区域，局域性表示保证服务位于单个区域。

公共负载均衡器和内部负载均衡器都支持区域冗余和局域性场景，并且两者都可根据需要跨区域定向流量（跨区域负载均衡）。

负载均衡器资源本身是区域性的，而永远不会是局域性的。  另外，VNet 和子网始终区域性的，而永远不会是局域性的。

### <a name="frontend"></a>前端

负载均衡器前端是引用虚拟网络资源子网中的公共 IP 地址资源或专用 IP 地址的前端 IP 配置。  它构成了公开服务的负载均衡终结点。

负载均衡器资源可以同时包含局域性和区域冗余的前端。 

如果保证某个公共 IP 资源属于某个区域，则局域性（或缺少局域性）是不可变的。  若要更改或省略公共 IP 前端的局域性，则需要在相应的区域中重新创建公共 IP。  

可以通过删除并重新创建前端、更改或省略局域性，来更改内部负载均衡器的前端局域性。

如果使用多个前端，请查看[负载均衡器的多个前端](load-balancer-multivip-overview.md)了解重要注意事项。

#### <a name="zone-redundant-by-default"></a>默认的区域冗余

在包含可用性区域的区域中，标准负载均衡器前端默认是区域冗余的。  单个前端 IP 地址在发生区域性故障时可以幸存，并且可用于访问后端池成员，不管这些成员位于哪个区域。 这并不意味着数据路径无法访问，任何重试或重新建立都会成功。 不需要 DNS 冗余方案。 前端的单个 IP 地址由多个可用性区域中多个独立的基础结构部署同时提供。  区域冗余意味着所有入站或出站流由某个区域中多个可用性区域使用单个 IP 地址同时提供。

一个或多个可用性区域可能会发生故障，而数据路径可以幸存，但前提是该区域中有一个局部区域保持正常。 区域冗余配置是默认配置，不需要额外的操作。  当某个区域能够支持可用性区域时，现有的前端会自动变成区域冗余。

使用以下脚本为内部标准负载均衡器创建区域冗余的公共 IP 地址。 如果在配置中使用现有的资源管理器模板，请将 sku 部分添加到这些模板中。

```json
            "apiVersion": "2017-08-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "public_ip_standard",
            "location": "region",
            "sku":
            {
                "name": "Standard"
            },
```

使用以下脚本为内部标准负载均衡器创建区域冗余的前端 IP 地址。 如果在配置中使用现有的资源管理器模板，请将 sku 部分添加到这些模板中。

```json
            "apiVersion": "2017-08-01",
            "type": "Microsoft.Network/loadBalancers",
            "name": "load_balancer_standard",
            "location": "[resourceGroup().location]",
            "sku":
            {
                "name": "Standard"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "zone_redundant_frontend",
                        "properties": {
                            "subnet": {
                                "Id": "[variables('subnetRef')]"
                            },
                            "privateIPAddress": "10.0.0.6",
                            "privateIPAllocationMethod": "Static"
                        }
                    },
                ],
```

#### <a name="optional-zone-guarantee"></a>可选的区域保证

可以选择将某个前端指定为保证位于单个区域，这称为局域性前端。  这意味着，任何入站或出站流将由某个区域中的单个局部区域提供。  前端的运行状态取决于该局部区域。  区域（保证前端所在的区域除外）中发生故障不会影响数据路径。 可以使用局域性前端来按可用性区域公开 IP 地址。  此外，可以直接使用局域性前端；如果前端由公共 IP 地址构成，可将其集成到[流量管理器](../traffic-manager/traffic-manager-overview.md)等 DNS 负载均衡产品并使用单个 DNS 名称，客户端会将该名称解析为多个局域性 IP 地址。  还可以使用此前端来按区域负载均衡终结点公开 IP 地址，以单独监视每个区域。  如果想要混合使用这些概念（对同一个后端使用区域冗余和局域性配置），请查看 [Azure 负载均衡器的多个前端](load-balancer-multivip-overview.md)。

对于公共负载均衡器前端，需将 *zones* 参数添加到前端 IP 配置引用的公共 IP。  

对于内部负载均衡器前端，需将 *zones* 参数添加到内部负载均衡器前端 IP 配置。 局域性前端能使负载均衡器保证某个子网中的 IP 地址位于特定的区域。

使用以下脚本在可用性区域 1 中创建局域性标准公共 IP 地址。 如果在配置中使用现有的资源管理器模板，请将 sku 部分添加到这些模板中。

```json
            "apiVersion": "2017-08-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "public_ip_standard",
            "location": "[resourceGroup().location]",
            "zones": [ "1" ],
            "sku":
            {
                "name": "Standard"
            },
```

使用以下脚本在可用性区域 1 中创建内部标准负载均衡器前端。

如果在配置中使用现有的资源管理器模板，请将 sku 部分添加到这些模板中。 此外，在子资源的前端 IP 配置中定义 **zones** 属性。

```json
            "apiVersion": "2017-08-01",
            "type": "Microsoft.Network/loadBalancers",
            "name": "load_balancer_standard",
            "location": "region",
            "sku":
            {
                "name": "Standard"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "zonal_frontend_in_az1",
                        "zones": [ "1" ],
                        "properties": {
                            "subnet": {
                                "Id": "[variables('subnetRef')]"
                            },
                            "privateIPAddress": "10.0.0.6",
                            "privateIPAllocationMethod": "Static"
                        }
                    },
                ],
```

### <a name="cross-zone-load-balancing"></a>跨区域负载均衡

跨区域负载均衡是指负载均衡器能够访问任何区域中的后端终结点，并且独立于前端及其局域性。

如果想要符合单个区域的要求并保证部署位于该区域，可将局域性前端和局域性后端资源调整到同一区域。 无需进一步执行操作。

### <a name="backend"></a>后端

负载均衡器使用虚拟机。  单个 VNet 中的任何 VM 可以是后端池的一部分，不管该 VM 是否已保证位于某个区域，或者保证所在的区域是什么。

如果想要符合单个区域的要求并保证前端和后端位于该区域，只需将同一区域中的 VM 放入相应的后端池中。

如果想要对跨多个区域的 VM 寻址，只需将多个区域中的 VM 放入同一后端池。  使用虚拟机规模集时，可将一个或多个虚拟机规模集放入同一后端池。  其中的每个虚拟机规模集可以位于一个或多个区域。

### <a name="outbound-connections"></a>出站连接

[出站连接](load-balancer-outbound-connections.md)由所有区域提供，将某个虚拟机关联到公共负载均衡器和区域冗余的前端时，在包含可用性区域的区域中，出站连接会自动变成区域冗余。  在发生区域故障时，出站连接 SNAT 端口分配可会保留。  

反过来，如果已将 VM 关联到公共负载均衡器和局域性前端，则可保证出站连接由单个区域提供。  出站连接的运行状况取决于相应区域的运行状况。

不管使用还是不使用区域，SNAT 端口预先分配和算法都是相同的。

### <a name="health-probes"></a>运行状况探测

现有的运行状况探测定义与不使用可用性区域时相同。  但是，我们已在基础结构级别扩展了运行状况模型。 

使用区域冗余的前端时，负载均衡器会扩展其内部运行状况模型，以便独立探测是否能够从每个可用性区域访问 VM，并关闭各个区域中可能有故障的路径，而无需客户干预。  如果一个区域的负载均衡器基础结构中的给定路径无法由另一个区域中的 VM 使用，则负载均衡器可以检测并避免这种故障。 可以访问此 VM 的其他区域可继续从其各自的前端为此 VM 提供服务。  因此，在发生故障期间，每个区域的流分配可能略有不同，同时可保护端到端服务的总体运行状况。

## <a name="design"></a>设计注意事项

负载均衡器在可用性区域上下文中特意采用灵活性设计。 可以选择与区域相适应，或者选择区域冗余。  提高可用性的代价可能是增大复杂性，必须经过精心设计才能获得最佳性能。  让我们了解一些重要的设计注意事项。

### <a name="automatic-zone-redundancy"></a>自动区域冗余

使用负载均衡器可以轻松地将一个 IP 用作区域冗余的前端。 区域冗余的 IP 地址能够安全地为任何区域中的局域性资源提供服务，并且可以承受一个或多个区域的故障，前提是区域中有一个局部区域保持正常。 相反，局域性前端是在单个区域中部署服务的简化设计，其命运与相应的区域相同。

区域冗余并不意味着数据路径或控制平面不可访问；它是明确的数据平面。 区域冗余流可以使用任何局部区域，客户流使用区域中所有正常的局部区域。 出现区域故障时，在该时间点使用正常区域的流量流不受影响。  发生区域故障时使用区域的流量可能会受影响，但应用程序可以恢复，并且在 Azure 从区域故障中恢复，且重新传输数据或重新建立连接后，这些流可在区域中剩余的正常局部区域中继续。

### <a name="xzonedesign"></a>跨区域边界

请务必了解，每当端到端服务跨区域时，运行状况并不是取决于一个区域，而可能是多个区域。  因此，端到端服务可能无法通过非局域性部署获得任何可用性。

使用可用性区域时，请避免引入意外的跨区域依赖关系，否则可能会完全失去可用性。  如果应用程序由多个组件构成，而你希望能够从区域故障中恢复，则必须慎重确保在发生区域故障时，有足够的关键组件能够幸存。  例如，如果应用程序的单个关键组件只位于除幸存区域以外的其他某个区域，则该组件可能会影响整个应用程序。  另外，请考虑区域还原和应用程序的聚合方式。 让我们探讨几个要点，并在研究特定的场景时，将其用作解答问题的灵感。

- 如果应用程序包含两个组件（例如，一个 IP 地址和包含托管磁盘的 VM），并且保证这两个组件位于区域 1 和区域 2，当区域 1 发生故障时，端到端服务不会幸存。  除非完全了解所创建的是潜在危险的故障模式，否则不要跨区域。

- 如果应用程序包含两个组件（例如，一个 IP 地址和包含托管磁盘的 VM），并且保证这两个组件分别位于区域冗余的区域和区域 1，当区域 2 和/或区域 3 发生故障时，端到端服务可以幸存，除非区域 1 也发生故障。  但是，如果要观察的功能只是前端的可访问性，则在一定程度上无法推测服务的运行状况。  请考虑开发一个涵盖范围更广泛的运行状况和容量模型。  可以结合使用区域冗余和局域性的概念来拓宽见解和可管理性。

- 如果应用程序在三个区域中包含两个组件（例如区域冗余的负载均衡器前端和跨区域的虚拟机规模集），则区域中不受故障影响的资源将保持可用，但在发生区域故障期间，端到端服务的容量可能会下降。 从基础结构的角度看，部署可以在一个或多个区域发生故障时幸存。这就引出了以下问题：
  - 是否了解应用程序如何推测此类故障和容量下降的原因？
  - 是否需要在服务中采取防护措施，以便在必要时强制故障转移到某个区域对？
  - 如何监视、检测和缓解此类场景？ 有时可以使用标准负载均衡器诊断功能来增强端到端服务性能的监视。 全方位地考虑哪个服务会保持可用，哪个服务可能需要增强的监视。

- 使用区域可以更轻松地识别和遏制故障。  但是，在涉及到超时、重试和退让算法等概念时，区域故障与其他故障没有不同。 即使 Azure 负载均衡器提供区域冗余的路径并且会快速尝试恢复，但在实时数据包级别看，重新传输或重新建立可能在故障初期发生，因此，必须了解应用程序应对故障的方式。 负载均衡方案将会幸存，但需要规划好以下方面：
  - 发生区域故障时，端到端服务是否能够识别此故障；如果状态丢失，应如何恢复？
  - 当区域恢复正常时，应用程序是否知道如何安全聚合？

### <a name="zonalityguidance"></a>区域冗余与局域性

区域冗余可以提供区域不可知性，同时，可以使用单个 IP 地址为服务提供复原能力。  因而它可以降低复杂性。  区域冗余还具有跨区域的机动性，可以针对任何区域中的资源安全使用。  此外，在不包含可用性区域的区域中，它可以充当一种保证，在区域获得可用性区域后限制所需的更改。  区域冗余 IP 地址或前端的配置语法在任何区域（包括不带可用性区域的区域）中都可成功。

局域性可以提供单个区域的明确保证，其命运取决于该区域的运行状况。 关联局域性 IP 地址局域性负载均衡器前端可能是必要或合理的属性，尤其是当附加的资源是同一区域中的局域性 VM 时。  或者，应用程序可能需要明确知道资源所在的区域，并且你希望能够明确推测出不同区域的可用性。  可以选择针对跨区域分布的端到端服务公开多个局域性前端（即，将每个区域的局域性前端用于多个局域性虚拟机规模集）。  如果局域性前端是公共 IP 地址，则可以通过[流量管理器](../traffic-manager/traffic-manager-overview.md)使用多个局域性前端来公开服务。  或者，可以通过第三方监视解决方案使用多个局域性前端来获取每个区域的运行状况和性能见解，并使用区域冗余的前端公开整个服务。 只能使用适应同一区域的局域性前端来为局域性资源提供服务，并避免对局域性资源使用潜在有害的跨区域场景。  局域性资源只会出现在可用性区域所在的区域。

在不了解服务体系结构的情况下，无法遵循任何常规指导来做出更好的选择。

## <a name="limitations"></a>限制

- 尽管数据平面是完全区域冗余的（除非指定了局域性保证），但控制平面操作不完全是区域冗余的。

## <a name="next-steps"></a>后续步骤
- 详细了解[可用性区域](../availability-zones/az-overview.md)
- 详细了解[标准负载均衡器](load-balancer-standard-overview.md)
- 了解如何[使用具有区域性前端的标准负载均衡器在区域内对 VM 进行负载均衡](load-balancer-standard-public-zonal-cli.md)
- 了解如何[使用具有区域冗余前端的标准负载均衡器跨区域对 VM 进行负载均衡](load-balancer-standard-public-zone-redundant-cli.md)
